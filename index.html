<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ボスバトルクイズゲーム</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
  <!-- Tone.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

  <style>
    body{font-family:'DotGothic16',sans-serif;background:#000;color:#fff;image-rendering:pixelated}
    .dq-window{border:4px solid #fff;background:#000088;padding:1rem;box-shadow:0 0 0 4px #000}
    .dq-button{cursor:pointer;padding:.5rem 1rem;border:2px solid #fff;background:#000088;text-align:center}
    .dq-button:hover{background:#4444CC}
    .hp-bar-container{border:2px solid #fff;height:24px;padding:2px;background:#333}
    .hp-bar{background:#33ff33;height:100%;transition:width .5s ease-out}
    .hp-bar.low{background:#ff3333}
    .boss-idle{animation:boss-idle 2s infinite ease-in-out}
    @keyframes boss-idle{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
    .damage-flash{animation:damage-flash .3s 1}
    @keyframes damage-flash{0%,100%{opacity:1}50%{opacity:.2}}
    .damage-text{position:absolute;font-size:2rem;font-weight:bold;color:#ff4444;text-shadow:2px 2px #000;animation:float-up 1s forwards;pointer-events:none}
    @keyframes float-up{from{transform:translateY(0);opacity:1}to{transform:translateY(-60px);opacity:0}}
  </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
  <div class="w-full max-w-3xl mx-auto">
    <!-- ボス表示 -->
    <div id="boss-area" class="mb-4 h-48 flex justify-center items-end relative hidden">
      <div id="boss-container" class="boss-idle">
        <svg width="120" height="100" viewBox="0 0 120 100">
          <path d="M60 100C10 100 10 60 10 60C10 20 40 10 60 10C80 10 110 20 110 60C110 60 110 100 60 100Z" fill="#29B6F6"/>
          <circle cx="45" cy="55" r="8" fill="white"/>
          <circle cx="75" cy="55" r="8" fill="white"/>
          <circle cx="47" cy="57" r="4" fill="black"/>
          <circle cx="77" cy="57" r="4" fill="black"/>
          <path d="M40 75 Q60 90 80 75" stroke="white" stroke-width="4" fill="none"/>
        </svg>
      </div>
    </div>

    <!-- ゲーム本体 -->
    <div id="game-container" class="w-full dq-window">
      <!-- スタート画面 -->
      <div id="start-screen" class="text-center">
        <h1 class="text-3xl sm:text-4xl font-bold mb-4">クイズの洞窟</h1>
        <p class="text-lg mb-6">奥にボスがいるようだ...！</p>

        <div class="flex flex-col items-center gap-3 mb-4">
          <input id="playerName" type="text" maxlength="30" class="text-black px-3 py-2 w-64"
                 placeholder="名前を入力（重複不可）"/>
          <div id="start-button" class="dq-button inline-block">▶ 冒険を始める</div>
          <div id="msg" class="text-yellow-300 text-sm h-5"></div>
        </div>
      </div>

      <!-- クイズ画面 -->
      <div id="quiz-screen" class="hidden">
        <div id="status-container" class="grid grid-cols-2 gap-4 mb-4">
          <div>
            <p>ゆうしゃ HP</p>
            <div class="hp-bar-container"><div id="player-hp-bar" class="hp-bar"></div></div>
          </div>
          <div>
            <p>ボス HP</p>
            <div class="hp-bar-container"><div id="boss-hp-bar" class="hp-bar"></div></div>
          </div>
        </div>

        <div id="question-container" class="mb-4 min-h-[80px] p-4 border-2 border-white">
          <p id="question-text" class="text-xl"></p>
        </div>

        <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      </div>

      <!-- 結果画面 -->
      <div id="result-screen" class="hidden text-center">
        <h2 id="result-title" class="text-3xl sm:text-4xl font-bold mb-4"></h2>
        <p id="result-message" class="text-xl mb-8"></p>
        <div id="restart-button" class="dq-button inline-block">▶ もう一度挑戦する</div>
      </div>
    </div>
  </div>

  <script>
    // === GAS連携設定 ===
    const GAS_URL = "https://script.google.com/macros/s/AKfycby8RB_-Io-bwuMaCL6f0shgO9Spbn2-0_g7TnbS44jbACiD9aZ_jij13SHl4oYCksK-DA/exec"; // 例: https://script.google.com/macros/s/XXXX/exec
    const QUIZ_ID = "quiz-001"; // クイズを分けたい時はここを変えてね

    const msgEl = () => document.getElementById('msg');
    const showMsg = (t)=>{ if(msgEl()) msgEl().textContent=t; };
    function alreadyTakenLocal(name){ return localStorage.getItem(`quiz_taken_${QUIZ_ID}_${name}`)==="1"; }
    function markTakenLocal(name){ localStorage.setItem(`quiz_taken_${QUIZ_ID}_${name}`,"1"); }

    // --- DOM ---
    const startScreen = document.getElementById('start-screen');
    const quizScreen = document.getElementById('quiz-screen');
    const resultScreen = document.getElementById('result-screen');
    const bossArea = document.getElementById('boss-area');
    const bossContainer = document.getElementById('boss-container');

    const startButton = document.getElementById('start-button');
    const restartButton = document.getElementById('restart-button');

    const playerHpBar = document.getElementById('player-hp-bar');
    const bossHpBar = document.getElementById('boss-hp-bar');

    const questionText = document.getElementById('question-text');
    const optionsContainer = document.getElementById('options-container');

    const resultTitle = document.getElementById('result-title');
    const resultMessage = document.getElementById('result-message');

    // --- クイズデータ ---
    const quizData = [
      { question: "HTMLでハイパーリンクを作成するタグはどれ？", options: ["<link>", "<a>", "<p>", "<h>"], answer: "<a>" },
      { question: "CSSは何の略？", options: ["Creative Style Sheets", "Computer Style Sheets", "Cascading Style Sheets", "Colorful Style Sheets"], answer: "Cascading Style Sheets" },
      { question: "JavaScriptで変数を宣言するキーワードでないものは？", options: ["var", "let", "const", "def"], answer: "def" },
      { question: "世界で最も高い山は？", options: ["K2", "富士山", "エベレスト", "カンチェンジュンガ"], answer: "エベレスト" },
      { question: "日本の現在の首都は？", options: ["京都", "大阪", "奈良", "東京"], answer: "東京" },
      { question: "太陽系で最も大きい惑星は？", options: ["地球", "木星", "土星", "火星"], answer: "木星"},
      { question: "化学記号「Fe」が示す元素は？", options: ["金", "銀", "鉄", "銅"], answer: "鉄"}
    ];
    let shuffledQuizData = [];
    let currentQuestionIndex = 0;

    // --- ゲーム状態 ---
    const PLAYER_MAX_HP = 100;
    const BOSS_MAX_HP = 200;
    let playerHP = PLAYER_MAX_HP;
    let bossHP = BOSS_MAX_HP;
    let audioStarted = false;
    let correctCount = 0;

    // --- サウンド ---
    let hitSound, damageSound, victorySound, defeatSound, clickSound;
    function setupAudio(){
      if(audioStarted) return;
      Tone.start();
      hitSound = ()=> new Tone.Synth({oscillator:{type:"triangle"},envelope:{attack:0.005,decay:0.1,sustain:0.0,release:0.1}}).toDestination().triggerAttackRelease("G5","16n");
      damageSound = ()=> new Tone.NoiseSynth({noise:{type:"brown"},envelope:{attack:0.005,decay:0.1,sustain:0,release:0.1}}).toDestination().triggerAttackRelease("8n");
      victorySound = ()=>{
        const s=new Tone.Synth().toDestination(); const n=Tone.now();
        s.triggerAttackRelease("C5","8n",n); s.triggerAttackRelease("E5","8n",n+0.2);
        s.triggerAttackRelease("G5","8n",n+0.4); s.triggerAttackRelease("C6","4n",n+0.6);
      };
      defeatSound = ()=>{
        const s=new Tone.Synth().toDestination(); const n=Tone.now();
        s.triggerAttackRelease("C4","4n",n); s.triggerAttackRelease("B3","4n",n+0.3);
        s.triggerAttackRelease("A#3","4n",n+0.6); s.triggerAttackRelease("A3","2n",n+0.9);
      };
      clickSound = ()=> new Tone.MembraneSynth({pitchDecay:0.008,octaves:2,envelope:{attack:0.0006,decay:0.2,sustain:0}}).toDestination().triggerAttackRelease("C2","8n");
      audioStarted = true;
    }

    // --- イベント ---
    startButton.addEventListener('click', startGame);
    restartButton.addEventListener('click', startGame);

    // --- ロジック ---
    function shuffleArray(arr){
      for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }
    }

    async function startGame(){
      setupAudio();
      clickSound();

      const name = (document.getElementById('playerName')?.value || "").trim();
      if(!name){ showMsg("名前いれてな〜"); return; }

      if(alreadyTakenLocal(name)){ showMsg("この端末ではその名前はもう受験済みやで🙅"); return; }

      // 重複チェック
      try{
        const r = await fetch(`${GAS_URL}?action=check&quizId=${encodeURIComponent(QUIZ_ID)}&name=${encodeURIComponent(name)}`);
        const j = await r.json();
        if(!j.ok){ showMsg("その名前はもう使われてるで！別名でお願い🙏"); return; }
      }catch{ showMsg("サーバ確認ミス…少し待って🙏"); return; }

      // 登録
      try{
        const r2 = await fetch(`${GAS_URL}?action=register`,{
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ quizId: QUIZ_ID, name })
        });
        if(r2.status===409){ showMsg("同じ名前は1回だけやで🙅"); return; }
        if(!r2.ok) throw new Error("register failed");
        markTakenLocal(name);
      }catch{ showMsg("登録に失敗…もう一回🙏"); return; }

      // いつもの初期化
      correctCount = 0;
      playerHP = PLAYER_MAX_HP;
      bossHP = BOSS_MAX_HP;
      currentQuestionIndex = 0;
      shuffledQuizData = [...quizData];
      shuffleArray(shuffledQuizData);

      updateHpBars();

      startScreen.classList.add('hidden');
      resultScreen.classList.add('hidden');
      quizScreen.classList.remove('hidden');
      bossArea.classList.remove('hidden');

      showMsg("");
      displayQuestion();
    }

    function displayQuestion(){
      if(playerHP<=0 || bossHP<=0) return;

      optionsContainer.innerHTML = '';
      if(currentQuestionIndex >= shuffledQuizData.length){ currentQuestionIndex = 0; }
      const current = shuffledQuizData[currentQuestionIndex];
      questionText.textContent = current.question;

      current.options.forEach(opt=>{
        const div = document.createElement('div');
        div.textContent = `▶ ${opt}`;
        div.classList.add('dq-button');
        div.dataset.answer = opt;
        div.addEventListener('click', handleAnswer);
        optionsContainer.appendChild(div);
      });
      currentQuestionIndex++;
    }

    function handleAnswer(e){
      const selected = e.target.dataset.answer;
      const correct = shuffledQuizData[currentQuestionIndex-1].answer;

      optionsContainer.querySelectorAll('.dq-button').forEach(b=>b.style.pointerEvents='none');

      if(selected === correct){
        correctCount++; // ★正解カウント
        hitSound();
        const damage = Math.floor(Math.random()*21)+30; // 30-50
        bossHP = Math.max(0, bossHP - damage);
        showDamage(bossArea, damage);
        bossContainer.classList.add('damage-flash');
      }else{
        damageSound();
        const damage = Math.floor(Math.random()*11)+15; // 15-25
        playerHP = Math.max(0, playerHP - damage);
        showDamage(document.body, damage);
        document.querySelector('.dq-window').classList.add('damage-flash');
      }

      updateHpBars();

      setTimeout(()=>{
        bossContainer.classList.remove('damage-flash');
        document.querySelector('.dq-window').classList.remove('damage-flash');

        if(playerHP<=0){ showEndScreen(false); }
        else if(bossHP<=0){ showEndScreen(true); }
        else{ displayQuestion(); }
      }, 1000);
    }

    function updateHpBars(){
      const p = (playerHP/PLAYER_MAX_HP)*100;
      playerHpBar.style.width = `${p}%`;
      playerHpBar.classList.toggle('low', p<30);

      const b = (bossHP/BOSS_MAX_HP)*100;
      bossHpBar.style.width = `${b}%`;
      bossHpBar.classList.toggle('low', b<30);
    }

    function showDamage(el, dmg){
      const d = document.createElement('div');
      d.textContent = dmg;
      d.className = 'damage-text';
      el.appendChild(d);
      setTimeout(()=>d.remove(), 1000);
    }

    function showEndScreen(isVictory){
      quizScreen.classList.add('hidden');
      bossArea.classList.add('hidden');
      resultScreen.classList.remove('hidden');

      if(isVictory){
        victorySound();
        resultTitle.textContent = '勝利！';
        resultMessage.textContent = 'ボスを倒した！洞窟に平和が戻った。';
      }else{
        defeatSound();
        resultTitle.textContent = '敗北...';
        resultMessage.textContent = 'ゆうしゃは力尽きた...。';
      }

      // ★スコア送信
      const name = (document.getElementById('playerName')?.value || "").trim();
      if(name){
        fetch(`${GAS_URL}?action=finish`,{
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ quizId: QUIZ_ID, name, score: correctCount })
        }).catch(()=>{});
      }
    }
  </script>
</body>
</html>
