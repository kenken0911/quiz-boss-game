<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>„Éú„Çπ„Éê„Éà„É´„ÇØ„Ç§„Ç∫„Ç≤„Éº„É†</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
  <!-- Tone.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

  <style>
    body{font-family:'DotGothic16',sans-serif;background:#000;color:#fff;image-rendering:pixelated}
    .dq-window{border:4px solid #fff;background:#000088;padding:1rem;box-shadow:0 0 0 4px #000}
    .dq-button{cursor:pointer;padding:.5rem 1rem;border:2px solid #fff;background:#000088;text-align:center}
    .dq-button:hover{background:#4444CC}
    .dq-button:disabled{background:#555;color:#999;cursor:not-allowed}
    .hp-bar-container{border:2px solid #fff;height:24px;padding:2px;background:#333}
    .hp-bar{background:#33ff33;height:100%;transition:width .5s ease-out}
    .hp-bar.low{background:#ff3333}

    /* „Éú„ÇπÊºîÂá∫ */
    .boss-idle{animation:boss-float 2.2s infinite ease-in-out}
    @keyframes boss-float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
    .boss-roar{animation:boss-roar .35s ease-in-out}
    @keyframes boss-roar{0%{transform:scale(1)}50%{transform:scale(1.08)}100%{transform:scale(1)}}

    /* „ÉÄ„É°„Éº„Ç∏ÔºÜ„Ç∑„Çß„Ç§„ÇØ */
    .damage-flash{animation:damage-flash .28s 1}
    @keyframes damage-flash{0%,100%{opacity:1}50%{opacity:.25}}
    .shake{animation:shake .35s}
    @keyframes shake{
      10%{transform:translate(-2px, -2px)} 20%{transform:translate(2px, 1px)}
      30%{transform:translate(-1px, 2px)} 40%{transform:translate(2px, -1px)}
      50%{transform:translate(-2px, 1px)} 60%{transform:translate(1px, -2px)}
      70%{transform:translate(-1px, 1px)} 80%{transform:translate(2px, 2px)}
      90%{transform:translate(-2px, -1px)} 100%{transform:translate(0,0)}
    }

    /* „ÉÄ„É°„Éº„Ç∏Êï∞Â≠ó */
    .damage-text{position:absolute;font-size:2rem;font-weight:bold;color:#ff5555;text-shadow:2px 2px #000;animation:float-up 1s forwards;pointer-events:none}
    @keyframes float-up{from{transform:translateY(0);opacity:1}to{transform:translateY(-60px);opacity:0}}

    /* ÁÇéÔºàSVG‰∏≠„ÅÆ„Ç¢„Éã„É°„ÅßÁÇπÊªÖÔºâ */
    .fire-glow{filter:drop-shadow(0 0 6px #ff8a00) drop-shadow(0 0 12px #ff3b00)}

    /* „É¨„Çπ„Éù„É≥„Ç∑„Éñ */
    #boss-svg{max-width:280px;width:60vw;height:auto}
  </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
  <div class="w-full max-w-3xl mx-auto">
    <!-- „Éú„ÇπË°®Á§∫ -->
    <div id="boss-area" class="mb-4 h-60 flex justify-center items-end relative hidden">
      <div id="boss-container" class="boss-idle">
        <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Ëø´Âäõ„Éú„ÇπÔºöÁÇéÁ´ú„ÅÆSVG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
        <svg id="boss-svg" viewBox="0 0 260 220">
          <defs>
            <linearGradient id="gradBody" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0%"   stop-color="#6622CC"/>
              <stop offset="50%" stop-color="#7A00F5"/>
              <stop offset="100%" stop-color="#300070"/>
            </linearGradient>
            <linearGradient id="gradEye" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0%" stop-color="#fff700"/>
              <stop offset="100%" stop-color="#ff4d00"/>
            </linearGradient>
            <linearGradient id="gradFire" x1="0" y1="0" x2="0" y2="1">
              <stop offset="0%" stop-color="#fff7a1"/>
              <stop offset="40%" stop-color="#ff8a00"/>
              <stop offset="100%" stop-color="#ff3b00"/>
            </linearGradient>
          </defs>

          <!-- ÂΩ± -->
          <ellipse cx="130" cy="205" rx="70" ry="10" fill="#000" opacity="0.5"></ellipse>

          <!-- ‰Ωì -->
          <path d="M35,150 C20,120 40,60 95,55 C110,40 145,30 175,45 C210,40 240,70 230,110
                   C225,125 200,145 180,155 C165,170 125,180 95,170 C70,170 45,165 35,150 Z"
                fill="url(#gradBody)" stroke="#caa8ff" stroke-width="3"/>

          <!-- Ëßí -->
          <path d="M150,42 C152,22 175,10 185,8 C175,20 170,32 165,44 Z" fill="#caa8ff"/>
          <path d="M128,38 C130,20 150,10 160,8 C150,20 145,30 140,42 Z" fill="#caa8ff"/>

          <!-- ÁõÆ -->
          <ellipse cx="160" cy="95" rx="15" ry="12" fill="black"/>
          <ellipse cx="160" cy="95" rx="9"  ry="7"  fill="url(#gradEye)"/>
          <circle  cx="162" cy="94" r="3" fill="#fff"/>

          <!-- Âè£ -->
          <path d="M120,120 C150,130 185,120 205,112" stroke="#ffd9d9" stroke-width="5" fill="none"/>

          <!-- ÁÇé -->
          <g class="fire-glow">
            <path id="flame" d="M210,115 C220,110 235,105 245,108
                                 C230,120 235,135 220,138
                                 C230,130 220,120 210,115 Z"
                  fill="url(#gradFire)" opacity="0.9">
              <animate attributeName="opacity" values="0.6;1;0.6" dur="0.9s" repeatCount="indefinite"/>
            </path>
          </g>

          <!-- Áâô -->
          <path d="M148,118 l6,10 l-10,0 Z" fill="#fff"/>
          <path d="M165,120 l6,10 l-10,0 Z" fill="#fff"/>
        </svg>
      </div>
    </div>

    <!-- „Ç≤„Éº„É†Êú¨‰Ωì -->
    <div id="game-container" class="w-full dq-window">
      <!-- „Çπ„Çø„Éº„ÉàÁîªÈù¢ -->
      <div id="start-screen" class="text-center">
        <h1 class="text-3xl sm:text-4xl font-bold mb-4">„ÇØ„Ç§„Ç∫„ÅÆÊ¥ûÁ™ü</h1>
        <p class="text-lg mb-6">Â••„Å´ÁÇéÁ´ú„ÅåÂæÖ„Å°Êßã„Åà„Å¶„ÅÑ„Çã‚Ä¶ÔºÅ</p>

        <div class="flex flex-col items-center gap-3 mb-4">
          <input id="playerName" type="text" maxlength="30" class="text-black px-3 py-2 w-64"
                 placeholder="ÂêçÂâç„ÇíÂÖ•ÂäõÔºàÈáçË§á‰∏çÂèØÔºâ"/>
          <button id="start-button" class="dq-button inline-flex items-center gap-2">
            <span>‚ñ∂</span><span>ÂÜíÈô∫„ÇíÂßã„ÇÅ„Çã</span>
          </button>
          <div id="msg" class="text-yellow-300 text-sm h-5"></div>
        </div>
      </div>

      <!-- „ÇØ„Ç§„Ç∫ÁîªÈù¢ -->
      <div id="quiz-screen" class="hidden">
        <div id="status-container" class="grid grid-cols-2 gap-4 mb-4">
          <div>
            <p>„ÇÜ„ÅÜ„Åó„ÇÉ HP</p>
            <div class="hp-bar-container"><div id="player-hp-bar" class="hp-bar"></div></div>
          </div>
          <div>
            <p>„Éú„Çπ HP</p>
            <div class="hp-bar-container"><div id="boss-hp-bar" class="hp-bar"></div></div>
          </div>
        </div>

        <div id="question-container" class="mb-4 min-h-[80px] p-4 border-2 border-white">
          <p id="question-text" class="text-xl"></p>
        </div>

        <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      </div>

      <!-- ÁµêÊûúÁîªÈù¢ -->
      <div id="result-screen" class="hidden text-center">
        <h2 id="result-title" class="text-3xl sm:text-4xl font-bold mb-4"></h2>
        <p id="result-message" class="text-xl mb-8"></p>
        <div id="restart-button" class="dq-button inline-block">‚ñ∂ „ÇÇ„ÅÜ‰∏ÄÂ∫¶ÊåëÊà¶„Åô„Çã</div>
      </div>
    </div>
  </div>

  <script>
    // === GASÈÄ£Êê∫Ë®≠ÂÆö ===
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyMgfq6urfcwxFVf7FhOWfLPhNA2LSK3glPc_SJDmYnh-_d0aTyhTGo2PIZhRRhKxCMDA/exec"; // ‚òÖ ÊúÄÊñ∞„ÅÆURL„Å´Êõ¥Êñ∞Ê∏à„ÅøÔºÅ ‚òÖ
    const QUIZ_ID = "quiz-001";

    const msgEl = () => document.getElementById('msg');
    const showMsg = (t)=>{ if(msgEl()) msgEl().textContent=t; };
    function alreadyTakenLocal(name){ return localStorage.getItem(`quiz_taken_${QUIZ_ID}_${name}`)==="1"; }
    function markTakenLocal(name){ localStorage.setItem(`quiz_taken_${QUIZ_ID}_${name}`,"1"); }

    // --- DOM ---
    const startScreen = document.getElementById('start-screen');
    const quizScreen = document.getElementById('quiz-screen');
    const resultScreen = document.getElementById('result-screen');
    const bossArea = document.getElementById('boss-area');
    const bossContainer = document.getElementById('boss-container');

    const startButton = document.getElementById('start-button');
    const restartButton = document.getElementById('restart-button');

    const playerHpBar = document.getElementById('player-hp-bar');
    const bossHpBar = document.getElementById('boss-hp-bar');

    const questionText = document.getElementById('question-text');
    const optionsContainer = document.getElementById('options-container');

    const resultTitle = document.getElementById('result-title');
    const resultMessage = document.getElementById('result-message');

    // --- „ÇØ„Ç§„Ç∫„Éá„Éº„Çø ---
    const quizData = [
      { question: "HTML„Åß„Éè„Ç§„Éë„Éº„É™„É≥„ÇØ„Çí‰ΩúÊàê„Åô„Çã„Çø„Ç∞„ÅØ„Å©„ÇåÔºü", options: ["<link>", "<a>", "<p>", "<h>"], answer: "<a>" },
      { question: "CSS„ÅØ‰Ωï„ÅÆÁï•Ôºü", options: ["Creative Style Sheets", "Computer Style Sheets", "Cascading Style Sheets", "Colorful Style Sheets"], answer: "Cascading Style Sheets" },
      { question: "JavaScript„ÅßÂ§âÊï∞„ÇíÂÆ£Ë®Ä„Åô„Çã„Ç≠„Éº„ÉØ„Éº„Éâ„Åß„Å™„ÅÑ„ÇÇ„ÅÆ„ÅØÔºü", options: ["var", "let", "const", "def"], answer: "def" },
      { question: "‰∏ñÁïå„ÅßÊúÄ„ÇÇÈ´ò„ÅÑÂ±±„ÅØÔºü", options: ["K2", "ÂØåÂ£´Â±±", "„Ç®„Éô„É¨„Çπ„Éà", "„Ç´„É≥„ÉÅ„Çß„É≥„Ç∏„É•„É≥„Ç¨"], answer: "„Ç®„Éô„É¨„Çπ„Éà" },
      { question: "Êó•Êú¨„ÅÆÁèæÂú®„ÅÆÈ¶ñÈÉΩ„ÅØÔºü", options: ["‰∫¨ÈÉΩ", "Â§ßÈò™", "Â•àËâØ", "Êù±‰∫¨"], answer: "Êù±‰∫¨" },
      { question: "Â§™ÈôΩÁ≥ª„ÅßÊúÄ„ÇÇÂ§ß„Åç„ÅÑÊÉëÊòü„ÅØÔºü", options: ["Âú∞ÁêÉ", "Êú®Êòü", "ÂúüÊòü", "ÁÅ´Êòü"], answer: "Êú®Êòü"},
      { question: "ÂåñÂ≠¶Ë®òÂè∑„ÄåFe„Äç„ÅåÁ§∫„ÅôÂÖÉÁ¥†„ÅØÔºü", options: ["Èáë", "ÈäÄ", "ÈâÑ", "ÈäÖ"], answer: "ÈâÑ"}
    ];
    let shuffledQuizData = [];
    let currentQuestionIndex = 0;

    // --- „Ç≤„Éº„É†Áä∂ÊÖã ---
    const PLAYER_MAX_HP = 100;
    const BOSS_MAX_HP = 200;
    let playerHP = PLAYER_MAX_HP;
    let bossHP = BOSS_MAX_HP;
    let audioStarted = false;
    let correctCount = 0;
    let starting = false; // ‰∫åÈáçÊäº„ÅóÈò≤Ê≠¢

    // --- „Çµ„Ç¶„É≥„Éâ ---
    let hitSound, damageSound, victorySound, defeatSound, clickSound, roarSound;
    function setupAudio(){
      if(audioStarted) return;
      Tone.start();
      hitSound = ()=> new Tone.Synth({oscillator:{type:"triangle"},envelope:{attack:0.005,decay:0.1,sustain:0.0,release:0.1}}).toDestination().triggerAttackRelease("G5","16n");
      damageSound = ()=> new Tone.NoiseSynth({noise:{type:"brown"},envelope:{attack:0.005,decay:0.1,sustain:0,release:0.1}}).toDestination().triggerAttackRelease("8n");
      victorySound = ()=>{
        const s=new Tone.Synth().toDestination(); const n=Tone.now();
        s.triggerAttackRelease("C5","8n",n); s.triggerAttackRelease("E5","8n",n+0.2);
        s.triggerAttackRelease("G5","8n",n+0.4); s.triggerAttackRelease("C6","4n",n+0.6);
      };
      defeatSound = ()=>{
        const s=new Tone.Synth().toDestination(); const n=Tone.now();
        s.triggerAttackRelease("C4","4n",n); s.triggerAttackRelease("B3","4n",n+0.3);
        s.triggerAttackRelease("A#3","4n",n+0.6); s.triggerAttackRelease("A3","2n",n+0.9);
      };
      clickSound = ()=> new Tone.MembraneSynth({pitchDecay:0.008,octaves:2,envelope:{attack:0.0006,decay:0.2,sustain:0}}).toDestination().triggerAttackRelease("C2","8n");
      roarSound = ()=> new Tone.MetalSynth({frequency:180, envelope:{attack:0.001,decay:1.2,release:0.4}}).toDestination().triggerAttackRelease("C3","8n");
      audioStarted = true;
    }

    // --- „Ç§„Éô„É≥„Éà ---
    startButton.addEventListener('click', () => startGame());
    restartButton.addEventListener('click', () => {
        startScreen.classList.remove('hidden');
        resultScreen.classList.add('hidden');
        document.getElementById('playerName').value = ''; 
    });


    // --- „É≠„Ç∏„ÉÉ„ÇØ ---
    function shuffleArray(arr){
      for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }
    }

    async function startGame(){
      if(starting) return; 
      starting = true;
      startButton.disabled = true;

      setupAudio();
      clickSound();

      const name = (document.getElementById('playerName')?.value || "").trim();
      if(!name){ 
        showMsg("ÂêçÂâç„ÅÑ„Çå„Å¶„Å™„Äú"); 
        starting=false; 
        startButton.disabled=false; 
        return; 
      }

      if(alreadyTakenLocal(name)){ 
        showMsg("„Åì„ÅÆÁ´ØÊú´„Åß„ÅØ„Åù„ÅÆÂêçÂâç„ÅØ„ÇÇ„ÅÜÂèóÈ®ìÊ∏à„Åø„ÇÑ„ÅßüôÖ"); 
        starting=false; 
        startButton.disabled=false; 
        return; 
      }

      // ÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ
      showMsg("„Çµ„Éº„Éê„Éº„Å®ÈÄö‰ø°‰∏≠‚Ä¶");
      try{
        const r = await fetch(`${GAS_URL}?action=check&quizId=${encodeURIComponent(QUIZ_ID)}&name=${encodeURIComponent(name)}`);
        if (!r.ok) throw new Error(`Server check failed: ${r.status}`);
        const j = await r.json();
        if(!j.ok){ 
          showMsg("„Åù„ÅÆÂêçÂâç„ÅØ„ÇÇ„ÅÜ‰Ωø„Çè„Çå„Å¶„Çã„ÅßÔºÅÂà•Âêç„Åß„ÅäÈ°ò„ÅÑüôè"); 
          starting=false; 
          startButton.disabled=false; 
          return; 
        }
      }catch(e){ 
        console.error("Check failed:", e); 
        showMsg("„Çµ„Éº„ÉêÁ¢∫Ë™ç„Éü„Çπ‚Ä¶Â∞ë„ÅóÂæÖ„Å£„Å¶üôè"); 
        starting=false; 
        startButton.disabled=false; 
        return; 
      }

      // ÁôªÈå≤
      try{
        const r2 = await fetch(`${GAS_URL}?action=register&quizId=${encodeURIComponent(QUIZ_ID)}&name=${encodeURIComponent(name)}`,{
          method:"POST",
        });
        if(r2.status===409){ 
          showMsg("Âêå„ÅòÂêçÂâç„ÅØ1Âõû„Å†„Åë„ÇÑ„ÅßüôÖ"); 
          starting=false; 
          startButton.disabled=false; 
          return; 
        }
        if(!r2.ok) throw new Error("Register failed");
        markTakenLocal(name);
      }catch(e){ 
        console.error("Register failed:", e); 
        showMsg("ÁôªÈå≤„Å´Â§±Êïó‚Ä¶„ÇÇ„ÅÜ‰∏ÄÂõûüôè"); 
        starting=false; 
        startButton.disabled=false; 
        return; 
      }

      // ÂàùÊúüÂåñ
      correctCount = 0;
      playerHP = PLAYER_MAX_HP;
      bossHP = BOSS_MAX_HP;
      currentQuestionIndex = 0;
      shuffledQuizData = [...quizData];
      shuffleArray(shuffledQuizData);

      updateHpBars();

      startScreen.classList.add('hidden');
      resultScreen.classList.add('hidden');
      quizScreen.classList.remove('hidden');
      bossArea.classList.remove('hidden');

      // „Éú„ÇπÊºîÂá∫
      bossContainer.classList.add('boss-roar','shake');
      roarSound();
      setTimeout(()=>{ bossContainer.classList.remove('boss-roar','shake'); }, 400);

      showMsg("");
      displayQuestion();

      starting=false; 
      startButton.disabled=false;
    }

    function displayQuestion(){
      if(playerHP<=0 || bossHP<=0) return;

      optionsContainer.innerHTML = '';
      if(currentQuestionIndex >= shuffledQuizData.length){ currentQuestionIndex = 0; }
      const current = shuffledQuizData[currentQuestionIndex];
      questionText.textContent = current.question;

      current.options.forEach(opt=>{
        const div = document.createElement('div');
        div.textContent = `‚ñ∂ ${opt}`;
        div.classList.add('dq-button');
        div.dataset.answer = opt;
        div.addEventListener('click', handleAnswer);
        optionsContainer.appendChild(div);
      });
      currentQuestionIndex++;
    }

    function handleAnswer(e){
      const selected = e.target.dataset.answer;
      const correct = shuffledQuizData[currentQuestionIndex-1].answer;

      optionsContainer.querySelectorAll('.dq-button').forEach(b=>b.style.pointerEvents='none');

      if(selected === correct){
        correctCount++;
        hitSound();
        const damage = Math.floor(Math.random()*21)+30; // 30-50
        bossHP = Math.max(0, bossHP - damage);
        showDamage(bossArea, damage);
        bossContainer.classList.add('damage-flash','shake');
      }else{
        damageSound();
        const damage = Math.floor(Math.random()*11)+15; // 15-25
        playerHP = Math.max(0, playerHP - damage);
        showDamage(document.body, damage);
        document.querySelector('.dq-window').classList.add('damage-flash','shake');
      }

      updateHpBars();

      setTimeout(()=>{
        bossContainer.classList.remove('damage-flash','shake');
        document.querySelector('.dq-window').classList.remove('damage-flash','shake');

        if(playerHP<=0){ showEndScreen(false); }
        else if(bossHP<=0){ showEndScreen(true); }
        else{ displayQuestion(); }
      }, 900);
    }

    function updateHpBars(){
      const p = (playerHP/PLAYER_MAX_HP)*100;
      playerHpBar.style.width = `${p}%`;
      playerHpBar.classList.toggle('low', p<30);

      const b = (bossHP/BOSS_MAX_HP)*100;
      bossHpBar.style.width = `${b}%`;
      bossHpBar.classList.toggle('low', b<30);
    }

    function showDamage(el, dmg){
      const d = document.createElement('div');
      d.textContent = dmg;
      d.className = 'damage-text';
      el.appendChild(d);
      setTimeout(()=>d.remove(), 1000);
    }

    function showEndScreen(isVictory){
      quizScreen.classList.add('hidden');
      bossArea.classList.add('hidden');
      resultScreen.classList.remove('hidden');

      if(isVictory){
        victorySound();
        resultTitle.textContent = 'ÂãùÂà©ÔºÅ';
        resultMessage.textContent = 'ÁÇéÁ´ú„ÇíË®é‰ºê„Åó„ÅüÔºÅÊ¥ûÁ™ü„Å´Âπ≥Âíå„ÅåÊàª„Å£„Åü„ÄÇ';
      }else{
        defeatSound();
        resultTitle.textContent = 'ÊïóÂåó...';
        resultMessage.textContent = '„ÇÜ„ÅÜ„Åó„ÇÉ„ÅØÂäõÂ∞Ω„Åç„Åü‚Ä¶Ê¨°„ÅØÂãù„Å§ÔºÅ';
      }

      // „Çπ„Ç≥„Ç¢ÈÄÅ‰ø°
      const name = (document.getElementById('playerName')?.value || "").trim();
      if(name){
        fetch(`${GAS_URL}?action=finish`,{
          method:"POST",
          headers:{ "Content-Type":"text/plain" }, // CORS„Éó„É™„Éï„É©„Ç§„Éà„ÇíÈÅø„Åë„Çã„Åü„ÇÅ
          body: JSON.stringify({ quizId: QUIZ_ID, name, score: correctCount })
        }).catch((e)=>{ console.error("Finish failed", e) });
      }
    }
  </script>
</body>
</html>
