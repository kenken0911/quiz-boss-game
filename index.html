<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ãƒœã‚¹ãƒãƒˆãƒ«ã‚¯ã‚¤ã‚ºã‚²ãƒ¼ãƒ </title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
  <!-- Tone.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

  <style>
    body{font-family:'DotGothic16',sans-serif;background:#000;color:#fff;image-rendering:pixelated}
    .dq-window{border:4px solid #fff;background:#000088;padding:1rem;box-shadow:0 0 0 4px #000}
    .dq-button{cursor:pointer;padding:.5rem 1rem;border:2px solid #fff;background:#000088;text-align:center}
    .dq-button:hover{background:#4444CC}
    .hp-bar-container{border:2px solid #fff;height:24px;padding:2px;background:#333}
    .hp-bar{background:#33ff33;height:100%;transition:width .5s ease-out}
    .hp-bar.low{background:#ff3333}
    .boss-idle{animation:boss-idle 2s infinite ease-in-out}
    @keyframes boss-idle{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
    .damage-flash{animation:damage-flash .3s 1}
    @keyframes damage-flash{0%,100%{opacity:1}50%{opacity:.2}}
    .damage-text{position:absolute;font-size:2rem;font-weight:bold;color:#ff4444;text-shadow:2px 2px #000;animation:float-up 1s forwards;pointer-events:none}
    @keyframes float-up{from{transform:translateY(0);opacity:1}to{transform:translateY(-60px);opacity:0}}
  </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
  <div class="w-full max-w-3xl mx-auto">
    <!-- ãƒœã‚¹è¡¨ç¤º -->
    <div id="boss-area" class="mb-4 h-48 flex justify-center items-end relative hidden">
      <div id="boss-container" class="boss-idle">
        <svg width="120" height="100" viewBox="0 0 120 100">
          <path d="M60 100C10 100 10 60 10 60C10 20 40 10 60 10C80 10 110 20 110 60C110 60 110 100 60 100Z" fill="#29B6F6"/>
          <circle cx="45" cy="55" r="8" fill="white"/>
          <circle cx="75" cy="55" r="8" fill="white"/>
          <circle cx="47" cy="57" r="4" fill="black"/>
          <circle cx="77" cy="57" r="4" fill="black"/>
          <path d="M40 75 Q60 90 80 75" stroke="white" stroke-width="4" fill="none"/>
        </svg>
      </div>
    </div>

    <!-- ã‚²ãƒ¼ãƒ æœ¬ä½“ -->
    <div id="game-container" class="w-full dq-window">
      <!-- ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ -->
      <div id="start-screen" class="text-center">
        <h1 class="text-3xl sm:text-4xl font-bold mb-4">ã‚¯ã‚¤ã‚ºã®æ´çªŸ</h1>
        <p class="text-lg mb-6">å¥¥ã«ãƒœã‚¹ãŒã„ã‚‹ã‚ˆã†ã ...ï¼</p>

        <div class="flex flex-col items-center gap-3 mb-4">
          <input id="playerName" type="text" maxlength="30" class="text-black px-3 py-2 w-64"
                 placeholder="åå‰ã‚’å…¥åŠ›ï¼ˆé‡è¤‡ä¸å¯ï¼‰"/>
          <div id="start-button" class="dq-button inline-block">â–¶ å†’é™ºã‚’å§‹ã‚ã‚‹</div>
          <div id="msg" class="text-yellow-300 text-sm h-5"></div>
        </div>
      </div>

      <!-- ã‚¯ã‚¤ã‚ºç”»é¢ -->
      <div id="quiz-screen" class="hidden">
        <div id="status-container" class="grid grid-cols-2 gap-4 mb-4">
          <div>
            <p>ã‚†ã†ã—ã‚ƒ HP</p>
            <div class="hp-bar-container"><div id="player-hp-bar" class="hp-bar"></div></div>
          </div>
          <div>
            <p>ãƒœã‚¹ HP</p>
            <div class="hp-bar-container"><div id="boss-hp-bar" class="hp-bar"></div></div>
          </div>
        </div>

        <div id="question-container" class="mb-4 min-h-[80px] p-4 border-2 border-white">
          <p id="question-text" class="text-xl"></p>
        </div>

        <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      </div>

      <!-- çµæœç”»é¢ -->
      <div id="result-screen" class="hidden text-center">
        <h2 id="result-title" class="text-3xl sm:text-4xl font-bold mb-4"></h2>
        <p id="result-message" class="text-xl mb-8"></p>
        <div id="restart-button" class="dq-button inline-block">â–¶ ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ã™ã‚‹</div>
      </div>
    </div>
  </div>

  <script>
    // === GASé€£æºè¨­å®š ===
    const GAS_URL = "https://script.google.com/macros/s/AKfycby8RB_-Io-bwuMaCL6f0shgO9Spbn2-0_g7TnbS44jbACiD9aZ_jij13SHl4oYCksK-DA/exec"; // ä¾‹: https://script.google.com/macros/s/XXXX/exec
    const QUIZ_ID = "quiz-001"; // ã‚¯ã‚¤ã‚ºã‚’åˆ†ã‘ãŸã„æ™‚ã¯ã“ã“ã‚’å¤‰ãˆã¦ã­

    const msgEl = () => document.getElementById('msg');
    const showMsg = (t)=>{ if(msgEl()) msgEl().textContent=t; };
    function alreadyTakenLocal(name){ return localStorage.getItem(`quiz_taken_${QUIZ_ID}_${name}`)==="1"; }
    function markTakenLocal(name){ localStorage.setItem(`quiz_taken_${QUIZ_ID}_${name}`,"1"); }

    // --- DOM ---
    const startScreen = document.getElementById('start-screen');
    const quizScreen = document.getElementById('quiz-screen');
    const resultScreen = document.getElementById('result-screen');
    const bossArea = document.getElementById('boss-area');
    const bossContainer = document.getElementById('boss-container');

    const startButton = document.getElementById('start-button');
    const restartButton = document.getElementById('restart-button');

    const playerHpBar = document.getElementById('player-hp-bar');
    const bossHpBar = document.getElementById('boss-hp-bar');

    const questionText = document.getElementById('question-text');
    const optionsContainer = document.getElementById('options-container');

    const resultTitle = document.getElementById('result-title');
    const resultMessage = document.getElementById('result-message');

    // --- ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ ---
    const quizData = [
      { question: "HTMLã§ãƒã‚¤ãƒ‘ãƒ¼ãƒªãƒ³ã‚¯ã‚’ä½œæˆã™ã‚‹ã‚¿ã‚°ã¯ã©ã‚Œï¼Ÿ", options: ["<link>", "<a>", "<p>", "<h>"], answer: "<a>" },
      { question: "CSSã¯ä½•ã®ç•¥ï¼Ÿ", options: ["Creative Style Sheets", "Computer Style Sheets", "Cascading Style Sheets", "Colorful Style Sheets"], answer: "Cascading Style Sheets" },
      { question: "JavaScriptã§å¤‰æ•°ã‚’å®£è¨€ã™ã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§ãªã„ã‚‚ã®ã¯ï¼Ÿ", options: ["var", "let", "const", "def"], answer: "def" },
      { question: "ä¸–ç•Œã§æœ€ã‚‚é«˜ã„å±±ã¯ï¼Ÿ", options: ["K2", "å¯Œå£«å±±", "ã‚¨ãƒ™ãƒ¬ã‚¹ãƒˆ", "ã‚«ãƒ³ãƒã‚§ãƒ³ã‚¸ãƒ¥ãƒ³ã‚¬"], answer: "ã‚¨ãƒ™ãƒ¬ã‚¹ãƒˆ" },
      { question: "æ—¥æœ¬ã®ç¾åœ¨ã®é¦–éƒ½ã¯ï¼Ÿ", options: ["äº¬éƒ½", "å¤§é˜ª", "å¥ˆè‰¯", "æ±äº¬"], answer: "æ±äº¬" },
      { question: "å¤ªé™½ç³»ã§æœ€ã‚‚å¤§ãã„æƒ‘æ˜Ÿã¯ï¼Ÿ", options: ["åœ°çƒ", "æœ¨æ˜Ÿ", "åœŸæ˜Ÿ", "ç«æ˜Ÿ"], answer: "æœ¨æ˜Ÿ"},
      { question: "åŒ–å­¦è¨˜å·ã€ŒFeã€ãŒç¤ºã™å…ƒç´ ã¯ï¼Ÿ", options: ["é‡‘", "éŠ€", "é‰„", "éŠ…"], answer: "é‰„"}
    ];
    let shuffledQuizData = [];
    let currentQuestionIndex = 0;

    // --- ã‚²ãƒ¼ãƒ çŠ¶æ…‹ ---
    const PLAYER_MAX_HP = 100;
    const BOSS_MAX_HP = 200;
    let playerHP = PLAYER_MAX_HP;
    let bossHP = BOSS_MAX_HP;
    let audioStarted = false;
    let correctCount = 0;

    // --- ã‚µã‚¦ãƒ³ãƒ‰ ---
    let hitSound, damageSound, victorySound, defeatSound, clickSound;
    function setupAudio(){
      if(audioStarted) return;
      Tone.start();
      hitSound = ()=> new Tone.Synth({oscillator:{type:"triangle"},envelope:{attack:0.005,decay:0.1,sustain:0.0,release:0.1}}).toDestination().triggerAttackRelease("G5","16n");
      damageSound = ()=> new Tone.NoiseSynth({noise:{type:"brown"},envelope:{attack:0.005,decay:0.1,sustain:0,release:0.1}}).toDestination().triggerAttackRelease("8n");
      victorySound = ()=>{
        const s=new Tone.Synth().toDestination(); const n=Tone.now();
        s.triggerAttackRelease("C5","8n",n); s.triggerAttackRelease("E5","8n",n+0.2);
        s.triggerAttackRelease("G5","8n",n+0.4); s.triggerAttackRelease("C6","4n",n+0.6);
      };
      defeatSound = ()=>{
        const s=new Tone.Synth().toDestination(); const n=Tone.now();
        s.triggerAttackRelease("C4","4n",n); s.triggerAttackRelease("B3","4n",n+0.3);
        s.triggerAttackRelease("A#3","4n",n+0.6); s.triggerAttackRelease("A3","2n",n+0.9);
      };
      clickSound = ()=> new Tone.MembraneSynth({pitchDecay:0.008,octaves:2,envelope:{attack:0.0006,decay:0.2,sustain:0}}).toDestination().triggerAttackRelease("C2","8n");
      audioStarted = true;
    }

    // --- ã‚¤ãƒ™ãƒ³ãƒˆ ---
    startButton.addEventListener('click', startGame);
    restartButton.addEventListener('click', startGame);

    // --- ãƒ­ã‚¸ãƒƒã‚¯ ---
    function shuffleArray(arr){
      for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }
    }

    async function startGame(){
      setupAudio();
      clickSound();

      const name = (document.getElementById('playerName')?.value || "").trim();
      if(!name){ showMsg("åå‰ã„ã‚Œã¦ãªã€œ"); return; }

      if(alreadyTakenLocal(name)){ showMsg("ã“ã®ç«¯æœ«ã§ã¯ãã®åå‰ã¯ã‚‚ã†å—é¨“æ¸ˆã¿ã‚„ã§ğŸ™…"); return; }

      // é‡è¤‡ãƒã‚§ãƒƒã‚¯
      try{
        const r = await fetch(`${GAS_URL}?action=check&quizId=${encodeURIComponent(QUIZ_ID)}&name=${encodeURIComponent(name)}`);
        const j = await r.json();
        if(!j.ok){ showMsg("ãã®åå‰ã¯ã‚‚ã†ä½¿ã‚ã‚Œã¦ã‚‹ã§ï¼åˆ¥åã§ãŠé¡˜ã„ğŸ™"); return; }
      }catch{ showMsg("ã‚µãƒ¼ãƒç¢ºèªãƒŸã‚¹â€¦å°‘ã—å¾…ã£ã¦ğŸ™"); return; }

      // ç™»éŒ²
      try{
        const r2 = await fetch(`${GAS_URL}?action=register`,{
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ quizId: QUIZ_ID, name })
        });
        if(r2.status===409){ showMsg("åŒã˜åå‰ã¯1å›ã ã‘ã‚„ã§ğŸ™…"); return; }
        if(!r2.ok) throw new Error("register failed");
        markTakenLocal(name);
      }catch{ showMsg("ç™»éŒ²ã«å¤±æ•—â€¦ã‚‚ã†ä¸€å›ğŸ™"); return; }

      // ã„ã¤ã‚‚ã®åˆæœŸåŒ–
      correctCount = 0;
      playerHP = PLAYER_MAX_HP;
      bossHP = BOSS_MAX_HP;
      currentQuestionIndex = 0;
      shuffledQuizData = [...quizData];
      shuffleArray(shuffledQuizData);

      updateHpBars();

      startScreen.classList.add('hidden');
      resultScreen.classList.add('hidden');
      quizScreen.classList.remove('hidden');
      bossArea.classList.remove('hidden');

      showMsg("");
      displayQuestion();
    }

    function displayQuestion(){
      if(playerHP<=0 || bossHP<=0) return;

      optionsContainer.innerHTML = '';
      if(currentQuestionIndex >= shuffledQuizData.length){ currentQuestionIndex = 0; }
      const current = shuffledQuizData[currentQuestionIndex];
      questionText.textContent = current.question;

      current.options.forEach(opt=>{
        const div = document.createElement('div');
        div.textContent = `â–¶ ${opt}`;
        div.classList.add('dq-button');
        div.dataset.answer = opt;
        div.addEventListener('click', handleAnswer);
        optionsContainer.appendChild(div);
      });
      currentQuestionIndex++;
    }

    function handleAnswer(e){
      const selected = e.target.dataset.answer;
      const correct = shuffledQuizData[currentQuestionIndex-1].answer;

      optionsContainer.querySelectorAll('.dq-button').forEach(b=>b.style.pointerEvents='none');

      if(selected === correct){
        correctCount++; // â˜…æ­£è§£ã‚«ã‚¦ãƒ³ãƒˆ
        hitSound();
        const damage = Math.floor(Math.random()*21)+30; // 30-50
        bossHP = Math.max(0, bossHP - damage);
        showDamage(bossArea, damage);
        bossContainer.classList.add('damage-flash');
      }else{
        damageSound();
        const damage = Math.floor(Math.random()*11)+15; // 15-25
        playerHP = Math.max(0, playerHP - damage);
        showDamage(document.body, damage);
        document.querySelector('.dq-window').classList.add('damage-flash');
      }

      updateHpBars();

      setTimeout(()=>{
        bossContainer.classList.remove('damage-flash');
        document.querySelector('.dq-window').classList.remove('damage-flash');

        if(playerHP<=0){ showEndScreen(false); }
        else if(bossHP<=0){ showEndScreen(true); }
        else{ displayQuestion(); }
      }, 1000);
    }

    function updateHpBars(){
      const p = (playerHP/PLAYER_MAX_HP)*100;
      playerHpBar.style.width = `${p}%`;
      playerHpBar.classList.toggle('low', p<30);

      const b = (bossHP/BOSS_MAX_HP)*100;
      bossHpBar.style.width = `${b}%`;
      bossHpBar.classList.toggle('low', b<30);
    }

    function showDamage(el, dmg){
      const d = document.createElement('div');
      d.textContent = dmg;
      d.className = 'damage-text';
      el.appendChild(d);
      setTimeout(()=>d.remove(), 1000);
    }

    function showEndScreen(isVictory){
      quizScreen.classList.add('hidden');
      bossArea.classList.add('hidden');
      resultScreen.classList.remove('hidden');

      if(isVictory){
        victorySound();
        resultTitle.textContent = 'å‹åˆ©ï¼';
        resultMessage.textContent = 'ãƒœã‚¹ã‚’å€’ã—ãŸï¼æ´çªŸã«å¹³å’ŒãŒæˆ»ã£ãŸã€‚';
      }else{
        defeatSound();
        resultTitle.textContent = 'æ•—åŒ—...';
        resultMessage.textContent = 'ã‚†ã†ã—ã‚ƒã¯åŠ›å°½ããŸ...ã€‚';
      }

      // â˜…ã‚¹ã‚³ã‚¢é€ä¿¡
      const name = (document.getElementById('playerName')?.value || "").trim();
      if(name){
        fetch(`${GAS_URL}?action=finish`,{
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ quizId: QUIZ_ID, name, score: correctCount })
        }).catch(()=>{});
      }
    }
  </script>
</body>
</html>
