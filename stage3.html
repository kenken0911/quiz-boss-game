<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sustainable Quest üó°Ô∏è - Stage 3</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=Press+Start+2P&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
  <style>
    body[lang="ja"], body[lang="zh"] { font-family: 'DotGothic16', sans-serif; }
    body[lang="en"] { font-family: 'Press Start 2P', cursive; }
    body { background-color: #000; color: #fff; image-rendering: pixelated; overflow-x: hidden; overflow-y: auto; }
    .dq-window { border: 4px solid #fff; background: rgba(0, 0, 80, 0.85); padding: 1.5rem; box-shadow: 0 0 0 4px #000, 0 0 20px rgba(0, 128, 255, 0.6); backdrop-filter: blur(3px); }
    .dq-button { cursor: pointer; padding: .75rem 1.5rem; border: 2px solid #fff; background-image: linear-gradient(to bottom, #0055dd, #0033aa); text-shadow: 1px 1px 2px #000; transition: all 0.2s; }
    .dq-button:hover { background-image: linear-gradient(to bottom, #4488ff, #0055dd); box-shadow: 0 0 10px #fff; }
    .video-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
    .bg-video { width: 100%; height: 100%; object-fit: cover; }
    #title-screen h1 { font-size: 2.5rem; font-weight: bold; text-shadow: 0 0 5px #fff, 0 0 15px #fff, 0 0 25px #00aaff; animation: fadeInTitle 2s ease-out forwards; }
    #title-start-button { animation: pulseButton 2.5s infinite ease-in-out; }
    @keyframes fadeInTitle { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
    @keyframes pulseButton { 0%, 100% { transform: scale(1); box-shadow: 0 0 10px rgba(255,255,255,0.7); } 50% { transform: scale(1.05); box-shadow: 0 0 20px rgba(255,255,255,1); } }
    .boss-hp-container { border: 2px solid #fff; height: 30px; padding: 3px; background: #333; border-radius: 5px; box-shadow: inset 0 0 5px #000; }
    .boss-hp-bar { height: 100%; transition: width .5s ease-out, background-image .5s ease-out; border-radius: 2px; }
    .boss-hp-bar.full { background-image: linear-gradient(to right, #33ff33, #88ff88); }
    .boss-hp-bar.mid { background-image: linear-gradient(to right, #ffff33, #ffff88); }
    .boss-hp-bar.low { background-image: linear-gradient(to right, #ff3333, #ff8833); }
    .boss-idle { animation: boss-float 2.5s infinite ease-in-out; }
    @keyframes boss-float{ 0%,100% { transform: translateY(0); } 50% { transform: translateY(-12px); } }
    .boss-defeat { animation: boss-defeat-anim 1.5s forwards; }
    @keyframes boss-defeat-anim { 0% { opacity: 1; transform: rotate(0deg); } 50% { opacity: 1; transform: rotate(10deg); } 100% { opacity: 0; transform: translateY(100px) rotate(-20deg) scale(0.5); } }
    .shake { animation: shake .35s; }
    @keyframes shake { 10%,90% { transform: translate(-2px, -2px); } 20%,80% { transform: translate(3px, 2px); } 30%,50%,70% { transform: translate(-3px, 3px); } 40%,60% { transform: translate(3px, -2px); } }
    .ice-glow { filter: drop-shadow(0 0 8px #00e5ff) drop-shadow(0 0 16px #00aeff) contrast(1.5); }
    #boss-img { width: 100%; max-width: 320px; height: auto; }
    .correct-answer { background-image: linear-gradient(to bottom, #ffdd00, #ffaa00) !important; color: #000; }
    .incorrect-answer { background-image: linear-gradient(to bottom, #888888, #555555) !important; opacity: 0.7; }
  </style>
</head>
<body class="flex items-start sm:items-center justify-center min-h-screen p-4">

  <div id="opening-video-container" class="video-container">
    <video id="opening-video" class="bg-video" src="./opening_movie.mp4" autoplay loop playsinline onerror="handleMediaError(this)"></video>
  </div>
  <div id="game-video-container" class="video-container hidden">
    <video id="game-bg-video" class="bg-video" src="./GameBackground3.mp4" autoplay muted loop playsinline onerror="handleMediaError(this)"></video>
  </div>

  <div class="w-full max-w-3xl mx-auto">
    <div id="boss-area" class="mb-4 h-64 flex justify-center items-end relative hidden">
      <div id="boss-container"><img id="boss-img" src="./Stage3_dragon.png" alt="„Éú„Çπ„ÅÆÁîªÂÉè" class="ice-glow" onerror="handleMediaError(this)"/></div>
    </div>
    <div id="game-container" class="w-full dq-window relative">
      <div id="title-screen" class="text-center py-8">
        <h1 class="mb-10">Sustainable Quest</h1>
        <button id="title-start-button" class="dq-button">START</button>
      </div>

      <div id="language-screen" class="text-center hidden">
        <h1 class="text-3xl font-bold mb-6">Select Language</h1>
        <div class="flex justify-center gap-2 flex-wrap">
          <button id="lang-ja" class="dq-button">Êó•Êú¨Ë™û</button>
          <button id="lang-en" class="dq-button">English</button>
          <button id="lang-zh" class="dq-button">‰∏≠Êñá</button>
        </div>
      </div>

      <div id="instruction-screen" class="text-center hidden">
        <h1 id="instruction-title" class="text-3xl font-bold mb-4"></h1>
        <div id="instruction-text" class="text-left mb-6 space-y-2"></div>
        <button id="instruction-ok-button" class="dq-button"></button>
      </div>
      
      <div id="start-screen" class="text-center hidden">
        <h1 id="title-text" class="text-2xl font-bold mb-4"></h1>
        <div class="flex flex-col items-center gap-4 mb-4">
          <input id="employeeIdInput" type="text" pattern="\d{5}" title="Á§æÂì°Áï™Âè∑„ÅØÂçäËßíÊï∞Â≠ó5Ê°Å„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ" class="text-black px-3 py-2 w-full md:w-80 text-center rounded" />
        </div>
        <button id="start-button" class="dq-button inline-flex items-center gap-2"><span id="start-button-text"></span></button>
        <div id="msg" class="text-yellow-300 text-sm h-5 mt-2"></div>
      </div>

      <div id="quiz-screen" class="hidden">
        <div class="flex justify-between items-center mb-2 text-lg">
          <span id="theme-display"></span>
          <span id="progress-display"></span>
          <span id="timer-display">0.0s</span>
        </div>
        <div class="mb-4"><p id="boss-hp-label"></p><div class="boss-hp-container"><div id="boss-hp-bar"></div></div></div>
        <div class="mb-4 min-h-[80px] p-4 border-2 border-white"><p id="question-text" class="text-xl"></p></div>
        <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      </div>
      <div id="result-screen" class="hidden text-center">
        <h2 id="result-title" class="text-3xl font-bold mb-4"></h2>
        <p id="result-message" class="text-xl mb-6"></p>
        <p id="submission-status" class="text-yellow-300 mb-8"></p>
        <div id="restart-button" class="dq-button inline-block"></div>
      </div>
      <div id="explanation-modal" class="absolute inset-0 bg-black bg-opacity-80 flex-col items-center justify-center p-4 hidden">
        <div class="dq-window w-full max-w-2xl text-center">
          <h2 id="explanation-title" class="text-4xl font-bold mb-4"></h2>
          <p id="explanation-text" class="text-lg mb-6 text-left h-48 overflow-y-auto p-2 border"></p>
          <button id="next-question-button" class="dq-button"></button>
        </div>
      </div>
    </div>
  </div>
  <audio id="bgm" src="./BS3_BGM.wav" loop onerror="handleMediaError(this)"></audio>
  <audio id="correct-sound" src="./correct_answer.mp3" onerror="handleMediaError(this)"></audio>
  <script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbzKjQfG-cW1tacggfb1JrGa8oT2iAqtgmdmeUb_wCdmMb3h78CXLgIiPVXsLXoMFdpHtQ/exec';
    const STAGE_NUMBER = '3';
    const TEXTS = {
      ja: {
        instructionTitle: "ÂÜíÈô∫„ÅÆÂøÉÂæó",
        instructions: ["„Éª„Çµ„Çπ„ÉÜ„Éä„Éì„É™„ÉÜ„Ç£„Å´Èñ¢„Åô„Çã5„Å§„ÅÆÂïèÈ°å„ÅåÂá∫È°å„Åï„Çå„Çã„Åû„ÄÇ", "„Éª4Âïè‰ª•‰∏äÊ≠£Ëß£„Åß„Éú„Çπ„ÇíË®é‰ºê„Åß„Åç„ÇãÔºÅ", "„ÉªÊúÄÂàù„ÅÆÊåëÊà¶ÁµêÊûú„ÅÆ„Åø„Åå„É©„É≥„Ç≠„É≥„Ç∞„Å´Ë®òÈå≤„Åï„Çå„Çã„Åû„ÄÇ", "„ÉªÂÅ•Èóò„ÇíÁ•à„ÇãÔºÅ"],
        instructionOk: "„Çè„Åã„Å£„Åü",
        title: "„Çπ„ÉÜ„Éº„Ç∏3Ôºö‰∏ñÁïå„ÅÆË™≤È°å",
        employeeIdPlaceholder: "Á§æÂì°Áï™Âè∑(ÂçäËßí5Ê°Å)„ÇíÂÖ•Âäõ",
        startButton: "ÊåëÊà¶„Åô„Çã",
        msgEnterId: "Á§æÂì°Áï™Âè∑„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ",
        msgCheckingId: "ÊåëÊà¶Ë≥áÊ†º„ÇíÁ¢∫Ë™ç‰∏≠...",
        msgIdNotFound: "„Çπ„ÉÜ„Éº„Ç∏1„Åã„ÇâÊåëÊà¶„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ",
        msgCheckError: "Á¢∫Ë™ç„Ç®„É©„Éº„ÄÇÊôÇÈñì„Çí„Åä„ÅÑ„Å¶ÂÜçË©¶Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
        theme: "„ÉÜ„Éº„ÉûÔºö‰∏ñÁïå„ÅÆË™≤È°å",
        progress: (q, t) => `${q}/${t}ÂïèÁõÆ`,
        bossHp: "„Éú„Çπ HP",
        resultWinTitle: "ÂãùÂà©ÔºÅ",
        resultWinMsg: "„Çπ„ÉÜ„Éº„Ç∏„ÇØ„É™„Ç¢ÔºÅ‰∏ñÁïå„Å∏„ÅÆË¶ñÈáé„ÅåÂ∫É„Åå„Å£„ÅüÔºÅ",
        resultLoseTitle: "„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº",
        resultLoseMsg: "Á´ú„ÅÆÁµ∂Êúõ„ÅØÊ∑±„Åã„Å£„Åü‚Ä¶",
        submitting: "ÁµêÊûú„ÇíÈÄÅ‰ø°‰∏≠...",
        submitSuccess: "ÁµêÊûú„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„ÅüÔºÅ",
        submitError: "„Ç®„É©„ÉºÔºöÁµêÊûú„ÇíÈÄÅ‰ø°„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ",
        restartButton: "„Çø„Ç§„Éà„É´„Å∏Êàª„Çã",
        correct: "Ê≠£Ëß£ÔºÅ",
        incorrect: "‰∏çÊ≠£Ëß£...",
        nextButton: "Ê¨°„Å∏",
        quiz: [
          { q: "‰∏ñÁïå„Åß„ÅØÊØéÊó•„ÄÅÂÆ∂Â∫≠„ÅÆË≤ßÂõ∞„ÇíÁêÜÁî±„Å´„Å©„Çå„Åè„Çâ„ÅÑ„ÅÆÂ≠ê‰æõ„ÅåÂëΩ„ÇíËêΩ„Å®„Åó„Å¶„ÅÑ„ÇãÔºü", o: ["Á¥Ñ10,000‰∫∫", "Á¥Ñ50,000‰∫∫", "Á¥Ñ150‰∫∫", "Á¥Ñ9‰∫∫"], a: "Á¥Ñ10,000‰∫∫", ex: "‰∏ñÁïå„Åß„ÅØÊØéÊó•„ÄÅË≤ßÂõ∞„ÅåÂéüÂõ†„ÅßÁ¥Ñ10,000‰∫∫„ÇÇ„ÅÆ5Ê≠≥Êú™Ê∫Ä„ÅÆ„Åì„Å©„ÇÇ„ÅåÂëΩ„ÇíËêΩ„Å®„Åó„Å¶„ÅÑ„Çã„Å®„ÅÑ„Çè„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ" },
          { q: "‰∏ñÁïå‰∏≠„ÅÆ„Åì„Å©„ÇÇ„Åü„Å°„ÅÆÊ®©Âà©„Å®ÂÅ•„ÇÑ„Åã„Å™ÊàêÈï∑„ÇíÂÆà„ÇãÂõΩÈÄ£Ê©üÈñ¢„ÅØÔºü", o: ["IMF", "„É¶„Éã„Çª„Éï", "WHO", "UNESCO"], a: "„É¶„Éã„Çª„Éï", ex: "‰∏ñÁïå‰∏≠„ÅÆ„Åì„Å©„ÇÇ„Åü„Å°„ÅÆÊ®©Âà©„Å®ÂÅ•„ÇÑ„Åã„Å™ÊàêÈï∑„ÇíÂÆà„Çã„Åü„ÇÅ„Å´Ê¥ªË∫ç„Åó„Å¶„ÅÑ„ÇãÂõΩÈÄ£Ê©üÈñ¢„ÅØ„É¶„Éã„Çª„ÉïÔºàÂõΩÈöõÈÄ£ÂêàÂÖêÁ´•Âü∫ÈáëÔºâ„Åß„Åô„ÄÇ" },
          { q: "„É¶„Éã„Çª„Éï„ÅåÁèæÂú∞„Å´Â±ä„Åë„ÇãÂÖ∑‰ΩìÁöÑ„Å™ÊîØÊè¥Áâ©Ë≥á„ÇíÈÅ∏„Çì„ÅßÂØÑ‰ªò„Åß„Åç„Çã‰ªïÁµÑ„Åø„ÅØÔºü", o: ["„É¶„Éã„Çª„ÉïÊîØÊè¥„ÇÆ„Éï„Éà", "„É¶„Éã„Çª„Éï„Éª„ÇØ„É™„Çπ„Éû„Çπ„Ç´„Éº„Éâ", "„É¶„Éã„Çª„Éï„Éª„ÉÅ„É£„É™„ÉÜ„Ç£", "„É¶„Éã„Çª„Éï„Éª„Éû„É≥„Çπ„É™„Éº„Çµ„Éù„Éº„Éà"], a: "„É¶„Éã„Çª„ÉïÊîØÊè¥„ÇÆ„Éï„Éà", ex: "ÂØÑ‰ªòËÄÖ„Åå„Äå„ÉØ„ÇØ„ÉÅ„É≥„Äç„ÇÑ„ÄåÊ†ÑÈ§äÊ≤ªÁôÇÈ£ü„Äç„Å®„ÅÑ„Å£„ÅüÂÖ∑‰ΩìÁöÑ„Å™Áâ©Ë≥á„ÇíÈÅ∏„Çì„ÅßÂØÑ‰ªò„Åô„Çã„Åì„Å®„Åß„ÄÅËá™ÂàÜ„ÅÆÊîØÊè¥„Åå„Å©„ÅÆ„Çà„ÅÜ„Å´ÂΩπÁ´ã„Å§„Åã„Çí„Çà„ÇäÂÆüÊÑü„Åß„Åç„Çã‰ªïÁµÑ„Åø„Åß„Åô„ÄÇ" },
          { q: "„Éï„Çß„Ç¢„Éà„É¨„Éº„Éâ„ÅÆÁêÜÂøµ„Å´ÊúÄ„ÇÇËøë„ÅÑË°åÂãï„ÅØÔºü", o: ["‰∏ÄÁï™ÂÆâ„ÅÑÂïÜÂìÅ„ÇíÈÅ∏„Å∂", "Â§ßÈáè„Å´‰ªïÂÖ•„Çå„Å¶ÂÆâ„ÅèÂ£≤„Çã", "Âèã‰∫∫„Åã„ÇâÂÆâ„ÅèË≠≤„Å£„Å¶„ÇÇ„Çâ„ÅÜ", "Âú∞Âüü„ÅÆËæ≤ÂÆ∂„Åã„ÇâÁõ¥Êé•ÈáéËèú„ÇíË≤∑„ÅÜ"], a: "Âú∞Âüü„ÅÆËæ≤ÂÆ∂„Åã„ÇâÁõ¥Êé•ÈáéËèú„ÇíË≤∑„ÅÜ", ex: "Âú∞Âüü„ÅÆÁîüÁî£ËÄÖ„Åã„ÇâÁõ¥Êé•„ÄÅÈÅ©Ê≠£„Å™‰æ°Ê†º„ÅßÂïÜÂìÅ„ÇíË≥ºÂÖ•„Åô„Çã„Åì„Å®„ÅØ„ÄÅ„Éï„Çß„Ç¢„Éà„É¨„Éº„Éâ„ÅÆÁêÜÂøµ„Åß„ÅÇ„Çã„ÄéÁîüÁî£ËÄÖ„Å∏„ÅÆÂÖ¨Ê≠£„Å™Âà©Áõä„ÅÆÈÇÑÂÖÉ„Äè„Å´ÈÄö„Åò„ÇãË°åÂãï„Åß„Åô„ÄÇ" },
          { q: "„Éï„Ç£„É™„Éî„É≥„ÅÆÂõΩÊ∞ëÁöÑ„Å™„Äå„Éê„Éä„Éä„Ç±„ÉÅ„É£„ÉÉ„Éó„Äç„ÄÇ„Éà„Éû„Éà„ÅÆ‰ª£Áî®ÂìÅ„Å®„Åó„Å¶‰Ωø„Çè„Çå„ÅüÊûúÁâ©„ÅØÔºü", o: ["„Éû„É≥„Ç¥„Éº", "„Éë„Ç§„Éä„ÉÉ„Éó„É´", "„Éê„Éä„Éä", "„Éë„Éë„Ç§„É§"], a: "„Éê„Éä„Éä", ex: "Á¨¨‰∫åÊ¨°‰∏ñÁïåÂ§ßÊà¶‰∏≠„ÅÆ„Éà„Éû„Éà‰∏çË∂≥„Çí„Åç„Å£„Åã„Åë„Å´„ÄÅÂΩìÊôÇË±äÂØå„Å´„ÅÇ„Å£„Åü„Éê„Éä„Éä„Çí‰ª£Áî®ÂìÅ„Å®„Åó„Å¶ÈñãÁô∫„Åï„Çå„Åü„ÅÆ„Åå„Äå„Éê„Éä„Éä„Ç±„ÉÅ„É£„ÉÉ„Éó„Äç„Åß„Åô„ÄÇ" }
        ]
      },
      en: {
        instructionTitle: "Rules of the Quest",
        instructions: ["- You will be asked 5 questions about sustainability.", "- Answer 4 or more correctly to defeat the boss!", "- Only your first attempt will be recorded for the ranking.", "- Good luck!"],
        instructionOk: "Got it",
        title: "Stage 3: Global Issues",
        employeeIdPlaceholder: "Enter 5-digit Employee ID",
        startButton: "Challenge",
        msgEnterId: "Please enter your Employee ID",
        msgCheckingId: "Checking eligibility...",
        msgIdNotFound: "Please complete Stage 1 first!",
        msgCheckError: "Verification error. Please try again later.",
        theme: "Theme: Global Issues",
        progress: (q, t) => `Q ${q}/${t}`,
        bossHp: "Boss HP",
        resultWinTitle: "Victory!",
        resultWinMsg: "Stage Clear! Your perspective on the world has broadened!",
        resultLoseTitle: "Game Over",
        resultLoseMsg: "The dragon's despair was deep...",
        submitting: "Submitting results...",
        submitSuccess: "Results submitted!",
        submitError: "Error: Could not submit results.",
        restartButton: "Back to Title",
        correct: "Correct!",
        incorrect: "Incorrect...",
        nextButton: "Next",
        quiz: [
          { q: "How many children die every day due to family poverty worldwide?", o: ["About 10,000", "About 50,000", "About 150", "About 9"], a: "About 10,000", ex: "It is said that about 10,000 children under the age of five die every day worldwide due to poverty." },
          { q: "Which UN agency protects the rights and healthy growth of children worldwide?", o: ["IMF", "UNICEF", "WHO", "UNESCO"], a: "UNICEF", ex: "UNICEF (United Nations Children's Fund) is the UN agency that works to protect the rights and healthy development of children worldwide." },
          { q: "What is the system that allows you to select and donate specific aid items for UNICEF to deliver?", o: ["UNICEF Inspired Gifts", "UNICEF Christmas Cards", "UNICEF Charity", "UNICEF Monthly Support"], a: "UNICEF Inspired Gifts", ex: "This is a system where donors can choose specific items such as vaccines or therapeutic food to donate, allowing them to better realize how their support helps children." },
          { q: "Which action is closest to the philosophy of Fair Trade?", o: ["Choosing the cheapest product", "Buying in bulk to sell cheaply", "Getting items cheaply from friends", "Buying vegetables directly from local farmers"], a: "Buying vegetables directly from local farmers", ex: "Buying products directly from local producers at a fair price is an action that aligns with the Fair Trade principle of 'fair returns to producers'." },
          { q: "What fruit was used as a substitute for tomatoes in the Philippines' national 'Banana Ketchup'?", o: ["Mango", "Pineapple", "Banana", "Papaya"], a: "Banana", ex: "'Banana Ketchup' was developed during a tomato shortage in World War II, using bananas, which were abundant at the time, as a substitute." }
        ]
      },
      zh: {
        instructionTitle: "ÂÜíÈô©È°ªÁü•",
        instructions: ["„ÉªÂ∞ÜÊèêÂá∫5‰∏™ÂÖ≥‰∫éÂèØÊåÅÁª≠ÊÄßÁöÑÈóÆÈ¢ò„ÄÇ", "„ÉªÊ≠£Á°ÆÂõûÁ≠î4‰∏™‰ª•‰∏äÈóÆÈ¢òÂç≥ÂèØÂáªË¥•Â§¥ÁõÆÔºÅ", "„ÉªÂè™ÊúâÁ¨¨‰∏ÄÊ¨°ÊåëÊàòÁöÑÁªìÊûú‰ºöË¢´ËÆ∞ÂΩïÂú®ÊéíÂêç‰∏≠„ÄÇ", "„ÉªÁ•ù‰Ω†Â•ΩËøêÔºÅ"],
        instructionOk: "Áü•ÈÅì‰∫Ü",
        title: "Á¨¨‰∏âÂÖ≥Ôºö‰∏ñÁïåÊÄßËØæÈ¢ò",
        employeeIdPlaceholder: "ËæìÂÖ•ÂëòÂ∑•ÁºñÂè∑(5‰ΩçÂçäËßíÊï∞Â≠ó)",
        startButton: "ÊåëÊàò",
        msgEnterId: "ËØ∑ËæìÂÖ•ÂëòÂ∑•ÁºñÂè∑",
        msgCheckingId: "Ê≠£Âú®Á°ÆËÆ§ÊåëÊàòËµÑÊ†º...",
        msgIdNotFound: "ËØ∑ÂÖàÊåëÊàòÁ¨¨‰∏ÄÂÖ≥ÔºÅ",
        msgCheckError: "Á°ÆËÆ§Âá∫Èîô„ÄÇËØ∑Á®çÂêéÂÜçËØï„ÄÇ",
        theme: "‰∏ªÈ¢òÔºö‰∏ñÁïåÊÄßËØæÈ¢ò",
        progress: (q, t) => `Á¨¨${q}/${t}È¢ò`,
        bossHp: "Â§¥ÁõÆ HP",
        resultWinTitle: "ËÉúÂà©ÔºÅ",
        resultWinMsg: "ÂÖ≥Âç°ÂÆåÊàêÔºÅÊãìÂÆΩ‰∫ÜÂØπ‰∏ñÁïåÁöÑËßÜÈáéÔºÅ",
        resultLoseTitle: "Ê∏∏ÊàèÁªìÊùü",
        resultLoseMsg: "ÈæôÁöÑÁªùÊúõÂæàÊ∑±‚Ä¶",
        submitting: "Ê≠£Âú®ÂèëÈÄÅÁªìÊûú...",
        submitSuccess: "ÁªìÊûúÂ∑≤ÂèëÈÄÅÔºÅ",
        submitError: "ÈîôËØØÔºöÊó†Ê≥ïÂèëÈÄÅÁªìÊûú„ÄÇ",
        restartButton: "ËøîÂõûÊ†áÈ¢ò",
        correct: "ÂõûÁ≠îÊ≠£Á°ÆÔºÅ",
        incorrect: "ÂõûÁ≠îÈîôËØØ...",
        nextButton: "‰∏ã‰∏Ä‰∏™",
        quiz: [
            { q: "ÂÖ®ÁêÉÊØèÂ§©ÊúâÂ§öÂ∞ëÂÑøÁ´•Âõ†ÂÆ∂Â∫≠Ë¥´Âõ∞ËÄåÊ≠ª‰∫°Ôºü", o: ["Á∫¶10,000‰∫∫", "Á∫¶50,000‰∫∫", "Á∫¶150‰∫∫", "Á∫¶9‰∫∫"], a: "Á∫¶10,000‰∫∫", ex: "ÊçÆËØ¥ÂÖ®ÁêÉÊØèÂ§©ÊúâÂ§ßÁ∫¶10,000Âêç‰∫îÂ≤Å‰ª•‰∏ãÂÑøÁ´•Âõ†Ë¥´Âõ∞ËÄåÊ≠ª‰∫°„ÄÇ" },
            { q: "Âì™‰∏™ËÅîÂêàÂõΩÊú∫ÊûÑË¥üË¥£‰øùÊä§ÂÖ®ÁêÉÂÑøÁ´•ÁöÑÊùÉÂà©ÂíåÂÅ•Â∫∑ÊàêÈïøÔºü", o: ["ÂõΩÈôÖË¥ßÂ∏ÅÂü∫ÈáëÁªÑÁªá", "ËÅîÂêàÂõΩÂÑøÁ´•Âü∫Èáë‰ºö", "‰∏ñÁïåÂç´ÁîüÁªÑÁªá", "ËÅîÂêàÂõΩÊïôÁßëÊñáÁªÑÁªá"], a: "ËÅîÂêàÂõΩÂÑøÁ´•Âü∫Èáë‰ºö", ex: "ËÅîÂêàÂõΩÂÑøÁ´•Âü∫Èáë‰ºöÔºàUNICEFÔºâÊòØËá¥Âäõ‰∫é‰øùÊä§ÂÖ®ÁêÉÂÑøÁ´•ÊùÉÂà©ÂíåÂÅ•Â∫∑ÊàêÈïøÁöÑËÅîÂêàÂõΩÊú∫ÊûÑ„ÄÇ" },
            { q: "ÂÖÅËÆ∏ÊçêËµ†ËÄÖÈÄâÊã©Âπ∂ÊçêËµ†ËÅîÂêàÂõΩÂÑøÁ´•Âü∫Èáë‰ºöÔºàUNICEFÔºâÊèê‰æõÁöÑÂÖ∑‰ΩìÊè¥Âä©Áâ©ËµÑÁöÑÊú∫Âà∂ÊòØ‰ªÄ‰πàÔºü", o: ["ËÅîÂêàÂõΩÂÑøÁ´•Âü∫Èáë‰ºö‚ÄúÁà±ÂøÉÁ§ºÁâ©‚Äù", "ËÅîÂêàÂõΩÂÑøÁ´•Âü∫Èáë‰ºöÂú£ËØûË¥∫Âç°", "ËÅîÂêàÂõΩÂÑøÁ´•Âü∫Èáë‰ºöÊÖàÂñÑÊ¥ªÂä®", "ËÅîÂêàÂõΩÂÑøÁ´•Âü∫Èáë‰ºöÊúàÂ∫¶ÊîØÊåÅ"], a: "ËÅîÂêàÂõΩÂÑøÁ´•Âü∫Èáë‰ºö‚ÄúÁà±ÂøÉÁ§ºÁâ©‚Äù", ex: "ËøôÊòØ‰∏Ä‰∏™ËÆ©ÊçêËµ†ËÄÖÂèØ‰ª•ÈÄâÊã©Â¶ÇÁñ´ËãóÊàñËê•ÂÖªÊ≤ªÁñóÈ£üÂìÅÁ≠âÂÖ∑‰ΩìÁâ©ËµÑËøõË°åÊçêËµ†ÁöÑÊú∫Âà∂Ôºå‰ªéËÄåËÆ©‰ªñ‰ª¨Êõ¥ÁúüÂàáÂú∞ÊÑüÂèóÂà∞Ëá™Â∑±ÁöÑÊîØÊåÅÊòØÂ¶Ç‰ΩïÂ∏ÆÂä©Â≠©Â≠ê‰ª¨ÁöÑ„ÄÇ" },
            { q: "‰ª•‰∏ãÂì™ÁßçË°å‰∏∫ÊúÄÊé•ËøëÂÖ¨Âπ≥Ë¥∏ÊòìÁöÑÁêÜÂøµÔºü", o: ["ÈÄâÊã©ÊúÄ‰æøÂÆúÁöÑÂïÜÂìÅ", "ÊâπÈáèË¥≠‰π∞‰ª•‰Ωé‰ª∑Âá∫ÂîÆ", "‰ªéÊúãÂèãÈÇ£ÈáåÂªâ‰ª∑Ëé∑ÂæóÁâ©ÂìÅ", "Áõ¥Êé•‰ªéÂΩìÂú∞ÂÜúÊ∞ëÈÇ£ÈáåË¥≠‰π∞Ëî¨Ëèú"], a: "Áõ¥Êé•‰ªéÂΩìÂú∞ÂÜúÊ∞ëÈÇ£ÈáåË¥≠‰π∞Ëî¨Ëèú", ex: "‰ª•ÂêàÁêÜÁöÑ‰ª∑Ê†ºÁõ¥Êé•‰ªéÂΩìÂú∞Áîü‰∫ßËÄÖÈÇ£ÈáåË¥≠‰π∞ÂïÜÂìÅÔºåËøô‰∏ÄË°å‰∏∫Á¨¶ÂêàÂÖ¨Âπ≥Ë¥∏Êòì‚ÄúÂêëÁîü‰∫ßËÄÖÊèê‰æõÂÖ¨Âπ≥ÂõûÊä•‚ÄùÁöÑÁêÜÂøµ„ÄÇ" },
            { q: "Âú®Ëè≤ÂæãÂÆæÁöÑÂõΩÊ∞ëÈ£üÂìÅ‚ÄúÈ¶ôËïâÁï™ËåÑÈÖ±‚Äù‰∏≠ÔºåÁî®‰ΩúÁï™ËåÑÊõø‰ª£ÂìÅÁöÑÊ∞¥ÊûúÊòØ‰ªÄ‰πàÔºü", o: ["ËäíÊûú", "Ëè†Ëêù", "È¶ôËïâ", "Êú®Áìú"], a: "È¶ôËïâ", ex: "‚ÄúÈ¶ôËïâÁï™ËåÑÈÖ±‚ÄùÊòØÂú®Á¨¨‰∫åÊ¨°‰∏ñÁïåÂ§ßÊàòÊúüÈó¥Âõ†Áï™ËåÑÁü≠Áº∫ËÄåÂºÄÂèëÁöÑÔºå‰ΩøÁî®‰∫ÜÂΩìÊó∂‰∏∞ÂØåÁöÑÈ¶ôËïâ‰Ωú‰∏∫Êõø‰ª£ÂìÅ„ÄÇ" }
        ]
      }
    };
    
    const titleScreen = document.getElementById('title-screen');
    const languageScreen = document.getElementById('language-screen');
    const instructionScreen = document.getElementById('instruction-screen');
    const startScreen = document.getElementById('start-screen');
    const quizScreen = document.getElementById('quiz-screen');
    const resultScreen = document.getElementById('result-screen');
    const bossContainer = document.getElementById('boss-container');
    const employeeIdInput = document.getElementById('employeeIdInput');
    const bgm = document.getElementById('bgm');
    const correctSound = document.getElementById('correct-sound');
    const startButton = document.getElementById('start-button');
    const explanationModal = document.getElementById('explanation-modal');
    const nextQuestionButton = document.getElementById('next-question-button');
    const openingVideoContainer = document.getElementById('opening-video-container');
    const gameVideoContainer = document.getElementById('game-video-container');

    let currentLang = 'ja';
    let timerInterval, startTime, correctCount, isGameInProgress = false, audioStarted = false;
    let clickSound, hitSound, damageSound, victorySound, defeatSound;

    function switchScreen(screenName) {
      [titleScreen, languageScreen, instructionScreen, startScreen, quizScreen, resultScreen].forEach(s => s.classList.add('hidden'));
      document.getElementById(`${screenName}-screen`).classList.remove('hidden');
    }
    
    function updateUIText() {
      const t = TEXTS[currentLang];
      document.body.lang = currentLang;
      document.getElementById('instruction-title').textContent = t.instructionTitle;
      document.getElementById('instruction-text').innerHTML = t.instructions.map(line => `<p>${line}</p>`).join('');
      document.getElementById('instruction-ok-button').textContent = t.instructionOk;
      document.getElementById('title-text').textContent = t.title;
      employeeIdInput.placeholder = t.employeeIdPlaceholder;
      document.getElementById('start-button-text').textContent = t.startButton;
      document.getElementById('boss-hp-label').textContent = t.bossHp;
      document.getElementById('restart-button').textContent = t.restartButton;
      document.getElementById('theme-display').textContent = t.theme;
    }

    function setupAudio() {
      if (audioStarted) return;
      clickSound = () => new Tone.MembraneSynth({ pitchDecay: 0.01, octaves: 3, envelope: { attack: 0.001, decay: 0.3, sustain: 0 } }).toDestination().triggerAttackRelease("C2", "8n");
      hitSound = () => {
        correctSound.currentTime = 0;
        correctSound.play().catch(e => console.error("Correct sound play failed:", e));
      };
      damageSound = () => new Tone.NoiseSynth({ noise: { type: "pink" }, envelope: { attack: 0.01, decay: 0.3, sustain: 0, release: 0.2 } }).toDestination().triggerAttackRelease("8n");
      victorySound = () => { const s = new Tone.Synth().toDestination(), n = Tone.now(); s.triggerAttackRelease("C5", "8n", n); s.triggerAttackRelease("E5", "8n", n + 0.2); s.triggerAttackRelease("G5", "8n", n + 0.4); s.triggerAttackRelease("C6", "4n", n + 0.6) };
      defeatSound = () => { const s = new Tone.Synth().toDestination(), n = Tone.now(); s.triggerAttackRelease("C4", "4n", n); s.triggerAttackRelease("B3", "4n", n + 0.3); s.triggerAttackRelease("A#3", "4n", n + 0.6); s.triggerAttackRelease("A3", "2n", n + 0.9) };
      audioStarted = true;
    }

    async function startGame() {
      if (!employeeIdInput.checkValidity()) {
        employeeIdInput.reportValidity();
        return;
      }
      const employeeId = employeeIdInput.value.trim();
      const msgEl = document.getElementById('msg');
      if (!employeeId) {
        msgEl.textContent = TEXTS[currentLang].msgEnterId;
        return;
      }
      if (isGameInProgress) return;
      isGameInProgress = true;
      startButton.disabled = true;
      msgEl.textContent = TEXTS[currentLang].msgCheckingId;

      try {
        const checkUrl = `${GAS_URL}?action=checkEmployeeId&employeeId=${encodeURIComponent(employeeId)}`;
        const response = await fetch(checkUrl);
        const result = await response.json();

        if (result.exists) {
          msgEl.textContent = "";
          bgm.play().catch(e => console.error("BGM play failed:", e));
          clickSound();
          correctCount = 0;
          document.getElementById('boss-area').classList.remove('hidden');
          bossContainer.className = 'boss-idle';
          updateHpBars(100);
          switchScreen('quiz');
          startTime = Date.now();
          timerInterval = setInterval(() => {
            const elapsedTime = ((Date.now() - startTime) / 1000).toFixed(1);
            document.getElementById('timer-display').textContent = `${elapsedTime}s`;
          }, 100);
          displayQuestion(0);
        } else {
          msgEl.textContent = TEXTS[currentLang].msgIdNotFound;
        }
      } catch (error) {
        console.error("Error checking employee ID:", error);
        msgEl.textContent = TEXTS[currentLang].msgCheckError;
      } finally {
        isGameInProgress = false;
        startButton.disabled = false;
      }
    }

    function displayQuestion(index) {
      const quizData = TEXTS[currentLang].quiz;
      document.getElementById('progress-display').textContent = TEXTS[currentLang].progress(index + 1, quizData.length);
      const current = quizData[index];
      document.getElementById('question-text').textContent = `Q${index + 1}: ${current.q}`;
      const optionsContainer = document.getElementById('options-container');
      optionsContainer.innerHTML = '';
      current.o.forEach(opt => {
        const div = document.createElement('div');
        div.textContent = `‚ñ∂ ${opt}`;
        div.classList.add('dq-button');
        div.addEventListener('click', () => handleAnswer(opt, current, index));
        optionsContainer.appendChild(div);
      });
    }

    function handleAnswer(selectedAnswer, currentQuiz, index) {
      const isCorrect = selectedAnswer === currentQuiz.a;
      const optionsContainer = document.getElementById('options-container');
      optionsContainer.querySelectorAll('.dq-button').forEach(btn => {
        btn.style.pointerEvents = 'none';
        if (btn.textContent.includes(currentQuiz.a)) {
          btn.classList.add('correct-answer');
        } else {
          btn.classList.add('incorrect-answer');
        }
      });

      if (isCorrect) {
        correctCount++;
        hitSound();
        updateHpBars(100 - (correctCount * (100 / 4)));
        bossContainer.classList.add('shake');
        document.getElementById('explanation-title').textContent = TEXTS[currentLang].correct;
      } else {
        damageSound();
        document.querySelector('.dq-window').classList.add('shake');
        document.getElementById('explanation-title').textContent = TEXTS[currentLang].incorrect;
      }
      
      document.getElementById('explanation-text').textContent = currentQuiz.ex;
      nextQuestionButton.textContent = TEXTS[currentLang].nextButton;
      nextQuestionButton.dataset.nextIndex = index + 1;
      
      setTimeout(() => {
        explanationModal.style.display = 'flex';
      }, 800);
    }
    
    nextQuestionButton.addEventListener('click', () => {
      explanationModal.style.display = 'none';
      bossContainer.classList.remove('shake');
      document.querySelector('.dq-window').classList.remove('shake');
      
      const nextIndex = parseInt(nextQuestionButton.dataset.nextIndex);
      if (nextIndex >= TEXTS[currentLang].quiz.length) {
        showEndScreen();
      } else {
        displayQuestion(nextIndex);
      }
    });

    function showEndScreen() {
      clearInterval(timerInterval);
      bgm.pause();
      bgm.currentTime = 0;
      
      const isVictory = correctCount >= 4;
      if (isVictory) {
        victorySound();
        bossContainer.className = 'boss-defeat';
      } else {
        defeatSound();
      }
      
      setTimeout(() => {
        document.getElementById('boss-area').classList.add('hidden');
        switchScreen('result');
        const t = TEXTS[currentLang];
        document.getElementById('result-title').textContent = isVictory ? t.resultWinTitle : t.resultLoseTitle;
        document.getElementById('result-message').textContent = isVictory ? t.resultWinMsg : t.resultLoseMsg;
        submitResults();
      }, isVictory ? 1500 : 500);
    }

    async function submitResults() {
        const statusEl = document.getElementById('submission-status');
        let ipAddress = 'N/A';
        try {
            const response = await fetch('https://api.ipify.org?format=json');
            ipAddress = (await response.json()).ip;
        } catch (error) {
            console.error('IP„Ç¢„Éâ„É¨„Çπ„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', error);
        }

        const payload = {
            employeeId: employeeIdInput.value.trim(),
            stage: STAGE_NUMBER,
            score: correctCount,
            time: ((Date.now() - startTime) / 1000).toFixed(2),
            ipAddress: ipAddress
        };
        statusEl.textContent = TEXTS[currentLang].submitting;
        fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload), mode: 'no-cors' })
            .then(() => { statusEl.textContent = TEXTS[currentLang].submitSuccess; })
            .catch(err => { statusEl.textContent = TEXTS[currentLang].submitError; console.error('Error:', err); });
    }

    function updateHpBars(percentage) {
      const hpBar = document.getElementById('boss-hp-bar');
      hpBar.style.width = `${Math.max(0, percentage)}%`;
      if (percentage <= 25) hpBar.className = 'boss-hp-bar low';
      else if (percentage <= 50) hpBar.className = 'boss-hp-bar mid';
      else hpBar.className = 'boss-hp-bar full';
    }
    
    function handleMediaError(element) {
        console.error(`Error loading media: ${element.src}`);
        element.style.display = 'none'; 
    }

    document.getElementById('title-start-button').addEventListener('click', async () => {
      if (!audioStarted) { 
        await Tone.start();
        setupAudio();
      }
      clickSound();
      const openingVideo = document.getElementById('opening-video');
      openingVideo.muted = false;
      openingVideo.play().catch(e => console.log("User interaction might be needed for audio"));
      switchScreen('language');
    });

    document.getElementById('lang-ja').addEventListener('click', () => { clickSound(); currentLang = 'ja'; updateUIText(); switchScreen('instruction'); });
    document.getElementById('lang-en').addEventListener('click', () => { clickSound(); currentLang = 'en'; updateUIText(); switchScreen('instruction'); });
    document.getElementById('lang-zh').addEventListener('click', () => { clickSound(); currentLang = 'zh'; updateUIText(); switchScreen('instruction'); });
    
    document.getElementById('instruction-ok-button').addEventListener('click', () => {
      clickSound();
      openingVideoContainer.classList.add('hidden');
      document.getElementById('opening-video').pause();
      gameVideoContainer.classList.remove('hidden');
      document.getElementById('game-bg-video').play().catch(e => console.log("Game video play failed"));
      switchScreen('start');
    });
    
    startButton.addEventListener('click', startGame);
    document.getElementById('restart-button').addEventListener('click', () => location.reload());

    updateUIText();
    switchScreen('title');
    const openingVideo = document.getElementById('opening-video');
    openingVideo.muted = false;
    openingVideo.play().catch(e => {
        console.log("Autoplay with sound was prevented. Muting and retrying.");
        openingVideo.muted = true;
        openingVideo.play();
    });
  </script>
</body>
</html>
