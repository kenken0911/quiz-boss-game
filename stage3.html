<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sustainability Quest 🗡️ - Stage 3</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=Press+Start+2P&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
  <style>
    body[lang="ja"], body[lang="zh"] { font-family: 'DotGothic16', sans-serif; }
    body[lang="en"] { font-family: 'Press Start 2P', cursive; }
    body { background-color: #000; color: #fff; image-rendering: pixelated; overflow-x: hidden; overflow-y: auto; }
    /* ★変更: ウィンドウの色を水色テーマに */
    .dq-window { border: 4px solid #fff; background: rgba(0, 0, 80, 0.85); padding: 1.5rem; box-shadow: 0 0 0 4px #000, 0 0 20px rgba(0, 128, 255, 0.6); backdrop-filter: blur(3px); }
    /* ★変更: ボタンの色を水色テーマに */
    .dq-button { cursor: pointer; padding: .75rem 1.5rem; border: 2px solid #fff; background-image: linear-gradient(to bottom, #0055dd, #0033aa); text-shadow: 1px 1px 2px #000; transition: all 0.2s; }
    .dq-button:hover { background-image: linear-gradient(to bottom, #4488ff, #0055dd); box-shadow: 0 0 10px #fff; }
    .video-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
    .bg-video { width: 100%; height: 100%; object-fit: cover; }
    /* ★変更: タイトルシャドウの色を水色テーマに */
    #title-screen h1 { font-size: 2.5rem; font-weight: bold; text-shadow: 0 0 5px #fff, 0 0 15px #fff, 0 0 25px #00aaff; animation: fadeInTitle 2s ease-out forwards; }
    #title-start-button { animation: pulseButton 2.5s infinite ease-in-out; }
    @keyframes fadeInTitle { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
    @keyframes pulseButton { 0%, 100% { transform: scale(1); box-shadow: 0 0 10px rgba(255,255,255,0.7); } 50% { transform: scale(1.05); box-shadow: 0 0 20px rgba(255,255,255,1); } }
    .boss-hp-container { border: 2px solid #fff; height: 30px; padding: 3px; background: #333; border-radius: 5px; box-shadow: inset 0 0 5px #000; }
    .boss-hp-bar { height: 100%; transition: width .5s ease-out, background-image .5s ease-out; border-radius: 2px; }
    .boss-hp-bar.full { background-image: linear-gradient(to right, #33ff33, #88ff88); }
    .boss-hp-bar.mid { background-image: linear-gradient(to right, #ffff33, #ffff88); }
    .boss-hp-bar.low { background-image: linear-gradient(to right, #ff3333, #ff8833); }
    .boss-idle { animation: boss-float 2.5s infinite ease-in-out; }
    @keyframes boss-float{ 0%,100% { transform: translateY(0); } 50% { transform: translateY(-12px); } }
    .boss-defeat { animation: boss-defeat-anim 1.5s forwards; }
    @keyframes boss-defeat-anim { 0% { opacity: 1; transform: rotate(0deg); } 50% { opacity: 1; transform: rotate(10deg); } 100% { opacity: 0; transform: translateY(100px) rotate(-20deg) scale(0.5); } }
    .shake { animation: shake .35s; }
    @keyframes shake { 10%,90% { transform: translate(-2px, -2px); } 20%,80% { transform: translate(3px, 2px); } 30%,50%,70% { transform: translate(-3px, 3px); } 40%,60% { transform: translate(3px, -2px); } }
    /* ★変更: ボスのオーラを水色テーマに */
    .gov-glow { filter: drop-shadow(0 0 8px #00aaff) drop-shadow(0 0 16px #00ffff) contrast(1.5); }
    #boss-img { width: 100%; max-width: 320px; height: auto; }
    .correct-answer { background-image: linear-gradient(to bottom, #ffdd00, #ffaa00) !important; color: #000; }
    .incorrect-answer { background-image: linear-gradient(to bottom, #888888, #555555) !important; opacity: 0.7; }
  </style>
</head>
<body class="flex items-start sm:items-center justify-center min-h-screen p-4">

  <div id="opening-video-container" class="video-container">
    <video id="opening-video" class="bg-video" src="./opening_movie.mp4" autoplay loop playsinline onerror="handleMediaError(this)"></video>
  </div>
  <div id="game-video-container" class="video-container hidden">
    <video id="game-bg-video" class="bg-video" src="./GameBackground3.mp4" autoplay muted loop playsinline onerror="handleMediaError(this)"></video>
  </div>

  <div class="w-full max-w-3xl mx-auto">
    <div id="boss-area" class="mb-4 h-64 flex justify-center items-end relative hidden">
      <div id="boss-container"><img id="boss-img" src="./Stage3_dragon.png" alt="ボスの画像" class="gov-glow" onerror="handleMediaError(this)"/></div>
    </div>
    <div id="game-container" class="w-full dq-window relative">
      <div id="title-screen" class="text-center py-8">
        <h1 class="mb-10">Sustainability Quest</h1>
        <button id="title-start-button" class="dq-button">START</button>
      </div>

      <div id="language-screen" class="text-center hidden">
        <h1 class="text-3xl font-bold mb-6">Select Language</h1>
        <p class="text-sm mb-6">Translations are provided by AI.</p>
        <div class="flex justify-center gap-2 flex-wrap">
          <button id="lang-ja" class="dq-button">日本語</button>
          <button id="lang-en" class="dq-button">English</button>
          <button id="lang-zh" class="dq-button">中文</button>
        </div>
      </div>

      <div id="instruction-screen" class="text-center hidden">
        <h1 id="instruction-title" class="text-3xl font-bold mb-4"></h1>
        <div id="instruction-text" class="text-left mb-6 space-y-2"></div>
        <button id="instruction-ok-button" class="dq-button"></button>
      </div>
      
      <div id="start-screen" class="text-center hidden">
        <h1 id="title-text" class="text-2xl font-bold mb-4"></h1>
        <div class="flex flex-col items-center gap-4 mb-4">
          <select id="companySelect" class="text-black px-3 py-2 w-full md:w-80 text-center rounded"></select>
          <input id="employeeIdInput" type="text" pattern="\d{5}" title="社員番号は半角数字5桁で入力してください" class="text-black px-3 py-2 w-full md:w-80 text-center rounded" />
        </div>
        <button id="start-button" class="dq-button inline-flex items-center gap-2"><span id="start-button-text"></span></button>
        <div id="msg" class="text-yellow-300 text-sm h-5 mt-2"></div>
      </div>

      <div id="quiz-screen" class="hidden">
        <div class="flex justify-between items-center mb-2 text-lg">
          <span id="theme-display"></span>
          <span id="progress-display"></span>
          <span id="timer-display">0.0s</span>
        </div>
        <div class="mb-4"><p id="boss-hp-label"></p><div class="boss-hp-container"><div id="boss-hp-bar"></div></div></div>
        <div class="mb-4 min-h-[80px] p-4 border-2 border-white"><p id="question-text" class="text-xl"></p></div>
        <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      </div>
      <div id="result-screen" class="hidden text-center">
        <h2 id="result-title" class="text-3xl font-bold mb-4"></h2>
        <p id="result-message" class="text-xl mb-6"></p>
        <p id="submission-status" class="text-yellow-300 mb-8"></p>
        <div id="restart-button" class="dq-button inline-block"></div>
      </div>
      <div id="explanation-modal" class="absolute inset-0 bg-black bg-opacity-80 flex-col items-center justify-center p-4 hidden">
        <div class="dq-window w-full max-w-2xl text-center">
          <h2 id="explanation-title" class="text-4xl font-bold mb-4"></h2>
          <p id="explanation-text" class="text-lg mb-6 text-left h-48 overflow-y-auto p-2 border"></p>
          <button id="next-question-button" class="dq-button"></button>
        </div>
      </div>
    </div>
  </div>
  <audio id="bgm" src="./BS3_BGM.wav" loop onerror="handleMediaError(this)"></audio>
  <audio id="correct-sound" src="./correct_answer.mp3" onerror="handleMediaError(this)"></audio>
  <script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbyJSdEy7FB8URSCuHC9DoFPHzPOcMS7TVnyFJ-4IGRunK09fLbwSdQxUGQDM0vOZ7wNmA/exec';
    const STAGE_NUMBER = '3';
    const TEXTS = {
      ja: {
        instructionTitle: "冒険の心得",
        instructions: ["・サステナビリティに関する5つの問題が出題されるぞ。", "・4問以上正解でボスを討伐できる！", "・各ステージの最初の挑戦結果のみが記録されるぞ。", "・健闘を祈る！"],
        instructionOk: "わかった",
        title: "ステージ3：ガバナンス",
        employeeIdPlaceholder: "社員番号(半角5桁)を入力",
        companySelectDefault: "所属会社を選択してください",
        startButton: "挑戦する",
        msgEnterId: "所属会社と社員番号を入力してください",
        msgCheckingId: "挑戦資格を確認中...",
        msgIdNotFound: "ステージ1の記録が見つかりません。会社名と社員番号を確認してください。",
        msgCheckError: "確認エラー。時間をおいて再試行してください。",
        theme: "テーマ：ガバナンス",
        progress: (q, t) => `${q}/${t}問目`,
        bossHp: "ボス HP",
        resultWinTitle: "勝利！",
        resultWinMsg: "ステージクリア！ガバナンスへの意識が高まった！",
        resultLoseTitle: "ゲームオーバー",
        resultLoseMsg: "竜の知恵は深かった…",
        submitting: "結果を送信中...",
        submitSuccess: "結果を送信しました！",
        submitError: "エラー：結果を送信できませんでした。",
        recordedFalse: "プレイありがとう！記録は初回のもののみとなります。",
        restartButton: "タイトルへ戻る",
        correct: "正解！",
        incorrect: "不正解...",
        nextButton: "次へ",
        quiz: [
          { q: "企業がESG(環境・社会・企業統治）に取り組むことによって得られるメリットとして、誤っているものは次のうちどれでしょうか？", o: ["顧客・市場から品質や価格以外の要素でも選ばれるような事業競争力を得られること。", "社会課題起点の新たなビジネス創出等により、事業成長とよりよい環境や社会との両立を実現できること。", "補助金等を得やすくなることで、短期的な利益を最大化できること。", "優秀な人財の採用や資金調達において有利に働くこと。"], a: "補助金等を得やすくなることで、短期的な利益を最大化できること。", ex: "ESGへの取り組みは、長期的な企業価値の向上と持続可能な成長を目指すものです。短期的な利益の最大化を唯一の目的とすることは、ESGの本来の目的とは異なります。NKCグループでも「NKC Sustainability Vision 2024」において、サステナビリティ戦略を事業戦略と融合させ新たな「成長戦略」とすることを目指すことを示しています。" },
          { q: "NKCグループにおいて、社員に積極的に社会貢献活動に参加することを推奨している目的として、誤っているものは次のうちどれでしょうか？", o: ["（会社の外の）社会に必要とされる役割を得ることで、より幸せで充実した人生を過ごしてもらうため。", "会社の業務以外から、さまざまな知見やスキルを獲得する機会の一つにしてもらいたいため。", "人事評価やボーナスの評価に直結させる要素として考慮するため。", "社会課題を起点に、新たな事業を生み出すきっかけにしてもらいたいため。"], a: "人事評価やボーナスの評価に直結させる要素として考慮するため。", ex: "第一義的には、会社の外でも必要とされる役割を得ることで、より幸せで充した人生を過ごしてもらいたいということですが、結果的にスキルアップや事業創出等が会社に跳ね返ってくるメリットもあると考えています。ただ、価値観は人それぞれですし、あくまでも任意での活動なので人事評価やボーナスに直結させるということはありません。" },
          { q: "NKCグループでは、「NKC Sustainability Vision 2024」において、ESG領域における目には見えにくいさまざまな要素を「可視化・定量化」するという方針を示しています。これにより狙っている効果は次のうちどれでしょうか？", o: ["非財務的な情報収集が不要になる", "会社の売上や利益が自動的に増加する", "すべての社会課題を一度に解決できる", "事業戦略の意思決定において社会的な価値を考慮しやすくなる"], a: "事業戦略の意思決定において社会的な価値を考慮しやすくなる", ex: "投資対効果等の事業戦略上の意思決定において、「環境負荷」「社会的価値」「法的リスク」等のさまざまなESG領域の要素も、一体的な考慮をしやすくなる（会社の利益とよりよい社会の両立を目指しやすい）という効果を狙っています。" },
          { q: "NKCグループのとある事業部門が、前例のない新たな事業アイディアを検討しています。この時、NKCグループの掲げる「ポジティブ志向型コンプライアンス」の精神に最も合致する行動は、次のうちどれでしょうか？", o: ["前例がなくリスクが高いことは明白なので、面倒になる前に計画を中止する。", "まずは小さく試してみて、問題が起きなければ本格的に進める。管理部門には後から報告する。", "関連部署を早期に巻き込み、リスクを客観的に評価した上で、どうすれば挑戦を実現できるかを建設的に議論する。", "経営陣にリスクの大きさを強調して説明し、事業を進めるかどうかの判断をすべて委ねる。"], a: "関連部署を早期に巻き込み、リスクを客観的に評価した上で、どうすれば挑戦を実現できるかを建設的に議論する。", ex: "「ポジティブ志向型コンプライアンス」では、リスクから「目を背けず、向き合い、克服することで、ワクワクする未来を自分たちの手で切り拓いていく」ことを目指しています。選択肢Cは、リスクを過剰評価して萎縮することなく、社員一人ひとりが「経営者目線」を持ったうえで「リスクをチャンスに」変えようとする実践的な行動です。" },
          { q: "NKCグループが大阪府（日本）等の行政自治体と連携協定を締結している主な目的として誤っているものは、次のうちどれでしょうか？", o: ["社会的な信頼性を高めることによる企業ブランド・企業価値の向上", "NKCグループを育んでくれた地域社会への恩返し", "行政と民間企業のそれぞれの強みを活かした社会課題解決の加速", "公的な補助金等を受けやすくすることでの短期的な収益性の向上"], a: "公的な補助金等を受けやすくすることでの短期的な収益性の向上", ex: "2022年3月に中西金属工業㈱と大阪府との間で締結した包括連携協定等に基づき、A～Cのような効果を狙っています。補助金等の獲得で有利に働く可能性もありますが、これを主たる目的とするものではありません。近時では、大阪府と連携協定を締結している他の民間企業との事業でのコラボレーションの検討も始まっています。" }
        ]
      },
      en: {
        instructionTitle: "Rules of the Quest",
        instructions: ["- You will be asked 5 questions about sustainability.", "- Answer 4 or more correctly to defeat the boss!", "- Only your first attempt on each stage will be recorded.", "- Good luck!"],
        instructionOk: "Got it",
        title: "Stage 3: Governance",
        employeeIdPlaceholder: "Enter 5-digit Employee ID",
        companySelectDefault: "Select your company",
        startButton: "Challenge",
        msgEnterId: "Please enter your Company and Employee ID",
        msgCheckingId: "Checking eligibility...",
        msgIdNotFound: "Stage 1 record not found. Please check your Company and Employee ID.",
        msgCheckError: "Verification error. Please try again later.",
        theme: "Theme: Governance",
        progress: (q, t) => `Q ${q}/${t}`,
        bossHp: "Boss HP",
        resultWinTitle: "Victory!",
        resultWinMsg: "Stage Clear! Your awareness of governance has increased!",
        resultLoseTitle: "Game Over",
        resultLoseMsg: "The dragon's wisdom was profound...",
        submitting: "Submitting results...",
        submitSuccess: "Results submitted!",
        submitError: "Error: Could not submit results.",
        recordedFalse: "Thanks for playing! Only your first result is recorded.",
        restartButton: "Back to Title",
        correct: "Correct!",
        incorrect: "Incorrect...",
        nextButton: "Next",
        quiz: [
          { q: "Which of the following is an incorrect benefit for a company engaging in ESG (Environmental, Social, and Governance)?", o: ["Gaining a competitive advantage by being chosen for factors other than quality and price.", "Achieving both business growth and a better society through new, socially-driven business creation.", "Maximizing short-term profits by making it easier to obtain subsidies.", "Gaining an advantage in recruiting talented personnel and in fundraising."], a: "Maximizing short-term profits by making it easier to obtain subsidies.", ex: "ESG initiatives aim for long-term corporate value enhancement and sustainable growth. Maximizing short-term profit as the sole objective is contrary to the original purpose of ESG. The NKC Group's 'NKC Sustainability Vision 2024' also aims to integrate sustainability strategy with business strategy to create a new 'growth strategy'." },
          { q: "Which of the following is an incorrect reason for the NKC Group to encourage employees to actively participate in social contribution activities?", o: ["To help them lead happier, more fulfilling lives by gaining roles needed by society (outside the company).", "To provide them with an opportunity to acquire diverse knowledge and skills from outside their regular work.", "To consider it as a direct factor in performance reviews and bonus evaluations.", "To inspire them to create new businesses based on social issues."], a: "To consider it as a direct factor in performance reviews and bonus evaluations.", ex: "Primarily, we want employees to lead happier lives by finding fulfilling roles outside the company. However, we also believe there are benefits for the company, such as skill enhancement and business creation. Since values differ and participation is voluntary, it is not directly linked to performance reviews or bonuses." },
          { q: "In 'NKC Sustainability Vision 2024,' the NKC Group aims to 'visualize and quantify' various intangible ESG factors. What is the intended effect of this policy?", o: ["It eliminates the need to collect non-financial information.", "It automatically increases company sales and profits.", "It can solve all social issues at once.", "It makes it easier to consider social value in business strategy decisions."], a: "It makes it easier to consider social value in business strategy decisions.", ex: "The goal is to make it easier to integrally consider various ESG factors such as 'environmental impact,' 'social value,' and 'legal risks' in business strategy decisions like return on investment, aiming for a balance between company profit and a better society." },
          { q: "A business unit within the NKC Group is considering an unprecedented new business idea. Which action best aligns with the NKC Group's 'Positive-Oriented Compliance' spirit?", o: ["Cancel the plan before it becomes troublesome, as it is clearly high-risk with no precedent.", "Try it on a small scale first, and if no problems arise, proceed fully, reporting to management later.", "Involve relevant departments early, objectively assess the risks, and constructively discuss how to make the challenge a reality.", "Emphasize the magnitude of the risks to management and leave the entire decision of whether to proceed to them."], a: "Involve relevant departments early, objectively assess the risks, and constructively discuss how to make the challenge a reality.", ex: "'Positive-Oriented Compliance' aims to 'not turn away from risks, but face them and overcome them to build an exciting future with our own hands.' Option C is a practical action that avoids being paralyzed by overestimating risks and instead seeks to turn 'risks into opportunities' with each employee having a 'manager's perspective'." },
          { q: "Which of the following is an incorrect primary purpose for the NKC Group's collaboration agreements with administrative bodies like Osaka Prefecture (Japan)?", o: ["Enhancing corporate brand and value by increasing social credibility.", "Giving back to the local community that has nurtured the NKC Group.", "Accelerating the resolution of social issues by leveraging the respective strengths of government and private companies.", "Improving short-term profitability by making it easier to receive public subsidies."], a: "Improving short-term profitability by making it easier to receive public subsidies.", ex: "Based on the comprehensive collaboration agreement signed between Nakanishi Metal Works Co., Ltd. and Osaka Prefecture in March 2022, we aim for effects A through C. While it may be advantageous for obtaining subsidies, this is not the primary goal. Recently, we have also begun exploring business collaborations with other private companies that have agreements with Osaka Prefecture." }
        ]
      },
      zh: {
        instructionTitle: "冒险须知",
        instructions: ["・将提出5个关于可持续性的问题。", "・正确回答4个以上问题即可击敗头目！", "・每个关卡只有第一次挑战的结果会被记录。", "・祝你好运！"],
        instructionOk: "知道了",
        title: "第三关：治理",
        employeeIdPlaceholder: "输入员工编号(5位半角数字)",
        companySelectDefault: "请选择所属公司",
        startButton: "挑战",
        msgEnterId: "请输入所属公司和员工编号",
        msgCheckingId: "正在确认挑战资格...",
        msgIdNotFound: "未找到第一关的记录。请检查公司名称和员工编号。",
        msgCheckError: "确认出错。请稍后再试。",
        theme: "主题：治理",
        progress: (q, t) => `第${q}/${t}题`,
        bossHp: "头目 HP",
        resultWinTitle: "胜利！",
        resultWinMsg: "关卡完成！加深了对治理的认识！",
        resultLoseTitle: "游戏结束",
        resultLoseMsg: "龙的智慧是深奥的…",
        submitting: "正在发送结果...",
        submitSuccess: "结果已发送！",
        submitError: "错误：无法发送结果。",
        recordedFalse: "感谢您的参与！只有初次挑战结果会被记录。",
        restartButton: "返回标题",
        correct: "回答正确！",
        incorrect: "回答错误...",
        nextButton: "下一个",
        quiz: [
          { q: "企业致力于ESG（环境、社会和公司治理）所能获得的益处中，以下哪项是错误的？", o: ["获得除质量和价格外，也能被顾客和市场选择的业务竞争力。", "通过源于社会课题的新业务创造等，实现业务增长与更美好环境和社会的双赢。", "通过更容易获得补助金等，实现短期利益最大化。", "在招聘优秀人才和资金筹措方面处于有利地位。"], a: "通过更容易获得补助金等，实现短期利益最大化。", ex: "致力于ESG是为了提升长期企业价值和实现可持续发展。将短期利益最大化作为唯一目的，与ESG的初衷不符。NKC集团在《NKC可持续发展愿景2024》中也提出，旨在将可持续发展战略与业务战略相融合，形成新的“增长战略”。" },
          { q: "NKC集团鼓励员工积极参与社会贡献活动的目的中，以下哪项是错误的？", o: ["通过在公司外部获得社会所需的角色，让他们度过更幸福、更充实的人生。", "希望这能成为他们从公司业务之外获得各种知识和技能的机会之一。", "作为直接关系到人事评价和奖金评估的因素加以考虑。", "希望这能成为他们以社会课题为起点，创造新业务的契机。"], a: "作为直接关系到人事评价和奖金评估的因素加以考虑。", ex: "首要目的是希望员工通过在公司外部获得被需要的角色，从而度过更幸福充实的人生。但我们认为，这最终也会为公司带来技能提升和业务创造等好处。不过，价值观因人而异，这纯属自愿活动，因此不会与人事评价或奖金直接挂钩。" },
          { q: "NKC集团在《NKC可持续发展愿景2024》中提出了将ESG领域中难以看见的各种要素“可视化、定量化”的方针。此举旨在达到以下哪种效果？", o: ["不再需要收集非财务信息", "公司销售额和利润将自动增长", "能够一次性解决所有社会问题", "在业务战略决策中更容易考虑社会价值"], a: "在业务战略决策中更容易考虑社会价值", ex: "此举旨在使“环境负荷”、“社会价值”、“法律风险”等各种ESG领域的要素，在投资回报率等业务战略决策中更容易被综合考虑，从而力求实现公司利益与更美好社会的双赢。" },
          { q: "NKC集团的某个业务部门正在探讨一个史无前例的新业务构想。此时，最符合NKC集团所倡导的“积极导向型合规”精神的行动是以下哪一项？", o: ["因为没有先例且风险明显很高，所以在变得麻烦之前中止计划。", "先进行小规模尝试，如果没有问题再正式推进。事后再向管理部门报告。", "尽早让相关部门参与进来，在客观评估风险的基础上，建设性地讨论如何才能实现这一挑战。", "向经营层强调风险的巨大，并将是否推进业务的判断全部委托给他们。"], a: "尽早让相关部门参与进来，在客观评估风险的基础上，建设性地讨论如何才能实现这一挑战。", ex: "“积极导向型合规”旨在“不回避风险，而是直面并克服它，用我们自己的双手开创激动人心的未来”。选项C是一种务实的行动，它不因过高评估风险而退缩，而是让每位员工都具备“经营者视角”，努力将“风险变为机遇”。" },
          { q: "NKC集团与大阪府（日本）等行政自治体签订合作协议的主要目的中，以下哪项是错误的？", o: ["通过提高社会信誉来提升企业品牌和企业价值", "回报培育了NKC集团的地区社会", "发挥行政和民营企业各自的优势，加速解决社会课题", "通过更容易获得公共补助金等来提高短期盈利能力"], a: "通过更容易获得公共补助金等来提高短期盈利能力", ex: "基于2022年3月中西金属工业株式会社与大阪府签订的全面合作协议等，我们旨在实现A至C的效果。虽然这可能有助于获得补助金等，但这并非主要目的。近期，我们也开始探讨与其他已同大阪府签订合作协议的民营企业进行业务合作。" }
        ]
      }
    };
    const companyList = {
      ja: ["本社/天満地区", "治工具工場", "神戸工場", "大阪工場", "名張工場", "三重工場", "滋賀工場", "河内工場", "株式会社NKC NASSH", "株式会社須田商事", "富士ホーニング工業株式会社", "中西興産株式会社", "シー・ティ・マシン株式会社", "イーグローバレッジ株式会社", "NKCながいグリーンパワー株式会社", "NMC", "NSC", "NWC", "NPC", "NAI", "NCP", "NDC", "その他"],
      en: ["HQ/Tenma Area", "Jig & Tool Factory", "Kobe Plant", "Osaka Plant", "Nabari Plant", "Mie Plant", "Shiga Plant", "Kawachi Plant", "NKC NASSH Inc.", "Suda Corporation", "Fuji Honing Industrial Co., Ltd.", "Nakanishi Kosan Co., Ltd.", "C.T. Machine Co., Ltd.", "e-Globaledge Corporation", "NKC Nagai Green Power Co., Ltd.", "NMC", "NSC", "NWC", "NPC", "NAI", "NCP", "NDC", "Other"],
      zh: ["总公司/天满地区", "治工具工場", "神户工厂", "大阪工厂", "名张工厂", "三重工厂", "滋贺工厂", "河内工厂", "株式会社NKC NASSH", "株式会社须田商事", "富士珩磨工业株式会社", "中西兴产株式会社", "C.T. Machine株式会社", "e-Globaledge株式会社", "NKC长井绿色电力株式会社", "NMC", "NSC", "NWC", "NPC", "NAI", "NCP", "NDC", "其他"]
    };
    
    const titleScreen = document.getElementById('title-screen');
    const languageScreen = document.getElementById('language-screen');
    const instructionScreen = document.getElementById('instruction-screen');
    const startScreen = document.getElementById('start-screen');
    const quizScreen = document.getElementById('quiz-screen');
    const resultScreen = document.getElementById('result-screen');
    const bossContainer = document.getElementById('boss-container');
    const employeeIdInput = document.getElementById('employeeIdInput');
    const companySelect = document.getElementById('companySelect');
    const bgm = document.getElementById('bgm');
    const correctSound = document.getElementById('correct-sound');
    const startButton = document.getElementById('start-button');
    const explanationModal = document.getElementById('explanation-modal');
    const nextQuestionButton = document.getElementById('next-question-button');
    const openingVideoContainer = document.getElementById('opening-video-container');
    const gameVideoContainer = document.getElementById('game-video-container');

    let currentLang = 'ja';
    let timerInterval, startTime, correctCount, isGameInProgress = false, audioStarted = false;
    let clickSound, hitSound, damageSound, victorySound, defeatSound;

    function switchScreen(screenName) {
      [titleScreen, languageScreen, instructionScreen, startScreen, quizScreen, resultScreen].forEach(s => s.classList.add('hidden'));
      document.getElementById(`${screenName}-screen`).classList.remove('hidden');
    }
    
    function updateUIText() {
      const t = TEXTS[currentLang];
      document.body.lang = currentLang;
      document.getElementById('instruction-title').textContent = t.instructionTitle;
      document.getElementById('instruction-text').innerHTML = t.instructions.map(line => `<p>${line}</p>`).join('');
      document.getElementById('instruction-ok-button').textContent = t.instructionOk;
      document.getElementById('title-text').textContent = t.title;
      employeeIdInput.placeholder = t.employeeIdPlaceholder;
      document.getElementById('start-button-text').textContent = t.startButton;
      document.getElementById('boss-hp-label').textContent = t.bossHp;
      document.getElementById('restart-button').textContent = t.restartButton;
      document.getElementById('theme-display').textContent = t.theme;
      
      companySelect.innerHTML = `<option value="">${t.companySelectDefault}</option>`;
      companyList[currentLang].forEach(company => {
        companySelect.innerHTML += `<option value="${company}">${company}</option>`;
      });
    }

    function setupAudio() {
      if (audioStarted) return;
      // ★追加: BGMの音量を70%に設定
      bgm.volume = 0.7;
      clickSound = () => new Tone.MembraneSynth({ pitchDecay: 0.01, octaves: 3, envelope: { attack: 0.001, decay: 0.3, sustain: 0 } }).toDestination().triggerAttackRelease("C2", "8n");
      hitSound = () => {
        correctSound.currentTime = 0;
        correctSound.play().catch(e => console.error("Correct sound play failed:", e));
      };
      damageSound = () => new Tone.NoiseSynth({ noise: { type: "pink" }, envelope: { attack: 0.01, decay: 0.3, sustain: 0, release: 0.2 } }).toDestination().triggerAttackRelease("8n");
      victorySound = () => { const s = new Tone.Synth().toDestination(), n = Tone.now(); s.triggerAttackRelease("C5", "8n", n); s.triggerAttackRelease("E5", "8n", n + 0.2); s.triggerAttackRelease("G5", "8n", n + 0.4); s.triggerAttackRelease("C6", "4n", n + 0.6) };
      defeatSound = () => { const s = new Tone.Synth().toDestination(), n = Tone.now(); s.triggerAttackRelease("C4", "4n", n); s.triggerAttackRelease("B3", "4n", n + 0.3); s.triggerAttackRelease("A#3", "4n", n + 0.6); s.triggerAttackRelease("A3", "2n", n + 0.9) };
      audioStarted = true;
    }

    function normalizeEmployeeIdForHTML(v) {
      const digits = String(v == null ? "" : v).replace(/[^\d]/g, "");
      return digits.padStart(5, "0");
    }

    async function startGame() {
      if (!employeeIdInput.checkValidity()) {
        employeeIdInput.reportValidity();
        return;
      }
      const company = companySelect.value;
      const employeeId = employeeIdInput.value.trim();
      const msgEl = document.getElementById('msg');
      if (!company || !employeeId) {
        msgEl.textContent = TEXTS[currentLang].msgEnterId;
        return;
      }
      if (isGameInProgress) return;
      isGameInProgress = true;
      startButton.disabled = true;
      msgEl.textContent = TEXTS[currentLang].msgCheckingId;

      const normalizedEmployeeId = normalizeEmployeeIdForHTML(employeeId);

      try {
        const checkUrl = `${GAS_URL}?action=checkEmployeeId&employeeId=${encodeURIComponent(normalizedEmployeeId)}&company=${encodeURIComponent(company)}`;
        const response = await fetch(checkUrl);
        const result = await response.json();

        if (result.exists) {
          msgEl.textContent = "";
          bgm.play().catch(e => console.error("BGM play failed:", e));
          clickSound();
          correctCount = 0;
          document.getElementById('boss-area').classList.remove('hidden');
          bossContainer.className = 'boss-idle';
          updateHpBars(100);
          switchScreen('quiz');
          startTime = Date.now();
          timerInterval = setInterval(() => {
            const elapsedTime = ((Date.now() - startTime) / 1000).toFixed(1);
            document.getElementById('timer-display').textContent = `${elapsedTime}s`;
          }, 100);
          displayQuestion(0);
        } else {
          msgEl.textContent = TEXTS[currentLang].msgIdNotFound;
        }
      } catch (error) {
        console.error("Error checking employee ID:", error);
        msgEl.textContent = TEXTS[currentLang].msgCheckError;
      } finally {
        isGameInProgress = false;
        startButton.disabled = false;
      }
    }

    function displayQuestion(index) {
      const quizData = TEXTS[currentLang].quiz;
      document.getElementById('progress-display').textContent = TEXTS[currentLang].progress(index + 1, quizData.length);
      const current = quizData[index];
      document.getElementById('question-text').textContent = `Q${index + 1}: ${current.q}`;
      const optionsContainer = document.getElementById('options-container');
      optionsContainer.innerHTML = '';
      current.o.forEach(opt => {
        const div = document.createElement('div');
        div.textContent = `▶ ${opt}`;
        div.classList.add('dq-button');
        div.addEventListener('click', () => handleAnswer(opt, current, index));
        optionsContainer.appendChild(div);
      });
    }

    function handleAnswer(selectedAnswer, currentQuiz, index) {
      const isCorrect = selectedAnswer === currentQuiz.a;
      const optionsContainer = document.getElementById('options-container');
      optionsContainer.querySelectorAll('.dq-button').forEach(btn => {
        btn.style.pointerEvents = 'none';
        if (btn.textContent.includes(currentQuiz.a)) {
          btn.classList.add('correct-answer');
        } else {
          btn.classList.add('incorrect-answer');
        }
      });

      if (isCorrect) {
        correctCount++;
        hitSound();
        updateHpBars(100 - (correctCount * (100 / 4)));
        bossContainer.classList.add('shake');
        document.getElementById('explanation-title').textContent = TEXTS[currentLang].correct;
      } else {
        damageSound();
        document.querySelector('.dq-window').classList.add('shake');
        document.getElementById('explanation-title').textContent = TEXTS[currentLang].incorrect;
      }
      
      document.getElementById('explanation-text').textContent = currentQuiz.ex;
      nextQuestionButton.textContent = TEXTS[currentLang].nextButton;
      nextQuestionButton.dataset.nextIndex = index + 1;
      
      setTimeout(() => {
        explanationModal.style.display = 'flex';
      }, 800);
    }
    
    nextQuestionButton.addEventListener('click', () => {
      explanationModal.style.display = 'none';
      bossContainer.classList.remove('shake');
      document.querySelector('.dq-window').classList.remove('shake');
      
      const nextIndex = parseInt(nextQuestionButton.dataset.nextIndex);
      if (nextIndex >= TEXTS[currentLang].quiz.length) {
        showEndScreen();
      } else {
        displayQuestion(nextIndex);
      }
    });

    function showEndScreen() {
      clearInterval(timerInterval);
      bgm.pause();
      bgm.currentTime = 0;
      
      const isVictory = correctCount >= 4;
      if (isVictory) {
        victorySound();
        bossContainer.className = 'boss-defeat';
      } else {
        defeatSound();
      }
      
      setTimeout(() => {
        document.getElementById('boss-area').classList.add('hidden');
        switchScreen('result');
        const t = TEXTS[currentLang];
        document.getElementById('result-title').textContent = isVictory ? t.resultWinTitle : t.resultLoseTitle;
        document.getElementById('result-message').textContent = isVictory ? t.resultWinMsg : t.resultLoseMsg;
        submitResults();
      }, isVictory ? 1500 : 500);
    }

    async function submitResults() {
        const statusEl = document.getElementById('submission-status');
        let ipAddress = 'N/A';
        try {
            const response = await fetch('https://api.ipify.org?format=json');
            ipAddress = (await response.json()).ip;
        } catch (error) {
            console.error('IPアドレスの取得に失敗しました:', error);
        }

        const normalizedEmployeeId = normalizeEmployeeIdForHTML(employeeIdInput.value.trim());
        const payload = {
            company: companySelect.value,
            employeeId: normalizedEmployeeId,
            stage: STAGE_NUMBER,
            score: correctCount,
            time: ((Date.now() - startTime) / 1000).toFixed(2),
            ipAddress: ipAddress
        };
        statusEl.textContent = TEXTS[currentLang].submitting;
        
        try {
            const response = await fetch(GAS_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/plain;charset=utf-8',
                },
                body: JSON.stringify(payload)
            });

            const result = await response.json();

            if (result.status === 'success') {
                if (result.recorded === false) {
                    statusEl.textContent = TEXTS[currentLang].recordedFalse;
                } else {
                    statusEl.textContent = TEXTS[currentLang].submitSuccess;
                }
            } else {
                statusEl.textContent = result.message || TEXTS[currentLang].submitError;
            }
        } catch (err) {
            statusEl.textContent = TEXTS[currentLang].submitError;
            console.error('Error:', err);
        }
    }

    function updateHpBars(percentage) {
      const hpBar = document.getElementById('boss-hp-bar');
      hpBar.style.width = `${Math.max(0, percentage)}%`;
      if (percentage <= 25) hpBar.className = 'boss-hp-bar low';
      else if (percentage <= 50) hpBar.className = 'boss-hp-bar mid';
      else hpBar.className = 'boss-hp-bar full';
    }
    
    function handleMediaError(element) {
        console.error(`Error loading media: ${element.src}`);
        element.style.display = 'none'; 
    }

    document.getElementById('title-start-button').addEventListener('click', async () => {
      if (!audioStarted) { 
        await Tone.start();
        setupAudio();
      }
      clickSound();
      const openingVideo = document.getElementById('opening-video');
      openingVideo.muted = false;
      openingVideo.play().catch(e => console.log("User interaction might be needed for audio"));
      switchScreen('language');
    });

    document.getElementById('lang-ja').addEventListener('click', () => { clickSound(); currentLang = 'ja'; updateUIText(); switchScreen('instruction'); });
    document.getElementById('lang-en').addEventListener('click', () => { clickSound(); currentLang = 'en'; updateUIText(); switchScreen('instruction'); });
    document.getElementById('lang-zh').addEventListener('click', () => { clickSound(); currentLang = 'zh'; updateUIText(); switchScreen('instruction'); });
    
    document.getElementById('instruction-ok-button').addEventListener('click', () => {
      clickSound();
      openingVideoContainer.classList.add('hidden');
      document.getElementById('opening-video').pause();
      gameVideoContainer.classList.remove('hidden');
      document.getElementById('game-bg-video').play().catch(e => console.log("Game video play failed"));
      switchScreen('start');
    });
    
    startButton.addEventListener('click', startGame);
    document.getElementById('restart-button').addEventListener('click', () => location.reload());

    updateUIText();
    switchScreen('title');
    const openingVideo = document.getElementById('opening-video');
    openingVideo.muted = false;
    openingVideo.play().catch(e => {
        console.log("Autoplay with sound was prevented. Muting and retrying.");
        openingVideo.muted = true;
        openingVideo.play();
    });
  </script>
</body>
</html>
