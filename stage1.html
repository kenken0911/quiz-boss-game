<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sustainability Quest 🗡️ - Stage 1</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=Press+Start+2P&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
  <style>
    body[lang="ja"], body[lang="zh"] { font-family: 'DotGothic16', sans-serif; }
    body[lang="en"] { font-family: 'Press Start 2P', cursive; }
    body { background-color: #000; color: #fff; image-rendering: pixelated; overflow-x: hidden; overflow-y: auto; }
    .dq-window { border: 4px solid #fff; background: rgba(0,0,80,0.85); padding: 1.5rem; box-shadow: 0 0 0 4px #000, 0 0 20px rgba(0,128,255,0.6); backdrop-filter: blur(3px); }
    .dq-button { cursor: pointer; padding: .75rem 1.5rem; border: 2px solid #fff; background-image: linear-gradient(to bottom, #0055dd, #0033aa); text-shadow: 1px 1px 2px #000; transition: all 0.2s; }
    .dq-button:hover { background-image: linear-gradient(to bottom, #4488ff, #0055dd); box-shadow: 0 0 10px #fff; }
    .video-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
    .bg-video { width: 100%; height: 100%; object-fit: cover; }
    #title-screen h1 { font-size: 2.5rem; font-weight: bold; text-shadow: 0 0 5px #fff, 0 0 15px #fff, 0 0 25px #00aaff; animation: fadeInTitle 2s ease-out forwards; }
    #title-start-button { animation: pulseButton 2.5s infinite ease-in-out; }
    @keyframes fadeInTitle { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
    @keyframes pulseButton { 0%, 100% { transform: scale(1); box-shadow: 0 0 10px rgba(255,255,255,0.7); } 50% { transform: scale(1.05); box-shadow: 0 0 20px rgba(255,255,255,1); } }
    .boss-hp-container { border: 2px solid #fff; height: 30px; padding: 3px; background: #333; border-radius: 5px; box-shadow: inset 0 0 5px #000; }
    .boss-hp-bar { height: 100%; transition: width .5s ease-out, background-image .5s ease-out; border-radius: 2px; }
    .boss-hp-bar.full { background-image: linear-gradient(to right, #33ff33, #88ff88); }
    .boss-hp-bar.mid { background-image: linear-gradient(to right, #ffff33, #ffff88); }
    .boss-hp-bar.low { background-image: linear-gradient(to right, #ff3333, #ff8833); }
    .boss-idle { animation: boss-float 2.5s infinite ease-in-out; }
    @keyframes boss-float{ 0%,100% { transform: translateY(0); } 50% { transform: translateY(-12px); } }
    .boss-defeat { animation: boss-defeat-anim 1.5s forwards; }
    @keyframes boss-defeat-anim { 0% { opacity: 1; transform: rotate(0deg); } 50% { opacity: 1; transform: rotate(10deg); } 100% { opacity: 0; transform: translateY(100px) rotate(-20deg) scale(0.5); } }
    .shake { animation: shake .35s; }
    @keyframes shake { 10%,90% { transform: translate(-2px, -2px); } 20%,80% { transform: translate(3px, 2px); } 30%,50%,70% { transform: translate(-3px, 3px); } 40%,60% { transform: translate(3px, -2px); } }
    .fire-glow { filter: drop-shadow(0 0 8px #ff8a00) drop-shadow(0 0 16px #ff3b00) contrast(1.5); }
    #boss-img { width: 100%; max-width: 320px; height: auto; }
    .correct-answer { background-image: linear-gradient(to bottom, #ffdd00, #ffaa00) !important; color: #000; }
    .incorrect-answer { background-image: linear-gradient(to bottom, #888888, #555555) !important; opacity: 0.7; }
  </style>
</head>
<body class="flex items-start sm:items-center justify-center min-h-screen p-4">

  <div id="opening-video-container" class="video-container">
    <video id="opening-video" class="bg-video" src="./opening_movie.mp4" autoplay loop playsinline onerror="handleMediaError(this)"></video>
  </div>
  <div id="game-video-container" class="video-container hidden">
    <video id="game-bg-video" class="bg-video" src="./GameBackground1.mp4" autoplay muted loop playsinline onerror="handleMediaError(this)"></video>
  </div>

  <div class="w-full max-w-3xl mx-auto">
    <div id="boss-area" class="mb-4 h-64 flex justify-center items-end relative hidden">
      <div id="boss-container"><img id="boss-img" src="./Stage1_dragon.png" alt="ボスの画像" class="fire-glow" onerror="handleMediaError(this)"/></div>
    </div>
    <div id="game-container" class="w-full dq-window relative">
      <div id="title-screen" class="text-center py-8">
        <h1 class="mb-10">Sustainability Quest</h1>
        <button id="title-start-button" class="dq-button">START</button>
      </div>

      <div id="language-screen" class="text-center hidden">
        <h1 class="text-3xl font-bold mb-6">Select Language</h1>
        <p class="text-sm mb-6">Translations are provided by AI.</p>
        <div class="flex justify-center gap-2 flex-wrap">
          <button id="lang-ja" class="dq-button">日本語</button>
          <button id="lang-en" class="dq-button">English</button>
          <button id="lang-zh" class="dq-button">中文</button>
        </div>
      </div>

      <div id="instruction-screen" class="text-center hidden">
        <h1 id="instruction-title" class="text-3xl font-bold mb-4"></h1>
        <div id="instruction-text" class="text-left mb-6 space-y-2"></div>
        <button id="instruction-ok-button" class="dq-button"></button>
      </div>
      
      <div id="start-screen" class="text-center hidden">
        <h1 id="title-text" class="text-2xl font-bold mb-4"></h1>
        <div class="flex flex-col items-center gap-4 mb-4">
          <input id="nicknameInput" type="text" maxlength="20" class="text-black px-3 py-2 w-full md:w-80 text-center rounded" />
          <select id="companySelect" class="text-black px-3 py-2 w-full md:w-80 text-center rounded"></select>
          <input id="employeeIdInput" type="text" pattern="\d{5}" title="社員番号は半角数字5桁で入力してください" class="text-black px-3 py-2 w-full md:w-80 text-center rounded" />
        </div>
        <button id="start-button" class="dq-button inline-flex items-center gap-2"><span id="start-button-text"></span></button>
        <div id="msg" class="text-yellow-300 text-sm h-5 mt-2"></div>
      </div>

      <div id="quiz-screen" class="hidden">
        <div class="flex justify-between items-center mb-2 text-lg">
          <span id="theme-display"></span>
          <span id="progress-display"></span>
          <span id="timer-display">0.0s</span>
        </div>
        <div class="mb-4"><p id="boss-hp-label"></p><div class="boss-hp-container"><div id="boss-hp-bar"></div></div></div>
        <div class="mb-4 min-h-[80px] p-4 border-2 border-white"><p id="question-text" class="text-xl"></p></div>
        <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      </div>
      <div id="result-screen" class="hidden text-center">
        <h2 id="result-title" class="text-3xl font-bold mb-4"></h2>
        <p id="result-message" class="text-xl mb-6"></p>
        <p id="submission-status" class="text-yellow-300 mb-8"></p>
        <div id="restart-button" class="dq-button inline-block"></div>
      </div>
      <div id="explanation-modal" class="absolute inset-0 bg-black bg-opacity-80 flex-col items-center justify-center p-4 hidden">
        <div class="dq-window w-full max-w-2xl text-center">
          <h2 id="explanation-title" class="text-4xl font-bold mb-4"></h2>
          <p id="explanation-text" class="text-lg mb-6 text-left h-48 overflow-y-auto p-2 border"></p>
          <button id="next-question-button" class="dq-button"></button>
        </div>
      </div>
    </div>
  </div>
  <audio id="bgm" src="./BS1_BGM.wav" loop onerror="handleMediaError(this)"></audio>
  <audio id="correct-sound" src="./correct_answer.mp3" onerror="handleMediaError(this)"></audio>
  <script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbyJSdEy7FB8URSCuHC9DoFPHzPOcMS7TVnyFJ-4IGRunK09fLbwSdQxUGQDM0vOZ7wNmA/exec';
    const STAGE_NUMBER = '1';
    const TEXTS = {
      ja: {
        instructionTitle: "冒険の心得",
        instructions: ["・サステナビリティに関する5つの問題が出題されるぞ。", "・4問以上正解でボスを討伐できる！", "・最初の挑戦結果のみがランキングに記録されるぞ。", "・健闘を祈る！"],
        instructionOk: "わかった",
        title: "ステージ1：地球環境",
        nicknamePlaceholder: "ニックネームを入力",
        employeeIdPlaceholder: "社員番号(半角5桁)を入力",
        companySelectDefault: "所属会社を選択してください",
        startButton: "挑戦する",
        msgEnterId: "ニックネーム、所属会社、社員番号をすべて入力してください",
        theme: "テーマ：地球環境",
        progress: (q, t) => `${q}/${t}問目`,
        bossHp: "ボス HP",
        resultWinTitle: "勝利！",
        resultWinMsg: "ステージクリア！環境への意識が高まった！",
        resultLoseTitle: "ゲームオーバー",
        resultLoseMsg: "竜の力は強大だった…",
        submitting: "結果を送信中...",
        submitSuccess: "結果を送信しました！",
        submitError: "エラー：結果を送信できませんでした。",
        recordedFalse: "プレイありがとう！記録は初回のもののみとなります。",
        restartButton: "タイトルへ戻る",
        correct: "正解！",
        incorrect: "不正解...",
        nextButton: "次へ",
        quiz: [
          { q: "気候変動対策として誤っているものは次のうちどれでしょうか？", o: ["省エネや再生エネルギーの使用", "森林保全", "気候変動への適応", "海の川のゴミ拾い"], a: "海の川のゴミ拾い", ex: "気候変動対策には、温室効果ガス排出量を削減するための「緩和」と、気候変動の影響を軽減したり、順応して快適に暮らすための「適応」があります。ゴミを拾っても、温室効果ガス排出量は減らないため、直接的な気候変動対策になりません。しかし、海洋汚染対策に貢献する価値のある活動です。" },
          { q: "廃棄物の発生を抑制し、資源を有効活用するための考え方として誤っているものは次のうちどれでしょうか？", o: ["Refuse", "Reduce", "Repair", "Remain"], a: "Remain", ex: "廃棄物の発生抑制、資源の有効活用のための考え方として、3R（Reduce・Reuse・Recycle）が提唱されていますが、最近ではRefuseやRepairなどの考え方にまで広がっています。" },
          { q: "生物多様性に含まれる「3つのレベルの多様性」として誤っているものは次のうちどれでしょうか？", o: ["生態系の多様性", "種の多様性", "遺伝子の多様性", "文化の多様性"], a: "文化の多様性", ex: "生物多様性とは、地球上の様々な種類の生物が、それぞれの環境で互いにつながり合いながら生きている状態のことです。具体的には、「生態系の多様性」、「種の多様性」、「遺伝子の多様性」の3つのレベルでの多様性を含みます。" },
          { q: "世界経済フォーラム（WEF）が発表する「グローバルリスクレポート（2024）」の中で、最も高い環境関連リスクは次のうちどれでしょうか？", o: ["異常気象", "生物多様性の喪失と生態系の崩壊", "自然資源の不足", "汚染"], a: "異常気象", ex: "異常気象は、短期間リスクでは2位、長期間リスクでは1位にランクインしています。グローバルリスクレポートには、環境以外にも、経済、地政学、社会、テクノロジーのリスクカテゴリーがありますが、長期間リスクのTOP10には、他の選択肢を含む環境関連リスクが5つもランクインしています。" },
          { q: "「永遠の化学物質」と呼ばれる有害化学物質は次のうちどれでしょうか？", o: ["BPA（ビスフェノールA）", "DDT（ジクロロジフェニルトリクロロエタン）", "PFAS（有機フッ素化合物）", "ダイオキシン類"], a: "PFAS（有機フッ素化合物）", ex: "PFASは、自然界でほとんど分解されず、環境や人体への長期的な影響が懸念されている有害化学物質の総称です。水や油をはじき、熱に強いため、フライパンや防水スプレーなど、幅広い製品で使用されてきました。DDT、BPA、ダイオキシン類はいずれも環境や人体に有害な化学物質ですが、「永遠の化学物質」とは呼ばれません。" }
        ]
      },
      en: {
        instructionTitle: "Rules of the Quest",
        instructions: ["- You will be asked 5 questions about sustainability.", "- Answer 4 or more correctly to defeat the boss!", "- Only your first attempt will be recorded for the ranking.", "- Good luck!"],
        instructionOk: "Got it",
        title: "Stage 1: Global Environment",
        nicknamePlaceholder: "Enter Nickname",
        employeeIdPlaceholder: "Enter 5-digit Employee ID",
        companySelectDefault: "Select your company",
        startButton: "Challenge",
        msgEnterId: "Please enter all fields: Nickname, Company, and Employee ID",
        theme: "Theme: Global Environment",
        progress: (q, t) => `Q ${q}/${t}`,
        bossHp: "Boss HP",
        resultWinTitle: "Victory!",
        resultWinMsg: "Stage Clear! Your environmental awareness has increased!",
        resultLoseTitle: "Game Over",
        resultLoseMsg: "The dragon's power was too great...",
        submitting: "Submitting results...",
        submitSuccess: "Results submitted!",
        submitError: "Error: Could not submit results.",
        recordedFalse: "Thanks for playing! Only your first result is recorded.",
        restartButton: "Back to Title",
        correct: "Correct!",
        incorrect: "Incorrect...",
        nextButton: "Next",
        quiz: [
          { q: "Which of the following is incorrect as a climate change countermeasure?", o: ["Energy saving and use of renewable energy", "Forest conservation", "Adaptation to climate change", "Picking up trash from the sea and rivers"], a: "Picking up trash from the sea and rivers", ex: "Climate change countermeasures include 'mitigation' to reduce greenhouse gas emissions and 'adaptation' to reduce the impacts of climate change. Picking up trash is not a direct countermeasure, but it is a valuable activity for ocean pollution control." },
          { q: "Which of the following is an incorrect concept for suppressing waste generation and effectively utilizing resources?", o: ["Refuse", "Reduce", "Repair", "Remain"], a: "Remain", ex: "To suppress waste generation and effectively utilize resources, the 3Rs (Reduce, Reuse, Recycle) have been advocated, but recently this has expanded to include concepts like Refuse and Repair. 'Remain' is not included." },
          { q: "Which of the following is incorrect as one of the 'three levels of diversity' included in biodiversity?", o: ["Ecosystem diversity", "Species diversity", "Genetic diversity", "Cultural diversity"], a: "Cultural diversity", ex: "Biodiversity is the state where various types of life on Earth live while being interconnected in their respective environments. Specifically, it includes diversity at three levels: 'ecosystem diversity,' 'species diversity,' and 'genetic diversity.'" },
          { q: "In the 'Global Risks Report (2024)' published by the World Economic Forum (WEF), which of the following is the highest environmental risk?", o: ["Extreme weather events", "Biodiversity loss and ecosystem collapse", "Natural resource shortages", "Pollution"], a: "Extreme weather events", ex: "Extreme weather events are ranked 2nd for short-term risks and 1st for long-term risks. The Global Risks Report includes economic, geopolitical, social, and technological risk categories in addition to environmental ones, but 5 of the top 10 long-term risks, including the other options, are environment-related." },
          { q: "Which of the following hazardous chemicals are known as 'forever chemicals'?", o: ["BPA (Bisphenol A)", "DDT (Dichlorodiphenyltrichloroethane)", "PFAS (Per- and polyfluoroalkyl substances)", "Dioxins"], a: "PFAS (Per- and polyfluoroalkyl substances)", ex: "PFAS is a general term for hazardous chemicals that hardly break down in nature, raising concerns about their long-term effects on the environment and human body. Because they repel water and oil and are heat-resistant, they have been used in a wide range of products, such as frying pans and waterproof sprays. DDT, BPA, and dioxins are all chemicals harmful to the environment and humans but are not called 'forever chemicals'." }
        ]
      },
      zh: {
        instructionTitle: "冒险须知",
        instructions: ["・将提出5个关于可持续性的问题。", "・正确回答4个以上问题即可击败头目！", "・只有第一次挑战的结果会被记录在排名中。", "・祝你好运！"],
        instructionOk: "知道了",
        title: "第一关：地球环境",
        nicknamePlaceholder: "输入昵称",
        employeeIdPlaceholder: "输入员工编号(5位半角数字)",
        companySelectDefault: "请选择所属公司",
        startButton: "挑战",
        msgEnterId: "请输入昵称、所属公司和员工编号",
        theme: "主题：地球环境",
        progress: (q, t) => `第${q}/${t}题`,
        bossHp: "头目 HP",
        resultWinTitle: "胜利！",
        resultWinMsg: "关卡完成！对环境的认识提高了！",
        resultLoseTitle: "游戏结束",
        resultLoseMsg: "龙的力量太强大了…",
        submitting: "正在发送结果...",
        submitSuccess: "结果已发送！",
        submitError: "错误：无法发送结果。",
        recordedFalse: "感谢您的参与！只有初次挑战结果会被记录。",
        restartButton: "返回标题",
        correct: "回答正确！",
        incorrect: "回答错误...",
        nextButton: "下一个",
        quiz: [
          { q: "以下哪项作为气候变化对策是错误的？", o: ["节能和使用可再生能源", "森林保护", "适应气候变化", "捡拾海洋和河流的垃圾"], a: "捡拾海洋和河流的垃圾", ex: "气候变化对策包括旨在减少温室气体排放的“减缓”措施，以及旨在减轻气候变化影响并舒适生活的“适应”措施。捡垃圾不会减少温室气体排放，因此不是直接的气候变化对策。但是，它是一项有价值的活动，有助于防治海洋污染。" },
          { q: "以下哪项是抑制废物产生和有效利用资源方面的错误概念？", o: ["拒绝 (Refuse)", "减少 (Reduce)", "修理 (Repair)", "保留 (Remain)"], a: "保留 (Remain)", ex: "为了抑制废物产生和有效利用资源，人们提倡3R（减少、再利用、回收），但最近这一理念已扩展到包括拒绝和修理等概念。不包括“保留”。" },
          { q: "以下哪项不属于生物多样性中所包含的“三个多样性层次”？", o: ["生态系统多样性", "物种多样性", "遗传多样性", "文化多样性"], a: "文化多样性", ex: "生物多样性是指地球上各种生物在各自的环境中相互联系、共存的状态。具体而言，它包括三个层次的多样性：“生态系统多样性”、“物种多样性”和“遗传多样性”。" },
          { q: "在世界经济论坛（WEF）发布的《2024年全球风险报告》中，以下哪项是最高的环境相关风险？", o: ["极端天气事件", "生物多样性丧失和生态系统崩溃", "自然资源短缺", "污染"], a: "极端天气事件", ex: "极端天气事件在短期风险中排名第二，在长期风险中排名第一。《全球风险报告》除了环境风险外，还包括经济、地缘政治、社会和技术风险类别，但在长期风险前十名中，包括其他选项在内的与环境相关的风险占了五项。" },
          { q: "以下哪种有害化学物质被称为“永久性化学物质”？", o: ["BPA (双酚A)", "DDT (二氯二苯三氯乙烷)", "PFAS (全氟和多氟烷基物质)", "二噁英类"], a: "PFAS (全氟和多氟烷基物质)", ex: "PFAS 是一类有害化学物质的总称，它们在自然界中几乎不分解，引发了人们对其对环境和人体长期影响的担忧。由于它们能防水防油且耐热，因此被广泛用于煎锅和防水喷雾等产品中。DDT、BPA和二噁英类都是对环境和人体有害的化学物质，但不被称为“永久性化学物质”。" }
        ]
      }
    };
    const companyList = {
      ja: ["本社/天満地区", "治工具工場", "神戸工場", "大阪工場", "名張工場", "三重工場", "滋賀工場", "河内工場", "株式会社NKC NASSH", "株式会社須田商事", "富士ホーニング工業株式会社", "中西興産株式会社", "シー・ティ・マシン株式会社", "イーグローバレッジ株式会社", "NKCながいグリーンパワー株式会社", "NMC", "NSC", "NWC", "NPC", "NAI", "NCP", "NDC", "その他"],
      en: ["HQ/Tenma Area", "Jig & Tool Factory", "Kobe Plant", "Osaka Plant", "Nabari Plant", "Mie Plant", "Shiga Plant", "Kawachi Plant", "NKC NASSH Inc.", "Suda Corporation", "Fuji Honing Industrial Co., Ltd.", "Nakanishi Kosan Co., Ltd.", "C.T. Machine Co., Ltd.", "e-Globaledge Corporation", "NKC Nagai Green Power Co., Ltd.", "NMC", "NSC", "NWC", "NPC", "NAI", "NCP", "NDC", "Other"],
      zh: ["总公司/天满地区", "治工具工場", "神户工厂", "大阪工厂", "名张工厂", "三重工厂", "滋贺工厂", "河内工厂", "株式会社NKC NASSH", "株式会社须田商事", "富士珩磨工业株式会社", "中西兴产株式会社", "C.T. Machine株式会社", "e-Globaledge株式会社", "NKC长井绿色电力株式会社", "NMC", "NSC", "NWC", "NPC", "NAI", "NCP", "NDC", "其他"]
    };
    
    const titleScreen = document.getElementById('title-screen');
    const languageScreen = document.getElementById('language-screen');
    const instructionScreen = document.getElementById('instruction-screen');
    const startScreen = document.getElementById('start-screen');
    const quizScreen = document.getElementById('quiz-screen');
    const resultScreen = document.getElementById('result-screen');
    const bossContainer = document.getElementById('boss-container');
    const employeeIdInput = document.getElementById('employeeIdInput');
    const nicknameInput = document.getElementById('nicknameInput');
    const companySelect = document.getElementById('companySelect');
    const bgm = document.getElementById('bgm');
    const correctSound = document.getElementById('correct-sound');
    const startButton = document.getElementById('start-button');
    const explanationModal = document.getElementById('explanation-modal');
    const nextQuestionButton = document.getElementById('next-question-button');
    const openingVideoContainer = document.getElementById('opening-video-container');
    const gameVideoContainer = document.getElementById('game-video-container');

    let currentLang = 'ja';
    let timerInterval, startTime, correctCount, isGameInProgress = false, audioStarted = false;
    let clickSound, hitSound, damageSound, victorySound, defeatSound;

    function switchScreen(screenName) {
      [titleScreen, languageScreen, instructionScreen, startScreen, quizScreen, resultScreen].forEach(s => s.classList.add('hidden'));
      document.getElementById(`${screenName}-screen`).classList.remove('hidden');
    }
    
    function updateUIText() {
      const t = TEXTS[currentLang];
      document.body.lang = currentLang;
      document.getElementById('instruction-title').textContent = t.instructionTitle;
      document.getElementById('instruction-text').innerHTML = t.instructions.map(line => `<p>${line}</p>`).join('');
      document.getElementById('instruction-ok-button').textContent = t.instructionOk;
      document.getElementById('title-text').textContent = t.title;
      nicknameInput.placeholder = t.nicknamePlaceholder;
      employeeIdInput.placeholder = t.employeeIdPlaceholder;
      document.getElementById('start-button-text').textContent = t.startButton;
      document.getElementById('boss-hp-label').textContent = t.bossHp;
      document.getElementById('restart-button').textContent = t.restartButton;
      document.getElementById('theme-display').textContent = t.theme;
      
      companySelect.innerHTML = `<option value="">${t.companySelectDefault}</option>`;
      companyList[currentLang].forEach(company => {
        companySelect.innerHTML += `<option value="${company}">${company}</option>`;
      });
    }

    function setupAudio() {
      if (audioStarted) return;
      clickSound = () => new Tone.MembraneSynth({ pitchDecay: 0.01, octaves: 3, envelope: { attack: 0.001, decay: 0.3, sustain: 0 } }).toDestination().triggerAttackRelease("C2", "8n");
      hitSound = () => {
        correctSound.currentTime = 0;
        correctSound.play().catch(e => console.error("Correct sound play failed:", e));
      };
      damageSound = () => new Tone.NoiseSynth({ noise: { type: "pink" }, envelope: { attack: 0.01, decay: 0.3, sustain: 0, release: 0.2 } }).toDestination().triggerAttackRelease("8n");
      victorySound = () => { const s = new Tone.Synth().toDestination(), n = Tone.now(); s.triggerAttackRelease("C5", "8n", n); s.triggerAttackRelease("E5", "8n", n + 0.2); s.triggerAttackRelease("G5", "8n", n + 0.4); s.triggerAttackRelease("C6", "4n", n + 0.6) };
      defeatSound = () => { const s = new Tone.Synth().toDestination(), n = Tone.now(); s.triggerAttackRelease("C4", "4n", n); s.triggerAttackRelease("B3", "4n", n + 0.3); s.triggerAttackRelease("A#3", "4n", n + 0.6); s.triggerAttackRelease("A3", "2n", n + 0.9) };
      audioStarted = true;
    }

    function normalizeEmployeeIdForHTML(v) {
      const digits = String(v == null ? "" : v).replace(/[^\d]/g, "");
      return digits.padStart(5, "0");
    }

    async function startGame() {
      if (!employeeIdInput.checkValidity()) {
        employeeIdInput.reportValidity();
        return;
      }
      const nickname = nicknameInput.value.trim();
      const company = companySelect.value;
      const employeeId = employeeIdInput.value.trim();
      const msgEl = document.getElementById('msg');
      if (!nickname || !company || !employeeId) {
        msgEl.textContent = TEXTS[currentLang].msgEnterId;
        return;
      }
      if (isGameInProgress) return;
      isGameInProgress = true;
      startButton.disabled = true;
      
      bgm.play().catch(e => console.error("BGM play failed:", e));
      clickSound();
      correctCount = 0;
      
      document.getElementById('boss-area').classList.remove('hidden');
      bossContainer.className = 'boss-idle';
      updateHpBars(100);
      switchScreen('quiz');
      
      startTime = Date.now();
      timerInterval = setInterval(() => {
        const elapsedTime = ((Date.now() - startTime) / 1000).toFixed(1);
        document.getElementById('timer-display').textContent = `${elapsedTime}s`;
      }, 100);
      
      displayQuestion(0);
      startButton.disabled = false;
      isGameInProgress = false;
    }

    function displayQuestion(index) {
      const quizData = TEXTS[currentLang].quiz;
      document.getElementById('progress-display').textContent = TEXTS[currentLang].progress(index + 1, quizData.length);
      const current = quizData[index];
      document.getElementById('question-text').textContent = `Q${index + 1}: ${current.q}`;
      const optionsContainer = document.getElementById('options-container');
      optionsContainer.innerHTML = '';
      current.o.forEach(opt => {
        const div = document.createElement('div');
        div.textContent = `▶ ${opt}`;
        div.classList.add('dq-button');
        div.addEventListener('click', () => handleAnswer(opt, current, index));
        optionsContainer.appendChild(div);
      });
    }

    function handleAnswer(selectedAnswer, currentQuiz, index) {
      const isCorrect = selectedAnswer === currentQuiz.a;
      const optionsContainer = document.getElementById('options-container');
      optionsContainer.querySelectorAll('.dq-button').forEach(btn => {
        btn.style.pointerEvents = 'none';
        if (btn.textContent.includes(currentQuiz.a)) {
          btn.classList.add('correct-answer');
        } else {
          btn.classList.add('incorrect-answer');
        }
      });

      if (isCorrect) {
        correctCount++;
        hitSound();
        updateHpBars(100 - (correctCount * (100 / 4)));
        bossContainer.classList.add('shake');
        document.getElementById('explanation-title').textContent = TEXTS[currentLang].correct;
      } else {
        damageSound();
        document.querySelector('.dq-window').classList.add('shake');
        document.getElementById('explanation-title').textContent = TEXTS[currentLang].incorrect;
      }
      
      document.getElementById('explanation-text').textContent = currentQuiz.ex;
      nextQuestionButton.textContent = TEXTS[currentLang].nextButton;
      nextQuestionButton.dataset.nextIndex = index + 1;
      
      setTimeout(() => {
        explanationModal.style.display = 'flex';
      }, 800);
    }
    
    nextQuestionButton.addEventListener('click', () => {
      explanationModal.style.display = 'none';
      bossContainer.classList.remove('shake');
      document.querySelector('.dq-window').classList.remove('shake');
      
      const nextIndex = parseInt(nextQuestionButton.dataset.nextIndex);
      if (nextIndex >= TEXTS[currentLang].quiz.length) {
        showEndScreen();
      } else {
        displayQuestion(nextIndex);
      }
    });

    function showEndScreen() {
      clearInterval(timerInterval);
      bgm.pause();
      bgm.currentTime = 0;
      
      const isVictory = correctCount >= 4;
      if (isVictory) {
        victorySound();
        bossContainer.className = 'boss-defeat';
      } else {
        defeatSound();
      }
      
      setTimeout(() => {
        document.getElementById('boss-area').classList.add('hidden');
        switchScreen('result');
        const t = TEXTS[currentLang];
        document.getElementById('result-title').textContent = isVictory ? t.resultWinTitle : t.resultLoseTitle;
        document.getElementById('result-message').textContent = isVictory ? t.resultWinMsg : t.resultLoseMsg;
        submitResults();
      }, isVictory ? 1500 : 500);
    }

    async function submitResults() {
        const statusEl = document.getElementById('submission-status');
        let ipAddress = 'N/A';
        try {
            const response = await fetch('https://api.ipify.org?format=json');
            ipAddress = (await response.json()).ip;
        } catch (error) {
            console.error('IPアドレスの取得に失敗しました:', error);
        }

        const normalizedEmployeeId = normalizeEmployeeIdForHTML(employeeIdInput.value.trim());
        const payload = {
            nickname: nicknameInput.value.trim(),
            company: companySelect.value,
            employeeId: normalizedEmployeeId,
            stage: STAGE_NUMBER,
            score: correctCount,
            time: ((Date.now() - startTime) / 1000).toFixed(2),
            ipAddress: ipAddress
        };
        statusEl.textContent = TEXTS[currentLang].submitting;
        
        try {
            const response = await fetch(GAS_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/plain;charset=utf-8',
                },
                body: JSON.stringify(payload)
            });

            const result = await response.json();

            if (result.status === 'success') {
                if (result.recorded === false) {
                    statusEl.textContent = TEXTS[currentLang].recordedFalse;
                } else {
                    statusEl.textContent = TEXTS[currentLang].submitSuccess;
                }
            } else {
                statusEl.textContent = result.message || TEXTS[currentLang].submitError;
            }
        } catch (err) {
            statusEl.textContent = TEXTS[currentLang].submitError;
            console.error('Error:', err);
        }
    }

    function updateHpBars(percentage) {
      const hpBar = document.getElementById('boss-hp-bar');
      hpBar.style.width = `${Math.max(0, percentage)}%`;
      if (percentage <= 25) hpBar.className = 'boss-hp-bar low';
      else if (percentage <= 50) hpBar.className = 'boss-hp-bar mid';
      else hpBar.className = 'boss-hp-bar full';
    }
    
    function handleMediaError(element) {
        console.error(`Error loading media: ${element.src}`);
        element.style.display = 'none'; 
    }

    document.getElementById('title-start-button').addEventListener('click', async () => {
      if (!audioStarted) { 
        await Tone.start();
        setupAudio();
      }
      clickSound();
      const openingVideo = document.getElementById('opening-video');
      openingVideo.muted = false;
      openingVideo.play().catch(e => console.log("User interaction might be needed for audio"));
      switchScreen('language');
    });

    document.getElementById('lang-ja').addEventListener('click', () => { clickSound(); currentLang = 'ja'; updateUIText(); switchScreen('instruction'); });
    document.getElementById('lang-en').addEventListener('click', () => { clickSound(); currentLang = 'en'; updateUIText(); switchScreen('instruction'); });
    document.getElementById('lang-zh').addEventListener('click', () => { clickSound(); currentLang = 'zh'; updateUIText(); switchScreen('instruction'); });
    
    document.getElementById('instruction-ok-button').addEventListener('click', () => {
      clickSound();
      openingVideoContainer.classList.add('hidden');
      document.getElementById('opening-video').pause();
      gameVideoContainer.classList.remove('hidden');
      document.getElementById('game-bg-video').play().catch(e => console.log("Game video play failed"));
      switchScreen('start');
    });
    
    startButton.addEventListener('click', startGame);
    document.getElementById('restart-button').addEventListener('click', () => location.reload());

    updateUIText();
    switchScreen('title');
    const openingVideo = document.getElementById('opening-video');
    openingVideo.muted = false;
    openingVideo.play().catch(e => {
        console.log("Autoplay with sound was prevented. Muting and retrying.");
        openingVideo.muted = true;
        openingVideo.play();
    });
  </script>
</body>
</html>
