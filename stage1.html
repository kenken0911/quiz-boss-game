<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sustainable Quest 🗡️ - Stage 1</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
  <style>
    /* --- 全体スタイル --- */
    body {
      font-family: 'DotGothic16', sans-serif;
      /* 迫力を出すため、背景に暗く壮大な画像を設定 */
      background-image: url('https://images.unsplash.com/photo-1531366936337-7c912a4589a7?q=80&w=2070&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D');
      background-size: cover;
      background-position: center;
      color: #fff;
      image-rendering: pixelated;
      overflow: hidden; /* スクロールバーを隠す */
    }
    .dq-window {
      border: 4px solid #fff;
      background: rgba(0, 0, 80, 0.85); /* 背景を少し濃くして可読性を上げる */
      padding: 1.5rem;
      box-shadow: 0 0 0 4px #000, 0 0 20px rgba(0, 128, 255, 0.6);
      backdrop-filter: blur(3px); /* ぼかし効果を少し強く */
    }

    /* --- ボタンのスタイル --- */
    .dq-button {
      cursor: pointer;
      padding: .75rem 1.5rem;
      border: 2px solid #fff;
      background-image: linear-gradient(to bottom, #0055dd, #0033aa);
      text-shadow: 1px 1px 2px #000;
      transition: all 0.2s;
    }
    .dq-button:hover {
      background-image: linear-gradient(to bottom, #4488ff, #0055dd);
      box-shadow: 0 0 10px #fff;
    }
    .dq-button:disabled { background: #555; color: #999; cursor: not-allowed; }

    /* --- タイトル画面の迫力演出 --- */
    #title-screen h1 {
      font-size: 2.5rem; /* タイトルを大きく */
      font-weight: bold;
      /* 炎のようなテキストシャドウで迫力を追加 */
      text-shadow: 0 0 5px #fff, 0 0 10px #ff8a00, 0 0 15px #ff3b00;
      /* フェードインしてスケールアップするアニメーション */
      animation: fadeInTitle 2s ease-out forwards;
    }
    #show-employee-id-screen-button {
      /* ボタンが脈動するように光るアニメーション */
      animation: pulseButton 2.5s infinite ease-in-out;
    }

    /* --- アニメーション定義 --- */
    @keyframes fadeInTitle {
      from { opacity: 0; transform: scale(0.8); }
      to { opacity: 1; transform: scale(1); }
    }
    @keyframes pulseButton {
      0%, 100% {
        transform: scale(1);
        box-shadow: 0 0 10px rgba(255,255,255,0.7), 0 0 20px rgba(0,170,255,0.5);
      }
      50% {
        transform: scale(1.05);
        box-shadow: 0 0 20px rgba(255,255,255,1), 0 0 40px rgba(0,170,255,0.8);
      }
    }

    /* --- その他のゲーム内スタイル --- */
    .correct-answer { background-image: linear-gradient(to bottom, #ffdd00, #ffaa00) !important; color: #000; }
    .incorrect-answer { background-image: linear-gradient(to bottom, #888888, #555555) !important; opacity: 0.7; }
    .boss-hp-container { border: 2px solid #fff; height: 30px; padding: 3px; background: #333; border-radius: 5px; box-shadow: inset 0 0 5px #000; }
    .boss-hp-bar { background-image: linear-gradient(to right, #ff3333, #ff8833); height: 100%; transition: width .5s ease-out; border-radius: 2px; }
    .boss-hp-bar.low { background-image: linear-gradient(to right, #cc0000, #ff3333); }
    .boss-idle { animation: boss-float 2.5s infinite ease-in-out; }
    @keyframes boss-float{ 0%,100% { transform: translateY(0); } 50% { transform: translateY(-12px); } }
    .shake { animation: shake .35s; }
    @keyframes shake { 10%,90% { transform: translate(-2px, -2px); } 20%,80% { transform: translate(3px, 2px); } 30%,50%,70% { transform: translate(-3px, 3px); } 40%,60% { transform: translate(3px, -2px); } }
    .damage-text { position: absolute; font-size: 2.5rem; font-weight: bold; color: #ffcc00; text-shadow: 2px 2px #000, -2px -2px #000; animation: float-up 1.2s forwards; pointer-events: none; }
    @keyframes float-up { from { transform: translateY(0) scale(1); opacity: 1; } to { transform: translateY(-80px) scale(1.5); opacity: 0; } }
    .fire-glow { filter: drop-shadow(0 0 8px #ff8a00) drop-shadow(0 0 16px #ff3b00) contrast(1.5); }
    #boss-img { width: 100%; max-width: 320px; height: auto; }
  </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
  <div class="w-full max-w-3xl mx-auto">
    <div id="boss-area" class="mb-4 h-64 flex justify-center items-end relative hidden">
      <div id="boss-container" class="boss-idle">
        <img id="boss-img" src="https://placehold.co/320x240/000000/ff8a00?text=DRAGON&font=gothic" onerror="this.onerror=null;this.src='https://placehold.co/320x240/000000/ffffff?text=Boss+Image+Error';" alt="ボスの画像" class="fire-glow"/>
      </div>
    </div>
    <div id="game-container" class="w-full dq-window relative">
      <div id="title-screen" class="text-center py-8">
        <h1 class="mb-10">Sustainable Quest 🗡️ Stage１</h1>
        <button id="show-employee-id-screen-button" class="dq-button">スタート</button>
      </div>

      <div id="start-screen" class="text-center hidden">
        <h1 id="title-text" class="text-3xl font-bold mb-4"></h1>
        <p id="subtitle-text" class="text-lg mb-6"></p>
        <div class="flex flex-col items-center gap-3 mb-4">
          <input id="employeeIdInput" type="text" pattern="\d{5}" title="社員番号は5桁の数字で入力してください" class="text-black px-3 py-2 w-64 text-center rounded" />
          <button id="start-button" class="dq-button inline-flex items-center gap-2"><span id="start-button-text"></span></button>
          <div id="msg" class="text-yellow-300 text-sm h-5"></div>
        </div>
      </div>

      <div id="quiz-screen" class="hidden">
        <div class="mb-4"><p id="boss-hp-label"></p><div class="boss-hp-container"><div id="boss-hp-bar" class="boss-hp-bar"></div></div></div>
        <div class="mb-4 min-h-[80px] p-4 border-2 border-white"><p id="question-text" class="text-xl"></p></div>
        <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      </div>

      <div id="result-screen" class="hidden text-center">
        <h2 id="result-title" class="text-3xl font-bold mb-4"></h2>
        <p id="result-message" class="text-xl mb-6"></p>
        <p id="submission-status" class="text-yellow-300 mb-8"></p>
        <div id="restart-button" class="dq-button inline-block"></div>
      </div>

      <div id="explanation-modal" class="absolute inset-0 bg-black bg-opacity-80 flex-col items-center justify-center p-4 hidden">
        <div class="dq-window w-full max-w-2xl text-center">
          <h2 id="explanation-title" class="text-4xl font-bold mb-4"></h2>
          <p id="explanation-text" class="text-lg mb-6 text-left h-48 overflow-y-auto p-2 border"></p>
          <button id="next-question-button" class="dq-button"></button>
        </div>
      </div>
    </div>
  </div>

  <audio id="bgm" src="https://cdn.jsdelivr.net/gh/planethiker/codepen-assets@main/games/dragon-quest-quiz/boss_bgm_8bit.wav" loop></audio>

  <script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbzL7tXBIsRkd-YH3q7RuVHJq4AiTNKDpYI2gAWQe5FUQhZtfQrdd2fGBBejGGSh4GuQig/exec';
    const STAGE_NUMBER = '1';

    const TEXTS = {
      ja: {
        title: "ステージ1：地球環境",
        subtitle: "環境問題の知識で竜を討て！",
        employeeIdPlaceholder: "社員番号(5桁)を入力",
        startButton: "挑戦する",
        msgEnterId: "5桁の社員番号を入力してください",
        bossHp: "ボス HP",
        resultWinTitle: "勝利！",
        resultWinMsg: "ステージクリア！環境への意識が高まった！",
        resultLoseTitle: "敗北...",
        resultLoseMsg: "竜の力は強大だった…",
        submitting: "結果を送信中...",
        submitSuccess: "結果を送信しました！",
        submitError: "エラー：結果を送信できませんでした。",
        restartButton: "最初の画面に戻る",
        correct: "正解！",
        incorrect: "不正解...",
        nextButton: "次へ",
        quiz: [
          { q: "気候変動対策として誤っているものは次のうちどれ？", o: ["省エネや再生可能エネルギーの使用", "森林保全", "気候変動への適応", "海や川のゴミ拾い"], a: "海や川のゴミ拾い", ex: "気候変動対策には、温室効果ガス排出量を削減する「緩和」と、気候変動の影響を軽減する「適応」があります。ゴミ拾いは直接的な気候変動対策にはなりませんが、海洋汚染対策として価値のある活動です。" },
          { q: "廃棄物の発生抑制や資源の有効活用のための考え方「5R」。これに含まれないものは？", o: ["リフューズ(断る)", "リデュース(減らす)", "リペア(修理する)", "リメイン(留まる)"], a: "リメイン(留まる)", ex: "廃棄物抑制の考え方として3R(リデュース、リユース、リサイクル)が提唱され、最近ではリフューズ(断る)、リペア(修理する)を加えた「5R」にまで広がっています。「リメイン(留まる)」は含まれません。" },
          { q: "生物多様性に含まれる「3つのレベルの多様性」に当てはまらないものは？", o: ["生態系の多様性", "種の多様性", "遺伝子の多様性", "文化の多様性"], a: "文化の多様性", ex: "生物多様性とは、地球上の生物が互いに繋がり合って生きている状態のことです。具体的には、「生態系の多様性」、「種の多様性」、「遺伝子の多様性」の3つのレベルでの多様性を含みます。" },
          { q: "ユニクロが実施している、服を回収し難民などに寄贈する活動名は？", o: ["RECYCLE-UNIQLO", "RE:UNIQLO", "REUSE-UNIQLO", "REBORN-UNIQLO"], a: "RE:UNIQLO", ex: "ユニクロは「RE.UNIQLO」という活動を通じて、お客様が着なくなった服を回収し、最大限に活用しています。まだ着られる服は、UNHCRと協力して世界中の難民や被災者に届けられます。" },
          { q: "フェアトレード製品を買うことが貧困問題の解決に繋がる主な理由は？", o: ["製品が無料で配布されるから", "製品の価格が安いから", "売上が全て寄付されるから", "生産者に公正な賃金が支払われるから"], a: "生産者に公正な賃金が支払われるから", ex: "フェアトレードの最も重要な原則の一つは、生産者に公正な価格を保証し、安定した収入を提供することです。これにより、彼らは生活を改善し、教育や医療に投資できるようになります。" }
        ]
      }
    };

    const currentLang = 'ja';

    const titleScreen = document.getElementById('title-screen');
    const showEmployeeIdScreenButton = document.getElementById('show-employee-id-screen-button');
    const startScreen = document.getElementById('start-screen');
    const quizScreen = document.getElementById('quiz-screen');
    const resultScreen = document.getElementById('result-screen');
    const bossArea = document.getElementById('boss-area');
    const bossContainer = document.getElementById('boss-container');
    const startButton = document.getElementById('start-button');
    const restartButton = document.getElementById('restart-button');
    const bossHpBar = document.getElementById('boss-hp-bar');
    const questionText = document.getElementById('question-text');
    const optionsContainer = document.getElementById('options-container');
    const employeeIdInput = document.getElementById('employeeIdInput');
    const msgEl = document.getElementById('msg');
    const bgm = document.getElementById('bgm');
    const explanationModal = document.getElementById('explanation-modal');
    const nextQuestionButton = document.getElementById('next-question-button');

    let currentQuestionIndex, bossHP, audioStarted = false, isGameInProgress = false, correctCount;
    const BOSS_MAX_HP = 100;

    function updateUIText() {
      const t = TEXTS[currentLang];
      document.body.lang = currentLang;
      document.getElementById('title-text').textContent = t.title;
      document.getElementById('subtitle-text').textContent = t.subtitle;
      employeeIdInput.placeholder = t.employeeIdPlaceholder;
      document.getElementById('start-button-text').textContent = t.startButton;
      document.getElementById('boss-hp-label').textContent = t.bossHp;
      restartButton.textContent = t.restartButton;
    }

    showEmployeeIdScreenButton.addEventListener('click', () => {
        if (!audioStarted) {
            Tone.start().then(setupAudio);
        }
        clickSound();
        titleScreen.classList.add('hidden');
        startScreen.classList.remove('hidden');
    });

    startButton.addEventListener('click', startGame);

    restartButton.addEventListener('click', () => {
        resultScreen.classList.add('hidden');
        titleScreen.classList.remove('hidden');
        employeeIdInput.value = '';
    });

    async function startGame(event) {
      if (!employeeIdInput.checkValidity()) {
        employeeIdInput.reportValidity();
        return;
      }
      if (isGameInProgress) return;
      isGameInProgress = true;
      startButton.disabled = true;

      if (!audioStarted) {
        await Tone.start();
        setupAudio();
      }

      bgm.play().catch(e => console.error("BGM play failed:", e));
      clickSound();
      const employeeId = employeeIdInput.value.trim();
      if (!employeeId) {
        msgEl.textContent = TEXTS[currentLang].msgEnterId;
        isGameInProgress = false;
        startButton.disabled = false;
        return;
      }
      bossHP = BOSS_MAX_HP;
      currentQuestionIndex = 0;
      correctCount = 0;
      updateHpBars();
      startScreen.classList.add('hidden');
      quizScreen.classList.remove('hidden');
      bossArea.classList.remove('hidden');
      msgEl.textContent = "";
      displayQuestion();
      startButton.disabled = false;
    }

    function displayQuestion() {
      const quizData = TEXTS[currentLang].quiz;
      if (currentQuestionIndex >= quizData.length) {
        showEndScreen();
        return;
      }
      optionsContainer.innerHTML = '';
      const current = quizData[currentQuestionIndex];
      questionText.textContent = `Q${currentQuestionIndex + 1}: ${current.q}`;
      current.o.forEach(opt => {
        const div = document.createElement('div');
        div.textContent = `▶ ${opt}`;
        div.classList.add('dq-button');
        div.addEventListener('click', () => handleAnswer(opt, current));
        optionsContainer.appendChild(div);
      });
    }

    function handleAnswer(selectedAnswer, currentQuiz) {
      const isCorrect = selectedAnswer === currentQuiz.a;
      optionsContainer.querySelectorAll('.dq-button').forEach(btn => {
        btn.style.pointerEvents = 'none';
        if (btn.textContent.includes(currentQuiz.a)) {
          btn.classList.add('correct-answer');
        } else {
          btn.classList.add('incorrect-answer');
        }
      });

      if (isCorrect) {
        correctCount++;
        hitSound();
        bossHP = Math.max(0, bossHP - (BOSS_MAX_HP / 5));
        showDamage();
        bossContainer.classList.add('shake');
        document.getElementById('explanation-title').textContent = TEXTS[currentLang].correct;
      } else {
        damageSound();
        document.querySelector('.dq-window').classList.add('shake');
        document.getElementById('explanation-title').textContent = TEXTS[currentLang].incorrect;
      }
      updateHpBars();
      document.getElementById('explanation-text').textContent = currentQuiz.ex;
      nextQuestionButton.textContent = TEXTS[currentLang].nextButton;
      setTimeout(() => {
        explanationModal.style.display = 'flex';
      }, 800);
    }

    nextQuestionButton.addEventListener('click', () => {
      explanationModal.style.display = 'none';
      bossContainer.classList.remove('shake');
      document.querySelector('.dq-window').classList.remove('shake');
      currentQuestionIndex++;
      if (bossHP <= 0 || currentQuestionIndex >= 5) {
        showEndScreen();
      } else {
        displayQuestion();
      }
    });

    function showEndScreen() {
      bgm.pause();
      bgm.currentTime = 0;
      quizScreen.classList.add('hidden');
      bossArea.classList.add('hidden');
      resultScreen.classList.remove('hidden');
      const t = TEXTS[currentLang];
      if (correctCount >= 4) {
        victorySound();
        document.getElementById('result-title').textContent = t.resultWinTitle;
        document.getElementById('result-message').textContent = t.resultWinMsg;
      } else {
        defeatSound();
        document.getElementById('result-title').textContent = t.resultLoseTitle;
        document.getElementById('result-message').textContent = t.resultLoseMsg;
      }
      submitResults();
      isGameInProgress = false;
    }

    function submitResults() {
      const employeeId = employeeIdInput.value.trim();
      const statusEl = document.getElementById('submission-status');
      if (!employeeId) return;
      const payload = { employeeId: employeeId, stage: STAGE_NUMBER, score: correctCount };
      statusEl.textContent = TEXTS[currentLang].submitting;
      fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload), mode: 'no-cors' })
        .then(res => {
            statusEl.textContent = TEXTS[currentLang].submitSuccess;
        })
        .catch(err => {
            statusEl.textContent = TEXTS[currentLang].submitError;
            console.error('Error:', err);
        });
    }

    function updateHpBars() {
      const b = (bossHP / BOSS_MAX_HP) * 100;
      bossHpBar.style.width = `${b}%`;
      bossHpBar.classList.toggle('low', b < 30);
    }

    function showDamage() {
      const d = document.createElement('div');
      d.textContent = Math.floor(Math.random() * 50) + 200;
      d.className = 'damage-text';
      bossArea.appendChild(d);
      setTimeout(() => d.remove(), 1200);
    }

    let hitSound, damageSound, victorySound, defeatSound, clickSound;
    function setupAudio() {
      if (audioStarted) return;
      hitSound = () => new Tone.Synth({ oscillator: { type: "fmsquare" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.0, release: 0.1 } }).toDestination().triggerAttackRelease("C5", "16n");
      damageSound = () => new Tone.NoiseSynth({ noise: { type: "pink" }, envelope: { attack: 0.01, decay: 0.3, sustain: 0, release: 0.2 } }).toDestination().triggerAttackRelease("8n");
      victorySound = () => { const s = new Tone.Synth().toDestination(), n = Tone.now(); s.triggerAttackRelease("C5", "8n", n); s.triggerAttackRelease("E5", "8n", n + 0.2); s.triggerAttackRelease("G5", "8n", n + 0.4); s.triggerAttackRelease("C6", "4n", n + 0.6) };
      defeatSound = () => { const s = new Tone.Synth().toDestination(), n = Tone.now(); s.triggerAttackRelease("C4", "4n", n); s.triggerAttackRelease("B3", "4n", n + 0.3); s.triggerAttackRelease("A#3", "4n", n + 0.6); s.triggerAttackRelease("A3", "2n", n + 0.9) };
      clickSound = () => new Tone.MembraneSynth({ pitchDecay: 0.01, octaves: 3, envelope: { attack: 0.001, decay: 0.3, sustain: 0 } }).toDestination().triggerAttackRelease("C2", "8n");
      audioStarted = true;
    }

    updateUIText();
  </script>
</body>
</html>
