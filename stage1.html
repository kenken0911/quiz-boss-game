<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sustainable Quest ğŸ—¡ï¸ - Stage 1</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
  <style>
    /* --- å…¨ä½“ã‚¹ã‚¿ã‚¤ãƒ« --- */
    body {
      font-family: 'DotGothic16', sans-serif;
      /* è¿«åŠ›ã‚’å‡ºã™ãŸã‚ã€èƒŒæ™¯ã«æš—ãå£®å¤§ãªç”»åƒã‚’è¨­å®š */
      background-image: url('https://images.unsplash.com/photo-1531366936337-7c912a4589a7?q=80&w=2070&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D');
      background-size: cover;
      background-position: center;
      color: #fff;
      image-rendering: pixelated;
      overflow: hidden; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’éš ã™ */
    }
    .dq-window {
      border: 4px solid #fff;
      background: rgba(0, 0, 80, 0.85); /* èƒŒæ™¯ã‚’å°‘ã—æ¿ƒãã—ã¦å¯èª­æ€§ã‚’ä¸Šã’ã‚‹ */
      padding: 1.5rem;
      box-shadow: 0 0 0 4px #000, 0 0 20px rgba(0, 128, 255, 0.6);
      backdrop-filter: blur(3px); /* ã¼ã‹ã—åŠ¹æœã‚’å°‘ã—å¼·ã */
    }

    /* --- ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
    .dq-button {
      cursor: pointer;
      padding: .75rem 1.5rem;
      border: 2px solid #fff;
      background-image: linear-gradient(to bottom, #0055dd, #0033aa);
      text-shadow: 1px 1px 2px #000;
      transition: all 0.2s;
    }
    .dq-button:hover {
      background-image: linear-gradient(to bottom, #4488ff, #0055dd);
      box-shadow: 0 0 10px #fff;
    }
    .dq-button:disabled { background: #555; color: #999; cursor: not-allowed; }

    /* --- ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ã®è¿«åŠ›æ¼”å‡º --- */
    #title-screen h1 {
      font-size: 2.5rem; /* ã‚¿ã‚¤ãƒˆãƒ«ã‚’å¤§ãã */
      font-weight: bold;
      /* ç‚ã®ã‚ˆã†ãªãƒ†ã‚­ã‚¹ãƒˆã‚·ãƒ£ãƒ‰ã‚¦ã§è¿«åŠ›ã‚’è¿½åŠ  */
      text-shadow: 0 0 5px #fff, 0 0 10px #ff8a00, 0 0 15px #ff3b00;
      /* ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ã—ã¦ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ãƒƒãƒ—ã™ã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
      animation: fadeInTitle 2s ease-out forwards;
    }
    #show-employee-id-screen-button {
      /* ãƒœã‚¿ãƒ³ãŒè„ˆå‹•ã™ã‚‹ã‚ˆã†ã«å…‰ã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
      animation: pulseButton 2.5s infinite ease-in-out;
    }

    /* --- ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®šç¾© --- */
    @keyframes fadeInTitle {
      from { opacity: 0; transform: scale(0.8); }
      to { opacity: 1; transform: scale(1); }
    }
    @keyframes pulseButton {
      0%, 100% {
        transform: scale(1);
        box-shadow: 0 0 10px rgba(255,255,255,0.7), 0 0 20px rgba(0,170,255,0.5);
      }
      50% {
        transform: scale(1.05);
        box-shadow: 0 0 20px rgba(255,255,255,1), 0 0 40px rgba(0,170,255,0.8);
      }
    }

    /* --- ãã®ä»–ã®ã‚²ãƒ¼ãƒ å†…ã‚¹ã‚¿ã‚¤ãƒ« --- */
    .correct-answer { background-image: linear-gradient(to bottom, #ffdd00, #ffaa00) !important; color: #000; }
    .incorrect-answer { background-image: linear-gradient(to bottom, #888888, #555555) !important; opacity: 0.7; }
    .boss-hp-container { border: 2px solid #fff; height: 30px; padding: 3px; background: #333; border-radius: 5px; box-shadow: inset 0 0 5px #000; }
    .boss-hp-bar { background-image: linear-gradient(to right, #ff3333, #ff8833); height: 100%; transition: width .5s ease-out; border-radius: 2px; }
    .boss-hp-bar.low { background-image: linear-gradient(to right, #cc0000, #ff3333); }
    .boss-idle { animation: boss-float 2.5s infinite ease-in-out; }
    @keyframes boss-float{ 0%,100% { transform: translateY(0); } 50% { transform: translateY(-12px); } }
    .shake { animation: shake .35s; }
    @keyframes shake { 10%,90% { transform: translate(-2px, -2px); } 20%,80% { transform: translate(3px, 2px); } 30%,50%,70% { transform: translate(-3px, 3px); } 40%,60% { transform: translate(3px, -2px); } }
    .damage-text { position: absolute; font-size: 2.5rem; font-weight: bold; color: #ffcc00; text-shadow: 2px 2px #000, -2px -2px #000; animation: float-up 1.2s forwards; pointer-events: none; }
    @keyframes float-up { from { transform: translateY(0) scale(1); opacity: 1; } to { transform: translateY(-80px) scale(1.5); opacity: 0; } }
    .fire-glow { filter: drop-shadow(0 0 8px #ff8a00) drop-shadow(0 0 16px #ff3b00) contrast(1.5); }
    #boss-img { width: 100%; max-width: 320px; height: auto; }
  </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
  <div class="w-full max-w-3xl mx-auto">
    <div id="boss-area" class="mb-4 h-64 flex justify-center items-end relative hidden">
      <div id="boss-container" class="boss-idle">
        <img id="boss-img" src="https://placehold.co/320x240/000000/ff8a00?text=DRAGON&font=gothic" onerror="this.onerror=null;this.src='https://placehold.co/320x240/000000/ffffff?text=Boss+Image+Error';" alt="ãƒœã‚¹ã®ç”»åƒ" class="fire-glow"/>
      </div>
    </div>
    <div id="game-container" class="w-full dq-window relative">
      <div id="title-screen" class="text-center py-8">
        <h1 class="mb-10">Sustainable Quest ğŸ—¡ï¸ Stageï¼‘</h1>
        <button id="show-employee-id-screen-button" class="dq-button">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
      </div>

      <div id="start-screen" class="text-center hidden">
        <h1 id="title-text" class="text-3xl font-bold mb-4"></h1>
        <p id="subtitle-text" class="text-lg mb-6"></p>
        <div class="flex flex-col items-center gap-3 mb-4">
          <input id="employeeIdInput" type="text" pattern="\d{5}" title="ç¤¾å“¡ç•ªå·ã¯5æ¡ã®æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„" class="text-black px-3 py-2 w-64 text-center rounded" />
          <button id="start-button" class="dq-button inline-flex items-center gap-2"><span id="start-button-text"></span></button>
          <div id="msg" class="text-yellow-300 text-sm h-5"></div>
        </div>
      </div>

      <div id="quiz-screen" class="hidden">
        <div class="mb-4"><p id="boss-hp-label"></p><div class="boss-hp-container"><div id="boss-hp-bar" class="boss-hp-bar"></div></div></div>
        <div class="mb-4 min-h-[80px] p-4 border-2 border-white"><p id="question-text" class="text-xl"></p></div>
        <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      </div>

      <div id="result-screen" class="hidden text-center">
        <h2 id="result-title" class="text-3xl font-bold mb-4"></h2>
        <p id="result-message" class="text-xl mb-6"></p>
        <p id="submission-status" class="text-yellow-300 mb-8"></p>
        <div id="restart-button" class="dq-button inline-block"></div>
      </div>

      <div id="explanation-modal" class="absolute inset-0 bg-black bg-opacity-80 flex-col items-center justify-center p-4 hidden">
        <div class="dq-window w-full max-w-2xl text-center">
          <h2 id="explanation-title" class="text-4xl font-bold mb-4"></h2>
          <p id="explanation-text" class="text-lg mb-6 text-left h-48 overflow-y-auto p-2 border"></p>
          <button id="next-question-button" class="dq-button"></button>
        </div>
      </div>
    </div>
  </div>

  <audio id="bgm" src="https://cdn.jsdelivr.net/gh/planethiker/codepen-assets@main/games/dragon-quest-quiz/boss_bgm_8bit.wav" loop></audio>

  <script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbzL7tXBIsRkd-YH3q7RuVHJq4AiTNKDpYI2gAWQe5FUQhZtfQrdd2fGBBejGGSh4GuQig/exec';
    const STAGE_NUMBER = '1';

    const TEXTS = {
      ja: {
        title: "ã‚¹ãƒ†ãƒ¼ã‚¸1ï¼šåœ°çƒç’°å¢ƒ",
        subtitle: "ç’°å¢ƒå•é¡Œã®çŸ¥è­˜ã§ç«œã‚’è¨ã¦ï¼",
        employeeIdPlaceholder: "ç¤¾å“¡ç•ªå·(5æ¡)ã‚’å…¥åŠ›",
        startButton: "æŒ‘æˆ¦ã™ã‚‹",
        msgEnterId: "5æ¡ã®ç¤¾å“¡ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„",
        bossHp: "ãƒœã‚¹ HP",
        resultWinTitle: "å‹åˆ©ï¼",
        resultWinMsg: "ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¯ãƒªã‚¢ï¼ç’°å¢ƒã¸ã®æ„è­˜ãŒé«˜ã¾ã£ãŸï¼",
        resultLoseTitle: "æ•—åŒ—...",
        resultLoseMsg: "ç«œã®åŠ›ã¯å¼·å¤§ã ã£ãŸâ€¦",
        submitting: "çµæœã‚’é€ä¿¡ä¸­...",
        submitSuccess: "çµæœã‚’é€ä¿¡ã—ã¾ã—ãŸï¼",
        submitError: "ã‚¨ãƒ©ãƒ¼ï¼šçµæœã‚’é€ä¿¡ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚",
        restartButton: "æœ€åˆã®ç”»é¢ã«æˆ»ã‚‹",
        correct: "æ­£è§£ï¼",
        incorrect: "ä¸æ­£è§£...",
        nextButton: "æ¬¡ã¸",
        quiz: [
          { q: "æ°—å€™å¤‰å‹•å¯¾ç­–ã¨ã—ã¦èª¤ã£ã¦ã„ã‚‹ã‚‚ã®ã¯æ¬¡ã®ã†ã¡ã©ã‚Œï¼Ÿ", o: ["çœã‚¨ãƒã‚„å†ç”Ÿå¯èƒ½ã‚¨ãƒãƒ«ã‚®ãƒ¼ã®ä½¿ç”¨", "æ£®æ—ä¿å…¨", "æ°—å€™å¤‰å‹•ã¸ã®é©å¿œ", "æµ·ã‚„å·ã®ã‚´ãƒŸæ‹¾ã„"], a: "æµ·ã‚„å·ã®ã‚´ãƒŸæ‹¾ã„", ex: "æ°—å€™å¤‰å‹•å¯¾ç­–ã«ã¯ã€æ¸©å®¤åŠ¹æœã‚¬ã‚¹æ’å‡ºé‡ã‚’å‰Šæ¸›ã™ã‚‹ã€Œç·©å’Œã€ã¨ã€æ°—å€™å¤‰å‹•ã®å½±éŸ¿ã‚’è»½æ¸›ã™ã‚‹ã€Œé©å¿œã€ãŒã‚ã‚Šã¾ã™ã€‚ã‚´ãƒŸæ‹¾ã„ã¯ç›´æ¥çš„ãªæ°—å€™å¤‰å‹•å¯¾ç­–ã«ã¯ãªã‚Šã¾ã›ã‚“ãŒã€æµ·æ´‹æ±šæŸ“å¯¾ç­–ã¨ã—ã¦ä¾¡å€¤ã®ã‚ã‚‹æ´»å‹•ã§ã™ã€‚" },
          { q: "å»ƒæ£„ç‰©ã®ç™ºç”ŸæŠ‘åˆ¶ã‚„è³‡æºã®æœ‰åŠ¹æ´»ç”¨ã®ãŸã‚ã®è€ƒãˆæ–¹ã€Œ5Rã€ã€‚ã“ã‚Œã«å«ã¾ã‚Œãªã„ã‚‚ã®ã¯ï¼Ÿ", o: ["ãƒªãƒ•ãƒ¥ãƒ¼ã‚º(æ–­ã‚‹)", "ãƒªãƒ‡ãƒ¥ãƒ¼ã‚¹(æ¸›ã‚‰ã™)", "ãƒªãƒšã‚¢(ä¿®ç†ã™ã‚‹)", "ãƒªãƒ¡ã‚¤ãƒ³(ç•™ã¾ã‚‹)"], a: "ãƒªãƒ¡ã‚¤ãƒ³(ç•™ã¾ã‚‹)", ex: "å»ƒæ£„ç‰©æŠ‘åˆ¶ã®è€ƒãˆæ–¹ã¨ã—ã¦3R(ãƒªãƒ‡ãƒ¥ãƒ¼ã‚¹ã€ãƒªãƒ¦ãƒ¼ã‚¹ã€ãƒªã‚µã‚¤ã‚¯ãƒ«)ãŒæå”±ã•ã‚Œã€æœ€è¿‘ã§ã¯ãƒªãƒ•ãƒ¥ãƒ¼ã‚º(æ–­ã‚‹)ã€ãƒªãƒšã‚¢(ä¿®ç†ã™ã‚‹)ã‚’åŠ ãˆãŸã€Œ5Rã€ã«ã¾ã§åºƒãŒã£ã¦ã„ã¾ã™ã€‚ã€Œãƒªãƒ¡ã‚¤ãƒ³(ç•™ã¾ã‚‹)ã€ã¯å«ã¾ã‚Œã¾ã›ã‚“ã€‚" },
          { q: "ç”Ÿç‰©å¤šæ§˜æ€§ã«å«ã¾ã‚Œã‚‹ã€Œ3ã¤ã®ãƒ¬ãƒ™ãƒ«ã®å¤šæ§˜æ€§ã€ã«å½“ã¦ã¯ã¾ã‚‰ãªã„ã‚‚ã®ã¯ï¼Ÿ", o: ["ç”Ÿæ…‹ç³»ã®å¤šæ§˜æ€§", "ç¨®ã®å¤šæ§˜æ€§", "éºä¼å­ã®å¤šæ§˜æ€§", "æ–‡åŒ–ã®å¤šæ§˜æ€§"], a: "æ–‡åŒ–ã®å¤šæ§˜æ€§", ex: "ç”Ÿç‰©å¤šæ§˜æ€§ã¨ã¯ã€åœ°çƒä¸Šã®ç”Ÿç‰©ãŒäº’ã„ã«ç¹‹ãŒã‚Šåˆã£ã¦ç”Ÿãã¦ã„ã‚‹çŠ¶æ…‹ã®ã“ã¨ã§ã™ã€‚å…·ä½“çš„ã«ã¯ã€ã€Œç”Ÿæ…‹ç³»ã®å¤šæ§˜æ€§ã€ã€ã€Œç¨®ã®å¤šæ§˜æ€§ã€ã€ã€Œéºä¼å­ã®å¤šæ§˜æ€§ã€ã®3ã¤ã®ãƒ¬ãƒ™ãƒ«ã§ã®å¤šæ§˜æ€§ã‚’å«ã¿ã¾ã™ã€‚" },
          { q: "ãƒ¦ãƒ‹ã‚¯ãƒ­ãŒå®Ÿæ–½ã—ã¦ã„ã‚‹ã€æœã‚’å›åã—é›£æ°‘ãªã©ã«å¯„è´ˆã™ã‚‹æ´»å‹•åã¯ï¼Ÿ", o: ["RECYCLE-UNIQLO", "RE:UNIQLO", "REUSE-UNIQLO", "REBORN-UNIQLO"], a: "RE:UNIQLO", ex: "ãƒ¦ãƒ‹ã‚¯ãƒ­ã¯ã€ŒRE.UNIQLOã€ã¨ã„ã†æ´»å‹•ã‚’é€šã˜ã¦ã€ãŠå®¢æ§˜ãŒç€ãªããªã£ãŸæœã‚’å›åã—ã€æœ€å¤§é™ã«æ´»ç”¨ã—ã¦ã„ã¾ã™ã€‚ã¾ã ç€ã‚‰ã‚Œã‚‹æœã¯ã€UNHCRã¨å”åŠ›ã—ã¦ä¸–ç•Œä¸­ã®é›£æ°‘ã‚„è¢«ç½è€…ã«å±Šã‘ã‚‰ã‚Œã¾ã™ã€‚" },
          { q: "ãƒ•ã‚§ã‚¢ãƒˆãƒ¬ãƒ¼ãƒ‰è£½å“ã‚’è²·ã†ã“ã¨ãŒè²§å›°å•é¡Œã®è§£æ±ºã«ç¹‹ãŒã‚‹ä¸»ãªç†ç”±ã¯ï¼Ÿ", o: ["è£½å“ãŒç„¡æ–™ã§é…å¸ƒã•ã‚Œã‚‹ã‹ã‚‰", "è£½å“ã®ä¾¡æ ¼ãŒå®‰ã„ã‹ã‚‰", "å£²ä¸ŠãŒå…¨ã¦å¯„ä»˜ã•ã‚Œã‚‹ã‹ã‚‰", "ç”Ÿç”£è€…ã«å…¬æ­£ãªè³ƒé‡‘ãŒæ”¯æ‰•ã‚ã‚Œã‚‹ã‹ã‚‰"], a: "ç”Ÿç”£è€…ã«å…¬æ­£ãªè³ƒé‡‘ãŒæ”¯æ‰•ã‚ã‚Œã‚‹ã‹ã‚‰", ex: "ãƒ•ã‚§ã‚¢ãƒˆãƒ¬ãƒ¼ãƒ‰ã®æœ€ã‚‚é‡è¦ãªåŸå‰‡ã®ä¸€ã¤ã¯ã€ç”Ÿç”£è€…ã«å…¬æ­£ãªä¾¡æ ¼ã‚’ä¿è¨¼ã—ã€å®‰å®šã—ãŸåå…¥ã‚’æä¾›ã™ã‚‹ã“ã¨ã§ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€å½¼ã‚‰ã¯ç”Ÿæ´»ã‚’æ”¹å–„ã—ã€æ•™è‚²ã‚„åŒ»ç™‚ã«æŠ•è³‡ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚" }
        ]
      }
    };

    const currentLang = 'ja';

    const titleScreen = document.getElementById('title-screen');
    const showEmployeeIdScreenButton = document.getElementById('show-employee-id-screen-button');
    const startScreen = document.getElementById('start-screen');
    const quizScreen = document.getElementById('quiz-screen');
    const resultScreen = document.getElementById('result-screen');
    const bossArea = document.getElementById('boss-area');
    const bossContainer = document.getElementById('boss-container');
    const startButton = document.getElementById('start-button');
    const restartButton = document.getElementById('restart-button');
    const bossHpBar = document.getElementById('boss-hp-bar');
    const questionText = document.getElementById('question-text');
    const optionsContainer = document.getElementById('options-container');
    const employeeIdInput = document.getElementById('employeeIdInput');
    const msgEl = document.getElementById('msg');
    const bgm = document.getElementById('bgm');
    const explanationModal = document.getElementById('explanation-modal');
    const nextQuestionButton = document.getElementById('next-question-button');

    let currentQuestionIndex, bossHP, audioStarted = false, isGameInProgress = false, correctCount;
    const BOSS_MAX_HP = 100;

    function updateUIText() {
      const t = TEXTS[currentLang];
      document.body.lang = currentLang;
      document.getElementById('title-text').textContent = t.title;
      document.getElementById('subtitle-text').textContent = t.subtitle;
      employeeIdInput.placeholder = t.employeeIdPlaceholder;
      document.getElementById('start-button-text').textContent = t.startButton;
      document.getElementById('boss-hp-label').textContent = t.bossHp;
      restartButton.textContent = t.restartButton;
    }

    showEmployeeIdScreenButton.addEventListener('click', () => {
        if (!audioStarted) {
            Tone.start().then(setupAudio);
        }
        clickSound();
        titleScreen.classList.add('hidden');
        startScreen.classList.remove('hidden');
    });

    startButton.addEventListener('click', startGame);

    restartButton.addEventListener('click', () => {
        resultScreen.classList.add('hidden');
        titleScreen.classList.remove('hidden');
        employeeIdInput.value = '';
    });

    async function startGame(event) {
      if (!employeeIdInput.checkValidity()) {
        employeeIdInput.reportValidity();
        return;
      }
      if (isGameInProgress) return;
      isGameInProgress = true;
      startButton.disabled = true;

      if (!audioStarted) {
        await Tone.start();
        setupAudio();
      }

      bgm.play().catch(e => console.error("BGM play failed:", e));
      clickSound();
      const employeeId = employeeIdInput.value.trim();
      if (!employeeId) {
        msgEl.textContent = TEXTS[currentLang].msgEnterId;
        isGameInProgress = false;
        startButton.disabled = false;
        return;
      }
      bossHP = BOSS_MAX_HP;
      currentQuestionIndex = 0;
      correctCount = 0;
      updateHpBars();
      startScreen.classList.add('hidden');
      quizScreen.classList.remove('hidden');
      bossArea.classList.remove('hidden');
      msgEl.textContent = "";
      displayQuestion();
      startButton.disabled = false;
    }

    function displayQuestion() {
      const quizData = TEXTS[currentLang].quiz;
      if (currentQuestionIndex >= quizData.length) {
        showEndScreen();
        return;
      }
      optionsContainer.innerHTML = '';
      const current = quizData[currentQuestionIndex];
      questionText.textContent = `Q${currentQuestionIndex + 1}: ${current.q}`;
      current.o.forEach(opt => {
        const div = document.createElement('div');
        div.textContent = `â–¶ ${opt}`;
        div.classList.add('dq-button');
        div.addEventListener('click', () => handleAnswer(opt, current));
        optionsContainer.appendChild(div);
      });
    }

    function handleAnswer(selectedAnswer, currentQuiz) {
      const isCorrect = selectedAnswer === currentQuiz.a;
      optionsContainer.querySelectorAll('.dq-button').forEach(btn => {
        btn.style.pointerEvents = 'none';
        if (btn.textContent.includes(currentQuiz.a)) {
          btn.classList.add('correct-answer');
        } else {
          btn.classList.add('incorrect-answer');
        }
      });

      if (isCorrect) {
        correctCount++;
        hitSound();
        bossHP = Math.max(0, bossHP - (BOSS_MAX_HP / 5));
        showDamage();
        bossContainer.classList.add('shake');
        document.getElementById('explanation-title').textContent = TEXTS[currentLang].correct;
      } else {
        damageSound();
        document.querySelector('.dq-window').classList.add('shake');
        document.getElementById('explanation-title').textContent = TEXTS[currentLang].incorrect;
      }
      updateHpBars();
      document.getElementById('explanation-text').textContent = currentQuiz.ex;
      nextQuestionButton.textContent = TEXTS[currentLang].nextButton;
      setTimeout(() => {
        explanationModal.style.display = 'flex';
      }, 800);
    }

    nextQuestionButton.addEventListener('click', () => {
      explanationModal.style.display = 'none';
      bossContainer.classList.remove('shake');
      document.querySelector('.dq-window').classList.remove('shake');
      currentQuestionIndex++;
      if (bossHP <= 0 || currentQuestionIndex >= 5) {
        showEndScreen();
      } else {
        displayQuestion();
      }
    });

    function showEndScreen() {
      bgm.pause();
      bgm.currentTime = 0;
      quizScreen.classList.add('hidden');
      bossArea.classList.add('hidden');
      resultScreen.classList.remove('hidden');
      const t = TEXTS[currentLang];
      if (correctCount >= 4) {
        victorySound();
        document.getElementById('result-title').textContent = t.resultWinTitle;
        document.getElementById('result-message').textContent = t.resultWinMsg;
      } else {
        defeatSound();
        document.getElementById('result-title').textContent = t.resultLoseTitle;
        document.getElementById('result-message').textContent = t.resultLoseMsg;
      }
      submitResults();
      isGameInProgress = false;
    }

    function submitResults() {
      const employeeId = employeeIdInput.value.trim();
      const statusEl = document.getElementById('submission-status');
      if (!employeeId) return;
      const payload = { employeeId: employeeId, stage: STAGE_NUMBER, score: correctCount };
      statusEl.textContent = TEXTS[currentLang].submitting;
      fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload), mode: 'no-cors' })
        .then(res => {
            statusEl.textContent = TEXTS[currentLang].submitSuccess;
        })
        .catch(err => {
            statusEl.textContent = TEXTS[currentLang].submitError;
            console.error('Error:', err);
        });
    }

    function updateHpBars() {
      const b = (bossHP / BOSS_MAX_HP) * 100;
      bossHpBar.style.width = `${b}%`;
      bossHpBar.classList.toggle('low', b < 30);
    }

    function showDamage() {
      const d = document.createElement('div');
      d.textContent = Math.floor(Math.random() * 50) + 200;
      d.className = 'damage-text';
      bossArea.appendChild(d);
      setTimeout(() => d.remove(), 1200);
    }

    let hitSound, damageSound, victorySound, defeatSound, clickSound;
    function setupAudio() {
      if (audioStarted) return;
      hitSound = () => new Tone.Synth({ oscillator: { type: "fmsquare" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.0, release: 0.1 } }).toDestination().triggerAttackRelease("C5", "16n");
      damageSound = () => new Tone.NoiseSynth({ noise: { type: "pink" }, envelope: { attack: 0.01, decay: 0.3, sustain: 0, release: 0.2 } }).toDestination().triggerAttackRelease("8n");
      victorySound = () => { const s = new Tone.Synth().toDestination(), n = Tone.now(); s.triggerAttackRelease("C5", "8n", n); s.triggerAttackRelease("E5", "8n", n + 0.2); s.triggerAttackRelease("G5", "8n", n + 0.4); s.triggerAttackRelease("C6", "4n", n + 0.6) };
      defeatSound = () => { const s = new Tone.Synth().toDestination(), n = Tone.now(); s.triggerAttackRelease("C4", "4n", n); s.triggerAttackRelease("B3", "4n", n + 0.3); s.triggerAttackRelease("A#3", "4n", n + 0.6); s.triggerAttackRelease("A3", "2n", n + 0.9) };
      clickSound = () => new Tone.MembraneSynth({ pitchDecay: 0.01, octaves: 3, envelope: { attack: 0.001, decay: 0.3, sustain: 0 } }).toDestination().triggerAttackRelease("C2", "8n");
      audioStarted = true;
    }

    updateUIText();
  </script>
</body>
</html>
