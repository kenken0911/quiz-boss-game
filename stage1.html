<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sustainability Quest üó°Ô∏è - Stage 1</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=Press+Start+2P&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
  <style>
    body[lang="ja"], body[lang="zh"] { font-family: 'DotGothic16', sans-serif; }
    body[lang="en"] { font-family: 'Press Start 2P', cursive; }
    body { background-color: #000; color: #fff; image-rendering: pixelated; overflow-x: hidden; overflow-y: auto; }
    .dq-window { border: 4px solid #fff; background: rgba(0,0,80,0.85); padding: 1.5rem; box-shadow: 0 0 0 4px #000, 0 0 20px rgba(0,128,255,0.6); backdrop-filter: blur(3px); }
    .dq-button { cursor: pointer; padding: .75rem 1.5rem; border: 2px solid #fff; background-image: linear-gradient(to bottom, #0055dd, #0033aa); text-shadow: 1px 1px 2px #000; transition: all 0.2s; }
    .dq-button:hover { background-image: linear-gradient(to bottom, #4488ff, #0055dd); box-shadow: 0 0 10px #fff; }
    .video-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
    .bg-video { width: 100%; height: 100%; object-fit: cover; }
    #title-screen h1 { font-size: 2.5rem; font-weight: bold; text-shadow: 0 0 5px #fff, 0 0 15px #fff, 0 0 25px #00aaff; animation: fadeInTitle 2s ease-out forwards; }
    #title-start-button { animation: pulseButton 2.5s infinite ease-in-out; }
    @keyframes fadeInTitle { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
    @keyframes pulseButton { 0%, 100% { transform: scale(1); box-shadow: 0 0 10px rgba(255,255,255,0.7); } 50% { transform: scale(1.05); box-shadow: 0 0 20px rgba(255,255,255,1); } }
    .boss-hp-container { border: 2px solid #fff; height: 30px; padding: 3px; background: #333; border-radius: 5px; box-shadow: inset 0 0 5px #000; }
    .boss-hp-bar { height: 100%; transition: width .5s ease-out, background-image .5s ease-out; border-radius: 2px; }
    .boss-hp-bar.full { background-image: linear-gradient(to right, #33ff33, #88ff88); }
    .boss-hp-bar.mid { background-image: linear-gradient(to right, #ffff33, #ffff88); }
    .boss-hp-bar.low { background-image: linear-gradient(to right, #ff3333, #ff8833); }
    .boss-idle { animation: boss-float 2.5s infinite ease-in-out; }
    @keyframes boss-float{ 0%,100% { transform: translateY(0); } 50% { transform: translateY(-12px); } }
    .boss-defeat { animation: boss-defeat-anim 1.5s forwards; }
    @keyframes boss-defeat-anim { 0% { opacity: 1; transform: rotate(0deg); } 50% { opacity: 1; transform: rotate(10deg); } 100% { opacity: 0; transform: translateY(100px) rotate(-20deg) scale(0.5); } }
    .shake { animation: shake .35s; }
    @keyframes shake { 10%,90% { transform: translate(-2px, -2px); } 20%,80% { transform: translate(3px, 2px); } 30%,50%,70% { transform: translate(-3px, 3px); } 40%,60% { transform: translate(3px, -2px); } }
    .fire-glow { filter: drop-shadow(0 0 8px #ff8a00) drop-shadow(0 0 16px #ff3b00) contrast(1.5); }
    #boss-img { width: 100%; max-width: 320px; height: auto; }
    .correct-answer { background-image: linear-gradient(to bottom, #ffdd00, #ffaa00) !important; color: #000; }
    .incorrect-answer { background-image: linear-gradient(to bottom, #888888, #555555) !important; opacity: 0.7; }
  </style>
</head>
<body class="flex items-start sm:items-center justify-center min-h-screen p-4">

  <div id="opening-video-container" class="video-container">
    <video id="opening-video" class="bg-video" src="./opening_movie.mp4" autoplay loop playsinline onerror="handleMediaError(this)"></video>
  </div>
  <div id="game-video-container" class="video-container hidden">
    <video id="game-bg-video" class="bg-video" src="./GameBackground1.mp4" autoplay muted loop playsinline onerror="handleMediaError(this)"></video>
  </div>

  <div class="w-full max-w-3xl mx-auto">
    <div id="boss-area" class="mb-4 h-64 flex justify-center items-end relative hidden">
      <div id="boss-container"><img id="boss-img" src="./Stage1_dragon.png" alt="„Éú„Çπ„ÅÆÁîªÂÉè" class="fire-glow" onerror="handleMediaError(this)"/></div>
    </div>
    <div id="game-container" class="w-full dq-window relative">
      <div id="title-screen" class="text-center py-8">
        <h1 class="mb-10">Sustainability Quest</h1>
        <button id="title-start-button" class="dq-button">START</button>
      </div>

      <div id="language-screen" class="text-center hidden">
        <h1 class="text-3xl font-bold mb-6">Select Language</h1>
        <p class="text-sm mb-6">Translations are provided by AI.</p>
        <div class="flex justify-center gap-2 flex-wrap">
          <button id="lang-ja" class="dq-button">Êó•Êú¨Ë™û</button>
          <button id="lang-en" class="dq-button">English</button>
          <button id="lang-zh" class="dq-button">‰∏≠Êñá</button>
        </div>
      </div>

      <div id="instruction-screen" class="text-center hidden">
        <h1 id="instruction-title" class="text-3xl font-bold mb-4"></h1>
        <div id="instruction-text" class="text-left mb-6 space-y-2"></div>
        <button id="instruction-ok-button" class="dq-button"></button>
      </div>
      
      <div id="start-screen" class="text-center hidden">
        <h1 id="title-text" class="text-2xl font-bold mb-4"></h1>
        <div class="flex flex-col items-center gap-4 mb-4">
          <input id="nicknameInput" type="text" maxlength="20" class="text-black px-3 py-2 w-full md:w-80 text-center rounded" />
          <select id="companySelect" class="text-black px-3 py-2 w-full md:w-80 text-center rounded"></select>
          <input id="employeeIdInput" type="text" pattern="\d{5}" title="Á§æÂì°Áï™Âè∑„ÅØÂçäËßíÊï∞Â≠ó5Ê°Å„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ" class="text-black px-3 py-2 w-full md:w-80 text-center rounded" />
        </div>
        <button id="start-button" class="dq-button inline-flex items-center gap-2"><span id="start-button-text"></span></button>
        <div id="msg" class="text-yellow-300 text-sm h-5 mt-2"></div>
      </div>

      <div id="quiz-screen" class="hidden">
        <div class="flex justify-between items-center mb-2 text-lg">
          <span id="theme-display"></span>
          <span id="progress-display"></span>
          <span id="timer-display">0.0s</span>
        </div>
        <div class="mb-4"><p id="boss-hp-label"></p><div class="boss-hp-container"><div id="boss-hp-bar"></div></div></div>
        <div class="mb-4 min-h-[80px] p-4 border-2 border-white"><p id="question-text" class="text-xl"></p></div>
        <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      </div>
      <div id="result-screen" class="hidden text-center">
        <h2 id="result-title" class="text-3xl font-bold mb-4"></h2>
        <p id="result-message" class="text-xl mb-6"></p>
        <p id="submission-status" class="text-yellow-300 mb-8"></p>
        <div id="restart-button" class="dq-button inline-block"></div>
      </div>
      <div id="explanation-modal" class="absolute inset-0 bg-black bg-opacity-80 flex-col items-center justify-center p-4 hidden">
        <div class="dq-window w-full max-w-2xl text-center">
          <h2 id="explanation-title" class="text-4xl font-bold mb-4"></h2>
          <p id="explanation-text" class="text-lg mb-6 text-left h-48 overflow-y-auto p-2 border"></p>
          <button id="next-question-button" class="dq-button"></button>
        </div>
      </div>
    </div>
  </div>
  <audio id="bgm" src="./BS1_BGM.wav" loop onerror="handleMediaError(this)"></audio>
  <audio id="correct-sound" src="./correct_answer.mp3" onerror="handleMediaError(this)"></audio>
  <script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbyJSdEy7FB8URSCuHC9DoFPHzPOcMS7TVnyFJ-4IGRunK09fLbwSdQxUGQDM0vOZ7wNmA/exec';
    const STAGE_NUMBER = '1';
    const TEXTS = {
      ja: {
        instructionTitle: "ÂÜíÈô∫„ÅÆÂøÉÂæó",
        instructions: ["„Éª„Çµ„Çπ„ÉÜ„Éä„Éì„É™„ÉÜ„Ç£„Å´Èñ¢„Åô„Çã5„Å§„ÅÆÂïèÈ°å„ÅåÂá∫È°å„Åï„Çå„Çã„Åû„ÄÇ", "„Éª4Âïè‰ª•‰∏äÊ≠£Ëß£„Åß„Éú„Çπ„ÇíË®é‰ºê„Åß„Åç„ÇãÔºÅ", "„ÉªÊúÄÂàù„ÅÆÊåëÊà¶ÁµêÊûú„ÅÆ„Åø„Åå„É©„É≥„Ç≠„É≥„Ç∞„Å´Ë®òÈå≤„Åï„Çå„Çã„Åû„ÄÇ", "„ÉªÂÅ•Èóò„ÇíÁ•à„ÇãÔºÅ"],
        instructionOk: "„Çè„Åã„Å£„Åü",
        title: "„Çπ„ÉÜ„Éº„Ç∏1ÔºöÂú∞ÁêÉÁí∞Â¢É",
        nicknamePlaceholder: "„Éã„ÉÉ„ÇØ„Éç„Éº„É†„ÇíÂÖ•Âäõ",
        employeeIdPlaceholder: "Á§æÂì°Áï™Âè∑(ÂçäËßí5Ê°Å)„ÇíÂÖ•Âäõ",
        companySelectDefault: "ÊâÄÂ±û‰ºöÁ§æ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ",
        startButton: "ÊåëÊà¶„Åô„Çã",
        msgEnterId: "„Éã„ÉÉ„ÇØ„Éç„Éº„É†„ÄÅÊâÄÂ±û‰ºöÁ§æ„ÄÅÁ§æÂì°Áï™Âè∑„Çí„Åô„Åπ„Å¶ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ",
        theme: "„ÉÜ„Éº„ÉûÔºöÂú∞ÁêÉÁí∞Â¢É",
        progress: (q, t) => `${q}/${t}ÂïèÁõÆ`,
        bossHp: "„Éú„Çπ HP",
        resultWinTitle: "ÂãùÂà©ÔºÅ",
        resultWinMsg: "„Çπ„ÉÜ„Éº„Ç∏„ÇØ„É™„Ç¢ÔºÅÁí∞Â¢É„Å∏„ÅÆÊÑèË≠ò„ÅåÈ´ò„Åæ„Å£„ÅüÔºÅ",
        resultLoseTitle: "„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº",
        resultLoseMsg: "Á´ú„ÅÆÂäõ„ÅØÂº∑Â§ß„Å†„Å£„Åü‚Ä¶",
        submitting: "ÁµêÊûú„ÇíÈÄÅ‰ø°‰∏≠...",
        submitSuccess: "ÁµêÊûú„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„ÅüÔºÅ",
        submitError: "„Ç®„É©„ÉºÔºöÁµêÊûú„ÇíÈÄÅ‰ø°„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ",
        recordedFalse: "„Éó„É¨„Ç§„ÅÇ„Çä„Åå„Å®„ÅÜÔºÅË®òÈå≤„ÅØÂàùÂõû„ÅÆ„ÇÇ„ÅÆ„ÅÆ„Åø„Å®„Å™„Çä„Åæ„Åô„ÄÇ",
        restartButton: "„Çø„Ç§„Éà„É´„Å∏Êàª„Çã",
        correct: "Ê≠£Ëß£ÔºÅ",
        incorrect: "‰∏çÊ≠£Ëß£...",
        nextButton: "Ê¨°„Å∏",
        quiz: [
          { q: "Ê∞óÂÄôÂ§âÂãïÂØæÁ≠ñ„Å®„Åó„Å¶Ë™§„Å£„Å¶„ÅÑ„Çã„ÇÇ„ÅÆ„ÅØÊ¨°„ÅÆ„ÅÜ„Å°„Å©„Çå„Åß„Åó„Çá„ÅÜ„ÅãÔºü", o: ["ÁúÅ„Ç®„Éç„ÇÑÂÜçÁîü„Ç®„Éç„É´„ÇÆ„Éº„ÅÆ‰ΩøÁî®", "Ê£ÆÊûó‰øùÂÖ®", "Ê∞óÂÄôÂ§âÂãï„Å∏„ÅÆÈÅ©Âøú", "Êµ∑„ÅÆÂ∑ù„ÅÆ„Ç¥„ÉüÊãæ„ÅÑ"], a: "Êµ∑„ÅÆÂ∑ù„ÅÆ„Ç¥„ÉüÊãæ„ÅÑ", ex: "Ê∞óÂÄôÂ§âÂãïÂØæÁ≠ñ„Å´„ÅØ„ÄÅÊ∏©ÂÆ§ÂäπÊûú„Ç¨„ÇπÊéíÂá∫Èáè„ÇíÂâäÊ∏õ„Åô„Çã„Åü„ÇÅ„ÅÆ„ÄåÁ∑©Âíå„Äç„Å®„ÄÅÊ∞óÂÄôÂ§âÂãï„ÅÆÂΩ±Èüø„ÇíËªΩÊ∏õ„Åó„Åü„Çä„ÄÅÈ†ÜÂøú„Åó„Å¶Âø´ÈÅ©„Å´ÊöÆ„Çâ„Åô„Åü„ÇÅ„ÅÆ„ÄåÈÅ©Âøú„Äç„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ„Ç¥„Éü„ÇíÊãæ„Å£„Å¶„ÇÇ„ÄÅÊ∏©ÂÆ§ÂäπÊûú„Ç¨„ÇπÊéíÂá∫Èáè„ÅØÊ∏õ„Çâ„Å™„ÅÑ„Åü„ÇÅ„ÄÅÁõ¥Êé•ÁöÑ„Å™Ê∞óÂÄôÂ§âÂãïÂØæÁ≠ñ„Å´„Å™„Çä„Åæ„Åõ„Çì„ÄÇ„Åó„Åã„Åó„ÄÅÊµ∑Ê¥ãÊ±öÊüìÂØæÁ≠ñ„Å´Ë≤¢ÁåÆ„Åô„Çã‰æ°ÂÄ§„ÅÆ„ÅÇ„ÇãÊ¥ªÂãï„Åß„Åô„ÄÇ" },
          { q: "ÂªÉÊ£ÑÁâ©„ÅÆÁô∫Áîü„ÇíÊäëÂà∂„Åó„ÄÅË≥áÊ∫ê„ÇíÊúâÂäπÊ¥ªÁî®„Åô„Çã„Åü„ÇÅ„ÅÆËÄÉ„ÅàÊñπ„Å®„Åó„Å¶Ë™§„Å£„Å¶„ÅÑ„Çã„ÇÇ„ÅÆ„ÅØÊ¨°„ÅÆ„ÅÜ„Å°„Å©„Çå„Åß„Åó„Çá„ÅÜ„ÅãÔºü", o: ["Refuse", "Reduce", "Repair", "Remain"], a: "Remain", ex: "ÂªÉÊ£ÑÁâ©„ÅÆÁô∫ÁîüÊäëÂà∂„ÄÅË≥áÊ∫ê„ÅÆÊúâÂäπÊ¥ªÁî®„ÅÆ„Åü„ÇÅ„ÅÆËÄÉ„ÅàÊñπ„Å®„Åó„Å¶„ÄÅ3RÔºàReduce„ÉªReuse„ÉªRecycleÔºâ„ÅåÊèêÂî±„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„Åå„ÄÅÊúÄËøë„Åß„ÅØRefuse„ÇÑRepair„Å™„Å©„ÅÆËÄÉ„ÅàÊñπ„Å´„Åæ„ÅßÂ∫É„Åå„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇ" },
          { q: "ÁîüÁâ©Â§öÊßòÊÄß„Å´Âê´„Åæ„Çå„Çã„Äå3„Å§„ÅÆ„É¨„Éô„É´„ÅÆÂ§öÊßòÊÄß„Äç„Å®„Åó„Å¶Ë™§„Å£„Å¶„ÅÑ„Çã„ÇÇ„ÅÆ„ÅØÊ¨°„ÅÆ„ÅÜ„Å°„Å©„Çå„Åß„Åó„Çá„ÅÜ„ÅãÔºü", o: ["ÁîüÊÖãÁ≥ª„ÅÆÂ§öÊßòÊÄß", "Á®Æ„ÅÆÂ§öÊßòÊÄß", "ÈÅ∫‰ºùÂ≠ê„ÅÆÂ§öÊßòÊÄß", "ÊñáÂåñ„ÅÆÂ§öÊßòÊÄß"], a: "ÊñáÂåñ„ÅÆÂ§öÊßòÊÄß", ex: "ÁîüÁâ©Â§öÊßòÊÄß„Å®„ÅØ„ÄÅÂú∞ÁêÉ‰∏ä„ÅÆÊßò„ÄÖ„Å™Á®ÆÈ°û„ÅÆÁîüÁâ©„Åå„ÄÅ„Åù„Çå„Åû„Çå„ÅÆÁí∞Â¢É„Åß‰∫í„ÅÑ„Å´„Å§„Å™„Åå„ÇäÂêà„ÅÑ„Å™„Åå„ÇâÁîü„Åç„Å¶„ÅÑ„ÇãÁä∂ÊÖã„ÅÆ„Åì„Å®„Åß„Åô„ÄÇÂÖ∑‰ΩìÁöÑ„Å´„ÅØ„ÄÅ„ÄåÁîüÊÖãÁ≥ª„ÅÆÂ§öÊßòÊÄß„Äç„ÄÅ„ÄåÁ®Æ„ÅÆÂ§öÊßòÊÄß„Äç„ÄÅ„ÄåÈÅ∫‰ºùÂ≠ê„ÅÆÂ§öÊßòÊÄß„Äç„ÅÆ3„Å§„ÅÆ„É¨„Éô„É´„Åß„ÅÆÂ§öÊßòÊÄß„ÇíÂê´„Åø„Åæ„Åô„ÄÇ" },
          { q: "‰∏ñÁïåÁµåÊ∏à„Éï„Ç©„Éº„É©„É†ÔºàWEFÔºâ„ÅåÁô∫Ë°®„Åô„Çã„Äå„Ç∞„É≠„Éº„Éê„É´„É™„Çπ„ÇØ„É¨„Éù„Éº„ÉàÔºà2024Ôºâ„Äç„ÅÆ‰∏≠„Åß„ÄÅÊúÄ„ÇÇÈ´ò„ÅÑÁí∞Â¢ÉÈñ¢ÈÄ£„É™„Çπ„ÇØ„ÅØÊ¨°„ÅÆ„ÅÜ„Å°„Å©„Çå„Åß„Åó„Çá„ÅÜ„ÅãÔºü", o: ["Áï∞Â∏∏Ê∞óË±°", "ÁîüÁâ©Â§öÊßòÊÄß„ÅÆÂñ™Â§±„Å®ÁîüÊÖãÁ≥ª„ÅÆÂ¥©Â£ä", "Ëá™ÁÑ∂Ë≥áÊ∫ê„ÅÆ‰∏çË∂≥", "Ê±öÊüì"], a: "Áï∞Â∏∏Ê∞óË±°", ex: "Áï∞Â∏∏Ê∞óË±°„ÅØ„ÄÅÁü≠ÊúüÈñì„É™„Çπ„ÇØ„Åß„ÅØ2‰Ωç„ÄÅÈï∑ÊúüÈñì„É™„Çπ„ÇØ„Åß„ÅØ1‰Ωç„Å´„É©„É≥„ÇØ„Ç§„É≥„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ„Ç∞„É≠„Éº„Éê„É´„É™„Çπ„ÇØ„É¨„Éù„Éº„Éà„Å´„ÅØ„ÄÅÁí∞Â¢É‰ª•Â§ñ„Å´„ÇÇ„ÄÅÁµåÊ∏à„ÄÅÂú∞ÊîøÂ≠¶„ÄÅÁ§æ‰ºö„ÄÅ„ÉÜ„ÇØ„Éé„É≠„Ç∏„Éº„ÅÆ„É™„Çπ„ÇØ„Ç´„ÉÜ„Ç¥„É™„Éº„Åå„ÅÇ„Çä„Åæ„Åô„Åå„ÄÅÈï∑ÊúüÈñì„É™„Çπ„ÇØ„ÅÆTOP10„Å´„ÅØ„ÄÅ‰ªñ„ÅÆÈÅ∏ÊäûËÇ¢„ÇíÂê´„ÇÄÁí∞Â¢ÉÈñ¢ÈÄ£„É™„Çπ„ÇØ„Åå5„Å§„ÇÇ„É©„É≥„ÇØ„Ç§„É≥„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ" },
          { q: "„ÄåÊ∞∏ÈÅ†„ÅÆÂåñÂ≠¶Áâ©Ë≥™„Äç„Å®Âëº„Å∞„Çå„ÇãÊúâÂÆ≥ÂåñÂ≠¶Áâ©Ë≥™„ÅØÊ¨°„ÅÆ„ÅÜ„Å°„Å©„Çå„Åß„Åó„Çá„ÅÜ„ÅãÔºü", o: ["BPAÔºà„Éì„Çπ„Éï„Çß„Éé„Éº„É´AÔºâ", "DDTÔºà„Ç∏„ÇØ„É≠„É≠„Ç∏„Éï„Çß„Éã„É´„Éà„É™„ÇØ„É≠„É≠„Ç®„Çø„É≥Ôºâ", "PFASÔºàÊúâÊ©ü„Éï„ÉÉÁ¥†ÂåñÂêàÁâ©Ôºâ", "„ÉÄ„Ç§„Ç™„Ç≠„Ç∑„É≥È°û"], a: "PFASÔºàÊúâÊ©ü„Éï„ÉÉÁ¥†ÂåñÂêàÁâ©Ôºâ", ex: "PFAS„ÅØ„ÄÅËá™ÁÑ∂Áïå„Åß„Åª„Å®„Çì„Å©ÂàÜËß£„Åï„Çå„Åö„ÄÅÁí∞Â¢É„ÇÑ‰∫∫‰Ωì„Å∏„ÅÆÈï∑ÊúüÁöÑ„Å™ÂΩ±Èüø„ÅåÊá∏Âøµ„Åï„Çå„Å¶„ÅÑ„ÇãÊúâÂÆ≥ÂåñÂ≠¶Áâ©Ë≥™„ÅÆÁ∑èÁß∞„Åß„Åô„ÄÇÊ∞¥„ÇÑÊ≤π„Çí„ÅØ„Åò„Åç„ÄÅÁÜ±„Å´Âº∑„ÅÑ„Åü„ÇÅ„ÄÅ„Éï„É©„Ç§„Éë„É≥„ÇÑÈò≤Ê∞¥„Çπ„Éó„É¨„Éº„Å™„Å©„ÄÅÂπÖÂ∫É„ÅÑË£ΩÂìÅ„Åß‰ΩøÁî®„Åï„Çå„Å¶„Åç„Åæ„Åó„Åü„ÄÇDDT„ÄÅBPA„ÄÅ„ÉÄ„Ç§„Ç™„Ç≠„Ç∑„É≥È°û„ÅØ„ÅÑ„Åö„Çå„ÇÇÁí∞Â¢É„ÇÑ‰∫∫‰Ωì„Å´ÊúâÂÆ≥„Å™ÂåñÂ≠¶Áâ©Ë≥™„Åß„Åô„Åå„ÄÅ„ÄåÊ∞∏ÈÅ†„ÅÆÂåñÂ≠¶Áâ©Ë≥™„Äç„Å®„ÅØÂëº„Å∞„Çå„Åæ„Åõ„Çì„ÄÇ" }
        ]
      },
      en: {
        instructionTitle: "Rules of the Quest",
        instructions: ["- You will be asked 5 questions about sustainability.", "- Answer 4 or more correctly to defeat the boss!", "- Only your first attempt will be recorded for the ranking.", "- Good luck!"],
        instructionOk: "Got it",
        title: "Stage 1: Global Environment",
        nicknamePlaceholder: "Enter Nickname",
        employeeIdPlaceholder: "Enter 5-digit Employee ID",
        companySelectDefault: "Select your company",
        startButton: "Challenge",
        msgEnterId: "Please enter all fields: Nickname, Company, and Employee ID",
        theme: "Theme: Global Environment",
        progress: (q, t) => `Q ${q}/${t}`,
        bossHp: "Boss HP",
        resultWinTitle: "Victory!",
        resultWinMsg: "Stage Clear! Your environmental awareness has increased!",
        resultLoseTitle: "Game Over",
        resultLoseMsg: "The dragon's power was too great...",
        submitting: "Submitting results...",
        submitSuccess: "Results submitted!",
        submitError: "Error: Could not submit results.",
        recordedFalse: "Thanks for playing! Only your first result is recorded.",
        restartButton: "Back to Title",
        correct: "Correct!",
        incorrect: "Incorrect...",
        nextButton: "Next",
        quiz: [
          { q: "Which of the following is incorrect as a climate change countermeasure?", o: ["Energy saving and use of renewable energy", "Forest conservation", "Adaptation to climate change", "Picking up trash from the sea and rivers"], a: "Picking up trash from the sea and rivers", ex: "Climate change countermeasures include 'mitigation' to reduce greenhouse gas emissions and 'adaptation' to reduce the impacts of climate change. Picking up trash is not a direct countermeasure, but it is a valuable activity for ocean pollution control." },
          { q: "Which of the following is an incorrect concept for suppressing waste generation and effectively utilizing resources?", o: ["Refuse", "Reduce", "Repair", "Remain"], a: "Remain", ex: "To suppress waste generation and effectively utilize resources, the 3Rs (Reduce, Reuse, Recycle) have been advocated, but recently this has expanded to include concepts like Refuse and Repair. 'Remain' is not included." },
          { q: "Which of the following is incorrect as one of the 'three levels of diversity' included in biodiversity?", o: ["Ecosystem diversity", "Species diversity", "Genetic diversity", "Cultural diversity"], a: "Cultural diversity", ex: "Biodiversity is the state where various types of life on Earth live while being interconnected in their respective environments. Specifically, it includes diversity at three levels: 'ecosystem diversity,' 'species diversity,' and 'genetic diversity.'" },
          { q: "In the 'Global Risks Report (2024)' published by the World Economic Forum (WEF), which of the following is the highest environmental risk?", o: ["Extreme weather events", "Biodiversity loss and ecosystem collapse", "Natural resource shortages", "Pollution"], a: "Extreme weather events", ex: "Extreme weather events are ranked 2nd for short-term risks and 1st for long-term risks. The Global Risks Report includes economic, geopolitical, social, and technological risk categories in addition to environmental ones, but 5 of the top 10 long-term risks, including the other options, are environment-related." },
          { q: "Which of the following hazardous chemicals are known as 'forever chemicals'?", o: ["BPA (Bisphenol A)", "DDT (Dichlorodiphenyltrichloroethane)", "PFAS (Per- and polyfluoroalkyl substances)", "Dioxins"], a: "PFAS (Per- and polyfluoroalkyl substances)", ex: "PFAS is a general term for hazardous chemicals that hardly break down in nature, raising concerns about their long-term effects on the environment and human body. Because they repel water and oil and are heat-resistant, they have been used in a wide range of products, such as frying pans and waterproof sprays. DDT, BPA, and dioxins are all chemicals harmful to the environment and humans but are not called 'forever chemicals'." }
        ]
      },
      zh: {
        instructionTitle: "ÂÜíÈô©È°ªÁü•",
        instructions: ["„ÉªÂ∞ÜÊèêÂá∫5‰∏™ÂÖ≥‰∫éÂèØÊåÅÁª≠ÊÄßÁöÑÈóÆÈ¢ò„ÄÇ", "„ÉªÊ≠£Á°ÆÂõûÁ≠î4‰∏™‰ª•‰∏äÈóÆÈ¢òÂç≥ÂèØÂáªË¥•Â§¥ÁõÆÔºÅ", "„ÉªÂè™ÊúâÁ¨¨‰∏ÄÊ¨°ÊåëÊàòÁöÑÁªìÊûú‰ºöË¢´ËÆ∞ÂΩïÂú®ÊéíÂêç‰∏≠„ÄÇ", "„ÉªÁ•ù‰Ω†Â•ΩËøêÔºÅ"],
        instructionOk: "Áü•ÈÅì‰∫Ü",
        title: "Á¨¨‰∏ÄÂÖ≥ÔºöÂú∞ÁêÉÁéØÂ¢É",
        nicknamePlaceholder: "ËæìÂÖ•ÊòµÁß∞",
        employeeIdPlaceholder: "ËæìÂÖ•ÂëòÂ∑•ÁºñÂè∑(5‰ΩçÂçäËßíÊï∞Â≠ó)",
        companySelectDefault: "ËØ∑ÈÄâÊã©ÊâÄÂ±ûÂÖ¨Âè∏",
        startButton: "ÊåëÊàò",
        msgEnterId: "ËØ∑ËæìÂÖ•ÊòµÁß∞„ÄÅÊâÄÂ±ûÂÖ¨Âè∏ÂíåÂëòÂ∑•ÁºñÂè∑",
        theme: "‰∏ªÈ¢òÔºöÂú∞ÁêÉÁéØÂ¢É",
        progress: (q, t) => `Á¨¨${q}/${t}È¢ò`,
        bossHp: "Â§¥ÁõÆ HP",
        resultWinTitle: "ËÉúÂà©ÔºÅ",
        resultWinMsg: "ÂÖ≥Âç°ÂÆåÊàêÔºÅÂØπÁéØÂ¢ÉÁöÑËÆ§ËØÜÊèêÈ´ò‰∫ÜÔºÅ",
        resultLoseTitle: "Ê∏∏ÊàèÁªìÊùü",
        resultLoseMsg: "ÈæôÁöÑÂäõÈáèÂ§™Âº∫Â§ß‰∫Ü‚Ä¶",
        submitting: "Ê≠£Âú®ÂèëÈÄÅÁªìÊûú...",
        submitSuccess: "ÁªìÊûúÂ∑≤ÂèëÈÄÅÔºÅ",
        submitError: "ÈîôËØØÔºöÊó†Ê≥ïÂèëÈÄÅÁªìÊûú„ÄÇ",
        recordedFalse: "ÊÑüË∞¢ÊÇ®ÁöÑÂèÇ‰∏éÔºÅÂè™ÊúâÂàùÊ¨°ÊåëÊàòÁªìÊûú‰ºöË¢´ËÆ∞ÂΩï„ÄÇ",
        restartButton: "ËøîÂõûÊ†áÈ¢ò",
        correct: "ÂõûÁ≠îÊ≠£Á°ÆÔºÅ",
        incorrect: "ÂõûÁ≠îÈîôËØØ...",
        nextButton: "‰∏ã‰∏Ä‰∏™",
        quiz: [
          { q: "‰ª•‰∏ãÂì™È°π‰Ωú‰∏∫Ê∞îÂÄôÂèòÂåñÂØπÁ≠ñÊòØÈîôËØØÁöÑÔºü", o: ["ËäÇËÉΩÂíå‰ΩøÁî®ÂèØÂÜçÁîüËÉΩÊ∫ê", "Ê£ÆÊûó‰øùÊä§", "ÈÄÇÂ∫îÊ∞îÂÄôÂèòÂåñ", "Êç°ÊãæÊµ∑Ê¥ãÂíåÊ≤≥ÊµÅÁöÑÂûÉÂúæ"], a: "Êç°ÊãæÊµ∑Ê¥ãÂíåÊ≤≥ÊµÅÁöÑÂûÉÂúæ", ex: "Ê∞îÂÄôÂèòÂåñÂØπÁ≠ñÂåÖÊã¨Êó®Âú®ÂáèÂ∞ëÊ∏©ÂÆ§Ê∞î‰ΩìÊéíÊîæÁöÑ‚ÄúÂáèÁºì‚ÄùÊé™ÊñΩÔºå‰ª•ÂèäÊó®Âú®ÂáèËΩªÊ∞îÂÄôÂèòÂåñÂΩ±ÂìçÂπ∂ËàíÈÄÇÁîüÊ¥ªÁöÑ‚ÄúÈÄÇÂ∫î‚ÄùÊé™ÊñΩ„ÄÇÊç°ÂûÉÂúæ‰∏ç‰ºöÂáèÂ∞ëÊ∏©ÂÆ§Ê∞î‰ΩìÊéíÊîæÔºåÂõ†Ê≠§‰∏çÊòØÁõ¥Êé•ÁöÑÊ∞îÂÄôÂèòÂåñÂØπÁ≠ñ„ÄÇ‰ΩÜÊòØÔºåÂÆÉÊòØ‰∏ÄÈ°πÊúâ‰ª∑ÂÄºÁöÑÊ¥ªÂä®ÔºåÊúâÂä©‰∫éÈò≤Ê≤ªÊµ∑Ê¥ãÊ±°Êüì„ÄÇ" },
          { q: "‰ª•‰∏ãÂì™È°πÊòØÊäëÂà∂Â∫üÁâ©‰∫ßÁîüÂíåÊúâÊïàÂà©Áî®ËµÑÊ∫êÊñπÈù¢ÁöÑÈîôËØØÊ¶ÇÂøµÔºü", o: ["ÊãíÁªù (Refuse)", "ÂáèÂ∞ë (Reduce)", "‰øÆÁêÜ (Repair)", "‰øùÁïô (Remain)"], a: "‰øùÁïô (Remain)", ex: "‰∏∫‰∫ÜÊäëÂà∂Â∫üÁâ©‰∫ßÁîüÂíåÊúâÊïàÂà©Áî®ËµÑÊ∫êÔºå‰∫∫‰ª¨ÊèêÂÄ°3RÔºàÂáèÂ∞ë„ÄÅÂÜçÂà©Áî®„ÄÅÂõûÊî∂ÔºâÔºå‰ΩÜÊúÄËøëËøô‰∏ÄÁêÜÂøµÂ∑≤Êâ©Â±ïÂà∞ÂåÖÊã¨ÊãíÁªùÂíå‰øÆÁêÜÁ≠âÊ¶ÇÂøµ„ÄÇ‰∏çÂåÖÊã¨‚Äú‰øùÁïô‚Äù„ÄÇ" },
          { q: "‰ª•‰∏ãÂì™È°π‰∏çÂ±û‰∫éÁîüÁâ©Â§öÊ†∑ÊÄß‰∏≠ÊâÄÂåÖÂê´ÁöÑ‚Äú‰∏â‰∏™Â§öÊ†∑ÊÄßÂ±ÇÊ¨°‚ÄùÔºü", o: ["ÁîüÊÄÅÁ≥ªÁªüÂ§öÊ†∑ÊÄß", "Áâ©ÁßçÂ§öÊ†∑ÊÄß", "ÈÅó‰º†Â§öÊ†∑ÊÄß", "ÊñáÂåñÂ§öÊ†∑ÊÄß"], a: "ÊñáÂåñÂ§öÊ†∑ÊÄß", ex: "ÁîüÁâ©Â§öÊ†∑ÊÄßÊòØÊåáÂú∞ÁêÉ‰∏äÂêÑÁßçÁîüÁâ©Âú®ÂêÑËá™ÁöÑÁéØÂ¢É‰∏≠Áõ∏‰∫íËÅîÁ≥ª„ÄÅÂÖ±Â≠òÁöÑÁä∂ÊÄÅ„ÄÇÂÖ∑‰ΩìËÄåË®ÄÔºåÂÆÉÂåÖÊã¨‰∏â‰∏™Â±ÇÊ¨°ÁöÑÂ§öÊ†∑ÊÄßÔºö‚ÄúÁîüÊÄÅÁ≥ªÁªüÂ§öÊ†∑ÊÄß‚Äù„ÄÅ‚ÄúÁâ©ÁßçÂ§öÊ†∑ÊÄß‚ÄùÂíå‚ÄúÈÅó‰º†Â§öÊ†∑ÊÄß‚Äù„ÄÇ" },
          { q: "Âú®‰∏ñÁïåÁªèÊµéËÆ∫ÂùõÔºàWEFÔºâÂèëÂ∏ÉÁöÑ„Ää2024Âπ¥ÂÖ®ÁêÉÈ£éÈô©Êä•Âëä„Äã‰∏≠Ôºå‰ª•‰∏ãÂì™È°πÊòØÊúÄÈ´òÁöÑÁéØÂ¢ÉÁõ∏ÂÖ≥È£éÈô©Ôºü", o: ["ÊûÅÁ´ØÂ§©Ê∞î‰∫ã‰ª∂", "ÁîüÁâ©Â§öÊ†∑ÊÄß‰∏ßÂ§±ÂíåÁîüÊÄÅÁ≥ªÁªüÂ¥©Ê∫É", "Ëá™ÁÑ∂ËµÑÊ∫êÁü≠Áº∫", "Ê±°Êüì"], a: "ÊûÅÁ´ØÂ§©Ê∞î‰∫ã‰ª∂", ex: "ÊûÅÁ´ØÂ§©Ê∞î‰∫ã‰ª∂Âú®Áü≠ÊúüÈ£éÈô©‰∏≠ÊéíÂêçÁ¨¨‰∫åÔºåÂú®ÈïøÊúüÈ£éÈô©‰∏≠ÊéíÂêçÁ¨¨‰∏Ä„ÄÇ„ÄäÂÖ®ÁêÉÈ£éÈô©Êä•Âëä„ÄãÈô§‰∫ÜÁéØÂ¢ÉÈ£éÈô©Â§ñÔºåËøòÂåÖÊã¨ÁªèÊµé„ÄÅÂú∞ÁºòÊîøÊ≤ª„ÄÅÁ§æ‰ºöÂíåÊäÄÊúØÈ£éÈô©Á±ªÂà´Ôºå‰ΩÜÂú®ÈïøÊúüÈ£éÈô©ÂâçÂçÅÂêç‰∏≠ÔºåÂåÖÊã¨ÂÖ∂‰ªñÈÄâÈ°πÂú®ÂÜÖÁöÑ‰∏éÁéØÂ¢ÉÁõ∏ÂÖ≥ÁöÑÈ£éÈô©Âç†‰∫Ü‰∫îÈ°π„ÄÇ" },
          { q: "‰ª•‰∏ãÂì™ÁßçÊúâÂÆ≥ÂåñÂ≠¶Áâ©Ë¥®Ë¢´Áß∞‰∏∫‚ÄúÊ∞∏‰πÖÊÄßÂåñÂ≠¶Áâ©Ë¥®‚ÄùÔºü", o: ["BPA (ÂèåÈÖöA)", "DDT (‰∫åÊ∞Ø‰∫åËãØ‰∏âÊ∞Ø‰πôÁÉ∑)", "PFAS (ÂÖ®Ê∞üÂíåÂ§öÊ∞üÁÉ∑Âü∫Áâ©Ë¥®)", "‰∫åÂôÅËã±Á±ª"], a: "PFAS (ÂÖ®Ê∞üÂíåÂ§öÊ∞üÁÉ∑Âü∫Áâ©Ë¥®)", ex: "PFAS ÊòØ‰∏ÄÁ±ªÊúâÂÆ≥ÂåñÂ≠¶Áâ©Ë¥®ÁöÑÊÄªÁß∞ÔºåÂÆÉ‰ª¨Âú®Ëá™ÁÑ∂Áïå‰∏≠Âá†‰πé‰∏çÂàÜËß£ÔºåÂºïÂèë‰∫Ü‰∫∫‰ª¨ÂØπÂÖ∂ÂØπÁéØÂ¢ÉÂíå‰∫∫‰ΩìÈïøÊúüÂΩ±ÂìçÁöÑÊãÖÂøß„ÄÇÁî±‰∫éÂÆÉ‰ª¨ËÉΩÈò≤Ê∞¥Èò≤Ê≤π‰∏îËÄêÁÉ≠ÔºåÂõ†Ê≠§Ë¢´ÂπøÊ≥õÁî®‰∫éÁÖéÈîÖÂíåÈò≤Ê∞¥Âñ∑ÈõæÁ≠â‰∫ßÂìÅ‰∏≠„ÄÇDDT„ÄÅBPAÂíå‰∫åÂôÅËã±Á±ªÈÉΩÊòØÂØπÁéØÂ¢ÉÂíå‰∫∫‰ΩìÊúâÂÆ≥ÁöÑÂåñÂ≠¶Áâ©Ë¥®Ôºå‰ΩÜ‰∏çË¢´Áß∞‰∏∫‚ÄúÊ∞∏‰πÖÊÄßÂåñÂ≠¶Áâ©Ë¥®‚Äù„ÄÇ" }
        ]
      }
    };
    const companyList = {
      ja: ["Êú¨Á§æ/Â§©Ê∫ÄÂú∞Âå∫", "Ê≤ªÂ∑•ÂÖ∑Â∑•Â†¥", "Á•ûÊà∏Â∑•Â†¥", "Â§ßÈò™Â∑•Â†¥", "ÂêçÂºµÂ∑•Â†¥", "‰∏âÈáçÂ∑•Â†¥", "ÊªãË≥ÄÂ∑•Â†¥", "Ê≤≥ÂÜÖÂ∑•Â†¥", "Ê†™Âºè‰ºöÁ§æNKC NASSH", "Ê†™Âºè‰ºöÁ§æÈ†àÁî∞ÂïÜ‰∫ã", "ÂØåÂ£´„Éõ„Éº„Éã„É≥„Ç∞Â∑•Ê•≠Ê†™Âºè‰ºöÁ§æ", "‰∏≠Ë•øËààÁî£Ê†™Âºè‰ºöÁ§æ", "„Ç∑„Éº„Éª„ÉÜ„Ç£„Éª„Éû„Ç∑„É≥Ê†™Âºè‰ºöÁ§æ", "„Ç§„Éº„Ç∞„É≠„Éº„Éê„É¨„ÉÉ„Ç∏Ê†™Âºè‰ºöÁ§æ", "NKC„Å™„Åå„ÅÑ„Ç∞„É™„Éº„É≥„Éë„ÉØ„ÉºÊ†™Âºè‰ºöÁ§æ", "NMC", "NSC", "NWC", "NPC", "NAI", "NCP", "NDC", "„Åù„ÅÆ‰ªñ"],
      en: ["HQ/Tenma Area", "Jig & Tool Factory", "Kobe Plant", "Osaka Plant", "Nabari Plant", "Mie Plant", "Shiga Plant", "Kawachi Plant", "NKC NASSH Inc.", "Suda Corporation", "Fuji Honing Industrial Co., Ltd.", "Nakanishi Kosan Co., Ltd.", "C.T. Machine Co., Ltd.", "e-Globaledge Corporation", "NKC Nagai Green Power Co., Ltd.", "NMC", "NSC", "NWC", "NPC", "NAI", "NCP", "NDC", "Other"],
      zh: ["ÊÄªÂÖ¨Âè∏/Â§©Êª°Âú∞Âå∫", "Ê≤ªÂ∑•ÂÖ∑Â∑•Â†¥", "Á•ûÊà∑Â∑•ÂéÇ", "Â§ßÈò™Â∑•ÂéÇ", "ÂêçÂº†Â∑•ÂéÇ", "‰∏âÈáçÂ∑•ÂéÇ", "ÊªãË¥∫Â∑•ÂéÇ", "Ê≤≥ÂÜÖÂ∑•ÂéÇ", "Ê†™Âºè‰ºöÁ§æNKC NASSH", "Ê†™Âºè‰ºöÁ§æÈ°ªÁî∞ÂïÜ‰∫ã", "ÂØåÂ£´Áè©Á£®Â∑•‰∏öÊ†™Âºè‰ºöÁ§æ", "‰∏≠Ë•øÂÖ¥‰∫ßÊ†™Âºè‰ºöÁ§æ", "C.T. MachineÊ†™Âºè‰ºöÁ§æ", "e-GlobaledgeÊ†™Âºè‰ºöÁ§æ", "NKCÈïø‰∫ïÁªøËâ≤ÁîµÂäõÊ†™Âºè‰ºöÁ§æ", "NMC", "NSC", "NWC", "NPC", "NAI", "NCP", "NDC", "ÂÖ∂‰ªñ"]
    };
    
    const titleScreen = document.getElementById('title-screen');
    const languageScreen = document.getElementById('language-screen');
    const instructionScreen = document.getElementById('instruction-screen');
    const startScreen = document.getElementById('start-screen');
    const quizScreen = document.getElementById('quiz-screen');
    const resultScreen = document.getElementById('result-screen');
    const bossContainer = document.getElementById('boss-container');
    const employeeIdInput = document.getElementById('employeeIdInput');
    const nicknameInput = document.getElementById('nicknameInput');
    const companySelect = document.getElementById('companySelect');
    const bgm = document.getElementById('bgm');
    const correctSound = document.getElementById('correct-sound');
    const startButton = document.getElementById('start-button');
    const explanationModal = document.getElementById('explanation-modal');
    const nextQuestionButton = document.getElementById('next-question-button');
    const openingVideoContainer = document.getElementById('opening-video-container');
    const gameVideoContainer = document.getElementById('game-video-container');

    let currentLang = 'ja';
    let timerInterval, startTime, correctCount, isGameInProgress = false, audioStarted = false;
    let clickSound, hitSound, damageSound, victorySound, defeatSound;

    function switchScreen(screenName) {
      [titleScreen, languageScreen, instructionScreen, startScreen, quizScreen, resultScreen].forEach(s => s.classList.add('hidden'));
      document.getElementById(`${screenName}-screen`).classList.remove('hidden');
    }
    
    function updateUIText() {
      const t = TEXTS[currentLang];
      document.body.lang = currentLang;
      document.getElementById('instruction-title').textContent = t.instructionTitle;
      document.getElementById('instruction-text').innerHTML = t.instructions.map(line => `<p>${line}</p>`).join('');
      document.getElementById('instruction-ok-button').textContent = t.instructionOk;
      document.getElementById('title-text').textContent = t.title;
      nicknameInput.placeholder = t.nicknamePlaceholder;
      employeeIdInput.placeholder = t.employeeIdPlaceholder;
      document.getElementById('start-button-text').textContent = t.startButton;
      document.getElementById('boss-hp-label').textContent = t.bossHp;
      document.getElementById('restart-button').textContent = t.restartButton;
      document.getElementById('theme-display').textContent = t.theme;
      
      companySelect.innerHTML = `<option value="">${t.companySelectDefault}</option>`;
      companyList[currentLang].forEach(company => {
        companySelect.innerHTML += `<option value="${company}">${company}</option>`;
      });
    }

    function setupAudio() {
      if (audioStarted) return;
      clickSound = () => new Tone.MembraneSynth({ pitchDecay: 0.01, octaves: 3, envelope: { attack: 0.001, decay: 0.3, sustain: 0 } }).toDestination().triggerAttackRelease("C2", "8n");
      hitSound = () => {
        correctSound.currentTime = 0;
        correctSound.play().catch(e => console.error("Correct sound play failed:", e));
      };
      damageSound = () => new Tone.NoiseSynth({ noise: { type: "pink" }, envelope: { attack: 0.01, decay: 0.3, sustain: 0, release: 0.2 } }).toDestination().triggerAttackRelease("8n");
      victorySound = () => { const s = new Tone.Synth().toDestination(), n = Tone.now(); s.triggerAttackRelease("C5", "8n", n); s.triggerAttackRelease("E5", "8n", n + 0.2); s.triggerAttackRelease("G5", "8n", n + 0.4); s.triggerAttackRelease("C6", "4n", n + 0.6) };
      defeatSound = () => { const s = new Tone.Synth().toDestination(), n = Tone.now(); s.triggerAttackRelease("C4", "4n", n); s.triggerAttackRelease("B3", "4n", n + 0.3); s.triggerAttackRelease("A#3", "4n", n + 0.6); s.triggerAttackRelease("A3", "2n", n + 0.9) };
      audioStarted = true;
    }

    function normalizeEmployeeIdForHTML(v) {
      const digits = String(v == null ? "" : v).replace(/[^\d]/g, "");
      return digits.padStart(5, "0");
    }

    async function startGame() {
      if (!employeeIdInput.checkValidity()) {
        employeeIdInput.reportValidity();
        return;
      }
      const nickname = nicknameInput.value.trim();
      const company = companySelect.value;
      const employeeId = employeeIdInput.value.trim();
      const msgEl = document.getElementById('msg');
      if (!nickname || !company || !employeeId) {
        msgEl.textContent = TEXTS[currentLang].msgEnterId;
        return;
      }
      if (isGameInProgress) return;
      isGameInProgress = true;
      startButton.disabled = true;
      
      bgm.play().catch(e => console.error("BGM play failed:", e));
      clickSound();
      correctCount = 0;
      
      document.getElementById('boss-area').classList.remove('hidden');
      bossContainer.className = 'boss-idle';
      updateHpBars(100);
      switchScreen('quiz');
      
      startTime = Date.now();
      timerInterval = setInterval(() => {
        const elapsedTime = ((Date.now() - startTime) / 1000).toFixed(1);
        document.getElementById('timer-display').textContent = `${elapsedTime}s`;
      }, 100);
      
      displayQuestion(0);
      startButton.disabled = false;
      isGameInProgress = false;
    }

    function displayQuestion(index) {
      const quizData = TEXTS[currentLang].quiz;
      document.getElementById('progress-display').textContent = TEXTS[currentLang].progress(index + 1, quizData.length);
      const current = quizData[index];
      document.getElementById('question-text').textContent = `Q${index + 1}: ${current.q}`;
      const optionsContainer = document.getElementById('options-container');
      optionsContainer.innerHTML = '';
      current.o.forEach(opt => {
        const div = document.createElement('div');
        div.textContent = `‚ñ∂ ${opt}`;
        div.classList.add('dq-button');
        div.addEventListener('click', () => handleAnswer(opt, current, index));
        optionsContainer.appendChild(div);
      });
    }

    function handleAnswer(selectedAnswer, currentQuiz, index) {
      const isCorrect = selectedAnswer === currentQuiz.a;
      const optionsContainer = document.getElementById('options-container');
      optionsContainer.querySelectorAll('.dq-button').forEach(btn => {
        btn.style.pointerEvents = 'none';
        if (btn.textContent.includes(currentQuiz.a)) {
          btn.classList.add('correct-answer');
        } else {
          btn.classList.add('incorrect-answer');
        }
      });

      if (isCorrect) {
        correctCount++;
        hitSound();
        updateHpBars(100 - (correctCount * (100 / 4)));
        bossContainer.classList.add('shake');
        document.getElementById('explanation-title').textContent = TEXTS[currentLang].correct;
      } else {
        damageSound();
        document.querySelector('.dq-window').classList.add('shake');
        document.getElementById('explanation-title').textContent = TEXTS[currentLang].incorrect;
      }
      
      document.getElementById('explanation-text').textContent = currentQuiz.ex;
      nextQuestionButton.textContent = TEXTS[currentLang].nextButton;
      nextQuestionButton.dataset.nextIndex = index + 1;
      
      setTimeout(() => {
        explanationModal.style.display = 'flex';
      }, 800);
    }
    
    nextQuestionButton.addEventListener('click', () => {
      explanationModal.style.display = 'none';
      bossContainer.classList.remove('shake');
      document.querySelector('.dq-window').classList.remove('shake');
      
      const nextIndex = parseInt(nextQuestionButton.dataset.nextIndex);
      if (nextIndex >= TEXTS[currentLang].quiz.length) {
        showEndScreen();
      } else {
        displayQuestion(nextIndex);
      }
    });

    function showEndScreen() {
      clearInterval(timerInterval);
      bgm.pause();
      bgm.currentTime = 0;
      
      const isVictory = correctCount >= 4;
      if (isVictory) {
        victorySound();
        bossContainer.className = 'boss-defeat';
      } else {
        defeatSound();
      }
      
      setTimeout(() => {
        document.getElementById('boss-area').classList.add('hidden');
        switchScreen('result');
        const t = TEXTS[currentLang];
        document.getElementById('result-title').textContent = isVictory ? t.resultWinTitle : t.resultLoseTitle;
        document.getElementById('result-message').textContent = isVictory ? t.resultWinMsg : t.resultLoseMsg;
        submitResults();
      }, isVictory ? 1500 : 500);
    }

    async function submitResults() {
        const statusEl = document.getElementById('submission-status');
        let ipAddress = 'N/A';
        try {
            const response = await fetch('https://api.ipify.org?format=json');
            ipAddress = (await response.json()).ip;
        } catch (error) {
            console.error('IP„Ç¢„Éâ„É¨„Çπ„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', error);
        }

        const normalizedEmployeeId = normalizeEmployeeIdForHTML(employeeIdInput.value.trim());
        const payload = {
            nickname: nicknameInput.value.trim(),
            company: companySelect.value,
            employeeId: normalizedEmployeeId,
            stage: STAGE_NUMBER,
            score: correctCount,
            time: ((Date.now() - startTime) / 1000).toFixed(2),
            ipAddress: ipAddress
        };
        statusEl.textContent = TEXTS[currentLang].submitting;
        
        try {
            const response = await fetch(GAS_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/plain;charset=utf-8',
                },
                body: JSON.stringify(payload)
            });

            const result = await response.json();

            if (result.status === 'success') {
                if (result.recorded === false) {
                    statusEl.textContent = TEXTS[currentLang].recordedFalse;
                } else {
                    statusEl.textContent = TEXTS[currentLang].submitSuccess;
                }
            } else {
                statusEl.textContent = result.message || TEXTS[currentLang].submitError;
            }
        } catch (err) {
            statusEl.textContent = TEXTS[currentLang].submitError;
            console.error('Error:', err);
        }
    }

    function updateHpBars(percentage) {
      const hpBar = document.getElementById('boss-hp-bar');
      hpBar.style.width = `${Math.max(0, percentage)}%`;
      if (percentage <= 25) hpBar.className = 'boss-hp-bar low';
      else if (percentage <= 50) hpBar.className = 'boss-hp-bar mid';
      else hpBar.className = 'boss-hp-bar full';
    }
    
    function handleMediaError(element) {
        console.error(`Error loading media: ${element.src}`);
        element.style.display = 'none'; 
    }

    document.getElementById('title-start-button').addEventListener('click', async () => {
      if (!audioStarted) { 
        await Tone.start();
        setupAudio();
      }
      clickSound();
      const openingVideo = document.getElementById('opening-video');
      openingVideo.muted = false;
      openingVideo.play().catch(e => console.log("User interaction might be needed for audio"));
      switchScreen('language');
    });

    document.getElementById('lang-ja').addEventListener('click', () => { clickSound(); currentLang = 'ja'; updateUIText(); switchScreen('instruction'); });
    document.getElementById('lang-en').addEventListener('click', () => { clickSound(); currentLang = 'en'; updateUIText(); switchScreen('instruction'); });
    document.getElementById('lang-zh').addEventListener('click', () => { clickSound(); currentLang = 'zh'; updateUIText(); switchScreen('instruction'); });
    
    document.getElementById('instruction-ok-button').addEventListener('click', () => {
      clickSound();
      openingVideoContainer.classList.add('hidden');
      document.getElementById('opening-video').pause();
      gameVideoContainer.classList.remove('hidden');
      document.getElementById('game-bg-video').play().catch(e => console.log("Game video play failed"));
      switchScreen('start');
    });
    
    startButton.addEventListener('click', startGame);
    document.getElementById('restart-button').addEventListener('click', () => location.reload());

    updateUIText();
    switchScreen('title');
    const openingVideo = document.getElementById('opening-video');
    openingVideo.muted = false;
    openingVideo.play().catch(e => {
        console.log("Autoplay with sound was prevented. Muting and retrying.");
        openingVideo.muted = true;
        openingVideo.play();
    });
  </script>
</body>
</html>
