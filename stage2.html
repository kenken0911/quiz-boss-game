<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sustainable Quest üó°Ô∏è - Stage 2</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=Press+Start+2P&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
  <style>
    body[lang="ja"], body[lang="zh"] { font-family: 'DotGothic16', sans-serif; }
    body[lang="en"] { font-family: 'Press Start 2P', cursive; }
    body { background-color: #000; color: #fff; image-rendering: pixelated; overflow-x: hidden; overflow-y: auto; }
    .dq-window { border: 4px solid #fff; background: rgba(0, 50, 0, 0.85); padding: 1.5rem; box-shadow: 0 0 0 4px #000, 0 0 20px rgba(0, 255, 128, 0.5); backdrop-filter: blur(3px); }
    .dq-button { cursor: pointer; padding: .75rem 1.5rem; border: 2px solid #fff; background-image: linear-gradient(to bottom, #00aa55, #008833); text-shadow: 1px 1px 2px #000; transition: all 0.2s; }
    .dq-button:hover { background-image: linear-gradient(to bottom, #33dd88, #00aa55); box-shadow: 0 0 10px #fff; }
    .video-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
    .bg-video { width: 100%; height: 100%; object-fit: cover; }
    #title-screen h1 { font-size: 2.5rem; font-weight: bold; text-shadow: 0 0 5px #fff, 0 0 15px #fff, 0 0 25px #00aaff; animation: fadeInTitle 2s ease-out forwards; }
    #title-start-button { animation: pulseButton 2.5s infinite ease-in-out; }
    @keyframes fadeInTitle { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
    @keyframes pulseButton { 0%, 100% { transform: scale(1); box-shadow: 0 0 10px rgba(255,255,255,0.7); } 50% { transform: scale(1.05); box-shadow: 0 0 20px rgba(255,255,255,1); } }
    .boss-hp-container { border: 2px solid #fff; height: 30px; padding: 3px; background: #333; border-radius: 5px; box-shadow: inset 0 0 5px #000; }
    .boss-hp-bar { height: 100%; transition: width .5s ease-out, background-image .5s ease-out; border-radius: 2px; }
    .boss-hp-bar.full { background-image: linear-gradient(to right, #33ff33, #88ff88); }
    .boss-hp-bar.mid { background-image: linear-gradient(to right, #ffff33, #ffff88); }
    .boss-hp-bar.low { background-image: linear-gradient(to right, #ff3333, #ff8833); }
    .boss-idle { animation: boss-float 2.5s infinite ease-in-out; }
    @keyframes boss-float{ 0%,100% { transform: translateY(0); } 50% { transform: translateY(-12px); } }
    .boss-defeat { animation: boss-defeat-anim 1.5s forwards; }
    @keyframes boss-defeat-anim { 0% { opacity: 1; transform: rotate(0deg); } 50% { opacity: 1; transform: rotate(10deg); } 100% { opacity: 0; transform: translateY(100px) rotate(-20deg) scale(0.5); } }
    .shake { animation: shake .35s; }
    @keyframes shake { 10%,90% { transform: translate(-2px, -2px); } 20%,80% { transform: translate(3px, 2px); } 30%,50%,70% { transform: translate(-3px, 3px); } 40%,60% { transform: translate(3px, -2px); } }
    .forest-glow { filter: drop-shadow(0 0 8px #aaff00) drop-shadow(0 0 16px #33dd00) contrast(1.5); }
    #boss-img { width: 100%; max-width: 320px; height: auto; }
    .correct-answer { background-image: linear-gradient(to bottom, #ffdd00, #ffaa00) !important; color: #000; }
    .incorrect-answer { background-image: linear-gradient(to bottom, #888888, #555555) !important; opacity: 0.7; }
  </style>
</head>
<body class="flex items-start sm:items-center justify-center min-h-screen p-4">

  <div id="opening-video-container" class="video-container">
    <video id="opening-video" class="bg-video" src="./opening_movie.mp4" autoplay loop playsinline onerror="handleMediaError(this)"></video>
  </div>
  <div id="game-video-container" class="video-container hidden">
    <video id="game-bg-video" class="bg-video" src="./GameBackground2.mp4" autoplay muted loop playsinline onerror="handleMediaError(this)"></video>
  </div>

  <div class="w-full max-w-3xl mx-auto">
    <div id="boss-area" class="mb-4 h-64 flex justify-center items-end relative hidden">
      <div id="boss-container"><img id="boss-img" src="./Stage2_dragon.png" alt="„Éú„Çπ„ÅÆÁîªÂÉè" class="forest-glow" onerror="handleMediaError(this)"/></div>
    </div>
    <div id="game-container" class="w-full dq-window relative">
      <div id="title-screen" class="text-center py-8">
        <h1 class="mb-10">Sustainable Quest</h1>
        <button id="title-start-button" class="dq-button">START</button>
      </div>

      <div id="language-screen" class="text-center hidden">
        <h1 class="text-3xl font-bold mb-6">Select Language</h1>
        <div class="flex justify-center gap-2 flex-wrap">
          <button id="lang-ja" class="dq-button">Êó•Êú¨Ë™û</button>
          <button id="lang-en" class="dq-button">English</button>
          <button id="lang-zh" class="dq-button">‰∏≠Êñá</button>
        </div>
      </div>

      <div id="instruction-screen" class="text-center hidden">
        <h1 id="instruction-title" class="text-3xl font-bold mb-4"></h1>
        <div id="instruction-text" class="text-left mb-6 space-y-2"></div>
        <button id="instruction-ok-button" class="dq-button"></button>
      </div>
      
      <div id="start-screen" class="text-center hidden">
        <h1 id="title-text" class="text-2xl font-bold mb-4"></h1>
        <div class="flex flex-col items-center gap-4 mb-4">
          <input id="employeeIdInput" type="text" pattern="\d{5}" title="Á§æÂì°Áï™Âè∑„ÅØÂçäËßíÊï∞Â≠ó5Ê°Å„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ" class="text-black px-3 py-2 w-full md:w-80 text-center rounded" />
        </div>
        <button id="start-button" class="dq-button inline-flex items-center gap-2"><span id="start-button-text"></span></button>
        <div id="msg" class="text-yellow-300 text-sm h-5 mt-2"></div>
      </div>

      <div id="quiz-screen" class="hidden">
        <div class="flex justify-between items-center mb-2 text-lg">
          <span id="theme-display"></span>
          <span id="progress-display"></span>
          <span id="timer-display">0.0s</span>
        </div>
        <div class="mb-4"><p id="boss-hp-label"></p><div class="boss-hp-container"><div id="boss-hp-bar"></div></div></div>
        <div class="mb-4 min-h-[80px] p-4 border-2 border-white"><p id="question-text" class="text-xl"></p></div>
        <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      </div>
      <div id="result-screen" class="hidden text-center">
        <h2 id="result-title" class="text-3xl font-bold mb-4"></h2>
        <p id="result-message" class="text-xl mb-6"></p>
        <p id="submission-status" class="text-yellow-300 mb-8"></p>
        <div id="restart-button" class="dq-button inline-block"></div>
      </div>
      <div id="explanation-modal" class="absolute inset-0 bg-black bg-opacity-80 flex-col items-center justify-center p-4 hidden">
        <div class="dq-window w-full max-w-2xl text-center">
          <h2 id="explanation-title" class="text-4xl font-bold mb-4"></h2>
          <p id="explanation-text" class="text-lg mb-6 text-left h-48 overflow-y-auto p-2 border"></p>
          <button id="next-question-button" class="dq-button"></button>
        </div>
      </div>
    </div>
  </div>
  <audio id="bgm" src="./BS2_BGM.wav" loop onerror="handleMediaError(this)"></audio>
  <audio id="correct-sound" src="./correct_answer.mp3" onerror="handleMediaError(this)"></audio>
  <script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbzKjQfG-cW1tacggfb1JrGa8oT2iAqtgmdmeUb_wCdmMb3h78CXLgIiPVXsLXoMFdpHtQ/exec';
    const STAGE_NUMBER = '2';
    const TEXTS = {
      ja: {
        instructionTitle: "ÂÜíÈô∫„ÅÆÂøÉÂæó",
        instructions: ["„Éª„Çµ„Çπ„ÉÜ„Éä„Éì„É™„ÉÜ„Ç£„Å´Èñ¢„Åô„Çã5„Å§„ÅÆÂïèÈ°å„ÅåÂá∫È°å„Åï„Çå„Çã„Åû„ÄÇ", "„Éª4Âïè‰ª•‰∏äÊ≠£Ëß£„Åß„Éú„Çπ„ÇíË®é‰ºê„Åß„Åç„ÇãÔºÅ", "„ÉªÊúÄÂàù„ÅÆÊåëÊà¶ÁµêÊûú„ÅÆ„Åø„Åå„É©„É≥„Ç≠„É≥„Ç∞„Å´Ë®òÈå≤„Åï„Çå„Çã„Åû„ÄÇ", "„ÉªÂÅ•Èóò„ÇíÁ•à„ÇãÔºÅ"],
        instructionOk: "„Çè„Åã„Å£„Åü",
        title: "„Çπ„ÉÜ„Éº„Ç∏2ÔºöÂú∞Âüü„Å®Á§æ‰ºö",
        employeeIdPlaceholder: "Á§æÂì°Áï™Âè∑(ÂçäËßí5Ê°Å)„ÇíÂÖ•Âäõ",
        startButton: "ÊåëÊà¶„Åô„Çã",
        msgEnterId: "Á§æÂì°Áï™Âè∑„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ",
        msgCheckingId: "ÊåëÊà¶Ë≥áÊ†º„ÇíÁ¢∫Ë™ç‰∏≠...",
        msgIdNotFound: "„Çπ„ÉÜ„Éº„Ç∏1„Åã„ÇâÊåëÊà¶„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ",
        msgCheckError: "Á¢∫Ë™ç„Ç®„É©„Éº„ÄÇÊôÇÈñì„Çí„Åä„ÅÑ„Å¶ÂÜçË©¶Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
        theme: "„ÉÜ„Éº„ÉûÔºöÂú∞Âüü„Å®Á§æ‰ºö",
        progress: (q, t) => `${q}/${t}ÂïèÁõÆ`,
        bossHp: "„Éú„Çπ HP",
        resultWinTitle: "ÂãùÂà©ÔºÅ",
        resultWinMsg: "„Çπ„ÉÜ„Éº„Ç∏„ÇØ„É™„Ç¢ÔºÅÁ§æ‰ºö„Å∏„ÅÆÁêÜËß£„ÅåÊ∑±„Åæ„Å£„ÅüÔºÅ",
        resultLoseTitle: "„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº",
        resultLoseMsg: "Á´ú„ÅÆÂÆà„Çä„ÅØÂõ∫„Åã„Å£„Åü‚Ä¶",
        submitting: "ÁµêÊûú„ÇíÈÄÅ‰ø°‰∏≠...",
        submitSuccess: "ÁµêÊûú„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„ÅüÔºÅ",
        submitError: "„Ç®„É©„ÉºÔºöÁµêÊûú„ÇíÈÄÅ‰ø°„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ",
        restartButton: "„Çø„Ç§„Éà„É´„Å∏Êàª„Çã",
        correct: "Ê≠£Ëß£ÔºÅ",
        incorrect: "‰∏çÊ≠£Ëß£...",
        nextButton: "Ê¨°„Å∏",
        quiz: [
          { q: "Âú∞ÂüüÊ¥ªÊÄßÂåñ„ÅåÁõÆÊåá„Åô„ÄÅÂ§ö„Åè„ÅÆÂú∞Âüü„ÅßÂÖ±ÈÄö„ÅÆË™≤È°å„Å®„ÅØÔºü", o: ["Ëá™ÁÑ∂Áí∞Â¢É„ÅÆÂÖ®„Å¶„ÇíÈñãÁô∫", "‰∫∫Âè£Ê∏õÂ∞ë„Å®ÁµåÊ∏àÂÅúÊªû„ÅÆÈ£ü„ÅÑÊ≠¢„ÇÅ", "ÁâπÂÆöÁî£Ê•≠„Å∏„ÅÆ‰æùÂ≠ò", "‰∏≠ÂøÉÈÉΩÂ∏Ç„ÅÆÈÅéÂØÜÂåñ‰øÉÈÄ≤"], a: "‰∫∫Âè£Ê∏õÂ∞ë„Å®ÁµåÊ∏àÂÅúÊªû„ÅÆÈ£ü„ÅÑÊ≠¢„ÇÅ", ex: "‰∫∫Âè£Ê∏õÂ∞ë„Å´„Çà„ÇãÂä¥ÂÉçÂäõ‰∏çË∂≥„ÇÑÈ´òÈΩ¢Âåñ„ÄÅÁµåÊ∏àÂäõ„ÅÆ‰Ωé‰∏ã„ÅØÂ§ö„Åè„ÅÆÂú∞Âüü„ÅåÁõ¥Èù¢„Åô„ÇãÂÖ±ÈÄö„ÅÆË™≤È°å„Åß„ÅÇ„Çä„ÄÅÂú∞ÂüüÊ¥ªÊÄßÂåñ„ÅÆÊúÄ„ÇÇÈáçË¶Å„Å™ÁõÆÁöÑ„Åß„Åô„ÄÇ" },
          { q: "ÂªÉÂ∑•Â†¥„Å™„Å©„Çí„ÇÆ„É£„É©„É™„Éº„ÇÑÂäáÂ†¥„Å´ÂÜçÁîü„Åô„ÇãÂèñ„ÇäÁµÑ„Åø„Çí‰Ωï„Å®Âëº„Å∂Ôºü", o: ["„Ç§„É≥„Éï„É©Êï¥ÂÇô", "„Ç§„É≥„Éï„Ç£„É´ÈñãÁô∫", "„Ç∏„Çß„É≥„Éà„É™„Éï„Ç£„Ç±„Éº„Ç∑„Éß„É≥", "„Ç≥„É≥„Éê„Éº„Ç∏„Éß„É≥"], a: "„Ç≥„É≥„Éê„Éº„Ç∏„Éß„É≥", ex: "Âª∫Áâ©„ÅÆÁî®ÈÄî„ÇíÂ§â„Åà„Å¶ÂÜçÂà©Áî®„Åô„Çã„Åì„Å®„Çí„Äé„Ç≥„É≥„Éê„Éº„Ç∏„Éß„É≥„Äè„Å®Âëº„Å≥„Åæ„Åô„ÄÇÁî£Ê•≠ÈÅ∫Áî£„Å™„Å©„ÇíÊñáÂåñ„ÇÑÂïÜÊ•≠„ÅÆÊã†ÁÇπ„Å®„Åó„Å¶Ê¥ªÁî®„Åô„ÇãÊâãÊ≥ï„ÅØ„ÄÅ‰∏ñÁïå‰∏≠„ÅÆÈÉΩÂ∏Ç„ÅßÂú∞ÂüüÊ¥ªÊÄßÂåñ„ÅÆÊàêÂäü‰æã„Å®„Åó„Å¶Áü•„Çâ„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ" },
          { q: "Á©∫„ÅçÂ∫óËàó„ÇíÊ¥ªÁî®„Åó„Å¶Â∞èË¶èÊ®°‰∫ãÊ•≠ËÄÖ„ÅÆËµ∑Ê•≠„ÇíÊîØÊè¥„Åô„Çã‰∏ª„Å™„É°„É™„ÉÉ„Éà„ÅØÔºü", o: ["Ëµ∑Ê•≠„Ç≥„Çπ„Éà„ÇíÊäë„Åà„ÄÅÈ≠ÖÂäõÁöÑ„Å™Ë°ó‰∏¶„Åø„Çí‰Ωú„Çã", "Á©∫„ÅçÂ∫óËàó„ÅÆÊåÅ„Å°‰∏ª„ÅÆÂèéÁõä‰øùË®º", "ÁâπÂÆö„ÉÅ„Çß„Éº„É≥Â∫ó„ÅÆ„Åø„ÇíË™òËá¥", "Â§ßË¶èÊ®°„Å™ÂïÜÊ•≠ÊñΩË®≠„ÅÆË™òËá¥"], a: "Ëµ∑Ê•≠„Ç≥„Çπ„Éà„ÇíÊäë„Åà„ÄÅÈ≠ÖÂäõÁöÑ„Å™Ë°ó‰∏¶„Åø„Çí‰Ωú„Çã", ex: "Á©∫„ÅçÂ∫óËàó„ÅÆÊ¥ªÁî®„ÅØÂàùÊúüÊäïË≥á„ÇíÊäë„Åà„Çâ„Çå„Çã„Åü„ÇÅ„ÄÅËµ∑Ê•≠„ÅÆ„Éè„Éº„Éâ„É´„Åå‰∏ã„Åå„Çä„Åæ„Åô„ÄÇÂ§öÊßò„Å™Â∫óËàó„ÅåÂ¢ó„Åà„Çã„Åì„Å®„Åß„ÄÅË°ó„Å´„Å´„Åé„Çè„ÅÑ„ÅåÁîü„Åæ„Çå„ÄÅÊñ∞„Åü„Å™È≠ÖÂäõ„Å®„Å™„Çã„Åì„Å®„ÅåÊúüÂæÖ„Åï„Çå„Åæ„Åô„ÄÇ" },
          { q: "NKC„Ç∞„É´„Éº„Éó„ÅåÂ§ßÈò™Â∏ÇÂåóÂå∫„Å®„ÅÆÈÄ£Êê∫ÂçîÂÆö„ÅßË≤¢ÁåÆ„Åß„Åç„Çã„Åì„Å®„ÅØÔºü", o: ["Ëã•Êâã‰∫∫ÊùêËÇ≤Êàê„Å®‰ºÅÊ•≠„ÅÆ‰∫∫ÊùêÁ¢∫‰øù", "Âú∞ÂüüÁ§æ‰ºö„ÅÆÁô∫Â±ï„Å®‰ºÅÊ•≠‰æ°ÂÄ§Âêë‰∏ä", "‰ΩèÊ∞ë„ÅÆÁ¶èÂà©ÂéöÁîü„Å®ÂæìÊ•≠Âì°Ê∫ÄË∂≥Â∫¶Âêë‰∏ä", "Âú∞ÂüüÁµåÊ∏àÊ¥ªÊÄßÂåñ„Å®Êñ∞Ë¶è‰∫ãÊ•≠ÂâµÂá∫"], a: "Âú∞ÂüüÁ§æ‰ºö„ÅÆÁô∫Â±ï„Å®‰ºÅÊ•≠‰æ°ÂÄ§Âêë‰∏ä", ex: "ÂåóÂå∫„Å®„ÅÆÈÄ£Êê∫ÂçîÂÆö„Å´„Çà„Çä„ÄÅNKC„Ç∞„É´„Éº„Éó„ÅåÂú∞ÂüüÁ§æ‰ºö„ÅÆÁô∫Â±ï„Å´Ë≤¢ÁåÆ„Åô„Çã„Åì„Å®„ÅØ„ÇÇ„Å°„Çç„Çì„ÄÅ„Åù„Çå„Çâ„ÅÆÂèñ„ÇäÁµÑ„Åø„ÇíÈÄö„Åò„Å¶NKC„Ç∞„É´„Éº„Éó„ÅÆ‰ºÅÊ•≠‰æ°ÂÄ§Âêë‰∏ä„Å´„ÇÇË≤¢ÁåÆ„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ" },
          { q: "ÁµåÊ∏àÁöÑÁêÜÁî±„ÅßÈ£ü‰∫ã„Åå„Å®„Çå„Å™„ÅÑÂ≠ê„Å©„ÇÇ„ÇíÊîØÊè¥„Åô„ÇãÊó•Êú¨„ÅßÂ∫É„Åå„ÇãÊ¥ªÂãï„ÅØÔºü", o: ["„Éï„Ç°„Çπ„Éà„Éï„Éº„ÉâÂ∫ó„ÅÆÂâ≤ÂºïÂà∏ÈÖçÂ∏É", "„Åì„Å©„ÇÇÈ£üÂ†Ç„ÅÆÈÅãÂñ∂", "È´òÈ°ç„Å™Â≠¶ÁøíÂ°æ„Å∏„ÅÆÁÑ°ÊñôÊãõÂæÖ", "Êµ∑Â§ñÊóÖË°å„ÅÆ„Éó„É¨„Çº„É≥„Éà"], a: "„Åì„Å©„ÇÇÈ£üÂ†Ç„ÅÆÈÅãÂñ∂", ex: "Â≠ê„Å©„ÇÇÈ£üÂ†Ç„ÅØ„ÄÅÁµåÊ∏àÁöÑ„Å™ÁêÜÁî±„Å†„Åë„Åß„Å™„Åè„ÄÅÂ≠§È£ü„ÅÆÈò≤Ê≠¢„ÇÑÂú∞Âüü„Ç≥„Éü„É•„Éã„ÉÜ„Ç£„ÅÆÊ¥ªÊÄßÂåñ„Å™„Å©„ÇÇÁõÆÁöÑ„Å´„ÄÅÂÖ®ÂõΩ„Å´Â∫É„Åå„Å£„Å¶„ÅÑ„ÇãÊ¥ªÂãï„Åß„Åô„ÄÇ" }
        ]
      },
      en: {
        instructionTitle: "Rules of the Quest",
        instructions: ["- You will be asked 5 questions about sustainability.", "- Answer 4 or more correctly to defeat the boss!", "- Only your first attempt will be recorded for the ranking.", "- Good luck!"],
        instructionOk: "Got it",
        title: "Stage 2: Community & Society",
        employeeIdPlaceholder: "Enter 5-digit Employee ID",
        startButton: "Challenge",
        msgEnterId: "Please enter your Employee ID",
        msgCheckingId: "Checking eligibility...",
        msgIdNotFound: "Please complete Stage 1 first!",
        msgCheckError: "Verification error. Please try again later.",
        theme: "Theme: Community & Society",
        progress: (q, t) => `Q ${q}/${t}`,
        bossHp: "Boss HP",
        resultWinTitle: "Victory!",
        resultWinMsg: "Stage Clear! Your understanding of society has deepened!",
        resultLoseTitle: "Game Over",
        resultLoseMsg: "The dragon's defense was solid...",
        submitting: "Submitting results...",
        submitSuccess: "Results submitted!",
        submitError: "Error: Could not submit results.",
        restartButton: "Back to Title",
        correct: "Correct!",
        incorrect: "Incorrect...",
        nextButton: "Next",
        quiz: [
          { q: "What is a common challenge that regional revitalization aims to solve in many areas?", o: ["Developing all natural environments", "Halting population decline and economic stagnation", "Dependence on specific industries", "Promoting overcrowding in central cities"], a: "Halting population decline and economic stagnation", ex: "Population decline, labor shortages, aging populations, and economic decline are common challenges facing many regions, making them the most important goals of regional revitalization." },
          { q: "What is the term for repurposing abandoned factories into galleries or theaters?", o: ["Infrastructure development", "Infill development", "Gentrification", "Conversion"], a: "Conversion", ex: "Changing a building's use for reuse is called 'conversion.' Utilizing industrial heritage as cultural and commercial hubs is a successful example of regional revitalization in cities worldwide." },
          { q: "What is the main benefit of using vacant stores to support small business startups?", o: ["Creating attractive streets while reducing startup costs", "Guaranteeing income for vacant store owners", "Attracting only specific chain stores", "Attracting large commercial facilities"], a: "Creating attractive streets while reducing startup costs", ex: "Utilizing vacant stores lowers the barrier to entry for startups by reducing initial investment. An increase in diverse shops is expected to bring vibrancy and new charm to the town." },
          { q: "How can the NKC Group contribute through its agreement with Kita Ward, Osaka?", o: ["Youth development and corporate recruitment", "Community development and corporate value enhancement", "Resident welfare and employee satisfaction", "Economic revitalization and new business creation"], a: "Community development and corporate value enhancement", ex: "Through the agreement with Kita Ward, the NKC Group not only contributes to community development but also enhances its corporate value through these initiatives." },
          { q: "What activity is spreading in Japan to support children who cannot get enough food for economic reasons?", o: ["Distributing fast-food coupons", "Operating 'Kodomo Shokudo' (children's cafeterias)", "Free invitations to expensive cram schools", "Gifts of overseas trips"], a: "Operating 'Kodomo Shokudo' (children's cafeterias)", ex: "'Kodomo Shokudo' are spreading nationwide not only for economic reasons but also to prevent solitary meals and revitalize local communities." }
        ]
      },
      zh: {
        instructionTitle: "ÂÜíÈô©È°ªÁü•",
        instructions: ["„ÉªÂ∞ÜÊèêÂá∫5‰∏™ÂÖ≥‰∫éÂèØÊåÅÁª≠ÊÄßÁöÑÈóÆÈ¢ò„ÄÇ", "„ÉªÊ≠£Á°ÆÂõûÁ≠î4‰∏™‰ª•‰∏äÈóÆÈ¢òÂç≥ÂèØÂáªË¥•Â§¥ÁõÆÔºÅ", "„ÉªÂè™ÊúâÁ¨¨‰∏ÄÊ¨°ÊåëÊàòÁöÑÁªìÊûú‰ºöË¢´ËÆ∞ÂΩïÂú®ÊéíÂêç‰∏≠„ÄÇ", "„ÉªÁ•ù‰Ω†Â•ΩËøêÔºÅ"],
        instructionOk: "Áü•ÈÅì‰∫Ü",
        title: "Á¨¨‰∫åÂÖ≥ÔºöÂú∞Âå∫‰∏éÁ§æ‰ºö",
        employeeIdPlaceholder: "ËæìÂÖ•ÂëòÂ∑•ÁºñÂè∑(5‰ΩçÂçäËßíÊï∞Â≠ó)",
        startButton: "ÊåëÊàò",
        msgEnterId: "ËØ∑ËæìÂÖ•ÂëòÂ∑•ÁºñÂè∑",
        msgCheckingId: "Ê≠£Âú®Á°ÆËÆ§ÊåëÊàòËµÑÊ†º...",
        msgIdNotFound: "ËØ∑ÂÖàÊåëÊàòÁ¨¨‰∏ÄÂÖ≥ÔºÅ",
        msgCheckError: "Á°ÆËÆ§Âá∫Èîô„ÄÇËØ∑Á®çÂêéÂÜçËØï„ÄÇ",
        theme: "‰∏ªÈ¢òÔºöÂú∞Âå∫‰∏éÁ§æ‰ºö",
        progress: (q, t) => `Á¨¨${q}/${t}È¢ò`,
        bossHp: "Â§¥ÁõÆ HP",
        resultWinTitle: "ËÉúÂà©ÔºÅ",
        resultWinMsg: "ÂÖ≥Âç°ÂÆåÊàêÔºÅÂä†Ê∑±‰∫ÜÂØπÁ§æ‰ºöÁöÑÁêÜËß£ÔºÅ",
        resultLoseTitle: "Ê∏∏ÊàèÁªìÊùü",
        resultLoseMsg: "ÈæôÁöÑÈò≤Âæ°ÂæàÂùöÂõ∫‚Ä¶",
        submitting: "Ê≠£Âú®ÂèëÈÄÅÁªìÊûú...",
        submitSuccess: "ÁªìÊûúÂ∑≤ÂèëÈÄÅÔºÅ",
        submitError: "ÈîôËØØÔºöÊó†Ê≥ïÂèëÈÄÅÁªìÊûú„ÄÇ",
        restartButton: "ËøîÂõûÊ†áÈ¢ò",
        correct: "ÂõûÁ≠îÊ≠£Á°ÆÔºÅ",
        incorrect: "ÂõûÁ≠îÈîôËØØ...",
        nextButton: "‰∏ã‰∏Ä‰∏™",
        quiz: [
            { q: "Âå∫ÂüüÊåØÂÖ¥Êó®Âú®Ëß£ÂÜ≥ÁöÑËÆ∏Â§öÂú∞Âå∫ÂÖ±ÈÄöÁöÑËØæÈ¢òÊòØ‰ªÄ‰πàÔºü", o: ["ÂºÄÂèëÊâÄÊúâËá™ÁÑ∂ÁéØÂ¢É", "ÈòªÊ≠¢‰∫∫Âè£ÂáèÂ∞ëÂíåÁªèÊµéÂÅúÊªû", "‰æùËµñÁâπÂÆö‰∫ß‰∏ö", "‰øÉËøõ‰∏≠ÂøÉÂüéÂ∏ÇËøáÂ∫¶Êã•Êå§"], a: "ÈòªÊ≠¢‰∫∫Âè£ÂáèÂ∞ëÂíåÁªèÊµéÂÅúÊªû", ex: "Âõ†‰∫∫Âè£ÂáèÂ∞ëÂØºËá¥ÁöÑÂä≥Âä®Âäõ‰∏çË∂≥„ÄÅËÄÅÈæÑÂåñ‰ª•ÂèäÁªèÊµéÂÆûÂäõ‰∏ãÈôçÊòØËÆ∏Â§öÂú∞Âå∫Èù¢‰∏¥ÁöÑÂÖ±ÂêåËØæÈ¢òÔºå‰πüÊòØÂå∫ÂüüÊåØÂÖ¥ÊúÄÈáçË¶ÅÁöÑÁõÆÊ†á„ÄÇ" },
            { q: "Â∞ÜÂ∫üÂºÉÂ∑•ÂéÇÁ≠âÊîπÈÄ†‰∏∫ÁîªÂªäÊàñÂâßÈô¢ÁöÑ‰∏æÊé™Áß∞‰∏∫‰ªÄ‰πàÔºü", o: ["Âü∫Á°ÄËÆæÊñΩÂª∫ËÆæ", "ÂÜÖÈÉ®Â°´ÂÖÖÂºÄÂèë", "Â£´ÁªÖÂåñ", "ÂäüËÉΩËΩ¨Êç¢"], a: "ÂäüËÉΩËΩ¨Êç¢", ex: "ÊîπÂèòÂª∫Á≠ëÁâ©Áî®ÈÄî‰ª•ÈáçÊñ∞Âà©Áî®Áß∞‰∏∫‚ÄúÂäüËÉΩËΩ¨Êç¢‚Äù„ÄÇÂ∞ÜÂ∑•‰∏öÈÅó‰∫ßÁ≠âÊ¥ªÂåñ‰∏∫ÊñáÂåñÂíåÂïÜ‰∏ö‰∏≠ÂøÉÁöÑÊâãÊ≥ïÔºåÂú®‰∏ñÁïåÂêÑÂú∞ÁöÑÂüéÂ∏Ç‰∏≠‰Ωú‰∏∫Âå∫ÂüüÊåØÂÖ¥ÁöÑÊàêÂäüÊ°à‰æãËÄåÈóªÂêç„ÄÇ" },
            { q: "Âà©Áî®Á©∫ÁΩÆÂ∫óÈì∫ÊîØÊåÅÂ∞èËßÑÊ®°Âàõ‰∏öËÄÖÁöÑ‰∏ªË¶ÅÂ•ΩÂ§ÑÊòØ‰ªÄ‰πàÔºü", o: ["Âú®ÊäëÂà∂Âàõ‰∏öÊàêÊú¨ÁöÑÂêåÊó∂ÔºåÊâìÈÄ†ÊúâÈ≠ÖÂäõÁöÑË°óÊôØ", "‰øùËØÅÁ©∫ÁΩÆÂ∫óÈì∫ÊâÄÊúâËÄÖÁöÑÊî∂Áõä", "‰ªÖÂê∏ÂºïÁâπÂÆöËøûÈîÅÂ∫ó", "Âê∏ÂºïÂ§ßÂûãÂïÜ‰∏öËÆæÊñΩ"], a: "Âú®ÊäëÂà∂Âàõ‰∏öÊàêÊú¨ÁöÑÂêåÊó∂ÔºåÊâìÈÄ†ÊúâÈ≠ÖÂäõÁöÑË°óÊôØ", ex: "Âà©Áî®Á©∫ÁΩÆÂ∫óÈì∫ÂèØ‰ª•ÊäëÂà∂ÂàùÊúüÊäïËµÑÔºå‰ªéËÄåÈôç‰ΩéÂàõ‰∏öÁöÑÈó®Êßõ„ÄÇÂ§öÊ†∑ÂåñÂ∫óÈì∫ÁöÑÂ¢ûÂä†ÔºåÊúâÊúõ‰∏∫Ë°óÈÅìÂ∏¶Êù•Ê¥ªÂäõÔºåÊàê‰∏∫Êñ∞ÁöÑÈ≠ÖÂäõ„ÄÇ" },
            { q: "NKCÈõÜÂõ¢ÈÄöËøá‰∏éÂ§ßÈò™Â∏ÇÂåóÂå∫ÁöÑÂêà‰ΩúÂçèËÆÆËÉΩÂÅöÂá∫‰ªÄ‰πàË¥°ÁåÆÔºü", o: ["ÂüπÂÖªÂú∞Âå∫ÈùíÂπ¥‰∫∫Êâç‰∏éÁ°Æ‰øù‰ºÅ‰∏ö‰∫∫Êâç", "Âú∞Âå∫Á§æ‰ºöÁöÑÂèëÂ±ï‰∏é‰ºÅ‰∏ö‰ª∑ÂÄºÁöÑÊèêÂçá", "ÊèêÈ´òÂú∞Âå∫Â±ÖÊ∞ëÁöÑÁ¶èÂà©‰∏éÂëòÂ∑•Êª°ÊÑèÂ∫¶", "Ê¥ªÂåñÂú∞Âå∫ÁªèÊµé‰∏éÂàõÈÄ†Êñ∞‰∫ã‰∏ö"], a: "Âú∞Âå∫Á§æ‰ºöÁöÑÂèëÂ±ï‰∏é‰ºÅ‰∏ö‰ª∑ÂÄºÁöÑÊèêÂçá", ex: "ÈÄöËøá‰∏éÂåóÂå∫ÁöÑÂêà‰ΩúÂçèËÆÆÔºåNKCÈõÜÂõ¢‰∏ç‰ªÖ‰∏∫Âú∞Âå∫Á§æ‰ºöÁöÑÂèëÂ±ïÂÅöÂá∫Ë¥°ÁåÆÔºåÂπ∂ÈÄöËøáËøô‰∫õ‰∏æÊé™ÊèêÂçáNKCÈõÜÂõ¢ÁöÑ‰ºÅ‰∏ö‰ª∑ÂÄº„ÄÇ" },
            { q: "Âú®Êó•Êú¨‰∏∫ÊîØÊè¥Âõ†ÁªèÊµéÂéüÂõ†Êó†Ê≥ïËé∑ÂæóË∂≥Â§üÈ£üÁâ©ÁöÑÂÑøÁ´•ËÄåÊé®ÂπøÁöÑÊ¥ªÂä®ÊòØ‰ªÄ‰πàÔºü", o: ["ÂàÜÂèëÂø´È§êÂ∫óÊäòÊâ£Âà∏", "ËøêËê•ÂÑøÁ´•È£üÂ†Ç", "ÂÖçË¥πÈÇÄËØ∑ÂèÇÂä†ÊòÇË¥µÁöÑË°•‰π†Áè≠", "Ëµ†ÈÄÅÊµ∑Â§ñÊóÖË°å"], a: "ËøêËê•ÂÑøÁ´•È£üÂ†Ç", ex: "ÂÑøÁ´•È£üÂ†Ç‰∏ç‰ªÖÂõ†‰∏∫ÁªèÊµéÂéüÂõ†Ôºå‰πü‰∏∫‰∫ÜÈò≤Ê≠¢Â≠§Áã¨Áî®È§êÂíåÊ¥ªÂåñÂú∞Âå∫Á§æÁæ§Á≠âÁõÆÁöÑÔºåÂú®ÂÖ®ÂõΩËåÉÂõ¥ÂÜÖÊé®Âπø„ÄÇ" }
        ]
      }
    };
    
    const titleScreen = document.getElementById('title-screen');
    const languageScreen = document.getElementById('language-screen');
    const instructionScreen = document.getElementById('instruction-screen');
    const startScreen = document.getElementById('start-screen');
    const quizScreen = document.getElementById('quiz-screen');
    const resultScreen = document.getElementById('result-screen');
    const bossContainer = document.getElementById('boss-container');
    const employeeIdInput = document.getElementById('employeeIdInput');
    const bgm = document.getElementById('bgm');
    const correctSound = document.getElementById('correct-sound');
    const startButton = document.getElementById('start-button');
    const explanationModal = document.getElementById('explanation-modal');
    const nextQuestionButton = document.getElementById('next-question-button');
    const openingVideoContainer = document.getElementById('opening-video-container');
    const gameVideoContainer = document.getElementById('game-video-container');

    let currentLang = 'ja';
    let timerInterval, startTime, correctCount, isGameInProgress = false, audioStarted = false;
    let clickSound, hitSound, damageSound, victorySound, defeatSound;

    function switchScreen(screenName) {
      [titleScreen, languageScreen, instructionScreen, startScreen, quizScreen, resultScreen].forEach(s => s.classList.add('hidden'));
      document.getElementById(`${screenName}-screen`).classList.remove('hidden');
    }
    
    function updateUIText() {
      const t = TEXTS[currentLang];
      document.body.lang = currentLang;
      document.getElementById('instruction-title').textContent = t.instructionTitle;
      document.getElementById('instruction-text').innerHTML = t.instructions.map(line => `<p>${line}</p>`).join('');
      document.getElementById('instruction-ok-button').textContent = t.instructionOk;
      document.getElementById('title-text').textContent = t.title;
      employeeIdInput.placeholder = t.employeeIdPlaceholder;
      document.getElementById('start-button-text').textContent = t.startButton;
      document.getElementById('boss-hp-label').textContent = t.bossHp;
      document.getElementById('restart-button').textContent = t.restartButton;
      document.getElementById('theme-display').textContent = t.theme;
    }

    function setupAudio() {
      if (audioStarted) return;
      clickSound = () => new Tone.MembraneSynth({ pitchDecay: 0.01, octaves: 3, envelope: { attack: 0.001, decay: 0.3, sustain: 0 } }).toDestination().triggerAttackRelease("C2", "8n");
      hitSound = () => {
        correctSound.currentTime = 0;
        correctSound.play().catch(e => console.error("Correct sound play failed:", e));
      };
      damageSound = () => new Tone.NoiseSynth({ noise: { type: "pink" }, envelope: { attack: 0.01, decay: 0.3, sustain: 0, release: 0.2 } }).toDestination().triggerAttackRelease("8n");
      victorySound = () => { const s = new Tone.Synth().toDestination(), n = Tone.now(); s.triggerAttackRelease("C5", "8n", n); s.triggerAttackRelease("E5", "8n", n + 0.2); s.triggerAttackRelease("G5", "8n", n + 0.4); s.triggerAttackRelease("C6", "4n", n + 0.6) };
      defeatSound = () => { const s = new Tone.Synth().toDestination(), n = Tone.now(); s.triggerAttackRelease("C4", "4n", n); s.triggerAttackRelease("B3", "4n", n + 0.3); s.triggerAttackRelease("A#3", "4n", n + 0.6); s.triggerAttackRelease("A3", "2n", n + 0.9) };
      audioStarted = true;
    }

    async function startGame() {
      if (!employeeIdInput.checkValidity()) {
        employeeIdInput.reportValidity();
        return;
      }
      const employeeId = employeeIdInput.value.trim();
      const msgEl = document.getElementById('msg');
      if (!employeeId) {
        msgEl.textContent = TEXTS[currentLang].msgEnterId;
        return;
      }
      if (isGameInProgress) return;
      isGameInProgress = true;
      startButton.disabled = true;
      msgEl.textContent = TEXTS[currentLang].msgCheckingId;

      try {
        const checkUrl = `${GAS_URL}?action=checkEmployeeId&employeeId=${encodeURIComponent(employeeId)}`;
        const response = await fetch(checkUrl);
        const result = await response.json();

        if (result.exists) {
          msgEl.textContent = "";
          bgm.play().catch(e => console.error("BGM play failed:", e));
          clickSound();
          correctCount = 0;
          document.getElementById('boss-area').classList.remove('hidden');
          bossContainer.className = 'boss-idle';
          updateHpBars(100);
          switchScreen('quiz');
          startTime = Date.now();
          timerInterval = setInterval(() => {
            const elapsedTime = ((Date.now() - startTime) / 1000).toFixed(1);
            document.getElementById('timer-display').textContent = `${elapsedTime}s`;
          }, 100);
          displayQuestion(0);
        } else {
          msgEl.textContent = TEXTS[currentLang].msgIdNotFound;
        }
      } catch (error) {
        console.error("Error checking employee ID:", error);
        msgEl.textContent = TEXTS[currentLang].msgCheckError;
      } finally {
        isGameInProgress = false;
        startButton.disabled = false;
      }
    }

    function displayQuestion(index) {
      const quizData = TEXTS[currentLang].quiz;
      document.getElementById('progress-display').textContent = TEXTS[currentLang].progress(index + 1, quizData.length);
      const current = quizData[index];
      document.getElementById('question-text').textContent = `Q${index + 1}: ${current.q}`;
      const optionsContainer = document.getElementById('options-container');
      optionsContainer.innerHTML = '';
      current.o.forEach(opt => {
        const div = document.createElement('div');
        div.textContent = `‚ñ∂ ${opt}`;
        div.classList.add('dq-button');
        div.addEventListener('click', () => handleAnswer(opt, current, index));
        optionsContainer.appendChild(div);
      });
    }

    function handleAnswer(selectedAnswer, currentQuiz, index) {
      const isCorrect = selectedAnswer === currentQuiz.a;
      const optionsContainer = document.getElementById('options-container');
      optionsContainer.querySelectorAll('.dq-button').forEach(btn => {
        btn.style.pointerEvents = 'none';
        if (btn.textContent.includes(currentQuiz.a)) {
          btn.classList.add('correct-answer');
        } else {
          btn.classList.add('incorrect-answer');
        }
      });

      if (isCorrect) {
        correctCount++;
        hitSound();
        updateHpBars(100 - (correctCount * (100 / 4)));
        bossContainer.classList.add('shake');
        document.getElementById('explanation-title').textContent = TEXTS[currentLang].correct;
      } else {
        damageSound();
        document.querySelector('.dq-window').classList.add('shake');
        document.getElementById('explanation-title').textContent = TEXTS[currentLang].incorrect;
      }
      
      document.getElementById('explanation-text').textContent = currentQuiz.ex;
      nextQuestionButton.textContent = TEXTS[currentLang].nextButton;
      nextQuestionButton.dataset.nextIndex = index + 1;
      
      setTimeout(() => {
        explanationModal.style.display = 'flex';
      }, 800);
    }
    
    nextQuestionButton.addEventListener('click', () => {
      explanationModal.style.display = 'none';
      bossContainer.classList.remove('shake');
      document.querySelector('.dq-window').classList.remove('shake');
      
      const nextIndex = parseInt(nextQuestionButton.dataset.nextIndex);
      if (nextIndex >= TEXTS[currentLang].quiz.length) {
        showEndScreen();
      } else {
        displayQuestion(nextIndex);
      }
    });

    function showEndScreen() {
      clearInterval(timerInterval);
      bgm.pause();
      bgm.currentTime = 0;
      
      const isVictory = correctCount >= 4;
      if (isVictory) {
        victorySound();
        bossContainer.className = 'boss-defeat';
      } else {
        defeatSound();
      }
      
      setTimeout(() => {
        document.getElementById('boss-area').classList.add('hidden');
        switchScreen('result');
        const t = TEXTS[currentLang];
        document.getElementById('result-title').textContent = isVictory ? t.resultWinTitle : t.resultLoseTitle;
        document.getElementById('result-message').textContent = isVictory ? t.resultWinMsg : t.resultLoseMsg;
        submitResults();
      }, isVictory ? 1500 : 500);
    }

    async function submitResults() {
        const statusEl = document.getElementById('submission-status');
        let ipAddress = 'N/A';
        try {
            const response = await fetch('https://api.ipify.org?format=json');
            ipAddress = (await response.json()).ip;
        } catch (error) {
            console.error('IP„Ç¢„Éâ„É¨„Çπ„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', error);
        }

        const payload = {
            employeeId: employeeIdInput.value.trim(),
            stage: STAGE_NUMBER,
            score: correctCount,
            time: ((Date.now() - startTime) / 1000).toFixed(2),
            ipAddress: ipAddress
        };
        statusEl.textContent = TEXTS[currentLang].submitting;
        fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload), mode: 'no-cors' })
            .then(() => { statusEl.textContent = TEXTS[currentLang].submitSuccess; })
            .catch(err => { statusEl.textContent = TEXTS[currentLang].submitError; console.error('Error:', err); });
    }

    function updateHpBars(percentage) {
      const hpBar = document.getElementById('boss-hp-bar');
      hpBar.style.width = `${Math.max(0, percentage)}%`;
      if (percentage <= 25) hpBar.className = 'boss-hp-bar low';
      else if (percentage <= 50) hpBar.className = 'boss-hp-bar mid';
      else hpBar.className = 'boss-hp-bar full';
    }
    
    function handleMediaError(element) {
        console.error(`Error loading media: ${element.src}`);
        element.style.display = 'none'; 
    }

    document.getElementById('title-start-button').addEventListener('click', async () => {
      if (!audioStarted) { 
        await Tone.start();
        setupAudio();
      }
      clickSound();
      const openingVideo = document.getElementById('opening-video');
      openingVideo.muted = false;
      openingVideo.play().catch(e => console.log("User interaction might be needed for audio"));
      switchScreen('language');
    });

    document.getElementById('lang-ja').addEventListener('click', () => { clickSound(); currentLang = 'ja'; updateUIText(); switchScreen('instruction'); });
    document.getElementById('lang-en').addEventListener('click', () => { clickSound(); currentLang = 'en'; updateUIText(); switchScreen('instruction'); });
    document.getElementById('lang-zh').addEventListener('click', () => { clickSound(); currentLang = 'zh'; updateUIText(); switchScreen('instruction'); });
    
    document.getElementById('instruction-ok-button').addEventListener('click', () => {
      clickSound();
      openingVideoContainer.classList.add('hidden');
      document.getElementById('opening-video').pause();
      gameVideoContainer.classList.remove('hidden');
      document.getElementById('game-bg-video').play().catch(e => console.log("Game video play failed"));
      switchScreen('start');
    });
    
    startButton.addEventListener('click', startGame);
    document.getElementById('restart-button').addEventListener('click', () => location.reload());

    updateUIText();
    switchScreen('title');
    const openingVideo = document.getElementById('opening-video');
    openingVideo.muted = false;
    openingVideo.play().catch(e => {
        console.log("Autoplay with sound was prevented. Muting and retrying.");
        openingVideo.muted = true;
        openingVideo.play();
    });
  </script>
</body>
</html>
