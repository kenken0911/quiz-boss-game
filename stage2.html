<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sustainability Quest 🗡️ - Stage 2</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=Press+Start+2P&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
  <style>
    body[lang="ja"], body[lang="zh"] { font-family: 'DotGothic16', sans-serif; }
    body[lang="en"] { font-family: 'Press Start 2P', cursive; }
    body { background-color: #000; color: #fff; image-rendering: pixelated; overflow-x: hidden; overflow-y: auto; }
    .dq-window { border: 4px solid #fff; background: rgba(0, 50, 0, 0.85); padding: 1.5rem; box-shadow: 0 0 0 4px #000, 0 0 20px rgba(0, 255, 128, 0.5); backdrop-filter: blur(3px); }
    .dq-button { cursor: pointer; padding: .75rem 1.5rem; border: 2px solid #fff; background-image: linear-gradient(to bottom, #00aa55, #008833); text-shadow: 1px 1px 2px #000; transition: all 0.2s; }
    .dq-button:hover { background-image: linear-gradient(to bottom, #33dd88, #00aa55); box-shadow: 0 0 10px #fff; }
    .video-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
    .bg-video { width: 100%; height: 100%; object-fit: cover; }
    #title-screen h1 { font-size: 2.5rem; font-weight: bold; text-shadow: 0 0 5px #fff, 0 0 15px #fff, 0 0 25px #00aaff; animation: fadeInTitle 2s ease-out forwards; }
    #title-start-button { animation: pulseButton 2.5s infinite ease-in-out; }
    @keyframes fadeInTitle { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
    @keyframes pulseButton { 0%, 100% { transform: scale(1); box-shadow: 0 0 10px rgba(255,255,255,0.7); } 50% { transform: scale(1.05); box-shadow: 0 0 20px rgba(255,255,255,1); } }
    .boss-hp-container { border: 2px solid #fff; height: 30px; padding: 3px; background: #333; border-radius: 5px; box-shadow: inset 0 0 5px #000; }
    .boss-hp-bar { height: 100%; transition: width .5s ease-out, background-image .5s ease-out; border-radius: 2px; }
    .boss-hp-bar.full { background-image: linear-gradient(to right, #33ff33, #88ff88); }
    .boss-hp-bar.mid { background-image: linear-gradient(to right, #ffff33, #ffff88); }
    .boss-hp-bar.low { background-image: linear-gradient(to right, #ff3333, #ff8833); }
    .boss-idle { animation: boss-float 2.5s infinite ease-in-out; }
    @keyframes boss-float{ 0%,100% { transform: translateY(0); } 50% { transform: translateY(-12px); } }
    .boss-defeat { animation: boss-defeat-anim 1.5s forwards; }
    @keyframes boss-defeat-anim { 0% { opacity: 1; transform: rotate(0deg); } 50% { opacity: 1; transform: rotate(10deg); } 100% { opacity: 0; transform: translateY(100px) rotate(-20deg) scale(0.5); } }
    .shake { animation: shake .35s; }
    @keyframes shake { 10%,90% { transform: translate(-2px, -2px); } 20%,80% { transform: translate(3px, 2px); } 30%,50%,70% { transform: translate(-3px, 3px); } 40%,60% { transform: translate(3px, -2px); } }
    .forest-glow { filter: drop-shadow(0 0 8px #aaff00) drop-shadow(0 0 16px #33dd00) contrast(1.5); }
    #boss-img { width: 100%; max-width: 320px; height: auto; }
    .correct-answer { background-image: linear-gradient(to bottom, #ffdd00, #ffaa00) !important; color: #000; }
    .incorrect-answer { background-image: linear-gradient(to bottom, #888888, #555555) !important; opacity: 0.7; }
  </style>
</head>
<body class="flex items-start sm:items-center justify-center min-h-screen p-4">

  <div id="opening-video-container" class="video-container">
    <video id="opening-video" class="bg-video" src="./opening_movie.mp4" autoplay loop playsinline onerror="handleMediaError(this)"></video>
  </div>
  <div id="game-video-container" class="video-container hidden">
    <video id="game-bg-video" class="bg-video" src="./GameBackground2.mp4" autoplay muted loop playsinline onerror="handleMediaError(this)"></video>
  </div>

  <div class="w-full max-w-3xl mx-auto">
    <div id="boss-area" class="mb-4 h-64 flex justify-center items-end relative hidden">
      <div id="boss-container"><img id="boss-img" src="./Stage2_dragon.png" alt="ボスの画像" class="forest-glow" onerror="handleMediaError(this)"/></div>
    </div>
    <div id="game-container" class="w-full dq-window relative">
      <div id="title-screen" class="text-center py-8">
        <h1 class="mb-10">Sustainability Quest</h1>
        <button id="title-start-button" class="dq-button">START</button>
      </div>

      <div id="language-screen" class="text-center hidden">
        <h1 class="text-3xl font-bold mb-6">Select Language</h1>
        <p class="text-sm mb-6">Translations are provided by AI.</p>
        <div class="flex justify-center gap-2 flex-wrap">
          <button id="lang-ja" class="dq-button">日本語</button>
          <button id="lang-en" class="dq-button">English</button>
          <button id="lang-zh" class="dq-button">中文</button>
        </div>
      </div>

      <div id="instruction-screen" class="text-center hidden">
        <h1 id="instruction-title" class="text-3xl font-bold mb-4"></h1>
        <div id="instruction-text" class="text-left mb-6 space-y-2"></div>
        <button id="instruction-ok-button" class="dq-button"></button>
      </div>
      
      <div id="start-screen" class="text-center hidden">
        <h1 id="title-text" class="text-2xl font-bold mb-4"></h1>
        <div class="flex flex-col items-center gap-4 mb-4">
          <select id="companySelect" class="text-black px-3 py-2 w-full md:w-80 text-center rounded"></select>
          <input id="employeeIdInput" type="text" pattern="\d{5}" title="社員番号は半角数字5桁で入力してください" class="text-black px-3 py-2 w-full md:w-80 text-center rounded" />
        </div>
        <button id="start-button" class="dq-button inline-flex items-center gap-2"><span id="start-button-text"></span></button>
        <div id="msg" class="text-yellow-300 text-sm h-5 mt-2"></div>
      </div>

      <div id="quiz-screen" class="hidden">
        <div class="flex justify-between items-center mb-2 text-lg">
          <span id="theme-display"></span>
          <span id="progress-display"></span>
          <span id="timer-display">0.0s</span>
        </div>
        <div class="mb-4"><p id="boss-hp-label"></p><div class="boss-hp-container"><div id="boss-hp-bar"></div></div></div>
        <div class="mb-4 min-h-[80px] p-4 border-2 border-white"><p id="question-text" class="text-xl"></p></div>
        <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      </div>
      <div id="result-screen" class="hidden text-center">
        <h2 id="result-title" class="text-3xl font-bold mb-4"></h2>
        <p id="result-message" class="text-xl mb-6"></p>
        <p id="submission-status" class="text-yellow-300 mb-8"></p>
        <div id="restart-button" class="dq-button inline-block"></div>
      </div>
      <div id="explanation-modal" class="absolute inset-0 bg-black bg-opacity-80 flex-col items-center justify-center p-4 hidden">
        <div class="dq-window w-full max-w-2xl text-center">
          <h2 id="explanation-title" class="text-4xl font-bold mb-4"></h2>
          <p id="explanation-text" class="text-lg mb-6 text-left h-48 overflow-y-auto p-2 border"></p>
          <button id="next-question-button" class="dq-button"></button>
        </div>
      </div>
    </div>
  </div>
  <audio id="bgm" src="./BS2_BGM.wav" loop onerror="handleMediaError(this)"></audio>
  <audio id="correct-sound" src="./correct_answer.mp3" onerror="handleMediaError(this)"></audio>
  <script>
    // ★変更: GASのURLを最新版に更新
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbw4c7h0WeWv1t_c7SKS6ZVOILwumsMQ7S1hGFkp2SRxRV3WR3f6cfGisFZ6ptuc5u_QIQ/exec';
    const STAGE_NUMBER = '2';
    const TEXTS = {
      ja: {
        instructionTitle: "冒険の心得",
        instructions: ["・サステナビリティに関する5つの問題が出題されるぞ。", "・4問以上正解でボスを討伐できる！", "・各ステージの最初の挑戦結果のみが記録されるぞ。", "・健闘を祈る！"],
        instructionOk: "わかった",
        title: "ステージ2：多様性",
        employeeIdPlaceholder: "社員番号(半角5桁)を入力",
        companySelectDefault: "所属会社を選択してください",
        startButton: "挑戦する",
        msgEnterId: "所属会社と社員番号を入力してください",
        msgCheckingId: "挑戦資格を確認中...",
        msgIdNotFound: "ステージ1の記録が見つかりません。会社名と社員番号を確認してください。",
        msgCheckError: "確認エラー。時間をおいて再試行してください。",
        theme: "テーマ：多様性",
        progress: (q, t) => `${q}/${t}問目`,
        bossHp: "ボス HP",
        resultWinTitle: "勝利！",
        resultWinMsg: "ステージクリア！多様性への理解が深まった！",
        resultLoseTitle: "ゲームオーバー",
        resultLoseMsg: "竜の守りは固かった…",
        submitting: "結果を送信中...",
        submitSuccess: "結果を送信しました！",
        submitError: "エラー：結果を送信できませんでした。",
        recordedFalse: "プレイありがとう！記録は初回のもののみとなります。",
        restartButton: "タイトルへ戻る",
        correct: "正解！",
        incorrect: "不正解...",
        nextButton: "次へ",
        quiz: [
            { q: "私たちの世界の「見え方」は文化や言語によって異なり、例えば虹の色の数にも差があると言われます。この事実は「多様性」について、どのような本質的な気づきを与えてくれるでしょうか？", o: ["文化というフィルターを通して私たちの「認識」が多様な「現実」を生み出しているということ。", "文化の違いを乗り越え、世界で「唯一の正しい認識」を共有することが最終目的であること。", "認識は歴史と共に進歩するため、現代文化は古代文化より世界を正確に捉えていること。", "多様な文化の根底には、言語を超えた「全人類共通の真実」が隠されていること。"], a: "文化というフィルターを通して私たちの「認識」が多様な「現実」を生み出しているということ。", ex: "以下のように、虹の色の数についても文化によって認識にちがいがあります。自分が当たり前と思っていることが相手にとって当たり前ではないかもという意識を持つことが大事です。（参考）7色: 日本、スウェーデン、フィリピンほか。17世紀にアイザック・ニュートンが音階や惑星の数と結びつけスペクトルを7色（赤・橙・黄・緑・青・藍・紫）に分類したことが由来と言われています。6色: アメリカ、イギリス、ドイツなど。一般的に「藍色（インディゴ）」を青の一部として区別しないため、6色とされることも多いです。5色: (古代の)中国、ドイツなど。古代の中国では、五行思想と結びつき、虹は「五色の橋」と考えられていました。2色: アフリカや南アジアの一部の部族。例えば、暖色系をまとめて「赤」、寒色系をまとめて「黒」と表現する人たちもいます。" },
            { q: "NKCグループの拠点のある各国の発酵食品に関連して、誤っているものは次のうちどれでしょうか？", o: ["「東洋のチーズ」とも呼ばれる中国の「腐乳」は豆腐にカビを植え付けてつくる。", "フィリピン発祥の「ナタ・デ・ココ」は、ココナツミルクを発酵させてつくる。", "スウェーデンの「シュールストレミング」は、マスを発酵させてつくる。", "アメリカでは、「Kombucha」と呼ばれる紅茶を発酵させた酸味と微炭酸のある飲み物が飲まれている。"], a: "スウェーデンの「シュールストレミング」は、マスを発酵させてつくる。", ex: "スウェーデンの「シュールストレミング」は「マス」ではなく「ニシン」を発酵させてつくられます。その臭さは、納豆の約18倍ともされ、「世界で最も臭い食べ物」との呼び声も高いです。（なお、Dの「Kombucha」は日本の海藻の昆布を使った「昆布茶」とは全く別のものです）" },
            { q: "多くの研究で、多様な人財(人材)で構成されたチームは、メンバーの背景が似たチームよりも、複雑な問題解決において高い成果を出すことが示されています。その最も重要な理由と考えられるのは次のうちどれでしょうか？", o: ["マイノリティ人材は、本質的に創造性が豊かだから。", "様々な視点や知識が組み合わさることで、個人の「視点の死角」を補い合えるから。", "対立を避けることで、穏便に結論を出せるから。", "チーム内の人間関係が円滑になり、協力しやすくなるから。"], a: "様々な視点や知識が組み合わさることで、個人の「視点の死角」を補い合えるから。", ex: "多様なチームの真価は、異なる視点の存在が、チーム全体の思考プロセスにおける「死角（均質的な価値観のチームメンバーが見落としがちな事柄）を減らし総合的に物事を考慮して対処できるようになる点にあります。多様な人材をチームに引き入れるだけでなく、自由な意見を引き出し、多数派とちがった少数意見にも耳を傾ける組織風土の醸成も大切になります。" },
            { q: "英語のことわざに \"Variety is the spice of life.\" (多様性は人生のスパイスだ) というものがあります。このことわざが伝えたい、最も重要なメッセージは次のうちどれでしょうか？", o: ["新しい経験や変化、違いがあることによって、人生はより面白く、豊かな味わいになる。", "多様な知識があれば、人生の困難を乗り越えるための近道が見つかる。", "多様な価値観に触れることで、人生における唯一の正しい道がわかる。", "多様な選択肢がありすぎると、かえって人生の重要な決断を迷わせてしまう。"], a: "新しい経験や変化、違いがあることによって、人生はより面白く、豊かな味わいになる。", ex: "このことわざは、新しい経験や変化が人生をより面白くする、という意味です。スパイスは、単独で味わっても美味しくないし時に辛かったり苦かったりかもしれませんが、さまざまな食材や他のスパイスと複雑に混ざり合うことで重層的な味わいを増していく、というのは、多様な価値観や経験に触れる人生の豊かさと、たしかに似ているかもしれません。" },
            { q: "時間の捉え方も国や文化によって多様です。各国の特徴（一般論）として言われているもので、誤っているものは次のうちどれでしょうか？", o: ["スウェーデンでは仕事とプライベートのバランスを重視し、午後に「Fika(フィーカ)」と呼ばれるコーヒーブレイクをとる。", "アメリカでは「Time is money.(時は金なり)」のように、効率的で素早い意思決定や成果を求められる。", "中国では「長期志向」が強く、将来の大成功のためには現在の利益や快適さを犠牲にすることも厭わない。", "フィリピンでは人間関係を大切にすることから、約束された時間への遅刻に対して厳格である。"], a: "フィリピンでは人間関係を大切にすることから、約束された時間への遅刻に対して厳格である。", ex: "先のタイムスケジュールよりもその場の人間関係を優先する傾向があり、時間に寛容な「Filipino Time」という言葉も存在するほどです。親しい間柄の集まりでは、時間通りに行くとかえって早すぎると見なされることさえあります。（あくまでも、文化による価値観の多様性を示すための一般論としての設問であり、「あの人は〇〇国人だからきっと△△だ」というような過度な「ステレオタイプ」に陥らないようにも注意しましょう）" }
        ]
      },
      en: {
        instructionTitle: "Rules of the Quest",
        instructions: ["- You will be asked 5 questions about sustainability.", "- Answer 4 or more correctly to defeat the boss!", "- Only your first attempt on each stage will be recorded.", "- Good luck!"],
        instructionOk: "Got it",
        title: "Stage 2: Diversity",
        employeeIdPlaceholder: "Enter 5-digit Employee ID",
        companySelectDefault: "Select your company",
        startButton: "Challenge",
        msgEnterId: "Please enter your Company and Employee ID",
        msgCheckingId: "Checking eligibility...",
        msgIdNotFound: "Stage 1 record not found. Please check your Company and Employee ID.",
        msgCheckError: "Verification error. Please try again later.",
        theme: "Theme: Diversity",
        progress: (q, t) => `Q ${q}/${t}`,
        bossHp: "Boss HP",
        resultWinTitle: "Victory!",
        resultWinMsg: "Stage Clear! Your understanding of diversity has deepened!",
        resultLoseTitle: "Game Over",
        resultLoseMsg: "The dragon's defense was solid...",
        submitting: "Submitting results...",
        submitSuccess: "Results submitted!",
        submitError: "Error: Could not submit results.",
        recordedFalse: "Thanks for playing! Only your first result is recorded.",
        restartButton: "Back to Title",
        correct: "Correct!",
        incorrect: "Incorrect...",
        nextButton: "Next",
        quiz: [
            { q: "The way we 'see' the world differs by culture. For example, the number of colors in a rainbow. What essential insight does this give us about diversity?", o: ["Our 'perception' creates diverse 'realities' through the filter of culture.", "The ultimate goal is to share a 'single correct perception' of the world.", "Modern cultures perceive the world more accurately than ancient ones.", "A 'common human truth' is hidden beneath diverse cultures."], a: "Our 'perception' creates diverse 'realities' through the filter of culture.", ex: "The perception of the number of colors in a rainbow differs by culture. It is important to be aware that what you take for granted may not be so for others. (Ref) 7 colors: Japan, Sweden, etc. Newton classified the spectrum into 7 colors in the 17th century. 6 colors: USA, UK, etc. 'Indigo' is often not distinguished from blue. 5 colors: Ancient China, etc. Linked to the Five Elements theory, the rainbow was a 'five-colored bridge.' 2 colors: Some tribes in Africa. They might group warm colors as 'red' and cool colors as 'black.'" },
            { q: "Regarding fermented foods from countries where the NKC Group has locations, which of the following is incorrect?", o: ["Chinese 'furu' (fermented tofu), also called 'oriental cheese,' is made by inoculating tofu with mold.", "Filipino 'nata de coco' is made by fermenting coconut milk.", "Swedish 'surströmming' is made by fermenting trout.", "In the US, a sour, slightly carbonated drink called 'Kombucha,' made from fermented tea, is popular."], a: "Swedish 'surströmming' is made by fermenting trout.", ex: "Swedish 'surströmming' is made by fermenting 'herring,' not 'trout.' Its smell is said to be about 18 times stronger than natto, earning it the reputation of being the 'world's smelliest food.' (Note: The 'Kombucha' is completely different from the Japanese 'Kombucha,' which is made from kelp seaweed.)" },
            { q: "Many studies show that diverse teams outperform homogeneous teams in complex problem-solving. What is the most important reason for this?", o: ["Minority individuals are inherently more creative.", "Various perspectives and knowledge compensate for individual 'blind spots.'", "They can reach conclusions amicably by avoiding conflict.", "Interpersonal relationships within the team become smoother, making cooperation easier."], a: "Various perspectives and knowledge compensate for individual 'blind spots.'", ex: "The true value of a diverse team lies in how different perspectives reduce 'blind spots' in the team's overall thought process, enabling them to address issues more comprehensively. It is also important to foster a culture that encourages free expression and listens to minority opinions." },
            { q: "What is the most important message of the English proverb, 'Variety is the spice of life'?", o: ["New experiences, changes, and differences make life more interesting and rich.", "Diverse knowledge provides shortcuts to overcome life's difficulties.", "Experiencing diverse values reveals the one true path in life.", "Too many options can make important life decisions more difficult."], a: "New experiences, changes, and differences make life more interesting and rich.", ex: "This proverb means that new experiences and changes make life more interesting. A spice might not be tasty on its own, but when mixed with various ingredients, it creates a complex flavor. This is similar to the richness of a life filled with diverse values and experiences." },
            { q: "The perception of time also varies by culture. Which of the following generalizations is incorrect?", o: ["In Sweden, people value work-life balance and have a coffee break called 'Fika.'", "In the US, efficiency is valued, as in 'Time is money.'", "In China, there is a strong 'long-term orientation' for future success.", "In the Philippines, people are strict about punctuality out of respect for relationships."], a: "In the Philippines, people are strict about punctuality out of respect for relationships.", ex: "There is a tendency to prioritize immediate personal relationships over schedules, so much so that the term 'Filipino Time' exists to describe this relaxed attitude toward time. Arriving on time can even be considered too early. (This is a generalization and one should be careful not to fall into excessive stereotyping.)" }
        ]
      },
      zh: {
        instructionTitle: "冒险须知",
        instructions: ["・将提出5个关于可持续性的问题。", "・正确回答4个以上问题即可击敗头目！", "・每个关卡只有第一次挑战的结果会被记录。", "・祝你好运！"],
        instructionOk: "知道了",
        title: "第二关：多样性",
        employeeIdPlaceholder: "输入员工编号(5位半角数字)",
        companySelectDefault: "请选择所属公司",
        startButton: "挑战",
        msgEnterId: "请输入所属公司和员工编号",
        msgCheckingId: "正在确认挑战资格...",
        msgIdNotFound: "未找到第一关的记录。请检查公司名称和员工编号。",
        msgCheckError: "确认出错。请稍后再试。",
        theme: "主题：多样性",
        progress: (q, t) => `第${q}/${t}题`,
        bossHp: "头目 HP",
        resultWinTitle: "胜利！",
        resultWinMsg: "关卡完成！加深了对多样性的理解！",
        resultLoseTitle: "游戏结束",
        resultLoseMsg: "龙的防御很坚固…",
        submitting: "正在发送结果...",
        submitSuccess: "结果已发送！",
        submitError: "错误：无法发送结果。",
        recordedFalse: "感谢您的参与！只有初次挑战结果会被记录。",
        restartButton: "返回标题",
        correct: "回答正确！",
        incorrect: "回答错误...",
        nextButton: "下一个",
        quiz: [
            { q: "我们“看待”世界的方式因文化而异，例如对彩虹颜色的认知。这一事实为我们提供了关于“多样性”的何种本质性启示？", o: ["我们的“认知”通过文化的滤镜创造出多样的“现实”。", "最终目标是共享一个“唯一正确的全球认知”。", "现代文化比古代文化更准确地把握世界。", "多样文化的根基下隐藏着“全人类共通的真理”。"], a: "我们的“认知”通过文化的滤镜创造出多样的“现实”。", ex: "如下所示，不同文化对彩虹颜色的数量认知也存在差异。重要的是要意识到，自己认为理所当然的事情，对他人来说可能并非如此。（参考）7色：日本、瑞典等。据说起源于17世纪牛顿将其分为七种颜色。6色：美国、英国等。通常不将“靛色”与蓝色区分。5色：（古代）中国等。与五行思想相结合，彩虹被认为是“五色彩桥”。2色：非洲和南亚的一些部落。例如，将暖色系统称为“红”，冷色系统称为“黑”。" },
            { q: "关于NKC集团设有据点的各国的发酵食品，以下哪项是错误的？", o: ["被称为“东方奶酪”的中国“腐乳”是通过在豆腐上接种霉菌制成的。", "源自菲律宾的“椰果”是通过发酵椰奶制成的。", "瑞典的“瑞典盐腌鲱鱼”是通过发酵鳟鱼制成的。", "在美国，一种名为“康普茶”的发酵红茶饮料很受欢迎。"], a: "瑞典的“瑞典盐腌鲱鱼”是通过发酵鳟鱼制成的。", ex: "瑞典的“瑞典盐腌鲱鱼”是使用“鲱鱼”而非“鳟鱼”发酵制成的。其臭味据说是纳豆的约18倍，被誉为“世界上最臭的食物”。（另外，“康普茶”与日本用海带制作的“昆布茶”完全是两回事。）" },
            { q: "许多研究表明，多元化团队在解决复杂问题时通常优于同质化团队。其最重要的原因是什么？", o: ["少数群体成员天生更具创造力。", "不同的视角和知识能弥补个人的“盲点”。", "通过避免冲突，能和平地得出结论。", "团队内部的人际关系更顺畅，更容易合作。"], a: "不同的视角和知识能弥补个人的“盲点”。", ex: "多元化团队的真正价值在于，不同视角的存在可以减少整个团队思维过程中的“盲点”，从而能够更全面地考虑和处理问题。营造一个能够引出自由意见、并倾听少数派意见的组织文化也至关重要。" },
            { q: "英语谚语“Variety is the spice of life.”（多样性是生活的调味品）传达的最重要的信息是什么？", o: ["新的经历、变化和差异使生活更有趣、更丰富。", "丰富的知识能为克服生活困难提供捷径。", "接触多样的价值观能揭示生活中唯一正确的道路。", "过多的选择会使人生的重要决策更加困难。"], a: "新的经历、变化和差异使生活更有趣、更丰富。", ex: "这句谚语的意思是，新的经历和变化会让生活变得更有趣。香料单独品尝可能并不美味，但当与各种食材混合时，就会增添层次丰富的味道。这与接触多元价值观和经历所带来的人生丰富性有相似之处。" },
            { q: "对时间的看法也因文化而异。以下关于不同国家普遍特征的说法中，哪项是错误的？", o: ["在瑞典，人们重视工作与生活的平衡，有称为“Fika”的咖啡休息时间。", "在美国，效率受到重视，如“时间就是金钱”。", "在中国，为未来成功有强烈的“长期导向”。", "在菲律-宾，出于对人际关系的尊重，人们对守时要求严格。"], a: "在菲律宾，出于对人际关系的尊重，人们对守时要求严格。", ex: "菲律宾人倾向于优先考虑当下的人际关系而非预定的时间表，甚至有“菲律宾时间”（Filipino Time）这个词来形容这种对时间宽容的态度。准时到达甚至可能被认为太早了。（这只是为了说明文化多样性的一般性问题，应注意避免陷入过度“刻板印象”。）" }
        ]
      }
    };
    const companyList = {
      ja: ["本社/天満地区", "治工具工場", "神戸工場", "大阪工場", "名張工場", "三重工場", "滋賀工場", "河内工場", "株式会社NKC NASSH", "株式会社須田商事", "富士ホーニング工業株式会社", "中西興産株式会社", "シー・ティ・マシン株式会社", "イーグローバレッジ株式会社", "NKCながいグリーンパワー株式会社", "NMC", "NSC", "NWC", "NPC", "NAI", "NCP", "NDC", "その他"],
      en: ["HQ/Tenma Area", "Jig & Tool Factory", "Kobe Plant", "Osaka Plant", "Nabari Plant", "Mie Plant", "Shiga Plant", "Kawachi Plant", "NKC NASSH Inc.", "Suda Corporation", "Fuji Honing Industrial Co., Ltd.", "Nakanishi Kosan Co., Ltd.", "C.T. Machine Co., Ltd.", "e-Globaledge Corporation", "NKC Nagai Green Power Co., Ltd.", "NMC", "NSC", "NWC", "NPC", "NAI", "NCP", "NDC", "Other"],
      zh: ["总公司/天满地区", "治工具工場", "神户工厂", "大阪工厂", "名张工厂", "三重工厂", "滋贺工厂", "河内工厂", "株式会社NKC NASSH", "株式会社须田商事", "富士珩磨工业株式会社", "中西兴产株式会社", "C.T. Machine株式会社", "e-Globaledge株式会社", "NKC长井绿色电力株式会社", "NMC", "NSC", "NWC", "NPC", "NAI", "NCP", "NDC", "其他"]
    };
    
    const titleScreen = document.getElementById('title-screen');
    const languageScreen = document.getElementById('language-screen');
    const instructionScreen = document.getElementById('instruction-screen');
    const startScreen = document.getElementById('start-screen');
    const quizScreen = document.getElementById('quiz-screen');
    const resultScreen = document.getElementById('result-screen');
    const bossContainer = document.getElementById('boss-container');
    const employeeIdInput = document.getElementById('employeeIdInput');
    const companySelect = document.getElementById('companySelect');
    const bgm = document.getElementById('bgm');
    const correctSound = document.getElementById('correct-sound');
    const startButton = document.getElementById('start-button');
    const explanationModal = document.getElementById('explanation-modal');
    const nextQuestionButton = document.getElementById('next-question-button');
    const openingVideoContainer = document.getElementById('opening-video-container');
    const gameVideoContainer = document.getElementById('game-video-container');

    let currentLang = 'ja';
    let timerInterval, startTime, correctCount, isGameInProgress = false, audioStarted = false;
    let clickSound, hitSound, damageSound, victorySound, defeatSound;

    function switchScreen(screenName) {
      [titleScreen, languageScreen, instructionScreen, startScreen, quizScreen, resultScreen].forEach(s => s.classList.add('hidden'));
      document.getElementById(`${screenName}-screen`).classList.remove('hidden');
    }
    
    function updateUIText() {
      const t = TEXTS[currentLang];
      document.body.lang = currentLang;
      document.getElementById('instruction-title').textContent = t.instructionTitle;
      document.getElementById('instruction-text').innerHTML = t.instructions.map(line => `<p>${line}</p>`).join('');
      document.getElementById('instruction-ok-button').textContent = t.instructionOk;
      document.getElementById('title-text').textContent = t.title;
      employeeIdInput.placeholder = t.employeeIdPlaceholder;
      document.getElementById('start-button-text').textContent = t.startButton;
      document.getElementById('boss-hp-label').textContent = t.bossHp;
      document.getElementById('restart-button').textContent = t.restartButton;
      document.getElementById('theme-display').textContent = t.theme;
      
      companySelect.innerHTML = `<option value="">${t.companySelectDefault}</option>`;
      companyList[currentLang].forEach(company => {
        companySelect.innerHTML += `<option value="${company}">${company}</option>`;
      });
    }

    function setupAudio() {
      if (audioStarted) return;
      clickSound = () => new Tone.MembraneSynth({ pitchDecay: 0.01, octaves: 3, envelope: { attack: 0.001, decay: 0.3, sustain: 0 } }).toDestination().triggerAttackRelease("C2", "8n");
      hitSound = () => {
        correctSound.currentTime = 0;
        correctSound.play().catch(e => console.error("Correct sound play failed:", e));
      };
      damageSound = () => new Tone.NoiseSynth({ noise: { type: "pink" }, envelope: { attack: 0.01, decay: 0.3, sustain: 0, release: 0.2 } }).toDestination().triggerAttackRelease("8n");
      victorySound = () => { const s = new Tone.Synth().toDestination(), n = Tone.now(); s.triggerAttackRelease("C5", "8n", n); s.triggerAttackRelease("E5", "8n", n + 0.2); s.triggerAttackRelease("G5", "8n", n + 0.4); s.triggerAttackRelease("C6", "4n", n + 0.6) };
      defeatSound = () => { const s = new Tone.Synth().toDestination(), n = Tone.now(); s.triggerAttackRelease("C4", "4n", n); s.triggerAttackRelease("B3", "4n", n + 0.3); s.triggerAttackRelease("A#3", "4n", n + 0.6); s.triggerAttackRelease("A3", "2n", n + 0.9) };
      audioStarted = true;
    }

    function normalizeEmployeeIdForHTML(v) {
      const digits = String(v == null ? "" : v).replace(/[^\d]/g, "");
      return digits.padStart(5, "0");
    }

    async function startGame() {
      if (!employeeIdInput.checkValidity()) {
        employeeIdInput.reportValidity();
        return;
      }
      const company = companySelect.value;
      const employeeId = employeeIdInput.value.trim();
      const msgEl = document.getElementById('msg');
      if (!company || !employeeId) {
        msgEl.textContent = TEXTS[currentLang].msgEnterId;
        return;
      }
      if (isGameInProgress) return;
      isGameInProgress = true;
      startButton.disabled = true;
      msgEl.textContent = TEXTS[currentLang].msgCheckingId;

      const normalizedEmployeeId = normalizeEmployeeIdForHTML(employeeId);

      try {
        const checkUrl = `${GAS_URL}?action=checkEmployeeId&employeeId=${encodeURIComponent(normalizedEmployeeId)}&company=${encodeURIComponent(company)}`;
        const response = await fetch(checkUrl);
        const result = await response.json();

        if (result.exists) {
          msgEl.textContent = "";
          bgm.play().catch(e => console.error("BGM play failed:", e));
          clickSound();
          correctCount = 0;
          document.getElementById('boss-area').classList.remove('hidden');
          bossContainer.className = 'boss-idle';
          updateHpBars(100);
          switchScreen('quiz');
          startTime = Date.now();
          timerInterval = setInterval(() => {
            const elapsedTime = ((Date.now() - startTime) / 1000).toFixed(1);
            document.getElementById('timer-display').textContent = `${elapsedTime}s`;
          }, 100);
          displayQuestion(0);
        } else {
          msgEl.textContent = TEXTS[currentLang].msgIdNotFound;
        }
      } catch (error) {
        console.error("Error checking employee ID:", error);
        msgEl.textContent = TEXTS[currentLang].msgCheckError;
      } finally {
        isGameInProgress = false;
        startButton.disabled = false;
      }
    }

    function displayQuestion(index) {
      const quizData = TEXTS[currentLang].quiz;
      document.getElementById('progress-display').textContent = TEXTS[currentLang].progress(index + 1, quizData.length);
      const current = quizData[index];
      document.getElementById('question-text').textContent = `Q${index + 1}: ${current.q}`;
      const optionsContainer = document.getElementById('options-container');
      optionsContainer.innerHTML = '';
      current.o.forEach(opt => {
        const div = document.createElement('div');
        div.textContent = `▶ ${opt}`;
        div.classList.add('dq-button');
        div.addEventListener('click', () => handleAnswer(opt, current, index));
        optionsContainer.appendChild(div);
      });
    }

    function handleAnswer(selectedAnswer, currentQuiz, index) {
      const isCorrect = selectedAnswer === currentQuiz.a;
      const optionsContainer = document.getElementById('options-container');
      optionsContainer.querySelectorAll('.dq-button').forEach(btn => {
        btn.style.pointerEvents = 'none';
        if (btn.textContent.includes(currentQuiz.a)) {
          btn.classList.add('correct-answer');
        } else {
          btn.classList.add('incorrect-answer');
        }
      });

      if (isCorrect) {
        correctCount++;
        hitSound();
        updateHpBars(100 - (correctCount * (100 / 4)));
        bossContainer.classList.add('shake');
        document.getElementById('explanation-title').textContent = TEXTS[currentLang].correct;
      } else {
        damageSound();
        document.querySelector('.dq-window').classList.add('shake');
        document.getElementById('explanation-title').textContent = TEXTS[currentLang].incorrect;
      }
      
      document.getElementById('explanation-text').textContent = currentQuiz.ex;
      nextQuestionButton.textContent = TEXTS[currentLang].nextButton;
      nextQuestionButton.dataset.nextIndex = index + 1;
      
      setTimeout(() => {
        explanationModal.style.display = 'flex';
      }, 800);
    }
    
    nextQuestionButton.addEventListener('click', () => {
      explanationModal.style.display = 'none';
      bossContainer.classList.remove('shake');
      document.querySelector('.dq-window').classList.remove('shake');
      
      const nextIndex = parseInt(nextQuestionButton.dataset.nextIndex);
      if (nextIndex >= TEXTS[currentLang].quiz.length) {
        showEndScreen();
      } else {
        displayQuestion(nextIndex);
      }
    });

    function showEndScreen() {
      clearInterval(timerInterval);
      bgm.pause();
      bgm.currentTime = 0;
      
      const isVictory = correctCount >= 4;
      if (isVictory) {
        victorySound();
        bossContainer.className = 'boss-defeat';
      } else {
        defeatSound();
      }
      
      setTimeout(() => {
        document.getElementById('boss-area').classList.add('hidden');
        switchScreen('result');
        const t = TEXTS[currentLang];
        document.getElementById('result-title').textContent = isVictory ? t.resultWinTitle : t.resultLoseTitle;
        document.getElementById('result-message').textContent = isVictory ? t.resultWinMsg : t.resultLoseMsg;
        submitResults();
      }, isVictory ? 1500 : 500);
    }

    async function submitResults() {
        const statusEl = document.getElementById('submission-status');
        let ipAddress = 'N/A';
        try {
            const response = await fetch('https://api.ipify.org?format=json');
            ipAddress = (await response.json()).ip;
        } catch (error) {
            console.error('IPアドレスの取得に失敗しました:', error);
        }

        const normalizedEmployeeId = normalizeEmployeeIdForHTML(employeeIdInput.value.trim());
        const payload = {
            company: companySelect.value,
            employeeId: normalizedEmployeeId,
            stage: STAGE_NUMBER,
            score: correctCount,
            time: ((Date.now() - startTime) / 1000).toFixed(2),
            ipAddress: ipAddress
        };
        statusEl.textContent = TEXTS[currentLang].submitting;
        
        try {
            const response = await fetch(GAS_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/plain;charset=utf-8',
                },
                body: JSON.stringify(payload)
            });

            const result = await response.json();

            if (result.status === 'success') {
                if (result.recorded === false) {
                    statusEl.textContent = TEXTS[currentLang].recordedFalse;
                } else {
                    statusEl.textContent = TEXTS[currentLang].submitSuccess;
                }
            } else {
                statusEl.textContent = result.message || TEXTS[currentLang].submitError;
            }
        } catch (err) {
            statusEl.textContent = TEXTS[currentLang].submitError;
            console.error('Error:', err);
        }
    }

    function updateHpBars(percentage) {
      const hpBar = document.getElementById('boss-hp-bar');
      hpBar.style.width = `${Math.max(0, percentage)}%`;
      if (percentage <= 25) hpBar.className = 'boss-hp-bar low';
      else if (percentage <= 50) hpBar.className = 'boss-hp-bar mid';
      else hpBar.className = 'boss-hp-bar full';
    }
    
    function handleMediaError(element) {
        console.error(`Error loading media: ${element.src}`);
        element.style.display = 'none'; 
    }

    document.getElementById('title-start-button').addEventListener('click', async () => {
      if (!audioStarted) { 
        await Tone.start();
        setupAudio();
      }
      clickSound();
      const openingVideo = document.getElementById('opening-video');
      openingVideo.muted = false;
      openingVideo.play().catch(e => console.log("User interaction might be needed for audio"));
      switchScreen('language');
    });

    document.getElementById('lang-ja').addEventListener('click', () => { clickSound(); currentLang = 'ja'; updateUIText(); switchScreen('instruction'); });
    document.getElementById('lang-en').addEventListener('click', () => { clickSound(); currentLang = 'en'; updateUIText(); switchScreen('instruction'); });
    document.getElementById('lang-zh').addEventListener('click', () => { clickSound(); currentLang = 'zh'; updateUIText(); switchScreen('instruction'); });
    
    document.getElementById('instruction-ok-button').addEventListener('click', () => {
      clickSound();
      openingVideoContainer.classList.add('hidden');
      document.getElementById('opening-video').pause();
      gameVideoContainer.classList.remove('hidden');
      document.getElementById('game-bg-video').play().catch(e => console.log("Game video play failed"));
      switchScreen('start');
    });
    
    startButton.addEventListener('click', startGame);
    document.getElementById('restart-button').addEventListener('click', () => location.reload());

    updateUIText();
    switchScreen('title');
    const openingVideo = document.getElementById('opening-video');
    openingVideo.muted = false;
    openingVideo.play().catch(e => {
        console.log("Autoplay with sound was prevented. Muting and retrying.");
        openingVideo.muted = true;
        openingVideo.play();
    });
  </script>
</body>
</html>
