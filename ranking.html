<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ† Sustainable Quest - Ranking ğŸ†</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'DotGothic16', sans-serif;
      background-color: #000;
      color: #fff;
      background-image: url('https://images.unsplash.com/photo-1531366936337-7c912a4589a7?q=80&w=2070&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }
    .dq-window { border: 4px solid #fff; background: rgba(0,0,80,0.85); padding: 1.5rem; box-shadow: 0 0 0 4px #000, 0 0 20px rgba(0,128,255,0.6); backdrop-filter: blur(3px); }
    th { border-bottom: 2px solid #fff; line-height: 1.4; }
    td { border-bottom: 1px solid #555; }
    .rank-1 { color: #ffd700; font-weight: bold; text-shadow: 0 0 5px #ffd700; }
    .rank-2 { color: #c0c0c0; font-weight: bold; }
    .rank-3 { color: #cd7f32; font-weight: bold; }
  </style>
</head>
<body class="p-4 md:p-8">
  <div class="dq-window max-w-4xl mx-auto">
    <h1 class="text-3xl md:text-4xl text-center font-bold mb-6 text-yellow-300" style="font-family: 'Press+Start+2P', cursive;">ğŸ† RANKING ğŸ†</h1>
    <div class="overflow-x-auto">
      <table class="w-full text-left text-lg">
        <thead>
          <tr>
            <th class="p-2 text-center">Rank<br>(é †ä½)</th>
            <th class="p-2">Nickname<br>(ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ )</th>
            <th class="p-2">Company<br>(æ‰€å±ä¼šç¤¾)</th>
            <th class="p-2 text-center">Score<br>(åˆè¨ˆã‚¹ã‚³ã‚¢)</th>
          </tr>
        </thead>
        <tbody id="ranking-body">
          <!-- ãƒ‡ãƒ¼ã‚¿ã¯JavaScriptã§ã“ã“ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
        </tbody>
      </table>
    </div>
    <p id="loading-message" class="text-center text-xl mt-4">ãƒ©ãƒ³ã‚­ãƒ³ã‚°é›†è¨ˆä¸­...</p>
    <p id="updated-time" class="text-center text-sm mt-4 text-gray-400"></p>
  </div>

  <script>
    // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
    // â˜… GASã‚’å†ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸå¾Œã®ã€Œæ–°ã—ã„ã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã®URLã€ã‚’ã“ã“ã«è¨­å®šã—ã¦ãã ã•ã„ â˜…
    // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbzKjQfG-cW1tacggfb1JrGa8oT2iAqtgmdmeUb_wCdmMb3h78CXLgIiPVXsLXoMFdpHtQ/exec';

    async function fetchRanking() {
      const rankingBody = document.getElementById('ranking-body');
      const loadingMessage = document.getElementById('loading-message');
      const updatedTimeEl = document.getElementById('updated-time');
      
      try {
        const response = await fetch(GAS_URL);
        if (!response.ok) {
          throw new Error(`Network response was not ok: ${response.statusText}`);
        }
        const data = await response.json();

        if (data.error) {
          throw new Error(data.error);
        }

        if (data.length === 0) {
          loadingMessage.textContent = 'ã¾ã æŒ‘æˆ¦è€…ãŒã„ã¾ã›ã‚“ã€‚';
          return;
        }

        let tableHtml = '';
        data.forEach((player, index) => {
          const rank = index + 1;
          let rankClass = '';
          if (rank === 1) rankClass = 'rank-1';
          if (rank === 2) rankClass = 'rank-2';
          if (rank === 3) rankClass = 'rank-3';

          tableHtml += `
            <tr class="${rankClass}">
              <td class="p-2 text-center">${rank}</td>
              <td class="p-2">${escapeHtml(player.nickname)}</td>
              <td class="p-2">${escapeHtml(player.company)}</td>
              <td class="p-2 text-center">${player.totalScore}</td>
            </tr>
          `;
        });

        rankingBody.innerHTML = tableHtml;
        loadingMessage.style.display = 'none';
        
        const now = new Date();
        updatedTimeEl.textContent = `æœ€çµ‚æ›´æ–°: ${now.toLocaleString('ja-JP')}`;

      } catch (error) {
        console.error('ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
        loadingMessage.textContent = 'ã‚¨ãƒ©ãƒ¼ï¼šãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚';
      }
    }

    function escapeHtml(unsafe) {
        // ã‚‚ã—ãƒ‡ãƒ¼ã‚¿ãŒnullã‚„undefinedã ã£ãŸå ´åˆã€ç©ºã®æ–‡å­—åˆ—ã«å¤‰æ›ã—ã¦ã‹ã‚‰å‡¦ç†ã™ã‚‹
        const safeString = String(unsafe || '');
        return safeString
             .replace(/&/g, "&amp;")
             .replace(/</g, "&lt;")
             .replace(/>/g, "&gt;")
             .replace(/"/g, "&quot;")
             .replace(/'/g, "&#039;");
     }

    // ãƒšãƒ¼ã‚¸ãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã‚‰ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’å–å¾—
    window.onload = fetchRanking;
  </script>
</body>
</html>
