<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sustainable Quest 🗡️ - Stage 4</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=Press+Start+2P&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
  <style>
    body[lang="ja"], body[lang="zh"] { font-family: 'DotGothic16', sans-serif; }
    body[lang="en"] { font-family: 'Press Start 2P', cursive; }
    body { background-color: #000; color: #fff; image-rendering: pixelated; overflow-x: hidden; overflow-y: auto; }
    .dq-window { border: 4px solid #fff; background: rgba(80, 0, 80, 0.85); padding: 1.5rem; box-shadow: 0 0 0 4px #000, 0 0 20px rgba(255, 0, 255, 0.5); backdrop-filter: blur(3px); }
    .dq-button { cursor: pointer; padding: .75rem 1.5rem; border: 2px solid #fff; background-image: linear-gradient(to bottom, #aa00aa, #880088); text-shadow: 1px 1px 2px #000; transition: all 0.2s; }
    .dq-button:hover { background-image: linear-gradient(to bottom, #dd33dd, #aa00aa); box-shadow: 0 0 10px #fff; }
    .video-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
    .bg-video { width: 100%; height: 100%; object-fit: cover; }
    #title-screen h1 { font-size: 2.5rem; font-weight: bold; text-shadow: 0 0 5px #fff, 0 0 15px #fff, 0 0 25px #ff00ff; animation: fadeInTitle 2s ease-out forwards; }
    #title-start-button { animation: pulseButton 2.5s infinite ease-in-out; }
    @keyframes fadeInTitle { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
    @keyframes pulseButton { 0%, 100% { transform: scale(1); box-shadow: 0 0 10px rgba(255,255,255,0.7); } 50% { transform: scale(1.05); box-shadow: 0 0 20px rgba(255,255,255,1); } }
    .boss-hp-container { border: 2px solid #fff; height: 30px; padding: 3px; background: #333; border-radius: 5px; box-shadow: inset 0 0 5px #000; }
    .boss-hp-bar { height: 100%; transition: width .5s ease-out, background-image .5s ease-out; border-radius: 2px; }
    .boss-hp-bar.full { background-image: linear-gradient(to right, #33ff33, #88ff88); }
    .boss-hp-bar.mid { background-image: linear-gradient(to right, #ffff33, #ffff88); }
    .boss-hp-bar.low { background-image: linear-gradient(to right, #ff3333, #ff8833); }
    .boss-idle { animation: boss-float 2.5s infinite ease-in-out; }
    @keyframes boss-float{ 0%,100% { transform: translateY(0); } 50% { transform: translateY(-12px); } }
    .boss-defeat { animation: boss-defeat-anim 1.5s forwards; }
    @keyframes boss-defeat-anim { 0% { opacity: 1; transform: rotate(0deg); } 50% { opacity: 1; transform: rotate(10deg); } 100% { opacity: 0; transform: translateY(100px) rotate(-20deg) scale(0.5); } }
    .shake { animation: shake .35s; }
    @keyframes shake { 10%,90% { transform: translate(-2px, -2px); } 20%,80% { transform: translate(3px, 2px); } 30%,50%,70% { transform: translate(-3px, 3px); } 40%,60% { transform: translate(3px, -2px); } }
    .magic-glow { filter: drop-shadow(0 0 8px #ff00ff) drop-shadow(0 0 16px #aa00ff) contrast(1.2); }
    #boss-img { width: 100%; max-width: 320px; height: auto; }
    .correct-answer { background-image: linear-gradient(to bottom, #ffdd00, #ffaa00) !important; color: #000; }
    .incorrect-answer { background-image: linear-gradient(to bottom, #888888, #555555) !important; opacity: 0.7; }
  </style>
</head>
<body class="flex items-start sm:items-center justify-center min-h-screen p-4">

  <div id="opening-video-container" class="video-container">
    <video id="opening-video" class="bg-video" src="./opening_movie.mp4" autoplay loop playsinline onerror="handleMediaError(this)"></video>
  </div>
  <div id="game-video-container" class="video-container hidden">
    <video id="game-bg-video" class="bg-video" src="./GameBackground4.mp4" autoplay muted loop playsinline onerror="handleMediaError(this)"></video>
  </div>

  <div class="w-full max-w-3xl mx-auto">
    <div id="boss-area" class="mb-4 h-64 flex justify-center items-end relative hidden">
      <div id="boss-container"><img id="boss-img" src="./Stage4_dragon.png" alt="ボスの画像" class="magic-glow" onerror="handleMediaError(this)"/></div>
    </div>
    <div id="game-container" class="w-full dq-window relative">
      <div id="title-screen" class="text-center py-8">
        <h1 class="mb-10">Sustainable Quest</h1>
        <button id="title-start-button" class="dq-button">START</button>
      </div>

      <div id="language-screen" class="text-center hidden">
        <h1 class="text-3xl font-bold mb-6">Select Language</h1>
        <div class="flex justify-center gap-2 flex-wrap">
          <button id="lang-ja" class="dq-button">日本語</button>
          <button id="lang-en" class="dq-button">English</button>
          <button id="lang-zh" class="dq-button">中文</button>
        </div>
      </div>

      <div id="instruction-screen" class="text-center hidden">
        <h1 id="instruction-title" class="text-3xl font-bold mb-4"></h1>
        <div id="instruction-text" class="text-left mb-6 space-y-2"></div>
        <button id="instruction-ok-button" class="dq-button"></button>
      </div>
      
      <div id="start-screen" class="text-center hidden">
        <h1 id="title-text" class="text-2xl font-bold mb-4"></h1>
        <div class="flex flex-col items-center gap-4 mb-4">
          <input id="employeeIdInput" type="text" pattern="\d{5}" title="社員番号は半角数字5桁で入力してください" class="text-black px-3 py-2 w-full md:w-80 text-center rounded" />
        </div>
        <button id="start-button" class="dq-button inline-flex items-center gap-2"><span id="start-button-text"></span></button>
        <div id="msg" class="text-yellow-300 text-sm h-5 mt-2"></div>
      </div>

      <div id="quiz-screen" class="hidden">
        <div class="flex justify-between items-center mb-2 text-lg">
          <span id="theme-display"></span>
          <span id="progress-display"></span>
          <span id="timer-display">0.0s</span>
        </div>
        <div class="mb-4"><p id="boss-hp-label"></p><div class="boss-hp-container"><div id="boss-hp-bar"></div></div></div>
        <div class="mb-4 min-h-[80px] p-4 border-2 border-white"><p id="question-text" class="text-xl"></p></div>
        <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      </div>
      <div id="result-screen" class="hidden text-center">
        <h2 id="result-title" class="text-3xl font-bold mb-4"></h2>
        <p id="result-message" class="text-xl mb-6"></p>
        <p id="submission-status" class="text-yellow-300 mb-8"></p>
        <div id="restart-button" class="dq-button inline-block"></div>
      </div>
      <div id="explanation-modal" class="absolute inset-0 bg-black bg-opacity-80 flex-col items-center justify-center p-4 hidden">
        <div class="dq-window w-full max-w-2xl text-center">
          <h2 id="explanation-title" class="text-4xl font-bold mb-4"></h2>
          <p id="explanation-text" class="text-lg mb-6 text-left h-48 overflow-y-auto p-2 border"></p>
          <button id="next-question-button" class="dq-button"></button>
        </div>
      </div>
    </div>
  </div>
  <audio id="bgm" src="./BS4_BGM.wav" loop onerror="handleMediaError(this)"></audio>
  <audio id="correct-sound" src="./correct_answer.mp3" onerror="handleMediaError(this)"></audio>
  <script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbzKjQfG-cW1tacggfb1JrGa8oT2iAqtgmdmeUb_wCdmMb3h78CXLgIiPVXsLXoMFdpHtQ/exec';
    const STAGE_NUMBER = '4';
    const TEXTS = {
      ja: {
        instructionTitle: "冒険の心得",
        instructions: ["・サステナビリティに関する5つの問題が出題されるぞ。", "・4問以上正解でボスを討伐できる！", "・最初の挑戦結果のみがランキングに記録されるぞ。", "・健闘を祈る！"],
        instructionOk: "わかった",
        title: "ステージ4：多様性の視点",
        employeeIdPlaceholder: "社員番号(半角5桁)を入力",
        startButton: "挑戦する",
        msgEnterId: "社員番号を入力してください",
        msgCheckingId: "挑戦資格を確認中...",
        msgIdNotFound: "ステージ3から挑戦してください！",
        msgCheckError: "確認エラー。時間をおいて再試行してください。",
        theme: "テーマ：多様性の視点",
        progress: (q, t) => `${q}/${t}問目`,
        bossHp: "ボス HP",
        resultWinTitle: "勝利！",
        resultWinMsg: "ステージクリア！多様な視点が世界を広げた！",
        resultLoseTitle: "ゲームオーバー",
        resultLoseMsg: "魔竜王の魔力は計り知れない…",
        submitting: "結果を送信中...",
        submitSuccess: "結果を送信しました！",
        submitError: "エラー：結果を送信できませんでした。",
        restartButton: "タイトルへ戻る",
        correct: "正解！",
        incorrect: "不正解...",
        nextButton: "次へ",
        quiz: [
          { q: "「青」と「緑」を区別しない言語の存在が示す、多様性に関する重要な気づきとは？", o: ["現実の認識は言語や文化により形作られる", "全ての言語は同じ構造を持つ", "色の認識は世界共通である", "古代言語は不完全だった"], a: "現実の認識は言語や文化により形作られる", ex: "私たちは「言語」や「文化」というフィルターを通して世界を認識しています。日本の「青信号」も古い日本語の名残です。" },
          { q: "多様な人材で構成されたチームが高い成果を出す、最も重要な理由とは？", o: ["意見がすぐにまとまるから", "より深く思考し周到な準備を促すから", "競争が激しくなるから", "専門家だけが集まるから"], a: "より深く思考し周到な準備を促すから", ex: "異なる視点の存在が、メンバー各自により深く情報を処理し、周到な準備と思考を促すためです。均質なチームでは思考のショートカットが生まれがちです。" },
          { q: "英語のことわざ「Variety is the spice of life.」の日本語訳として最も適切なものは？", o: ["多様性は人生の薬味である", "人生はスパイスのように辛い", "変化のない人生が一番だ", "人生はバラエティ番組だ"], a: "多様性は人生の薬味である", ex: "変化に富んだ様々な経験が人生を豊かにするという意味です。薬味が料理の味を引き立てるように、多様な経験が人生をより面白く、味わい深いものにしてくれます。" },
          { q: "日本では緑色の信号を「青信号」と呼ぶことがある。これはなぜ？", o: ["信号機が青色に見えるから", "法律で「青」と定められているから", "古い日本語では緑も「あお」と呼んだ名残", "国際的なルールだから"], a: "古い日本語では緑も「あお」と呼んだ名残", ex: "古い日本語の「あお」が緑色も含む言葉だった名残です。" },
          { q: "自分と似たメンバーだけのチームが陥りがちな、思考の罠とは？", o: ["革新的なアイデアが生まれやすい", "意思決定が遅くなる", "固定観念に縛られる", "議論が活発になりすぎる"], a: "固定観念に縛られる", ex: "「きっと皆も同じように考えているだろう」という暗黙の前提から思考のショートカットが生まれ、チーム全体が固定観念に縛られがちになります。" }
        ]
      },
      en: {
        instructionTitle: "Rules of the Quest",
        instructions: ["- You will be asked 5 questions about sustainability.", "- Answer 4 or more correctly to defeat the boss!", "- Only your first attempt will be recorded for the ranking.", "- Good luck!"],
        instructionOk: "Got it",
        title: "Stage 4: Perspectives on Diversity",
        employeeIdPlaceholder: "Enter 5-digit Employee ID",
        startButton: "Challenge",
        msgEnterId: "Please enter your Employee ID",
        msgCheckingId: "Checking eligibility...",
        msgIdNotFound: "Please complete Stage 3 first!",
        msgCheckError: "Verification error. Please try again later.",
        theme: "Theme: Perspectives on Diversity",
        progress: (q, t) => `Q ${q}/${t}`,
        bossHp: "Boss HP",
        resultWinTitle: "Victory!",
        resultWinMsg: "Stage Clear! Diverse perspectives have broadened your world!",
        resultLoseTitle: "Game Over",
        resultLoseMsg: "The Magic Dragon King's power is immeasurable...",
        submitting: "Submitting results...",
        submitSuccess: "Results submitted!",
        submitError: "Error: Could not submit results.",
        restartButton: "Back to Title",
        correct: "Correct!",
        incorrect: "Incorrect...",
        nextButton: "Next",
        quiz: [
          { q: "What important insight about diversity is revealed by languages that don't distinguish between 'blue' and 'green'?", o: ["Perception of reality is shaped by language and culture", "All languages share the same structure", "Color perception is universal", "Ancient languages were incomplete"], a: "Perception of reality is shaped by language and culture", ex: "We perceive the world through the filters of 'language' and 'culture.' The Japanese 'blue signal' (aoshingo) for a green traffic light is a remnant of old Japanese." },
          { q: "What is the most important reason a diverse team achieves high performance?", o: ["Decisions are made quickly", "It encourages deeper thinking and thorough preparation", "Competition becomes more intense", "It consists only of experts"], a: "It encourages deeper thinking and thorough preparation", ex: "The presence of different viewpoints prompts each member to process information more deeply, encouraging thorough preparation and thought. Homogeneous teams tend to take mental shortcuts." },
          { q: "What is the most appropriate translation for the English proverb 'Variety is the spice of life.'?", o: ["Variety is the spice of life", "Life is spicy", "A life without change is best", "Life is a variety show"], a: "Variety is the spice of life", ex: "It means that a variety of rich experiences enriches life. Just as spices enhance a dish's flavor, diverse experiences make life more interesting and flavorful." },
          { q: "In Japan, green traffic lights are sometimes called 'blue signals' (aoshingo). Why?", o: ["The light looks blue", "It's legally defined as 'blue'", "It's a remnant of old Japanese where green was also 'ao'", "It's an international rule"], a: "It's a remnant of old Japanese where green was also 'ao'", ex: "It's a remnant from when the old Japanese word 'ao' also included the color green." },
          { q: "What is a common mental trap for a team composed only of like-minded members?", o: ["Innovative ideas emerge easily", "Decision-making becomes slower", "Being bound by stereotypes", "Discussions become too heated"], a: "Being bound by stereotypes", ex: "The implicit assumption that 'everyone probably thinks the same way' leads to mental shortcuts, and the entire team tends to be bound by stereotypes." }
        ]
      },
      zh: {
        instructionTitle: "冒险须知",
        instructions: ["・将提出5个关于可持续性的问题。", "・正确回答4个以上问题即可击败头目！", "・只有第一次挑战的结果会被记录在排名中。", "・祝你好运！"],
        instructionOk: "知道了",
        title: "第四关：多样性视角",
        employeeIdPlaceholder: "输入员工编号(5位半角数字)",
        startButton: "挑战",
        msgEnterId: "请输入员工编号",
        msgCheckingId: "正在确认挑战资格...",
        msgIdNotFound: "请先挑战第三关！",
        msgCheckError: "确认出错。请稍后再试。",
        theme: "主题：多样性视角",
        progress: (q, t) => `第${q}/${t}题`,
        bossHp: "头目 HP",
        resultWinTitle: "胜利！",
        resultWinMsg: "关卡完成！多样的视角拓宽了世界！",
        resultLoseTitle: "游戏结束",
        resultLoseMsg: "魔龙王的力量深不可测…",
        submitting: "正在发送结果...",
        submitSuccess: "结果已发送！",
        submitError: "错误：无法发送结果。",
        restartButton: "返回标题",
        correct: "回答正确！",
        incorrect: "回答错误...",
        nextButton: "下一个",
        quiz: [
            { q: "存在不区分“蓝色”和“绿色”的语言，这一事实揭示了关于多样性的何种重要启示？", o: ["对现实的认知是由语言和文化塑造的", "所有语言都具有相同的结构", "颜色识别是世界共通的", "古代语言不完整"], a: "对现实的认知是由语言和文化塑造的", ex: "我们通过“语言”和“文化”的滤镜来认识世界。日本的“青信号”（绿灯）也是古代日语的遗留。" },
            { q: "由多元化人才组成的团队能取得更高成就的最重要原因是什么？", o: ["能迅速统一意见", "因为它能促进更深入的思考和周密的准备", "竞争变得更加激烈", "因为只有专家聚集在一起"], a: "因为它能促进更深入的思考和周密的准备", ex: "不同视点的存在，促使每个成员更深入地处理信息，并鼓励周密的准备和思考。同质化的团队容易产生思维捷径。" },
            { q: "英语谚语“Variety is the spice of life.”最贴切的中文翻译是什么？", o: ["多样性是生活的调味品", "人生像香料一样辛辣", "没有变化的人生是最好的", "人生是一场综艺秀"], a: "多样性是生活的调味品", ex: "意思是丰富多彩的经历能使人生更加充实。就像调味品能提升菜肴的味道一样，多样的经历能让人生更有趣、更有味道。" },
            { q: "在日本，绿色的交通信号灯有时被称为“青信号”。这是为什么？", o: ["因为信号灯看起来是蓝色的", "因为法律规定为“青色”", "古代日语中绿色也称为“ao”的遗留", "因为这是国际规则"], a: "古代日语中绿色也称为“ao”的遗留", ex: "这是古代日语中“ao”一词也包含绿色的遗留。" },
            { q: "只由想法相似的成员组成的团队容易陷入什么样的思维陷阱？", o: ["容易产生创新想法", "决策变慢", "被刻板印象所束缚", "讨论变得过于激烈"], a: "被刻板印象所束缚", ex: "“大家肯定都这么想”的默契前提会导致思维捷径，使整个团队容易被刻板印象所束缚。" }
        ]
      }
    };
    
    const titleScreen = document.getElementById('title-screen');
    const languageScreen = document.getElementById('language-screen');
    const instructionScreen = document.getElementById('instruction-screen');
    const startScreen = document.getElementById('start-screen');
    const quizScreen = document.getElementById('quiz-screen');
    const resultScreen = document.getElementById('result-screen');
    const bossContainer = document.getElementById('boss-container');
    const employeeIdInput = document.getElementById('employeeIdInput');
    const bgm = document.getElementById('bgm');
    const correctSound = document.getElementById('correct-sound');
    const startButton = document.getElementById('start-button');
    const explanationModal = document.getElementById('explanation-modal');
    const nextQuestionButton = document.getElementById('next-question-button');
    const openingVideoContainer = document.getElementById('opening-video-container');
    const gameVideoContainer = document.getElementById('game-video-container');

    let currentLang = 'ja';
    let timerInterval, startTime, correctCount, isGameInProgress = false, audioStarted = false;
    let clickSound, hitSound, damageSound, victorySound, defeatSound;

    function switchScreen(screenName) {
      [titleScreen, languageScreen, instructionScreen, startScreen, quizScreen, resultScreen].forEach(s => s.classList.add('hidden'));
      document.getElementById(`${screenName}-screen`).classList.remove('hidden');
    }
    
    function updateUIText() {
      const t = TEXTS[currentLang];
      document.body.lang = currentLang;
      document.getElementById('instruction-title').textContent = t.instructionTitle;
      document.getElementById('instruction-text').innerHTML = t.instructions.map(line => `<p>${line}</p>`).join('');
      document.getElementById('instruction-ok-button').textContent = t.instructionOk;
      document.getElementById('title-text').textContent = t.title;
      employeeIdInput.placeholder = t.employeeIdPlaceholder;
      document.getElementById('start-button-text').textContent = t.startButton;
      document.getElementById('boss-hp-label').textContent = t.bossHp;
      document.getElementById('restart-button').textContent = t.restartButton;
      document.getElementById('theme-display').textContent = t.theme;
    }

    function setupAudio() {
      if (audioStarted) return;
      clickSound = () => new Tone.MembraneSynth({ pitchDecay: 0.01, octaves: 3, envelope: { attack: 0.001, decay: 0.3, sustain: 0 } }).toDestination().triggerAttackRelease("C2", "8n");
      hitSound = () => {
        correctSound.currentTime = 0;
        correctSound.play().catch(e => console.error("Correct sound play failed:", e));
      };
      damageSound = () => new Tone.NoiseSynth({ noise: { type: "pink" }, envelope: { attack: 0.01, decay: 0.3, sustain: 0, release: 0.2 } }).toDestination().triggerAttackRelease("8n");
      victorySound = () => { const s = new Tone.Synth().toDestination(), n = Tone.now(); s.triggerAttackRelease("C5", "8n", n); s.triggerAttackRelease("E5", "8n", n + 0.2); s.triggerAttackRelease("G5", "8n", n + 0.4); s.triggerAttackRelease("C6", "4n", n + 0.6) };
      defeatSound = () => { const s = new Tone.Synth().toDestination(), n = Tone.now(); s.triggerAttackRelease("C4", "4n", n); s.triggerAttackRelease("B3", "4n", n + 0.3); s.triggerAttackRelease("A#3", "4n", n + 0.6); s.triggerAttackRelease("A3", "2n", n + 0.9) };
      audioStarted = true;
    }

    async function startGame() {
      if (!employeeIdInput.checkValidity()) {
        employeeIdInput.reportValidity();
        return;
      }
      const employeeId = employeeIdInput.value.trim();
      const msgEl = document.getElementById('msg');
      if (!employeeId) {
        msgEl.textContent = TEXTS[currentLang].msgEnterId;
        return;
      }
      if (isGameInProgress) return;
      isGameInProgress = true;
      startButton.disabled = true;
      msgEl.textContent = TEXTS[currentLang].msgCheckingId;

      try {
        const checkUrl = `${GAS_URL}?action=checkEmployeeId&employeeId=${encodeURIComponent(employeeId)}&stage=3`;
        const response = await fetch(checkUrl);
        const result = await response.json();

        if (result.exists) {
          msgEl.textContent = "";
          bgm.play().catch(e => console.error("BGM play failed:", e));
          clickSound();
          correctCount = 0;
          document.getElementById('boss-area').classList.remove('hidden');
          bossContainer.className = 'boss-idle';
          updateHpBars(100);
          switchScreen('quiz');
          startTime = Date.now();
          timerInterval = setInterval(() => {
            const elapsedTime = ((Date.now() - startTime) / 1000).toFixed(1);
            document.getElementById('timer-display').textContent = `${elapsedTime}s`;
          }, 100);
          displayQuestion(0);
        } else {
          msgEl.textContent = TEXTS[currentLang].msgIdNotFound;
        }
      } catch (error) {
        console.error("Error checking employee ID:", error);
        msgEl.textContent = TEXTS[currentLang].msgCheckError;
      } finally {
        isGameInProgress = false;
        startButton.disabled = false;
      }
    }

    function displayQuestion(index) {
      const quizData = TEXTS[currentLang].quiz;
      document.getElementById('progress-display').textContent = TEXTS[currentLang].progress(index + 1, quizData.length);
      const current = quizData[index];
      document.getElementById('question-text').textContent = `Q${index + 1}: ${current.q}`;
      const optionsContainer = document.getElementById('options-container');
      optionsContainer.innerHTML = '';
      current.o.forEach(opt => {
        const div = document.createElement('div');
        div.textContent = `▶ ${opt}`;
        div.classList.add('dq-button');
        div.addEventListener('click', () => handleAnswer(opt, current, index));
        optionsContainer.appendChild(div);
      });
    }

    function handleAnswer(selectedAnswer, currentQuiz, index) {
      const isCorrect = selectedAnswer === currentQuiz.a;
      const optionsContainer = document.getElementById('options-container');
      optionsContainer.querySelectorAll('.dq-button').forEach(btn => {
        btn.style.pointerEvents = 'none';
        if (btn.textContent.includes(currentQuiz.a)) {
          btn.classList.add('correct-answer');
        } else {
          btn.classList.add('incorrect-answer');
        }
      });

      if (isCorrect) {
        correctCount++;
        hitSound();
        updateHpBars(100 - (correctCount * (100 / 4)));
        bossContainer.classList.add('shake');
        document.getElementById('explanation-title').textContent = TEXTS[currentLang].correct;
      } else {
        damageSound();
        document.querySelector('.dq-window').classList.add('shake');
        document.getElementById('explanation-title').textContent = TEXTS[currentLang].incorrect;
      }
      
      document.getElementById('explanation-text').textContent = currentQuiz.ex;
      nextQuestionButton.textContent = TEXTS[currentLang].nextButton;
      nextQuestionButton.dataset.nextIndex = index + 1;
      
      setTimeout(() => {
        explanationModal.style.display = 'flex';
      }, 800);
    }
    
    nextQuestionButton.addEventListener('click', () => {
      explanationModal.style.display = 'none';
      bossContainer.classList.remove('shake');
      document.querySelector('.dq-window').classList.remove('shake');
      
      const nextIndex = parseInt(nextQuestionButton.dataset.nextIndex);
      if (nextIndex >= TEXTS[currentLang].quiz.length) {
        showEndScreen();
      } else {
        displayQuestion(nextIndex);
      }
    });

    function showEndScreen() {
      clearInterval(timerInterval);
      bgm.pause();
      bgm.currentTime = 0;
      
      const isVictory = correctCount >= 4;
      if (isVictory) {
        victorySound();
        bossContainer.className = 'boss-defeat';
      } else {
        defeatSound();
      }
      
      setTimeout(() => {
        document.getElementById('boss-area').classList.add('hidden');
        switchScreen('result');
        const t = TEXTS[currentLang];
        document.getElementById('result-title').textContent = isVictory ? t.resultWinTitle : t.resultLoseTitle;
        document.getElementById('result-message').textContent = isVictory ? t.resultWinMsg : t.resultLoseMsg;
        submitResults();
      }, isVictory ? 1500 : 500);
    }

    async function submitResults() {
        const statusEl = document.getElementById('submission-status');
        let ipAddress = 'N/A';
        try {
            const response = await fetch('https://api.ipify.org?format=json');
            ipAddress = (await response.json()).ip;
        } catch (error) {
            console.error('IPアドレスの取得に失敗しました:', error);
        }

        const payload = {
            employeeId: employeeIdInput.value.trim(),
            stage: STAGE_NUMBER,
            score: correctCount,
            time: ((Date.now() - startTime) / 1000).toFixed(2),
            ipAddress: ipAddress
        };
        statusEl.textContent = TEXTS[currentLang].submitting;
        fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload), mode: 'no-cors' })
            .then(() => { statusEl.textContent = TEXTS[currentLang].submitSuccess; })
            .catch(err => { statusEl.textContent = TEXTS[currentLang].submitError; console.error('Error:', err); });
    }

    function updateHpBars(percentage) {
      const hpBar = document.getElementById('boss-hp-bar');
      hpBar.style.width = `${Math.max(0, percentage)}%`;
      if (percentage <= 25) hpBar.className = 'boss-hp-bar low';
      else if (percentage <= 50) hpBar.className = 'boss-hp-bar mid';
      else hpBar.className = 'boss-hp-bar full';
    }
    
    function handleMediaError(element) {
        console.error(`Error loading media: ${element.src}`);
        element.style.display = 'none'; 
    }

    document.getElementById('title-start-button').addEventListener('click', async () => {
      if (!audioStarted) { 
        await Tone.start();
        setupAudio();
      }
      clickSound();
      const openingVideo = document.getElementById('opening-video');
      openingVideo.muted = false;
      openingVideo.play().catch(e => console.log("User interaction might be needed for audio"));
      switchScreen('language');
    });

    document.getElementById('lang-ja').addEventListener('click', () => { clickSound(); currentLang = 'ja'; updateUIText(); switchScreen('instruction'); });
    document.getElementById('lang-en').addEventListener('click', () => { clickSound(); currentLang = 'en'; updateUIText(); switchScreen('instruction'); });
    document.getElementById('lang-zh').addEventListener('click', () => { clickSound(); currentLang = 'zh'; updateUIText(); switchScreen('instruction'); });
    
    document.getElementById('instruction-ok-button').addEventListener('click', () => {
      clickSound();
      openingVideoContainer.classList.add('hidden');
      document.getElementById('opening-video').pause();
      gameVideoContainer.classList.remove('hidden');
      document.getElementById('game-bg-video').play().catch(e => console.log("Game video play failed"));
      switchScreen('start');
    });
    
    startButton.addEventListener('click', startGame);
    document.getElementById('restart-button').addEventListener('click', () => location.reload());

    updateUIText();
    switchScreen('title');
    const openingVideo = document.getElementById('opening-video');
    openingVideo.muted = false;
    openingVideo.play().catch(e => {
        console.log("Autoplay with sound was prevented. Muting and retrying.");
        openingVideo.muted = true;
        openingVideo.play();
    });
  </script>
</body>
</html>
