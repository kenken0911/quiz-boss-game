<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sustainable Quest üó°Ô∏è - Stage 4</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=Press+Start+2P&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
  <style>
    body[lang="ja"], body[lang="zh"] { font-family: 'DotGothic16', sans-serif; }
    body[lang="en"] { font-family: 'Press Start 2P', cursive; }
    body { background-color: #000; color: #fff; image-rendering: pixelated; overflow-x: hidden; overflow-y: auto; }
    .dq-window { border: 4px solid #fff; background: rgba(80, 0, 80, 0.85); padding: 1.5rem; box-shadow: 0 0 0 4px #000, 0 0 20px rgba(255, 0, 255, 0.5); backdrop-filter: blur(3px); }
    .dq-button { cursor: pointer; padding: .75rem 1.5rem; border: 2px solid #fff; background-image: linear-gradient(to bottom, #aa00aa, #880088); text-shadow: 1px 1px 2px #000; transition: all 0.2s; }
    .dq-button:hover { background-image: linear-gradient(to bottom, #dd33dd, #aa00aa); box-shadow: 0 0 10px #fff; }
    .video-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
    .bg-video { width: 100%; height: 100%; object-fit: cover; }
    #title-screen h1 { font-size: 2.5rem; font-weight: bold; text-shadow: 0 0 5px #fff, 0 0 15px #fff, 0 0 25px #ff00ff; animation: fadeInTitle 2s ease-out forwards; }
    #title-start-button { animation: pulseButton 2.5s infinite ease-in-out; }
    @keyframes fadeInTitle { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
    @keyframes pulseButton { 0%, 100% { transform: scale(1); box-shadow: 0 0 10px rgba(255,255,255,0.7); } 50% { transform: scale(1.05); box-shadow: 0 0 20px rgba(255,255,255,1); } }
    .boss-hp-container { border: 2px solid #fff; height: 30px; padding: 3px; background: #333; border-radius: 5px; box-shadow: inset 0 0 5px #000; }
    .boss-hp-bar { height: 100%; transition: width .5s ease-out, background-image .5s ease-out; border-radius: 2px; }
    .boss-hp-bar.full { background-image: linear-gradient(to right, #33ff33, #88ff88); }
    .boss-hp-bar.mid { background-image: linear-gradient(to right, #ffff33, #ffff88); }
    .boss-hp-bar.low { background-image: linear-gradient(to right, #ff3333, #ff8833); }
    .boss-idle { animation: boss-float 2.5s infinite ease-in-out; }
    @keyframes boss-float{ 0%,100% { transform: translateY(0); } 50% { transform: translateY(-12px); } }
    .boss-defeat { animation: boss-defeat-anim 1.5s forwards; }
    @keyframes boss-defeat-anim { 0% { opacity: 1; transform: rotate(0deg); } 50% { opacity: 1; transform: rotate(10deg); } 100% { opacity: 0; transform: translateY(100px) rotate(-20deg) scale(0.5); } }
    .shake { animation: shake .35s; }
    @keyframes shake { 10%,90% { transform: translate(-2px, -2px); } 20%,80% { transform: translate(3px, 2px); } 30%,50%,70% { transform: translate(-3px, 3px); } 40%,60% { transform: translate(3px, -2px); } }
    .magic-glow { filter: drop-shadow(0 0 8px #ff00ff) drop-shadow(0 0 16px #aa00ff) contrast(1.2); }
    #boss-img { width: 100%; max-width: 320px; height: auto; }
    .correct-answer { background-image: linear-gradient(to bottom, #ffdd00, #ffaa00) !important; color: #000; }
    .incorrect-answer { background-image: linear-gradient(to bottom, #888888, #555555) !important; opacity: 0.7; }
  </style>
</head>
<body class="flex items-start sm:items-center justify-center min-h-screen p-4">

  <div id="opening-video-container" class="video-container">
    <video id="opening-video" class="bg-video" src="./opening_movie.mp4" autoplay loop playsinline onerror="handleMediaError(this)"></video>
  </div>
  <div id="game-video-container" class="video-container hidden">
    <video id="game-bg-video" class="bg-video" src="./GameBackground4.mp4" autoplay muted loop playsinline onerror="handleMediaError(this)"></video>
  </div>

  <div class="w-full max-w-3xl mx-auto">
    <div id="boss-area" class="mb-4 h-64 flex justify-center items-end relative hidden">
      <div id="boss-container"><img id="boss-img" src="./Stage4_dragon.png" alt="„Éú„Çπ„ÅÆÁîªÂÉè" class="magic-glow" onerror="handleMediaError(this)"/></div>
    </div>
    <div id="game-container" class="w-full dq-window relative">
      <div id="title-screen" class="text-center py-8">
        <h1 class="mb-10">Sustainable Quest</h1>
        <button id="title-start-button" class="dq-button">START</button>
      </div>

      <div id="language-screen" class="text-center hidden">
        <h1 class="text-3xl font-bold mb-6">Select Language</h1>
        <div class="flex justify-center gap-2 flex-wrap">
          <button id="lang-ja" class="dq-button">Êó•Êú¨Ë™û</button>
          <button id="lang-en" class="dq-button">English</button>
          <button id="lang-zh" class="dq-button">‰∏≠Êñá</button>
        </div>
      </div>

      <div id="instruction-screen" class="text-center hidden">
        <h1 id="instruction-title" class="text-3xl font-bold mb-4"></h1>
        <div id="instruction-text" class="text-left mb-6 space-y-2"></div>
        <button id="instruction-ok-button" class="dq-button"></button>
      </div>
      
      <div id="start-screen" class="text-center hidden">
        <h1 id="title-text" class="text-2xl font-bold mb-4"></h1>
        <div class="flex flex-col items-center gap-4 mb-4">
          <input id="employeeIdInput" type="text" pattern="\d{5}" title="Á§æÂì°Áï™Âè∑„ÅØÂçäËßíÊï∞Â≠ó5Ê°Å„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ" class="text-black px-3 py-2 w-full md:w-80 text-center rounded" />
        </div>
        <button id="start-button" class="dq-button inline-flex items-center gap-2"><span id="start-button-text"></span></button>
        <div id="msg" class="text-yellow-300 text-sm h-5 mt-2"></div>
      </div>

      <div id="quiz-screen" class="hidden">
        <div class="flex justify-between items-center mb-2 text-lg">
          <span id="theme-display"></span>
          <span id="progress-display"></span>
          <span id="timer-display">0.0s</span>
        </div>
        <div class="mb-4"><p id="boss-hp-label"></p><div class="boss-hp-container"><div id="boss-hp-bar"></div></div></div>
        <div class="mb-4 min-h-[80px] p-4 border-2 border-white"><p id="question-text" class="text-xl"></p></div>
        <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      </div>
      <div id="result-screen" class="hidden text-center">
        <h2 id="result-title" class="text-3xl font-bold mb-4"></h2>
        <p id="result-message" class="text-xl mb-6"></p>
        <p id="submission-status" class="text-yellow-300 mb-8"></p>
        <div id="restart-button" class="dq-button inline-block"></div>
      </div>
      <div id="explanation-modal" class="absolute inset-0 bg-black bg-opacity-80 flex-col items-center justify-center p-4 hidden">
        <div class="dq-window w-full max-w-2xl text-center">
          <h2 id="explanation-title" class="text-4xl font-bold mb-4"></h2>
          <p id="explanation-text" class="text-lg mb-6 text-left h-48 overflow-y-auto p-2 border"></p>
          <button id="next-question-button" class="dq-button"></button>
        </div>
      </div>
    </div>
  </div>
  <audio id="bgm" src="./BS4_BGM.wav" loop onerror="handleMediaError(this)"></audio>
  <audio id="correct-sound" src="./correct_answer.mp3" onerror="handleMediaError(this)"></audio>
  <script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbzKjQfG-cW1tacggfb1JrGa8oT2iAqtgmdmeUb_wCdmMb3h78CXLgIiPVXsLXoMFdpHtQ/exec';
    const STAGE_NUMBER = '4';
    const TEXTS = {
      ja: {
        instructionTitle: "ÂÜíÈô∫„ÅÆÂøÉÂæó",
        instructions: ["„Éª„Çµ„Çπ„ÉÜ„Éä„Éì„É™„ÉÜ„Ç£„Å´Èñ¢„Åô„Çã5„Å§„ÅÆÂïèÈ°å„ÅåÂá∫È°å„Åï„Çå„Çã„Åû„ÄÇ", "„Éª4Âïè‰ª•‰∏äÊ≠£Ëß£„Åß„Éú„Çπ„ÇíË®é‰ºê„Åß„Åç„ÇãÔºÅ", "„ÉªÊúÄÂàù„ÅÆÊåëÊà¶ÁµêÊûú„ÅÆ„Åø„Åå„É©„É≥„Ç≠„É≥„Ç∞„Å´Ë®òÈå≤„Åï„Çå„Çã„Åû„ÄÇ", "„ÉªÂÅ•Èóò„ÇíÁ•à„ÇãÔºÅ"],
        instructionOk: "„Çè„Åã„Å£„Åü",
        title: "„Çπ„ÉÜ„Éº„Ç∏4ÔºöÂ§öÊßòÊÄß„ÅÆË¶ñÁÇπ",
        employeeIdPlaceholder: "Á§æÂì°Áï™Âè∑(ÂçäËßí5Ê°Å)„ÇíÂÖ•Âäõ",
        startButton: "ÊåëÊà¶„Åô„Çã",
        msgEnterId: "Á§æÂì°Áï™Âè∑„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ",
        msgCheckingId: "ÊåëÊà¶Ë≥áÊ†º„ÇíÁ¢∫Ë™ç‰∏≠...",
        msgIdNotFound: "„Çπ„ÉÜ„Éº„Ç∏3„Åã„ÇâÊåëÊà¶„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ",
        msgCheckError: "Á¢∫Ë™ç„Ç®„É©„Éº„ÄÇÊôÇÈñì„Çí„Åä„ÅÑ„Å¶ÂÜçË©¶Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
        theme: "„ÉÜ„Éº„ÉûÔºöÂ§öÊßòÊÄß„ÅÆË¶ñÁÇπ",
        progress: (q, t) => `${q}/${t}ÂïèÁõÆ`,
        bossHp: "„Éú„Çπ HP",
        resultWinTitle: "ÂãùÂà©ÔºÅ",
        resultWinMsg: "„Çπ„ÉÜ„Éº„Ç∏„ÇØ„É™„Ç¢ÔºÅÂ§öÊßò„Å™Ë¶ñÁÇπ„Åå‰∏ñÁïå„ÇíÂ∫É„Åí„ÅüÔºÅ",
        resultLoseTitle: "„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº",
        resultLoseMsg: "È≠îÁ´úÁéã„ÅÆÈ≠îÂäõ„ÅØË®à„ÇäÁü•„Çå„Å™„ÅÑ‚Ä¶",
        submitting: "ÁµêÊûú„ÇíÈÄÅ‰ø°‰∏≠...",
        submitSuccess: "ÁµêÊûú„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„ÅüÔºÅ",
        submitError: "„Ç®„É©„ÉºÔºöÁµêÊûú„ÇíÈÄÅ‰ø°„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ",
        restartButton: "„Çø„Ç§„Éà„É´„Å∏Êàª„Çã",
        correct: "Ê≠£Ëß£ÔºÅ",
        incorrect: "‰∏çÊ≠£Ëß£...",
        nextButton: "Ê¨°„Å∏",
        quiz: [
          { q: "„ÄåÈùí„Äç„Å®„ÄåÁ∑ë„Äç„ÇíÂå∫Âà•„Åó„Å™„ÅÑË®ÄË™û„ÅÆÂ≠òÂú®„ÅåÁ§∫„Åô„ÄÅÂ§öÊßòÊÄß„Å´Èñ¢„Åô„ÇãÈáçË¶Å„Å™Ê∞ó„Å•„Åç„Å®„ÅØÔºü", o: ["ÁèæÂÆü„ÅÆË™çË≠ò„ÅØË®ÄË™û„ÇÑÊñáÂåñ„Å´„Çà„ÇäÂΩ¢‰Ωú„Çâ„Çå„Çã", "ÂÖ®„Å¶„ÅÆË®ÄË™û„ÅØÂêå„ÅòÊßãÈÄ†„ÇíÊåÅ„Å§", "Ëâ≤„ÅÆË™çË≠ò„ÅØ‰∏ñÁïåÂÖ±ÈÄö„Åß„ÅÇ„Çã", "Âè§‰ª£Ë®ÄË™û„ÅØ‰∏çÂÆåÂÖ®„Å†„Å£„Åü"], a: "ÁèæÂÆü„ÅÆË™çË≠ò„ÅØË®ÄË™û„ÇÑÊñáÂåñ„Å´„Çà„ÇäÂΩ¢‰Ωú„Çâ„Çå„Çã", ex: "ÁßÅ„Åü„Å°„ÅØ„ÄåË®ÄË™û„Äç„ÇÑ„ÄåÊñáÂåñ„Äç„Å®„ÅÑ„ÅÜ„Éï„Ç£„É´„Çø„Éº„ÇíÈÄö„Åó„Å¶‰∏ñÁïå„ÇíË™çË≠ò„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇÊó•Êú¨„ÅÆ„ÄåÈùí‰ø°Âè∑„Äç„ÇÇÂè§„ÅÑÊó•Êú¨Ë™û„ÅÆÂêçÊÆã„Åß„Åô„ÄÇ" },
          { q: "Â§öÊßò„Å™‰∫∫Êùê„ÅßÊßãÊàê„Åï„Çå„Åü„ÉÅ„Éº„É†„ÅåÈ´ò„ÅÑÊàêÊûú„ÇíÂá∫„Åô„ÄÅÊúÄ„ÇÇÈáçË¶Å„Å™ÁêÜÁî±„Å®„ÅØÔºü", o: ["ÊÑèË¶ã„Åå„Åô„Åê„Å´„Åæ„Å®„Åæ„Çã„Åã„Çâ", "„Çà„ÇäÊ∑±„ÅèÊÄùËÄÉ„ÅóÂë®Âà∞„Å™Ê∫ñÂÇô„Çí‰øÉ„Åô„Åã„Çâ", "Á´∂‰∫â„ÅåÊøÄ„Åó„Åè„Å™„Çã„Åã„Çâ", "Â∞ÇÈñÄÂÆ∂„Å†„Åë„ÅåÈõÜ„Åæ„Çã„Åã„Çâ"], a: "„Çà„ÇäÊ∑±„ÅèÊÄùËÄÉ„ÅóÂë®Âà∞„Å™Ê∫ñÂÇô„Çí‰øÉ„Åô„Åã„Çâ", ex: "Áï∞„Å™„ÇãË¶ñÁÇπ„ÅÆÂ≠òÂú®„Åå„ÄÅ„É°„É≥„Éê„ÉºÂêÑËá™„Å´„Çà„ÇäÊ∑±„ÅèÊÉÖÂ†±„ÇíÂá¶ÁêÜ„Åó„ÄÅÂë®Âà∞„Å™Ê∫ñÂÇô„Å®ÊÄùËÄÉ„Çí‰øÉ„Åô„Åü„ÇÅ„Åß„Åô„ÄÇÂùáË≥™„Å™„ÉÅ„Éº„É†„Åß„ÅØÊÄùËÄÉ„ÅÆ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà„ÅåÁîü„Åæ„Çå„Åå„Å°„Åß„Åô„ÄÇ" },
          { q: "Ëã±Ë™û„ÅÆ„Åì„Å®„Çè„Åñ„ÄåVariety is the spice of life.„Äç„ÅÆÊó•Êú¨Ë™ûË®≥„Å®„Åó„Å¶ÊúÄ„ÇÇÈÅ©Âàá„Å™„ÇÇ„ÅÆ„ÅØÔºü", o: ["Â§öÊßòÊÄß„ÅØ‰∫∫Áîü„ÅÆËñ¨Âë≥„Åß„ÅÇ„Çã", "‰∫∫Áîü„ÅØ„Çπ„Éë„Ç§„Çπ„ÅÆ„Çà„ÅÜ„Å´Ëæõ„ÅÑ", "Â§âÂåñ„ÅÆ„Å™„ÅÑ‰∫∫Áîü„Åå‰∏ÄÁï™„Å†", "‰∫∫Áîü„ÅØ„Éê„É©„Ç®„ÉÜ„Ç£Áï™ÁµÑ„Å†"], a: "Â§öÊßòÊÄß„ÅØ‰∫∫Áîü„ÅÆËñ¨Âë≥„Åß„ÅÇ„Çã", ex: "Â§âÂåñ„Å´ÂØå„Çì„Å†Êßò„ÄÖ„Å™ÁµåÈ®ì„Åå‰∫∫Áîü„ÇíË±ä„Åã„Å´„Åô„Çã„Å®„ÅÑ„ÅÜÊÑèÂë≥„Åß„Åô„ÄÇËñ¨Âë≥„ÅåÊñôÁêÜ„ÅÆÂë≥„ÇíÂºï„ÅçÁ´ã„Å¶„Çã„Çà„ÅÜ„Å´„ÄÅÂ§öÊßò„Å™ÁµåÈ®ì„Åå‰∫∫Áîü„Çí„Çà„ÇäÈù¢ÁôΩ„Åè„ÄÅÂë≥„Çè„ÅÑÊ∑±„ÅÑ„ÇÇ„ÅÆ„Å´„Åó„Å¶„Åè„Çå„Åæ„Åô„ÄÇ" },
          { q: "Êó•Êú¨„Åß„ÅØÁ∑ëËâ≤„ÅÆ‰ø°Âè∑„Çí„ÄåÈùí‰ø°Âè∑„Äç„Å®Âëº„Å∂„Åì„Å®„Åå„ÅÇ„Çã„ÄÇ„Åì„Çå„ÅØ„Å™„ÅúÔºü", o: ["‰ø°Âè∑Ê©ü„ÅåÈùíËâ≤„Å´Ë¶ã„Åà„Çã„Åã„Çâ", "Ê≥ïÂæã„Åß„ÄåÈùí„Äç„Å®ÂÆö„ÇÅ„Çâ„Çå„Å¶„ÅÑ„Çã„Åã„Çâ", "Âè§„ÅÑÊó•Êú¨Ë™û„Åß„ÅØÁ∑ë„ÇÇ„Äå„ÅÇ„Åä„Äç„Å®Âëº„Çì„Å†ÂêçÊÆã", "ÂõΩÈöõÁöÑ„Å™„É´„Éº„É´„Å†„Åã„Çâ"], a: "Âè§„ÅÑÊó•Êú¨Ë™û„Åß„ÅØÁ∑ë„ÇÇ„Äå„ÅÇ„Åä„Äç„Å®Âëº„Çì„Å†ÂêçÊÆã", ex: "Âè§„ÅÑÊó•Êú¨Ë™û„ÅÆ„Äå„ÅÇ„Åä„Äç„ÅåÁ∑ëËâ≤„ÇÇÂê´„ÇÄË®ÄËëâ„Å†„Å£„ÅüÂêçÊÆã„Åß„Åô„ÄÇ" },
          { q: "Ëá™ÂàÜ„Å®‰ºº„Åü„É°„É≥„Éê„Éº„Å†„Åë„ÅÆ„ÉÅ„Éº„É†„ÅåÈô•„Çä„Åå„Å°„Å™„ÄÅÊÄùËÄÉ„ÅÆÁΩ†„Å®„ÅØÔºü", o: ["Èù©Êñ∞ÁöÑ„Å™„Ç¢„Ç§„Éá„Ç¢„ÅåÁîü„Åæ„Çå„ÇÑ„Åô„ÅÑ", "ÊÑèÊÄùÊ±∫ÂÆö„ÅåÈÅÖ„Åè„Å™„Çã", "Âõ∫ÂÆöË¶≥Âøµ„Å´Á∏õ„Çâ„Çå„Çã", "Ë≠∞Ë´ñ„ÅåÊ¥ªÁô∫„Å´„Å™„Çä„Åô„Åé„Çã"], a: "Âõ∫ÂÆöË¶≥Âøµ„Å´Á∏õ„Çâ„Çå„Çã", ex: "„Äå„Åç„Å£„Å®ÁöÜ„ÇÇÂêå„Åò„Çà„ÅÜ„Å´ËÄÉ„Åà„Å¶„ÅÑ„Çã„Å†„Çç„ÅÜ„Äç„Å®„ÅÑ„ÅÜÊöóÈªô„ÅÆÂâçÊèê„Åã„ÇâÊÄùËÄÉ„ÅÆ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà„ÅåÁîü„Åæ„Çå„ÄÅ„ÉÅ„Éº„É†ÂÖ®‰Ωì„ÅåÂõ∫ÂÆöË¶≥Âøµ„Å´Á∏õ„Çâ„Çå„Åå„Å°„Å´„Å™„Çä„Åæ„Åô„ÄÇ" }
        ]
      },
      en: {
        instructionTitle: "Rules of the Quest",
        instructions: ["- You will be asked 5 questions about sustainability.", "- Answer 4 or more correctly to defeat the boss!", "- Only your first attempt will be recorded for the ranking.", "- Good luck!"],
        instructionOk: "Got it",
        title: "Stage 4: Perspectives on Diversity",
        employeeIdPlaceholder: "Enter 5-digit Employee ID",
        startButton: "Challenge",
        msgEnterId: "Please enter your Employee ID",
        msgCheckingId: "Checking eligibility...",
        msgIdNotFound: "Please complete Stage 3 first!",
        msgCheckError: "Verification error. Please try again later.",
        theme: "Theme: Perspectives on Diversity",
        progress: (q, t) => `Q ${q}/${t}`,
        bossHp: "Boss HP",
        resultWinTitle: "Victory!",
        resultWinMsg: "Stage Clear! Diverse perspectives have broadened your world!",
        resultLoseTitle: "Game Over",
        resultLoseMsg: "The Magic Dragon King's power is immeasurable...",
        submitting: "Submitting results...",
        submitSuccess: "Results submitted!",
        submitError: "Error: Could not submit results.",
        restartButton: "Back to Title",
        correct: "Correct!",
        incorrect: "Incorrect...",
        nextButton: "Next",
        quiz: [
          { q: "What important insight about diversity is revealed by languages that don't distinguish between 'blue' and 'green'?", o: ["Perception of reality is shaped by language and culture", "All languages share the same structure", "Color perception is universal", "Ancient languages were incomplete"], a: "Perception of reality is shaped by language and culture", ex: "We perceive the world through the filters of 'language' and 'culture.' The Japanese 'blue signal' (aoshingo) for a green traffic light is a remnant of old Japanese." },
          { q: "What is the most important reason a diverse team achieves high performance?", o: ["Decisions are made quickly", "It encourages deeper thinking and thorough preparation", "Competition becomes more intense", "It consists only of experts"], a: "It encourages deeper thinking and thorough preparation", ex: "The presence of different viewpoints prompts each member to process information more deeply, encouraging thorough preparation and thought. Homogeneous teams tend to take mental shortcuts." },
          { q: "What is the most appropriate translation for the English proverb 'Variety is the spice of life.'?", o: ["Variety is the spice of life", "Life is spicy", "A life without change is best", "Life is a variety show"], a: "Variety is the spice of life", ex: "It means that a variety of rich experiences enriches life. Just as spices enhance a dish's flavor, diverse experiences make life more interesting and flavorful." },
          { q: "In Japan, green traffic lights are sometimes called 'blue signals' (aoshingo). Why?", o: ["The light looks blue", "It's legally defined as 'blue'", "It's a remnant of old Japanese where green was also 'ao'", "It's an international rule"], a: "It's a remnant of old Japanese where green was also 'ao'", ex: "It's a remnant from when the old Japanese word 'ao' also included the color green." },
          { q: "What is a common mental trap for a team composed only of like-minded members?", o: ["Innovative ideas emerge easily", "Decision-making becomes slower", "Being bound by stereotypes", "Discussions become too heated"], a: "Being bound by stereotypes", ex: "The implicit assumption that 'everyone probably thinks the same way' leads to mental shortcuts, and the entire team tends to be bound by stereotypes." }
        ]
      },
      zh: {
        instructionTitle: "ÂÜíÈô©È°ªÁü•",
        instructions: ["„ÉªÂ∞ÜÊèêÂá∫5‰∏™ÂÖ≥‰∫éÂèØÊåÅÁª≠ÊÄßÁöÑÈóÆÈ¢ò„ÄÇ", "„ÉªÊ≠£Á°ÆÂõûÁ≠î4‰∏™‰ª•‰∏äÈóÆÈ¢òÂç≥ÂèØÂáªË¥•Â§¥ÁõÆÔºÅ", "„ÉªÂè™ÊúâÁ¨¨‰∏ÄÊ¨°ÊåëÊàòÁöÑÁªìÊûú‰ºöË¢´ËÆ∞ÂΩïÂú®ÊéíÂêç‰∏≠„ÄÇ", "„ÉªÁ•ù‰Ω†Â•ΩËøêÔºÅ"],
        instructionOk: "Áü•ÈÅì‰∫Ü",
        title: "Á¨¨ÂõõÂÖ≥ÔºöÂ§öÊ†∑ÊÄßËßÜËßí",
        employeeIdPlaceholder: "ËæìÂÖ•ÂëòÂ∑•ÁºñÂè∑(5‰ΩçÂçäËßíÊï∞Â≠ó)",
        startButton: "ÊåëÊàò",
        msgEnterId: "ËØ∑ËæìÂÖ•ÂëòÂ∑•ÁºñÂè∑",
        msgCheckingId: "Ê≠£Âú®Á°ÆËÆ§ÊåëÊàòËµÑÊ†º...",
        msgIdNotFound: "ËØ∑ÂÖàÊåëÊàòÁ¨¨‰∏âÂÖ≥ÔºÅ",
        msgCheckError: "Á°ÆËÆ§Âá∫Èîô„ÄÇËØ∑Á®çÂêéÂÜçËØï„ÄÇ",
        theme: "‰∏ªÈ¢òÔºöÂ§öÊ†∑ÊÄßËßÜËßí",
        progress: (q, t) => `Á¨¨${q}/${t}È¢ò`,
        bossHp: "Â§¥ÁõÆ HP",
        resultWinTitle: "ËÉúÂà©ÔºÅ",
        resultWinMsg: "ÂÖ≥Âç°ÂÆåÊàêÔºÅÂ§öÊ†∑ÁöÑËßÜËßíÊãìÂÆΩ‰∫Ü‰∏ñÁïåÔºÅ",
        resultLoseTitle: "Ê∏∏ÊàèÁªìÊùü",
        resultLoseMsg: "È≠îÈæôÁéãÁöÑÂäõÈáèÊ∑±‰∏çÂèØÊµã‚Ä¶",
        submitting: "Ê≠£Âú®ÂèëÈÄÅÁªìÊûú...",
        submitSuccess: "ÁªìÊûúÂ∑≤ÂèëÈÄÅÔºÅ",
        submitError: "ÈîôËØØÔºöÊó†Ê≥ïÂèëÈÄÅÁªìÊûú„ÄÇ",
        restartButton: "ËøîÂõûÊ†áÈ¢ò",
        correct: "ÂõûÁ≠îÊ≠£Á°ÆÔºÅ",
        incorrect: "ÂõûÁ≠îÈîôËØØ...",
        nextButton: "‰∏ã‰∏Ä‰∏™",
        quiz: [
            { q: "Â≠òÂú®‰∏çÂå∫ÂàÜ‚ÄúËìùËâ≤‚ÄùÂíå‚ÄúÁªøËâ≤‚ÄùÁöÑËØ≠Ë®ÄÔºåËøô‰∏Ä‰∫ãÂÆûÊè≠Á§∫‰∫ÜÂÖ≥‰∫éÂ§öÊ†∑ÊÄßÁöÑ‰ΩïÁßçÈáçË¶ÅÂêØÁ§∫Ôºü", o: ["ÂØπÁé∞ÂÆûÁöÑËÆ§Áü•ÊòØÁî±ËØ≠Ë®ÄÂíåÊñáÂåñÂ°ëÈÄ†ÁöÑ", "ÊâÄÊúâËØ≠Ë®ÄÈÉΩÂÖ∑ÊúâÁõ∏ÂêåÁöÑÁªìÊûÑ", "È¢úËâ≤ËØÜÂà´ÊòØ‰∏ñÁïåÂÖ±ÈÄöÁöÑ", "Âè§‰ª£ËØ≠Ë®Ä‰∏çÂÆåÊï¥"], a: "ÂØπÁé∞ÂÆûÁöÑËÆ§Áü•ÊòØÁî±ËØ≠Ë®ÄÂíåÊñáÂåñÂ°ëÈÄ†ÁöÑ", ex: "Êàë‰ª¨ÈÄöËøá‚ÄúËØ≠Ë®Ä‚ÄùÂíå‚ÄúÊñáÂåñ‚ÄùÁöÑÊª§ÈïúÊù•ËÆ§ËØÜ‰∏ñÁïå„ÄÇÊó•Êú¨ÁöÑ‚ÄúÈùí‰ø°Âè∑‚ÄùÔºàÁªøÁÅØÔºâ‰πüÊòØÂè§‰ª£Êó•ËØ≠ÁöÑÈÅóÁïô„ÄÇ" },
            { q: "Áî±Â§öÂÖÉÂåñ‰∫∫ÊâçÁªÑÊàêÁöÑÂõ¢ÈòüËÉΩÂèñÂæóÊõ¥È´òÊàêÂ∞±ÁöÑÊúÄÈáçË¶ÅÂéüÂõ†ÊòØ‰ªÄ‰πàÔºü", o: ["ËÉΩËøÖÈÄüÁªü‰∏ÄÊÑèËßÅ", "Âõ†‰∏∫ÂÆÉËÉΩ‰øÉËøõÊõ¥Ê∑±ÂÖ•ÁöÑÊÄùËÄÉÂíåÂë®ÂØÜÁöÑÂáÜÂ§á", "Á´û‰∫âÂèòÂæóÊõ¥Âä†ÊøÄÁÉà", "Âõ†‰∏∫Âè™Êúâ‰∏ìÂÆ∂ËÅöÈõÜÂú®‰∏ÄËµ∑"], a: "Âõ†‰∏∫ÂÆÉËÉΩ‰øÉËøõÊõ¥Ê∑±ÂÖ•ÁöÑÊÄùËÄÉÂíåÂë®ÂØÜÁöÑÂáÜÂ§á", ex: "‰∏çÂêåËßÜÁÇπÁöÑÂ≠òÂú®Ôºå‰øÉ‰ΩøÊØè‰∏™ÊàêÂëòÊõ¥Ê∑±ÂÖ•Âú∞Â§ÑÁêÜ‰ø°ÊÅØÔºåÂπ∂ÈºìÂä±Âë®ÂØÜÁöÑÂáÜÂ§áÂíåÊÄùËÄÉ„ÄÇÂêåË¥®ÂåñÁöÑÂõ¢ÈòüÂÆπÊòì‰∫ßÁîüÊÄùÁª¥Êç∑ÂæÑ„ÄÇ" },
            { q: "Ëã±ËØ≠Ë∞öËØ≠‚ÄúVariety is the spice of life.‚ÄùÊúÄË¥¥ÂàáÁöÑ‰∏≠ÊñáÁøªËØëÊòØ‰ªÄ‰πàÔºü", o: ["Â§öÊ†∑ÊÄßÊòØÁîüÊ¥ªÁöÑË∞ÉÂë≥ÂìÅ", "‰∫∫ÁîüÂÉèÈ¶ôÊñô‰∏ÄÊ†∑ËæõËæ£", "Ê≤°ÊúâÂèòÂåñÁöÑ‰∫∫ÁîüÊòØÊúÄÂ•ΩÁöÑ", "‰∫∫ÁîüÊòØ‰∏ÄÂú∫ÁªºËâ∫ÁßÄ"], a: "Â§öÊ†∑ÊÄßÊòØÁîüÊ¥ªÁöÑË∞ÉÂë≥ÂìÅ", ex: "ÊÑèÊÄùÊòØ‰∏∞ÂØåÂ§öÂΩ©ÁöÑÁªèÂéÜËÉΩ‰Ωø‰∫∫ÁîüÊõ¥Âä†ÂÖÖÂÆû„ÄÇÂ∞±ÂÉèË∞ÉÂë≥ÂìÅËÉΩÊèêÂçáËèúËÇ¥ÁöÑÂë≥ÈÅì‰∏ÄÊ†∑ÔºåÂ§öÊ†∑ÁöÑÁªèÂéÜËÉΩËÆ©‰∫∫ÁîüÊõ¥ÊúâË∂£„ÄÅÊõ¥ÊúâÂë≥ÈÅì„ÄÇ" },
            { q: "Âú®Êó•Êú¨ÔºåÁªøËâ≤ÁöÑ‰∫§ÈÄö‰ø°Âè∑ÁÅØÊúâÊó∂Ë¢´Áß∞‰∏∫‚ÄúÈùí‰ø°Âè∑‚Äù„ÄÇËøôÊòØ‰∏∫‰ªÄ‰πàÔºü", o: ["Âõ†‰∏∫‰ø°Âè∑ÁÅØÁúãËµ∑Êù•ÊòØËìùËâ≤ÁöÑ", "Âõ†‰∏∫Ê≥ïÂæãËßÑÂÆö‰∏∫‚ÄúÈùíËâ≤‚Äù", "Âè§‰ª£Êó•ËØ≠‰∏≠ÁªøËâ≤‰πüÁß∞‰∏∫‚Äúao‚ÄùÁöÑÈÅóÁïô", "Âõ†‰∏∫ËøôÊòØÂõΩÈôÖËßÑÂàô"], a: "Âè§‰ª£Êó•ËØ≠‰∏≠ÁªøËâ≤‰πüÁß∞‰∏∫‚Äúao‚ÄùÁöÑÈÅóÁïô", ex: "ËøôÊòØÂè§‰ª£Êó•ËØ≠‰∏≠‚Äúao‚Äù‰∏ÄËØç‰πüÂåÖÂê´ÁªøËâ≤ÁöÑÈÅóÁïô„ÄÇ" },
            { q: "Âè™Áî±ÊÉ≥Ê≥ïÁõ∏‰ººÁöÑÊàêÂëòÁªÑÊàêÁöÑÂõ¢ÈòüÂÆπÊòìÈô∑ÂÖ•‰ªÄ‰πàÊ†∑ÁöÑÊÄùÁª¥Èô∑Èò±Ôºü", o: ["ÂÆπÊòì‰∫ßÁîüÂàõÊñ∞ÊÉ≥Ê≥ï", "ÂÜ≥Á≠ñÂèòÊÖ¢", "Ë¢´ÂàªÊùøÂç∞Ë±°ÊâÄÊùüÁºö", "ËÆ®ËÆ∫ÂèòÂæóËøá‰∫éÊøÄÁÉà"], a: "Ë¢´ÂàªÊùøÂç∞Ë±°ÊâÄÊùüÁºö", ex: "‚ÄúÂ§ßÂÆ∂ËÇØÂÆöÈÉΩËøô‰πàÊÉ≥‚ÄùÁöÑÈªòÂ•ëÂâçÊèê‰ºöÂØºËá¥ÊÄùÁª¥Êç∑ÂæÑÔºå‰ΩøÊï¥‰∏™Âõ¢ÈòüÂÆπÊòìË¢´ÂàªÊùøÂç∞Ë±°ÊâÄÊùüÁºö„ÄÇ" }
        ]
      }
    };
    
    const titleScreen = document.getElementById('title-screen');
    const languageScreen = document.getElementById('language-screen');
    const instructionScreen = document.getElementById('instruction-screen');
    const startScreen = document.getElementById('start-screen');
    const quizScreen = document.getElementById('quiz-screen');
    const resultScreen = document.getElementById('result-screen');
    const bossContainer = document.getElementById('boss-container');
    const employeeIdInput = document.getElementById('employeeIdInput');
    const bgm = document.getElementById('bgm');
    const correctSound = document.getElementById('correct-sound');
    const startButton = document.getElementById('start-button');
    const explanationModal = document.getElementById('explanation-modal');
    const nextQuestionButton = document.getElementById('next-question-button');
    const openingVideoContainer = document.getElementById('opening-video-container');
    const gameVideoContainer = document.getElementById('game-video-container');

    let currentLang = 'ja';
    let timerInterval, startTime, correctCount, isGameInProgress = false, audioStarted = false;
    let clickSound, hitSound, damageSound, victorySound, defeatSound;

    function switchScreen(screenName) {
      [titleScreen, languageScreen, instructionScreen, startScreen, quizScreen, resultScreen].forEach(s => s.classList.add('hidden'));
      document.getElementById(`${screenName}-screen`).classList.remove('hidden');
    }
    
    function updateUIText() {
      const t = TEXTS[currentLang];
      document.body.lang = currentLang;
      document.getElementById('instruction-title').textContent = t.instructionTitle;
      document.getElementById('instruction-text').innerHTML = t.instructions.map(line => `<p>${line}</p>`).join('');
      document.getElementById('instruction-ok-button').textContent = t.instructionOk;
      document.getElementById('title-text').textContent = t.title;
      employeeIdInput.placeholder = t.employeeIdPlaceholder;
      document.getElementById('start-button-text').textContent = t.startButton;
      document.getElementById('boss-hp-label').textContent = t.bossHp;
      document.getElementById('restart-button').textContent = t.restartButton;
      document.getElementById('theme-display').textContent = t.theme;
    }

    function setupAudio() {
      if (audioStarted) return;
      clickSound = () => new Tone.MembraneSynth({ pitchDecay: 0.01, octaves: 3, envelope: { attack: 0.001, decay: 0.3, sustain: 0 } }).toDestination().triggerAttackRelease("C2", "8n");
      hitSound = () => {
        correctSound.currentTime = 0;
        correctSound.play().catch(e => console.error("Correct sound play failed:", e));
      };
      damageSound = () => new Tone.NoiseSynth({ noise: { type: "pink" }, envelope: { attack: 0.01, decay: 0.3, sustain: 0, release: 0.2 } }).toDestination().triggerAttackRelease("8n");
      victorySound = () => { const s = new Tone.Synth().toDestination(), n = Tone.now(); s.triggerAttackRelease("C5", "8n", n); s.triggerAttackRelease("E5", "8n", n + 0.2); s.triggerAttackRelease("G5", "8n", n + 0.4); s.triggerAttackRelease("C6", "4n", n + 0.6) };
      defeatSound = () => { const s = new Tone.Synth().toDestination(), n = Tone.now(); s.triggerAttackRelease("C4", "4n", n); s.triggerAttackRelease("B3", "4n", n + 0.3); s.triggerAttackRelease("A#3", "4n", n + 0.6); s.triggerAttackRelease("A3", "2n", n + 0.9) };
      audioStarted = true;
    }

    async function startGame() {
      if (!employeeIdInput.checkValidity()) {
        employeeIdInput.reportValidity();
        return;
      }
      const employeeId = employeeIdInput.value.trim();
      const msgEl = document.getElementById('msg');
      if (!employeeId) {
        msgEl.textContent = TEXTS[currentLang].msgEnterId;
        return;
      }
      if (isGameInProgress) return;
      isGameInProgress = true;
      startButton.disabled = true;
      msgEl.textContent = TEXTS[currentLang].msgCheckingId;

      try {
        const checkUrl = `${GAS_URL}?action=checkEmployeeId&employeeId=${encodeURIComponent(employeeId)}&stage=3`;
        const response = await fetch(checkUrl);
        const result = await response.json();

        if (result.exists) {
          msgEl.textContent = "";
          bgm.play().catch(e => console.error("BGM play failed:", e));
          clickSound();
          correctCount = 0;
          document.getElementById('boss-area').classList.remove('hidden');
          bossContainer.className = 'boss-idle';
          updateHpBars(100);
          switchScreen('quiz');
          startTime = Date.now();
          timerInterval = setInterval(() => {
            const elapsedTime = ((Date.now() - startTime) / 1000).toFixed(1);
            document.getElementById('timer-display').textContent = `${elapsedTime}s`;
          }, 100);
          displayQuestion(0);
        } else {
          msgEl.textContent = TEXTS[currentLang].msgIdNotFound;
        }
      } catch (error) {
        console.error("Error checking employee ID:", error);
        msgEl.textContent = TEXTS[currentLang].msgCheckError;
      } finally {
        isGameInProgress = false;
        startButton.disabled = false;
      }
    }

    function displayQuestion(index) {
      const quizData = TEXTS[currentLang].quiz;
      document.getElementById('progress-display').textContent = TEXTS[currentLang].progress(index + 1, quizData.length);
      const current = quizData[index];
      document.getElementById('question-text').textContent = `Q${index + 1}: ${current.q}`;
      const optionsContainer = document.getElementById('options-container');
      optionsContainer.innerHTML = '';
      current.o.forEach(opt => {
        const div = document.createElement('div');
        div.textContent = `‚ñ∂ ${opt}`;
        div.classList.add('dq-button');
        div.addEventListener('click', () => handleAnswer(opt, current, index));
        optionsContainer.appendChild(div);
      });
    }

    function handleAnswer(selectedAnswer, currentQuiz, index) {
      const isCorrect = selectedAnswer === currentQuiz.a;
      const optionsContainer = document.getElementById('options-container');
      optionsContainer.querySelectorAll('.dq-button').forEach(btn => {
        btn.style.pointerEvents = 'none';
        if (btn.textContent.includes(currentQuiz.a)) {
          btn.classList.add('correct-answer');
        } else {
          btn.classList.add('incorrect-answer');
        }
      });

      if (isCorrect) {
        correctCount++;
        hitSound();
        updateHpBars(100 - (correctCount * (100 / 4)));
        bossContainer.classList.add('shake');
        document.getElementById('explanation-title').textContent = TEXTS[currentLang].correct;
      } else {
        damageSound();
        document.querySelector('.dq-window').classList.add('shake');
        document.getElementById('explanation-title').textContent = TEXTS[currentLang].incorrect;
      }
      
      document.getElementById('explanation-text').textContent = currentQuiz.ex;
      nextQuestionButton.textContent = TEXTS[currentLang].nextButton;
      nextQuestionButton.dataset.nextIndex = index + 1;
      
      setTimeout(() => {
        explanationModal.style.display = 'flex';
      }, 800);
    }
    
    nextQuestionButton.addEventListener('click', () => {
      explanationModal.style.display = 'none';
      bossContainer.classList.remove('shake');
      document.querySelector('.dq-window').classList.remove('shake');
      
      const nextIndex = parseInt(nextQuestionButton.dataset.nextIndex);
      if (nextIndex >= TEXTS[currentLang].quiz.length) {
        showEndScreen();
      } else {
        displayQuestion(nextIndex);
      }
    });

    function showEndScreen() {
      clearInterval(timerInterval);
      bgm.pause();
      bgm.currentTime = 0;
      
      const isVictory = correctCount >= 4;
      if (isVictory) {
        victorySound();
        bossContainer.className = 'boss-defeat';
      } else {
        defeatSound();
      }
      
      setTimeout(() => {
        document.getElementById('boss-area').classList.add('hidden');
        switchScreen('result');
        const t = TEXTS[currentLang];
        document.getElementById('result-title').textContent = isVictory ? t.resultWinTitle : t.resultLoseTitle;
        document.getElementById('result-message').textContent = isVictory ? t.resultWinMsg : t.resultLoseMsg;
        submitResults();
      }, isVictory ? 1500 : 500);
    }

    async function submitResults() {
        const statusEl = document.getElementById('submission-status');
        let ipAddress = 'N/A';
        try {
            const response = await fetch('https://api.ipify.org?format=json');
            ipAddress = (await response.json()).ip;
        } catch (error) {
            console.error('IP„Ç¢„Éâ„É¨„Çπ„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', error);
        }

        const payload = {
            employeeId: employeeIdInput.value.trim(),
            stage: STAGE_NUMBER,
            score: correctCount,
            time: ((Date.now() - startTime) / 1000).toFixed(2),
            ipAddress: ipAddress
        };
        statusEl.textContent = TEXTS[currentLang].submitting;
        fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload), mode: 'no-cors' })
            .then(() => { statusEl.textContent = TEXTS[currentLang].submitSuccess; })
            .catch(err => { statusEl.textContent = TEXTS[currentLang].submitError; console.error('Error:', err); });
    }

    function updateHpBars(percentage) {
      const hpBar = document.getElementById('boss-hp-bar');
      hpBar.style.width = `${Math.max(0, percentage)}%`;
      if (percentage <= 25) hpBar.className = 'boss-hp-bar low';
      else if (percentage <= 50) hpBar.className = 'boss-hp-bar mid';
      else hpBar.className = 'boss-hp-bar full';
    }
    
    function handleMediaError(element) {
        console.error(`Error loading media: ${element.src}`);
        element.style.display = 'none'; 
    }

    document.getElementById('title-start-button').addEventListener('click', async () => {
      if (!audioStarted) { 
        await Tone.start();
        setupAudio();
      }
      clickSound();
      const openingVideo = document.getElementById('opening-video');
      openingVideo.muted = false;
      openingVideo.play().catch(e => console.log("User interaction might be needed for audio"));
      switchScreen('language');
    });

    document.getElementById('lang-ja').addEventListener('click', () => { clickSound(); currentLang = 'ja'; updateUIText(); switchScreen('instruction'); });
    document.getElementById('lang-en').addEventListener('click', () => { clickSound(); currentLang = 'en'; updateUIText(); switchScreen('instruction'); });
    document.getElementById('lang-zh').addEventListener('click', () => { clickSound(); currentLang = 'zh'; updateUIText(); switchScreen('instruction'); });
    
    document.getElementById('instruction-ok-button').addEventListener('click', () => {
      clickSound();
      openingVideoContainer.classList.add('hidden');
      document.getElementById('opening-video').pause();
      gameVideoContainer.classList.remove('hidden');
      document.getElementById('game-bg-video').play().catch(e => console.log("Game video play failed"));
      switchScreen('start');
    });
    
    startButton.addEventListener('click', startGame);
    document.getElementById('restart-button').addEventListener('click', () => location.reload());

    updateUIText();
    switchScreen('title');
    const openingVideo = document.getElementById('opening-video');
    openingVideo.muted = false;
    openingVideo.play().catch(e => {
        console.log("Autoplay with sound was prevented. Muting and retrying.");
        openingVideo.muted = true;
        openingVideo.play();
    });
  </script>
</body>
</html>
