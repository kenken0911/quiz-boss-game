<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sustainability Quest üó°Ô∏è</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=Press+Start+2P&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
  <style>
    body[lang="ja"], body[lang="zh"] { font-family: 'DotGothic16', sans-serif; }
    body[lang="en"] { font-family: 'Press Start 2P', cursive; }
    body { background-color: #000; color: #fff; image-rendering: pixelated; overflow-x: hidden; overflow-y: auto; }
    .dq-window { border: 4px solid #fff; background: rgba(80, 0, 80, 0.85); padding: 1.5rem; box-shadow: 0 0 0 4px #000, 0 0 20px rgba(255, 0, 255, 0.5); backdrop-filter: blur(3px); }
    .dq-button { cursor: pointer; padding: .75rem 1.5rem; border: 2px solid #fff; background-image: linear-gradient(to bottom, #aa00aa, #880088); text-shadow: 1px 1px 2px #000; transition: all 0.2s; }
    .dq-button:hover { background-image: linear-gradient(to bottom, #dd33dd, #aa00aa); box-shadow: 0 0 10px #fff; }
    .video-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
    .bg-video { width: 100%; height: 100%; object-fit: cover; }
    #title-screen h1 { font-size: 2.5rem; font-weight: bold; text-shadow: 0 0 5px #fff, 0 0 15px #fff, 0 0 25px #ff00ff; animation: fadeInTitle 2s ease-out forwards; }
    #title-start-button { animation: pulseButton 2.5s infinite ease-in-out; }
    @keyframes fadeInTitle { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
    @keyframes pulseButton { 0%, 100% { transform: scale(1); box-shadow: 0 0 10px rgba(255,255,255,0.7); } 50% { transform: scale(1.05); box-shadow: 0 0 20px rgba(255,255,255,1); } }
    .boss-hp-container { border: 2px solid #fff; height: 30px; padding: 3px; background: #333; border-radius: 5px; box-shadow: inset 0 0 5px #000; }
    .boss-hp-bar { height: 100%; transition: width .5s ease-out, background-image .5s ease-out; border-radius: 2px; }
    .boss-hp-bar.full { background-image: linear-gradient(to right, #33ff33, #88ff88); }
    .boss-hp-bar.mid { background-image: linear-gradient(to right, #ffff33, #ffff88); }
    .boss-hp-bar.low { background-image: linear-gradient(to right, #ff3333, #ff8833); }
    .boss-idle { animation: boss-float 2.5s infinite ease-in-out; }
    @keyframes boss-float{ 0%,100% { transform: translateY(0); } 50% { transform: translateY(-12px); } }
    .boss-defeat { animation: boss-defeat-anim 1.5s forwards; }
    @keyframes boss-defeat-anim { 0% { opacity: 1; transform: rotate(0deg); } 50% { opacity: 1; transform: rotate(10deg); } 100% { opacity: 0; transform: translateY(100px) rotate(-20deg) scale(0.5); } }
    .shake { animation: shake .35s; }
    @keyframes shake { 10%,90% { transform: translate(-2px, -2px); } 20%,80% { transform: translate(3px, 2px); } 30%,50%,70% { transform: translate(-3px, 3px); } 40%,60% { transform: translate(3px, -2px); } }
    .magic-glow { filter: drop-shadow(0 0 8px #ff00ff) drop-shadow(0 0 16px #aa00ff) contrast(1.2); }
    #boss-img { width: 100%; max-width: 320px; height: auto; }
    .correct-answer { background-image: linear-gradient(to bottom, #ffdd00, #ffaa00) !important; color: #000; }
    .incorrect-answer { background-image: linear-gradient(to bottom, #888888, #555555) !important; opacity: 0.7; }
  </style>
</head>
<body class="flex items-start sm:items-center justify-center min-h-screen p-4">

  <div id="opening-video-container" class="video-container">
    <video id="opening-video" class="bg-video" src="./opening_movie.mp4" autoplay loop playsinline onerror="handleMediaError(this)"></video>
  </div>
  <div id="game-video-container" class="video-container hidden">
    <video id="game-bg-video" class="bg-video" src="./GameBackground4.mp4" autoplay muted loop playsinline onerror="handleMediaError(this)"></video>
  </div>

  <div class="w-full max-w-3xl mx-auto">
    <div id="boss-area" class="mb-4 h-64 flex justify-center items-end relative hidden">
      <div id="boss-container"><img id="boss-img" src="./Stage4_dragon.png" alt="„Éú„Çπ„ÅÆÁîªÂÉè" class="magic-glow" onerror="handleMediaError(this)"/></div>
    </div>
    <div id="game-container" class="w-full dq-window relative">
      <div id="title-screen" class="text-center py-8">
        <h1 class="mb-10">Sustainability Quest</h1>
        <button id="title-start-button" class="dq-button">START</button>
      </div>

      <div id="language-screen" class="text-center hidden">
        <h1 class="text-3xl font-bold mb-6">Select Language</h1>
        <p class="text-sm mb-6">Translations are provided by AI. / ÁøªËØëÁî±‰∫∫Â∑•Êô∫ËÉΩÊèê‰æõ„ÄÇ</p>
        <div class="flex justify-center gap-2 flex-wrap">
          <button id="lang-ja" class="dq-button">Êó•Êú¨Ë™û</button>
          <button id="lang-en" class="dq-button">English</button>
          <button id="lang-zh" class="dq-button">‰∏≠Êñá</button>
        </div>
      </div>

      <div id="instruction-screen" class="text-center hidden">
        <h1 id="instruction-title" class="text-3xl font-bold mb-4"></h1>
        <div id="instruction-text" class="text-left mb-6 space-y-2"></div>
        <button id="instruction-ok-button" class="dq-button"></button>
      </div>
      
      <div id="start-screen" class="text-center hidden">
        <h1 id="title-text" class="text-2xl font-bold mb-4"></h1>
        <div class="flex flex-col items-center gap-4 mb-4">
          <select id="companySelect" class="text-black px-3 py-2 w-full md:w-80 text-center rounded"></select>
          <input id="employeeIdInput" type="text" pattern="\d{5}" title="Á§æÂì°Áï™Âè∑„ÅØÂçäËßíÊï∞Â≠ó5Ê°Å„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ" class="text-black px-3 py-2 w-full md:w-80 text-center rounded" />
          <p id="employeeIdNoteDisplay" class="text-xs text-gray-300 -mt-2"></p>
        </div>
        <button id="start-button" class="dq-button inline-flex items-center gap-2"><span id="start-button-text"></span></button>
        <div id="msg" class="text-yellow-300 text-sm h-5 mt-2"></div>
      </div>

      <div id="quiz-screen" class="hidden">
        <div class="flex justify-between items-center mb-2 text-lg">
          <span id="theme-display"></span>
          <span id="progress-display"></span>
          <span id="timer-display" class="hidden">0.0s</span>
        </div>
        <div class="mb-4"><p id="boss-hp-label"></p><div class="boss-hp-container"><div id="boss-hp-bar"></div></div></div>
        <div class="mb-4 min-h-[80px] p-4 border-2 border-white"><p id="question-text" class="text-xl"></p></div>
        <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      </div>
      <div id="result-screen" class="hidden text-center">
        <h2 id="result-title" class="text-3xl font-bold mb-4"></h2>
        <p id="result-message" class="text-xl mb-2"></p>
        <p id="submission-status" class="text-yellow-300 mb-4"></p>
        <div id="review-container" class="mt-4"></div>
        <button id="restart-button" class="dq-button inline-block mt-6"></button>
      </div>
      <div id="explanation-modal" class="absolute inset-0 bg-black bg-opacity-80 flex-col items-center justify-center p-4 hidden">
        <div class="dq-window w-full max-w-2xl text-center">
          <h2 id="explanation-title" class="text-4xl font-bold mb-4"></h2>
          <p id="explanation-text" class="text-lg mb-6 text-left h-48 overflow-y-auto p-2 border"></p>
          <button id="next-question-button" class="dq-button"></button>
        </div>
      </div>
    </div>
  </div>
  <audio id="bgm" src="./BS4_BGM.wav" loop onerror="handleMediaError(this)"></audio>
  <audio id="correct-sound" src="./correct_answer.mp3" onerror="handleMediaError(this)"></audio>
  <script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbyJ-jSH9YdU0ltF9O2Y_LJJmqd24l5PNve_ZtTze0qj6Iv4OIT8Iz77YAoh705-fAuJgg/exec';
    const STAGE_NUMBER = '4';
    const TEXTS = {
      ja: {
        instructionTitle: "ÂÜíÈô∫„ÅÆÂøÉÂæó",
        instructions: ["„Éª„Çµ„Çπ„ÉÜ„Éä„Éì„É™„ÉÜ„Ç£„Å´Èñ¢„Åô„Çã5„Å§„ÅÆÂïèÈ°å„ÅåÂá∫È°å„Åï„Çå„Çã„Åû„ÄÇ", "„Éª4Âïè‰ª•‰∏äÊ≠£Ëß£„Åß„Éú„Çπ„ÇíË®é‰ºê„Åß„Åç„ÇãÔºÅ", "„ÉªÂêÑ„Çπ„ÉÜ„Éº„Ç∏„ÅÆÊúÄÂàù„ÅÆÊåëÊà¶ÁµêÊûú„ÅÆ„Åø„ÅåË®òÈå≤„Åï„Çå„Çã„Åû„ÄÇ", "„Éª„ÇØ„Ç§„Ç∫„ÅÆÈÄî‰∏≠„ÅßÁîªÈù¢„ÇíÈñâ„Åò„Çã„Å®„ÄÅ„Åù„ÅÆÊôÇÁÇπ„Åæ„Åß„ÅÆ„Çπ„Ç≥„Ç¢„Åå„ÅÇ„Å™„Åü„ÅÆË®òÈå≤„Å®„Å™„Çã„Åû„ÄÇ", "„ÉªÂÅ•Èóò„ÇíÁ•à„ÇãÔºÅ"],
        instructionOk: "„Çè„Åã„Å£„Åü",
        title: "„Åì„Å©„ÇÇ„ÉªË≤ßÂõ∞",
        employeeIdPlaceholder: "Á§æÂì°Áï™Âè∑(ÂçäËßí5Ê°Å)„ÇíÂÖ•Âäõ",
        employeeIdNote: "Á§æÂì°Áï™Âè∑4Ê°Å‰ª•‰∏ã„ÅÆÊñπ„ÅØ„ÄÅÂÖàÈ†≠„Å´„Äå0„Äç„ÇíÂÖ•ÂäõÔºà‰æãÔºö111‚Üí00111)",
        companySelectDefault: "ÊâÄÂ±û‰ºöÁ§æ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ",
        startButton: "ÊåëÊà¶„Åô„Çã",
        msgEnterId: "ÊâÄÂ±û‰ºöÁ§æ„Å®Á§æÂì°Áï™Âè∑„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ",
        msgCheckingId: "ÊåëÊà¶Ë≥áÊ†º„ÇíÁ¢∫Ë™ç‰∏≠...",
        msgIdNotFound: "„Çπ„ÉÜ„Éº„Ç∏1„ÅÆË®òÈå≤„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ‰ºöÁ§æÂêç„Å®Á§æÂì°Áï™Âè∑„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
        msgCheckError: "Á¢∫Ë™ç„Ç®„É©„Éº„ÄÇÊôÇÈñì„Çí„Åä„ÅÑ„Å¶ÂÜçË©¶Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
        theme: "„ÉÜ„Éº„ÉûÔºö„Åì„Å©„ÇÇ„ÉªË≤ßÂõ∞",
        progress: (q, t) => `${q}/${t}ÂïèÁõÆ`,
        bossHp: "„Éú„Çπ HP",
        resultWinTitle: "ÂãùÂà©ÔºÅ",
        resultWinMsg: "„Çπ„ÉÜ„Éº„Ç∏„ÇØ„É™„Ç¢ÔºÅÊú™Êù•„Å∏„ÅÆÂ∏åÊúõ„Çí„Å§„Å™„ÅÑ„Å†ÔºÅ",
        resultLoseTitle: "„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº",
        resultLoseMsg: "È≠îÁ´úÁéã„ÅÆÈ≠îÂäõ„ÅØË®à„ÇäÁü•„Çå„Å™„ÅÑ‚Ä¶",
        submitting: "ÁµêÊûú„ÇíÈÄÅ‰ø°‰∏≠...",
        submitSuccess: "ÁµêÊûú„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„ÅüÔºÅ",
        submitError: "„Ç®„É©„ÉºÔºöÁµêÊûú„ÇíÈÄÅ‰ø°„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ",
        recordedFalse: "„Éó„É¨„Ç§„ÅÇ„Çä„Åå„Å®„ÅÜÔºÅË®òÈå≤„ÅØÂàùÂõû„ÅÆ„ÇÇ„ÅÆ„ÅÆ„Åø„Å®„Å™„Çä„Åæ„Åô„ÄÇ",
        restartButton: "„Çø„Ç§„Éà„É´„Å∏Êàª„Çã",
        correct: "Ê≠£Ëß£ÔºÅ",
        incorrect: "‰∏çÊ≠£Ëß£...",
        nextButton: "Ê¨°„Å∏",
        reviewTitle: "„ÇØ„Ç§„Ç∫„ÅÆÊåØ„ÇäËøî„Çä",
        reviewAnswerLabel: "Ê≠£Ëß£",
        reviewUserAnswerLabel: "„ÅÇ„Å™„Åü„ÅÆÂõûÁ≠î",
        quiz: [
          { q: "‰∏ñÁïå„Åß„ÅØ„ÄÅÊØéÊó•„Å©„Çå„Åè„Çâ„ÅÑ„ÅÆ„Åì„Å©„ÇÇ„Åå„ÄÅÂÆ∂Â∫≠„ÅÆË≤ßÂõ∞„ÇíÁêÜÁî±„Å´ÂëΩ„ÇíËêΩ„Å®„Åó„Å¶„ÅÑ„Çã„Åß„Åó„Çá„ÅÜ„ÅãÔºü", o: ["Á¥Ñ150,000‰∫∫", "Á¥Ñ10,000‰∫∫", "Á¥Ñ1,000‰∫∫", "Á¥Ñ100‰∫∫"], a: "Á¥Ñ10,000‰∫∫", ex: "‰∏ñÁïå„Åß„ÅØÊØéÊó•„ÄÅË≤ßÂõ∞„ÅåÂéüÂõ†„ÅßÁ¥Ñ10,000‰∫∫„ÇÇ„ÅÆ5Ê≠≥Êú™Ê∫Ä„ÅÆ„Åì„Å©„ÇÇ„ÅåÂëΩ„ÇíËêΩ„Å®„Åó„Å¶„ÅÑ„Çã„Å®„ÅÑ„Çè„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ" },
          { q: "‰∏ñÁïå‰∏≠„ÅÆ„Åì„Å©„ÇÇ„Åü„Å°„ÅÆÊ®©Âà©„Å®ÂÅ•„ÇÑ„Åã„Å™ÊàêÈï∑„ÇíÂÆà„ÇãÂõΩÈÄ£Ê©üÈñ¢„ÅØÔºü", o: ["WHO", "UNICEF", "UNESCO", "UNDP"], a: "UNICEF", ex: "‰∏ñÁïå‰∏≠„ÅÆ„Åì„Å©„ÇÇ„Åü„Å°„ÅÆÊ®©Âà©„Å®ÂÅ•„ÇÑ„Åã„Å™ÊàêÈï∑„ÇíÂÆà„Çã„Åü„ÇÅ„Å´Ê¥ªË∫ç„Åó„Å¶„ÅÑ„ÇãÂõΩÈÄ£Ê©üÈñ¢„ÅØUNICEFÔºàÂõΩÈöõÈÄ£ÂêàÂÖêÁ´•Âü∫ÈáëÔºâ„Åß„Åô„ÄÇ" },
          { q: "Ë≤ßÂõ∞„ÅÆÂÜçÁîüÁî£ÔºàÈÄ£ÈéñÔºâ„ÇíÊñ≠„Å°Âàá„Çã„Åü„ÇÅ„Å´„ÄÅÊúÄ„ÇÇÈáçË¶Å„Å†„Å®ËÄÉ„Åà„Çâ„Çå„Å¶„ÅÑ„ÇãÂØæÁ≠ñ„ÅØÊ¨°„ÅÆ„ÅÜ„Å°„Å©„Çå„Åß„Åó„Çá„ÅÜ„ÅãÔºü", o: ["Ë≤ß„Åó„ÅÑÂÆ∂Â∫≠„ÅÆÂåªÁôÇË≤ª„ÇíÂÖ®È°çÂÖçÈô§„Åô„Çã„Åì„Å®", "Â§±Ê•≠ËÄÖ„Å´È£üÊñô„ÇíÈÖçÂ∏É„Åô„Çã„Åì„Å®", "Ë≤ßÂõ∞Â±§„Åå‰Ωè„ÇÄÂú∞Âüü„ÅÆÂª∫Áâ©„ÇíÊñ∞„Åó„ÅèÂª∫„Å¶Êõø„Åà„Çã„Åì„Å®", "„Åì„Å©„ÇÇ„Åü„Å°„Å´ÂÖ¨Âπ≥„ÅßË≥™„ÅÆÈ´ò„ÅÑÊ©ü‰ºö„ÅÆ‰øùÈöú„Çí„Åô„Çã„Åì„Å®"], a: "„Åì„Å©„ÇÇ„Åü„Å°„Å´ÂÖ¨Âπ≥„ÅßË≥™„ÅÆÈ´ò„ÅÑÊ©ü‰ºö„ÅÆ‰øùÈöú„Çí„Åô„Çã„Åì„Å®", ex: "Ë≤ßÂõ∞„ÅÆÂÜçÁîüÁî£„ÅØ„ÄÅË¶™„ÅÆË≤ßÂõ∞„ÅåÂ≠ê„Å©„ÇÇ„ÅÆÊ©ü‰ºö„ÇíÂ•™„ÅÜ„Åì„Å®„ÅßËµ∑„Åì„Çä„Åæ„Åô„ÄÇÊïôËÇ≤„ÅØ„ÄÅ„Åì„ÅÆ„ÄåÊ©ü‰ºö„ÅÆ‰∏çÂπ≥Á≠â„Äç„ÇíÊòØÊ≠£„Åó„ÄÅÂ≠ê„Å©„ÇÇ„Åü„Å°„Å´Ëá™Âäõ„ÅßÊú™Êù•„ÇíÂàá„ÇäÈñã„Åè„Åü„ÇÅ„ÅÆÊ©ü‰ºö„Çí‰∏é„Åà„Çã„ÄÅÊúÄ„ÇÇÂäπÊûúÁöÑ„Å™ÊâãÊÆµ„Åß„Åô„ÄÇ" },
          { q: "„Éï„Çß„Ç¢„Éà„É¨„Éº„ÉâË£ΩÂìÅ„ÇíË≤∑„ÅÜ„Åì„Å®„ÅåË≤ßÂõ∞ÂïèÈ°å„ÅÆËß£Ê±∫„Å´Áπã„Åå„Çã‰∏ª„Å™ÁêÜÁî±„ÅØÊ¨°„ÅÆ„ÅÜ„Å°„Å©„Çå„Åß„Åó„Çá„ÅÜ„ÅãÔºü", o: ["Ë£ΩÂìÅ„ÅåÁÑ°Êñô„ÅßÈÖçÂ∏É„Åï„Çå„Çã„Åã„Çâ„ÄÇ", "Ê∂àË≤ªËÄÖ„ÅåÁØÄÁ¥Ñ„Åó„Åü„ÅäÈáë„ÇíÂØÑ‰ªò„Åß„Åç„Çã„Åã„Çâ„ÄÇ", "Â£≤‰∏äÈáë„Åå„Åô„Åπ„Å¶Ë≤ßÂõ∞Âú∞Âüü„Å´ÂØÑ‰ªò„Åï„Çå„Çã„Åã„Çâ„ÄÇ", "ÁîüÁî£ËÄÖ„Å´ÂÖ¨Ê≠£„Å™Ë≥ÉÈáë„ÅåÊîØÊâï„Çè„Çå„Çã„Åã„Çâ„ÄÇ"], a: "ÁîüÁî£ËÄÖ„Å´ÂÖ¨Ê≠£„Å™Ë≥ÉÈáë„ÅåÊîØÊâï„Çè„Çå„Çã„Åã„Çâ„ÄÇ", ex: "„Éï„Çß„Ç¢„Éà„É¨„Éº„Éâ„ÅÆÊúÄ„ÇÇÈáçË¶Å„Å™ÂéüÂâá„ÅÆ‰∏Ä„Å§„ÅØ„ÄÅÁîüÁî£ËÄÖ„Å´ÂÖ¨Ê≠£„Å™‰æ°Ê†º„Çí‰øùË®º„Åó„ÄÅÂÆâÂÆö„Åó„ÅüÂèéÂÖ•„ÇíÊèê‰æõ„Åô„Çã„Åì„Å®„Åß„Åô„ÄÇ„Åì„Çå„Å´„Çà„Çä„ÄÅÂΩº„Çâ„ÅØÁîüÊ¥ª„ÇíÊîπÂñÑ„Åó„ÄÅÊïôËÇ≤„ÇÑÂåªÁôÇ„Å´ÊäïË≥á„Åß„Åç„Çã„Çà„ÅÜ„Å´„Å™„Çä„Åæ„Åô„ÄÇ" },
          { q: "ÂÆ∂Â∫≠„ÅÆÁµåÊ∏àÁöÑ„Å™ÁêÜÁî±„ÅßÂçÅÂàÜ„Å™È£ü‰∫ã„Åå„Å®„Çå„Å™„ÅÑÂ≠ê„Å©„ÇÇ„ÇíÊîØÊè¥„Åô„ÇãÊ¥ªÂãï„Å®„Åó„Å¶„Äå„Åì„Å©„ÇÇÈ£üÂ†Ç„Äç„ÅåÂ∫É„Åå„Å£„Å¶„ÅÑ„Åæ„Åô„Åå„ÄÅ‰∏≠ÂøÉÁöÑ„Å™ÂΩπÂâ≤„Å®„Åó„Å¶ÊúÄ„ÇÇÈÅ©Âàá„Å™„ÇÇ„ÅÆ„ÅØÊ¨°„ÅÆ„ÅÜ„Å°„Å©„Çå„Åß„Åó„Çá„ÅÜ„ÅãÔºü", o: ["Â≠ê„Å©„ÇÇ„Åü„Å°„Å´ÊñôÁêÜ„ÅÆÊäÄË°ì„ÇíÊïô„Åà„ÄÅËá™Á´ã„Çí‰øÉ„Åô„Åì„Å®„ÄÇ", "Â≠ê„Å©„ÇÇ„Åü„Å°„ÅåÂ≠§Á´ã„Åõ„Åö„ÄÅÂÆâÂøÉ„Åó„Å¶ÈÅé„Åî„Åõ„ÇãÂ±ÖÂ†¥ÊâÄ„ÇíÊèê‰æõ„Åô„Çã„Åì„Å®„ÄÇ", "Ë≤ß„Åó„ÅÑÂÆ∂Â∫≠„ÅÆÂ≠ê„Å©„ÇÇ„Å†„Åë„ÇíÂØæË±°„Å´„ÄÅÈ£ü‰∫ã„ÇíÈÖçÁµ¶„Åô„Çã„Åì„Å®„ÄÇ", "Â≠ê„Å©„ÇÇ„Åü„Å°„Å´„ÄÅÂÆâ‰æ°„Åæ„Åü„ÅØÁÑ°Êñô„ÅßË±™ËèØ„Å™È£ü‰∫ã„ÇíÊèê‰æõ„Åô„Çã„Åì„Å®„ÄÇ"], a: "Â≠ê„Å©„ÇÇ„Åü„Å°„ÅåÂ≠§Á´ã„Åõ„Åö„ÄÅÂÆâÂøÉ„Åó„Å¶ÈÅé„Åî„Åõ„ÇãÂ±ÖÂ†¥ÊâÄ„ÇíÊèê‰æõ„Åô„Çã„Åì„Å®„ÄÇ", ex: "„Åì„Å©„ÇÇÈ£üÂ†Ç„ÅØ„ÄÅÈ£ü‰∫ã„ÇíÈÄö„Åò„Å¶„ÄÅÂ≠ê„Å©„ÇÇ„Åü„Å°„ÅåÂ≠§Á´ã„Åô„Çã„Åì„Å®„Å™„Åè„ÄÅÂú∞ÂüüÁ§æ‰ºö„Å®„Å§„Å™„Åå„Çã„ÄåÂ±ÖÂ†¥ÊâÄ„Äç„ÇíÊèê‰æõ„Åô„Çã„Åì„Å®„ÇíÊúÄ„ÇÇÈáçË¶Å„Å™ÂΩπÂâ≤„Å®„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇNKC„Åß„ÅØ„ÄÅ2018Âπ¥„Åã„Çâ„ÄÅÊú™Êù•„ÅÇ„Çã„Åì„Å©„ÇÇ„Åü„Å°„ÅÆ„Åü„ÇÅ„Å´„Äå„Å™„Åã„Å´„Çè„Åì„Å©„ÇÇÈ£üÂ†Ç„Äç„ÇíÁ´ã„Å°‰∏ä„Åí„ÄÅÊñ∞„Åü„Å™‰æ°ÂÄ§„ÇíÊèê‰æõ„Åô„Çã‰ΩìÈ®ìÊ©ü‰ºö„Å•„Åè„Çä„Å´Âèñ„ÇäÁµÑ„Çì„Åß„ÅÑ„Åæ„Åô„ÄÇ" }
        ]
      },
      en: {
        instructionTitle: "Rules of the Quest",
        instructions: ["- You will be asked 5 questions about sustainability.", "- Answer 4 or more correctly to defeat the boss!", "- Only your first attempt on each stage will be recorded.", "- If you close the screen mid-quiz, your score up to that point will be recorded.", "- Good luck!"],
        instructionOk: "Got it",
        title: "Children & Poverty",
        employeeIdPlaceholder: "Enter 5-digit Employee ID",
        employeeIdNote: "For IDs with 4 or fewer digits, add leading '0's (e.g., 111 -> 00111).",
        companySelectDefault: "Select your company",
        startButton: "Challenge",
        msgEnterId: "Please enter your Company and Employee ID",
        msgCheckingId: "Checking eligibility...",
        msgIdNotFound: "Stage 1 record not found. Please check your Company and Employee ID.",
        msgCheckError: "Verification error. Please try again later.",
        theme: "Theme: Children & Poverty",
        progress: (q, t) => `Q ${q}/${t}`,
        bossHp: "Boss HP",
        resultWinTitle: "Victory!",
        resultWinMsg: "Stage Clear! You have connected hope for the future!",
        resultLoseTitle: "Game Over",
        resultLoseMsg: "The Magic Dragon King's power is immeasurable...",
        submitting: "Submitting results...",
        submitSuccess: "Results submitted!",
        submitError: "Error: Could not submit results.",
        recordedFalse: "Thanks for playing! Only your first result is recorded.",
        restartButton: "Back to Title",
        correct: "Correct!",
        incorrect: "Incorrect...",
        nextButton: "Next",
        reviewTitle: "Quiz Review",
        reviewAnswerLabel: "Answer",
        reviewUserAnswerLabel: "Your Answer",
        quiz: [
          { q: "How many children are estimated to die every day due to family poverty worldwide?", o: ["About 150,000", "About 10,000", "About 1,000", "About 100"], a: "About 10,000", ex: "It is said that every day, about 10,000 children under the age of five lose their lives due to poverty." },
          { q: "Which UN agency protects the rights and healthy development of children worldwide?", o: ["WHO", "UNICEF", "UNESCO", "UNDP"], a: "UNICEF", ex: "The UN agency that works to protect the rights and healthy development of children worldwide is UNICEF (United Nations Children's Fund)." },
          { q: "Which of the following is considered the most important measure to break the cycle of poverty?", o: ["Waiving all medical expenses for poor families", "Distributing food to the unemployed", "Rebuilding homes in poor areas", "Ensuring fair, high-quality opportunities for children"], a: "Ensuring fair, high-quality opportunities for children", ex: "The cycle of poverty occurs when parental poverty deprives children of opportunities. Education is the most effective means to correct this 'inequality of opportunity' and give children the chance to build their own futures." },
          { q: "What is the main reason why buying Fair Trade products helps solve the problem of poverty?", o: ["The products are distributed for free.", "Consumers can donate the money they save.", "All sales are donated to poor regions.", "Producers are paid a fair wage."], a: "Producers are paid a fair wage.", ex: "One of the most important principles of Fair Trade is to guarantee a fair price to producers and provide them with a stable income. This allows them to improve their lives and invest in education and healthcare." },
          { q: "What is the most appropriate central role of 'Kodomo Shokudo' (Children's Cafeterias), which support children who can't get enough food for economic reasons?", o: ["Teaching children cooking skills to promote independence.", "Providing a safe place where children can feel secure and not isolated.", "Distributing meals exclusively to children from poor families.", "Providing children with cheap or free luxurious meals."], a: "Providing a safe place where children can feel secure and not isolated.", ex: "The most important role of Kodomo Shokudo is to provide a 'place to belong' through meals, where children can connect with the community without being isolated. Since 2018, NKC has run the 'Nakaniwa Kodomo Shokudo' to create new value experiences for children." }
        ]
      },
      zh: {
        instructionTitle: "ÂÜíÈô©È°ªÁü•",
        instructions: ["„ÉªÂ∞ÜÊèêÂá∫5‰∏™ÂÖ≥‰∫éÂèØÊåÅÁª≠ÊÄßÁöÑÈóÆÈ¢ò„ÄÇ", "„ÉªÊ≠£Á°ÆÂõûÁ≠î4‰∏™‰ª•‰∏äÈóÆÈ¢òÂç≥ÂèØÂáªÊïóÂ§¥ÁõÆÔºÅ", "„ÉªÊØè‰∏™ÂÖ≥Âç°Âè™ÊúâÁ¨¨‰∏ÄÊ¨°ÊåëÊàòÁöÑÁªìÊûú‰ºöË¢´ËÆ∞ÂΩï„ÄÇ", "„ÉªÂ¶ÇÊûúÊÇ®Âú®ÊµãÈ™å‰∏≠ÈÄîÂÖ≥Èó≠Â±èÂπïÔºåÊÇ®Âà∞ÈÇ£Êó∂‰∏∫Ê≠¢ÁöÑÂàÜÊï∞Â∞ÜÊàê‰∏∫ÊÇ®ÁöÑËÆ∞ÂΩï„ÄÇ", "„ÉªÁ•ù‰Ω†Â•ΩËøêÔºÅ"],
        instructionOk: "Áü•ÈÅì‰∫Ü",
        title: "ÂÑøÁ´•‰∏éË¥´Âõ∞",
        employeeIdPlaceholder: "ËæìÂÖ•ÂëòÂ∑•ÁºñÂè∑(5‰ΩçÂçäËßíÊï∞Â≠ó)",
        employeeIdNote: "ÂëòÂ∑•ÁºñÂè∑‰∏∫4‰ΩçÊï∞Êàñ‰ª•‰∏ãËÄÖÔºåËØ∑Âú®ÂºÄÂ§¥ËæìÂÖ•‚Äú0‚ÄùÔºà‰æãÔºö111‚Üí00111Ôºâ",
        companySelectDefault: "ËØ∑ÈÄâÊã©ÊâÄÂ±ûÂÖ¨Âè∏",
        startButton: "ÊåëÊàò",
        msgEnterId: "ËØ∑ËæìÂÖ•ÊâÄÂ±ûÂÖ¨Âè∏ÂíåÂëòÂ∑•ÁºñÂè∑",
        msgCheckingId: "Ê≠£Âú®Á°ÆËÆ§ÊåëÊàòËµÑÊ†º...",
        msgIdNotFound: "Êú™ÊâæÂà∞Á¨¨‰∏ÄÂÖ≥ÁöÑËÆ∞ÂΩï„ÄÇËØ∑Ê£ÄÊü•ÂÖ¨Âè∏ÂêçÁß∞ÂíåÂëòÂ∑•ÁºñÂè∑„ÄÇ",
        msgCheckError: "Á°ÆËÆ§Âá∫Èîô„ÄÇËØ∑Á®çÂêéÂÜçËØï„ÄÇ",
        theme: "‰∏ªÈ¢òÔºöÂÑøÁ´•‰∏éË¥´Âõ∞",
        progress: (q, t) => `Á¨¨${q}/${t}È¢ò`,
        bossHp: "Â§¥ÁõÆ HP",
        resultWinTitle: "ËÉúÂà©ÔºÅ",
        resultWinMsg: "ÂÖ≥Âç°ÂÆåÊàêÔºÅËøûÊé•‰∫ÜÊú™Êù•ÁöÑÂ∏åÊúõÔºÅ",
        resultLoseTitle: "Ê∏∏ÊàèÁªìÊùü",
        resultLoseMsg: "È≠îÈæôÁéãÁöÑÂäõÈáèÊ∑±‰∏çÂèØÊµã‚Ä¶",
        submitting: "Ê≠£Âú®ÂèëÈÄÅÁªìÊûú...",
        submitSuccess: "ÁªìÊûúÂ∑≤ÂèëÈÄÅÔºÅ",
        submitError: "ÈîôËØØÔºöÊó†Ê≥ïÂèëÈÄÅÁªìÊûú„ÄÇ",
        recordedFalse: "ÊÑüË∞¢ÊÇ®ÁöÑÂèÇ‰∏éÔºÅÂè™ÊúâÂàùÊ¨°ÊåëÊàòÁªìÊûú‰ºöË¢´ËÆ∞ÂΩï„ÄÇ",
        restartButton: "ËøîÂõûÊ†áÈ¢ò",
        correct: "ÂõûÁ≠îÊ≠£Á°ÆÔºÅ",
        incorrect: "ÂõûÁ≠îÈîôËØØ...",
        nextButton: "‰∏ã‰∏Ä‰∏™",
        reviewTitle: "ÊµãÈ™åÂõûÈ°æ",
        reviewAnswerLabel: "Ê≠£Á°ÆÁ≠îÊ°à",
        reviewUserAnswerLabel: "‰Ω†ÁöÑÁ≠îÊ°à",
        quiz: [
          { q: "ÂÖ®ÁêÉÊØèÂ§©Â§ßÁ∫¶ÊúâÂ§öÂ∞ëÂÑøÁ´•Âõ†ÂÆ∂Â∫≠Ë¥´Âõ∞ËÄåÊ≠ª‰∫°Ôºü", o: ["Á∫¶150,000‰∫∫", "Á∫¶10,000‰∫∫", "Á∫¶1,000‰∫∫", "Á∫¶100‰∫∫"], a: "Á∫¶10,000‰∫∫", ex: "ÊçÆËØ¥ÔºåÂÖ®ÁêÉÊØèÂ§©ÊúâÂ§öËææ10,000Âêç5Â≤Å‰ª•‰∏ãÂÑøÁ´•Âõ†Ë¥´Âõ∞ËÄåÊ≠ª‰∫°„ÄÇ" },
          { q: "Âì™‰∏™ËÅîÂêàÂõΩÊú∫ÊûÑË¥üË¥£‰øùÊä§ÂÖ®‰∏ñÁïåÂÑøÁ´•ÁöÑÊùÉÂà©ÂíåÂÅ•Â∫∑ÊàêÈïøÔºü", o: ["WHO", "UNICEF", "UNESCO", "UNDP"], a: "UNICEF", ex: "Ëá¥Âäõ‰∫é‰øùÊä§ÂÖ®‰∏ñÁïåÂÑøÁ´•ÊùÉÂà©ÂíåÂÅ•Â∫∑ÊàêÈïøÁöÑËÅîÂêàÂõΩÊú∫ÊûÑÊòØËÅîÂêàÂõΩÂÑøÁ´•Âü∫Èáë‰ºöÔºàUNICEFÔºâ„ÄÇ" },
          { q: "‰∏∫ÊâìÁ†¥Ë¥´Âõ∞ÁöÑ‰ª£ÈôÖ‰º†ÈÄíÔºàÂæ™ÁéØÔºâÔºå‰ª•‰∏ãÂì™È°πË¢´ËÆ§‰∏∫ÊòØÊúÄÈáçË¶ÅÁöÑÊé™ÊñΩÔºü", o: ["ÂÖ®È¢ùÂÖçÈô§Ë¥´Âõ∞ÂÆ∂Â∫≠ÁöÑÂåªÁñóË¥πÁî®", "ÂêëÂ§±‰∏öËÄÖÂàÜÂèëÈ£üÁâ©", "ÈáçÂª∫Ë¥´Âõ∞Âú∞Âå∫ÁöÑ‰ΩèÊàø", "Á°Æ‰øùÂÑøÁ´•Ëé∑ÂæóÂÖ¨Âπ≥ÂíåÈ´òË¥®ÈáèÁöÑÊú∫‰ºö"], a: "Á°Æ‰øùÂÑøÁ´•Ëé∑ÂæóÂÖ¨Âπ≥ÂíåÈ´òË¥®ÈáèÁöÑÊú∫‰ºö", ex: "Ë¥´Âõ∞ÁöÑ‰ª£ÈôÖ‰º†ÈÄíÊòØÁî±‰∫éÁà∂ÊØçÁöÑË¥´Âõ∞Ââ•Â§∫‰∫ÜÂ≠©Â≠êÁöÑÊú∫‰ºöËÄåÂèëÁîüÁöÑ„ÄÇÊïôËÇ≤ÊòØÁ∫†Ê≠£ËøôÁßç‚ÄúÊú∫‰ºö‰∏çÂπ≥Á≠â‚Äù„ÄÅÁªô‰∫àÂ≠©Â≠ê‰ª¨‰æùÈù†Ëá™Â∑±ÂäõÈáèÂºÄÂàõÊú™Êù•ÁöÑÊú∫‰ºöÁöÑÊúÄÊúâÊïàÊâãÊÆµ„ÄÇ" },
          { q: "Ë¥≠‰π∞ÂÖ¨Âπ≥Ë¥∏Êòì‰∫ßÂìÅÊúâÂä©‰∫éËß£ÂÜ≥Ë¥´Âõ∞ÈóÆÈ¢òÁöÑ‰∏ªË¶ÅÂéüÂõ†ÊòØ‰ªÄ‰πàÔºü", o: ["‰∫ßÂìÅÊòØÂÖçË¥πÂàÜÂèëÁöÑ„ÄÇ", "Ê∂àË¥πËÄÖÂèØ‰ª•ÊçêÂá∫ËäÇÁúÅ‰∏ãÊù•ÁöÑÈí±„ÄÇ", "ÊâÄÊúâÈîÄÂîÆÈ¢ùÈÉΩÊçêËµ†ÁªôË¥´Âõ∞Âú∞Âå∫„ÄÇ", "Áîü‰∫ßËÄÖËÉΩËé∑ÂæóÂÖ¨Âπ≥ÁöÑÊä•ÈÖ¨„ÄÇ"], a: "Áîü‰∫ßËÄÖËÉΩËé∑ÂæóÂÖ¨Âπ≥ÁöÑÊä•ÈÖ¨„ÄÇ", ex: "ÂÖ¨Âπ≥Ë¥∏ÊòìÊúÄÈáçË¶ÅÁöÑÂéüÂàô‰πã‰∏ÄÊòØ‰øùËØÅÁîü‰∫ßËÄÖËé∑ÂæóÂÖ¨Ê≠£ÁöÑ‰ª∑Ê†ºÔºåÂπ∂‰∏∫‰ªñ‰ª¨Êèê‰æõÁ®≥ÂÆöÁöÑÊî∂ÂÖ•„ÄÇËøô‰Ωø‰ªñ‰ª¨ËÉΩÂ§üÊîπÂñÑÁîüÊ¥ªÔºåÂπ∂ÊäïËµÑ‰∫éÊïôËÇ≤ÂíåÂåªÁñó„ÄÇ" },
          { q: "‚ÄúÂÑøÁ´•È£üÂ†Ç‚Äù‰Ωú‰∏∫‰∏ÄÈ°πÊîØÊè¥Âõ†ÂÆ∂Â∫≠ÁªèÊµéÂéüÂõ†ËÄåÊó†Ê≥ïËé∑ÂæóË∂≥Â§üÈ£üÁâ©ÁöÑÂÑøÁ´•ÁöÑÊ¥ªÂä®Ê≠£Âú®ÊôÆÂèä„ÄÇ‰ª•‰∏ãÂì™È°πÊòØÂÖ∂ÊúÄÊ†∏ÂøÉÁöÑ‰ΩúÁî®Ôºü", o: ["ÊïôÂ≠©Â≠ê‰ª¨ÁÉπÈ•™ÊäÄÂ∑ßÔºå‰øÉËøõ‰ªñ‰ª¨Ëá™Á´ã„ÄÇ", "Êèê‰æõ‰∏Ä‰∏™ËÆ©Â≠©Â≠ê‰ª¨‰∏çÊÑüÂà∞Â≠§Á´ã„ÄÅÂèØ‰ª•ÂÆâÂøÉÂ∫¶ËøáÁöÑÂú∫ÊâÄ„ÄÇ", "‰∏ìÈó®‰∏∫Ë¥´Âõ∞ÂÆ∂Â∫≠ÁöÑÂÑøÁ´•ÈÖçÈ§ê„ÄÇ", "‰∏∫Â≠©Â≠ê‰ª¨Êèê‰æõÂªâ‰ª∑ÊàñÂÖçË¥πÁöÑË±™ÂçéÈ§êÈ£ü„ÄÇ"], a: "Êèê‰æõ‰∏Ä‰∏™ËÆ©Â≠©Â≠ê‰ª¨‰∏çÊÑüÂà∞Â≠§Á´ã„ÄÅÂèØ‰ª•ÂÆâÂøÉÂ∫¶ËøáÁöÑÂú∫ÊâÄ„ÄÇ", ex: "ÂÑøÁ´•È£üÂ†ÇÊúÄÈáçË¶ÅÁöÑ‰ΩúÁî®ÊòØÈÄöËøáÊèê‰æõÈ§êÈ£üÔºå‰∏∫Â≠©Â≠ê‰ª¨Êèê‰æõ‰∏Ä‰∏™‰∏éÂΩìÂú∞Á§æÂå∫ËÅîÁ≥ª„ÄÅ‰∏çÊÑüÂà∞Â≠§Á´ãÁöÑ‚ÄúÂΩíÂ±ûÂú∞‚Äù„ÄÇËá™2018Âπ¥‰ª•Êù•ÔºåNKC‰∏∫ËÇ©Ë¥üÊú™Êù•ÁöÑÂ≠©Â≠ê‰ª¨ÂàõÂäû‰∫Ü‚Äú‰∏≠Â∫≠ÂÑøÁ´•È£üÂ†Ç‚ÄùÔºåËá¥Âäõ‰∫éÂàõÈÄ†Êèê‰æõÊñ∞‰ª∑ÂÄºÁöÑ‰ΩìÈ™åÊú∫‰ºö„ÄÇ" }
        ]
      }
    };
    const companyList = {
      ja: ["Êú¨Á§æ/Â§©Ê∫ÄÂú∞Âå∫", "Ê≤ªÂ∑•ÂÖ∑Â∑•Â†¥", "Á•ûÊà∏Â∑•Â†¥", "Â§ßÈò™Â∑•Â†¥", "ÂêçÂºµÂ∑•Â†¥", "‰∏âÈáçÂ∑•Â†¥", "ÊªãË≥ÄÂ∑•Â†¥", "Ê≤≥ÂÜÖÂ∑•Â†¥", "NASSH", "È†àÁî∞ÂïÜ‰∫ã", "ÂØåÂ£´„Éõ„Éº„Éã„É≥„Ç∞", "‰∏≠Ë•øËààÁî£", "CTM", "„Ç§„Éº„Ç∞„É≠„Éº„Éê„É¨„ÉÉ„Ç∏", "„Å™„Åå„ÅÑ„Ç∞„É™„Éº„É≥„Éë„ÉØ„Éº", "NMC", "NSC", "NWC", "NPC", "NAI", "NCP", "NDC", "„Åù„ÅÆ‰ªñ"],
      en: ["HQ/Tenma Area", "Jig & Tool Factory", "Kobe Plant", "Osaka Plant", "Nabari Plant", "Mie Plant", "Shiga Plant", "Kawachi Plant", "NASSH", "Suda Corporation", "Fuji Honing", "Nakanishi Kosan", "CTM", "e-Globaledge", "Nagai Green Power", "NMC", "NSC", "NWC", "NPC", "NAI", "NCP", "NDC", "Other"],
      zh: ["ÊÄªÂÖ¨Âè∏/Â§©Êª°Âú∞Âå∫", "Ê≤ªÂ∑•ÂÖ∑Â∑•Â†¥", "Á•ûÊà∑Â∑•ÂéÇ", "Â§ßÈò™Â∑•ÂéÇ", "ÂêçÂº†Â∑•ÂéÇ", "‰∏âÈáçÂ∑•ÂéÇ", "ÊªãË¥∫Â∑•ÂéÇ", "Ê≤≥ÂÜÖÂ∑•ÂéÇ", "NASSH", "È°ªÁî∞ÂïÜ‰∫ã", "ÂØåÂ£´Áè©Á£®", "‰∏≠Ë•øÂÖ¥‰∫ß", "CTM", "e-Globaledge", "Èïø‰∫ïÁªøËâ≤ÁîµÂäõ", "NMC", "NSC", "NWC", "NPC", "NAI", "NCP", "NDC", "ÂÖ∂‰ªñ"]
    };
    
    const titleScreen = document.getElementById('title-screen');
    const languageScreen = document.getElementById('language-screen');
    const instructionScreen = document.getElementById('instruction-screen');
    const startScreen = document.getElementById('start-screen');
    const quizScreen = document.getElementById('quiz-screen');
    const resultScreen = document.getElementById('result-screen');
    const bossContainer = document.getElementById('boss-container');
    const employeeIdInput = document.getElementById('employeeIdInput');
    const companySelect = document.getElementById('companySelect');
    const bgm = document.getElementById('bgm');
    const correctSound = document.getElementById('correct-sound');
    const startButton = document.getElementById('start-button');
    const explanationModal = document.getElementById('explanation-modal');
    const nextQuestionButton = document.getElementById('next-question-button');
    const openingVideoContainer = document.getElementById('opening-video-container');
    const gameVideoContainer = document.getElementById('game-video-container');

    let currentLang = 'ja';
    let timerInterval, startTime, correctCount, isGameInProgress = false, audioStarted = false;
    let clickSound, hitSound, damageSound, victorySound, defeatSound;
    let userAnswers = [];

    function switchScreen(screenName) {
      [titleScreen, languageScreen, instructionScreen, startScreen, quizScreen, resultScreen].forEach(s => s.classList.add('hidden'));
      document.getElementById(`${screenName}-screen`).classList.remove('hidden');
    }
    
    function updateUIText() {
      const t = TEXTS[currentLang];
      document.body.lang = currentLang;
      document.getElementById('instruction-title').textContent = t.instructionTitle;
      document.getElementById('instruction-text').innerHTML = t.instructions.map(line => `<p>${line}</p>`).join('');
      document.getElementById('instruction-ok-button').textContent = t.instructionOk;
      document.getElementById('title-text').textContent = t.title;
      employeeIdInput.placeholder = t.employeeIdPlaceholder;
      document.getElementById('employeeIdNoteDisplay').textContent = t.employeeIdNote;
      document.getElementById('start-button-text').textContent = t.startButton;
      document.getElementById('boss-hp-label').textContent = t.bossHp;
      document.getElementById('restart-button').textContent = t.restartButton;
      document.getElementById('theme-display').textContent = t.theme;
      
      companySelect.innerHTML = `<option value="">${t.companySelectDefault}</option>`;
      companyList[currentLang].forEach(company => {
        companySelect.innerHTML += `<option value="${company}">${company}</option>`;
      });
    }

    function setupAudio() {
      if (audioStarted) return;
      clickSound = () => new Tone.MembraneSynth({ pitchDecay: 0.01, octaves: 3, envelope: { attack: 0.001, decay: 0.3, sustain: 0 } }).toDestination().triggerAttackRelease("C2", "8n");
      hitSound = () => {
        correctSound.currentTime = 0;
        correctSound.play().catch(e => console.error("Correct sound play failed:", e));
      };
      damageSound = () => new Tone.NoiseSynth({ noise: { type: "pink" }, envelope: { attack: 0.01, decay: 0.3, sustain: 0, release: 0.2 } }).toDestination().triggerAttackRelease("8n");
      victorySound = () => { const s = new Tone.Synth().toDestination(), n = Tone.now(); s.triggerAttackRelease("C5", "8n", n); s.triggerAttackRelease("E5", "8n", n + 0.2); s.triggerAttackRelease("G5", "8n", n + 0.4); s.triggerAttackRelease("C6", "4n", n + 0.6) };
      defeatSound = () => { const s = new Tone.Synth().toDestination(), n = Tone.now(); s.triggerAttackRelease("C4", "4n", n); s.triggerAttackRelease("B3", "4n", n + 0.3); s.triggerAttackRelease("A#3", "4n", n + 0.6); s.triggerAttackRelease("A3", "2n", n + 0.9) };
      audioStarted = true;
    }

    function normalizeEmployeeIdForHTML(v) {
      const digits = String(v == null ? "" : v).replace(/[^\d]/g, "");
      return digits.padStart(5, "0");
    }

    async function startGame() {
      if (!employeeIdInput.checkValidity()) {
        employeeIdInput.reportValidity();
        return;
      }
      const company = companySelect.value;
      const employeeId = employeeIdInput.value.trim();
      const msgEl = document.getElementById('msg');
      if (!company || !employeeId) {
        msgEl.textContent = TEXTS[currentLang].msgEnterId;
        return;
      }
      if (isGameInProgress) return;
      isGameInProgress = true;
      startButton.disabled = true;
      msgEl.textContent = TEXTS[currentLang].msgCheckingId;

      const normalizedEmployeeId = normalizeEmployeeIdForHTML(employeeId);

      try {
        const checkUrl = `${GAS_URL}?action=checkEmployeeId&employeeId=${encodeURIComponent(normalizedEmployeeId)}&company=${encodeURIComponent(company)}`;
        const response = await fetch(checkUrl);
        const result = await response.json();

        if (result.exists) {
          msgEl.textContent = "";
          bgm.play().catch(e => console.error("BGM play failed:", e));
          clickSound();
          correctCount = 0;
          userAnswers = [];
          document.getElementById('boss-area').classList.remove('hidden');
          bossContainer.className = 'boss-idle';
          updateHpBars(100);
          switchScreen('quiz');
          startTime = Date.now();
          timerInterval = setInterval(() => {
            const elapsedTime = ((Date.now() - startTime) / 1000).toFixed(1);
            document.getElementById('timer-display').textContent = `${elapsedTime}s`;
          }, 100);
          displayQuestion(0);
        } else {
          msgEl.textContent = TEXTS[currentLang].msgIdNotFound;
        }
      } catch (error) {
        console.error("Error checking employee ID:", error);
        msgEl.textContent = TEXTS[currentLang].msgCheckError;
      } finally {
        isGameInProgress = false;
        startButton.disabled = false;
      }
    }

    function displayQuestion(index) {
      const quizData = TEXTS[currentLang].quiz;
      document.getElementById('progress-display').textContent = TEXTS[currentLang].progress(index + 1, quizData.length);
      const current = quizData[index];
      document.getElementById('question-text').textContent = `${current.q}`;
      const optionsContainer = document.getElementById('options-container');
      optionsContainer.innerHTML = '';
      current.o.forEach(opt => {
        const div = document.createElement('div');
        div.textContent = `‚ñ∂ ${opt}`;
        div.classList.add('dq-button');
        div.addEventListener('click', () => handleAnswer(opt, current, index));
        optionsContainer.appendChild(div);
      });
    }

    function handleAnswer(selectedAnswer, currentQuiz, index) {
      const isCorrect = selectedAnswer === currentQuiz.a;
      userAnswers.push({
          questionIndex: index,
          selectedAnswer: selectedAnswer,
          isCorrect: isCorrect
      });
        
      const optionsContainer = document.getElementById('options-container');
      optionsContainer.querySelectorAll('.dq-button').forEach(btn => {
        btn.style.pointerEvents = 'none';
        if (btn.textContent.includes(currentQuiz.a)) {
          btn.classList.add('correct-answer');
        } else {
          btn.classList.add('incorrect-answer');
        }
      });

      if (isCorrect) {
        correctCount++;
        hitSound();
        updateHpBars(100 - (correctCount * (100 / 4)));
        bossContainer.classList.add('shake');
        document.getElementById('explanation-title').textContent = TEXTS[currentLang].correct;
      } else {
        damageSound();
        document.querySelector('.dq-window').classList.add('shake');
        document.getElementById('explanation-title').textContent = TEXTS[currentLang].incorrect;
      }
      
      document.getElementById('explanation-text').textContent = currentQuiz.ex;
      nextQuestionButton.textContent = TEXTS[currentLang].nextButton;
      nextQuestionButton.dataset.nextIndex = index + 1;
      
      setTimeout(() => {
        explanationModal.style.display = 'flex';
      }, 800);
    }
    
    nextQuestionButton.addEventListener('click', () => {
      explanationModal.style.display = 'none';
      bossContainer.classList.remove('shake');
      document.querySelector('.dq-window').classList.remove('shake');
      
      const nextIndex = parseInt(nextQuestionButton.dataset.nextIndex);
      if (nextIndex >= TEXTS[currentLang].quiz.length) {
        showEndScreen();
      } else {
        displayQuestion(nextIndex);
      }
    });

    function showEndScreen() {
      clearInterval(timerInterval);
      bgm.pause();
      bgm.currentTime = 0;
      
      const isVictory = correctCount >= 4;
      if (isVictory) {
        victorySound();
        bossContainer.className = 'boss-defeat';
      } else {
        defeatSound();
      }
      
      setTimeout(() => {
        document.getElementById('boss-area').classList.add('hidden');
        switchScreen('result');
        const t = TEXTS[currentLang];
        document.getElementById('result-title').textContent = isVictory ? t.resultWinTitle : t.resultLoseTitle;
        document.getElementById('result-message').textContent = isVictory ? t.resultWinMsg : t.resultLoseMsg;
        populateReviewSection();
        submitResults();
      }, isVictory ? 1500 : 500);
    }

    function populateReviewSection() {
        const reviewContainer = document.getElementById('review-container');
        const quizData = TEXTS[currentLang].quiz;
        reviewContainer.innerHTML = '';

        const title = document.createElement('h3');
        title.textContent = TEXTS[currentLang].reviewTitle;
        title.className = 'text-2xl font-bold mb-4';
        reviewContainer.appendChild(title);

        const contentWrapper = document.createElement('div');
        contentWrapper.className = 'text-base text-left h-48 overflow-y-auto p-2 border-2 border-white space-y-4 rounded-lg';
        reviewContainer.appendChild(contentWrapper);

        quizData.forEach((q, index) => {
            const userAnswerData = userAnswers.find(ans => ans.questionIndex === index);
            const isCorrect = userAnswerData ? userAnswerData.isCorrect : false;

            const questionBlock = document.createElement('div');
            questionBlock.className = `p-3 border-b border-gray-500 ${!isCorrect ? 'bg-red-500 bg-opacity-20 rounded-md' : ''}`;

            const questionP = document.createElement('p');
            questionP.className = 'font-bold';
            questionP.textContent = `Q${index + 1}: ${q.q}`;
            questionBlock.appendChild(questionP);

            if (!isCorrect && userAnswerData) {
                const userAnswerP = document.createElement('p');
                userAnswerP.innerHTML = `<strong class="text-red-400">${TEXTS[currentLang].reviewUserAnswerLabel}:</strong> ${userAnswerData.selectedAnswer}`;
                questionBlock.appendChild(userAnswerP);
            }

            const answerP = document.createElement('p');
            answerP.innerHTML = `<strong class="text-green-400">${TEXTS[currentLang].reviewAnswerLabel}:</strong> ${q.a}`;
            questionBlock.appendChild(answerP);

            const explanationP = document.createElement('p');
            explanationP.textContent = q.ex;
            explanationP.className = 'text-sm mt-2 text-gray-300';
            questionBlock.appendChild(explanationP);

            contentWrapper.appendChild(questionBlock);
        });
    }

    async function submitResults() {
        const statusEl = document.getElementById('submission-status');
        let ipAddress = 'N/A';
        try {
            const response = await fetch('https://api.ipify.org?format=json');
            ipAddress = (await response.json()).ip;
        } catch (error) {
            console.error('IP„Ç¢„Éâ„É¨„Çπ„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', error);
        }

        const normalizedEmployeeId = normalizeEmployeeIdForHTML(employeeIdInput.value.trim());
        const payload = {
            company: companySelect.value,
            employeeId: normalizedEmployeeId,
            stage: STAGE_NUMBER,
            score: correctCount,
            time: ((Date.now() - startTime) / 1000).toFixed(2),
            ipAddress: ipAddress
        };
        statusEl.textContent = TEXTS[currentLang].submitting;
        
        try {
            const response = await fetch(GAS_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/plain;charset=utf-8',
                },
                body: JSON.stringify(payload)
            });

            const result = await response.json();

            if (result.status === 'success') {
                if (result.recorded === false) {
                    statusEl.textContent = TEXTS[currentLang].recordedFalse;
                } else {
                    statusEl.textContent = TEXTS[currentLang].submitSuccess;
                }
            } else {
                statusEl.textContent = result.message || TEXTS[currentLang].submitError;
            }
        } catch (err) {
            statusEl.textContent = TEXTS[currentLang].submitError;
            console.error('Error:', err);
        }
    }

    function updateHpBars(percentage) {
      const hpBar = document.getElementById('boss-hp-bar');
      hpBar.style.width = `${Math.max(0, percentage)}%`;
      if (percentage <= 25) hpBar.className = 'boss-hp-bar low';
      else if (percentage <= 50) hpBar.className = 'boss-hp-bar mid';
      else hpBar.className = 'boss-hp-bar full';
    }
    
    function handleMediaError(element) {
        console.error(`Error loading media: ${element.src || 'No Source'}`);
        element.style.display = 'none'; 
    }

    document.getElementById('title-start-button').addEventListener('click', async () => {
      if (!audioStarted) { 
        await Tone.start();
        setupAudio();
      }
      clickSound();
      const openingVideo = document.getElementById('opening-video');
      openingVideo.muted = false;
      openingVideo.play().catch(e => console.log("User interaction might be needed for audio"));
      switchScreen('language');
    });

    document.getElementById('lang-ja').addEventListener('click', () => { clickSound(); currentLang = 'ja'; updateUIText(); switchScreen('instruction'); });
    document.getElementById('lang-en').addEventListener('click', () => { clickSound(); currentLang = 'en'; updateUIText(); switchScreen('instruction'); });
    document.getElementById('lang-zh').addEventListener('click', () => { clickSound(); currentLang = 'zh'; updateUIText(); switchScreen('instruction'); });
    
    document.getElementById('instruction-ok-button').addEventListener('click', () => {
      clickSound();
      openingVideoContainer.classList.add('hidden');
      document.getElementById('opening-video').pause();
      gameVideoContainer.classList.remove('hidden');
      document.getElementById('game-bg-video').play().catch(e => console.log("Game video play failed"));
      switchScreen('start');
    });
    
    startButton.addEventListener('click', startGame);
    document.getElementById('restart-button').addEventListener('click', () => location.reload());

    updateUIText();
    switchScreen('title');
    const openingVideo = document.getElementById('opening-video');
    openingVideo.muted = false;
    openingVideo.play().catch(e => {
        console.log("Autoplay with sound was prevented. Muting and retrying.");
        openingVideo.muted = true;
        openingVideo.play();
    });
  </script>
</body>
</html>
