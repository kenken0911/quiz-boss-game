<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sustainable Quest üó°Ô∏è - Final Stage</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=Press+Start+2P&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
  <style>
    body[lang="ja"] { font-family: 'DotGothic16', sans-serif; }
    body[lang="en"] { font-family: 'Press Start 2P', cursive; }
    body { background-color: #000; color: #fff; image-rendering: pixelated; overflow-x: hidden; overflow-y: auto; }
    /* ‚òÖÂ§âÊõ¥ÁÇπ: ÊúÄÁµÇ„Çπ„ÉÜ„Éº„Ç∏„ÅÆ„ÉÜ„Éº„Éû„Ç´„É©„Éº */
    .dq-window { border: 4px solid #fff; background: rgba(50, 0, 50, 0.85); padding: 1.5rem; box-shadow: 0 0 0 4px #000, 0 0 20px rgba(255, 0, 255, 0.6); backdrop-filter: blur(3px); }
    .dq-button { cursor: pointer; padding: .75rem 1.5rem; border: 2px solid #fff; background-image: linear-gradient(to bottom, #aa00aa, #880088); text-shadow: 1px 1px 2px #000; transition: all 0.2s; }
    .dq-button:hover { background-image: linear-gradient(to bottom, #dd44dd, #aa00aa); box-shadow: 0 0 10px #fff; }
    .video-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
    .bg-video { width: 100%; height: 100%; object-fit: cover; }
    #title-screen h1 { font-size: 2.5rem; font-weight: bold; text-shadow: 0 0 5px #fff, 0 0 15px #fff, 0 0 25px #00aaff; animation: fadeInTitle 2s ease-out forwards; }
    #title-start-button { animation: pulseButton 2.5s infinite ease-in-out; }
    @keyframes fadeInTitle { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
    @keyframes pulseButton { 0%, 100% { transform: scale(1); box-shadow: 0 0 10px rgba(255,255,255,0.7); } 50% { transform: scale(1.05); box-shadow: 0 0 20px rgba(255,255,255,1); } }
    .boss-hp-container { border: 2px solid #fff; height: 30px; padding: 3px; background: #333; border-radius: 5px; box-shadow: inset 0 0 5px #000; }
    .boss-hp-bar { height: 100%; transition: width .5s ease-out, background-image .5s ease-out; border-radius: 2px; }
    .boss-hp-bar.full { background-image: linear-gradient(to right, #33ff33, #88ff88); }
    .boss-hp-bar.mid { background-image: linear-gradient(to right, #ffff33, #ffff88); }
    .boss-hp-bar.low { background-image: linear-gradient(to right, #ff3333, #ff8833); }
    .boss-idle { animation: boss-float 2.5s infinite ease-in-out; }
    @keyframes boss-float{ 0%,100% { transform: translateY(0); } 50% { transform: translateY(-12px); } }
    .boss-defeat { animation: boss-defeat-anim 1.5s forwards; }
    @keyframes boss-defeat-anim { 0% { opacity: 1; transform: rotate(0deg); } 50% { opacity: 1; transform: rotate(10deg); } 100% { opacity: 0; transform: translateY(100px) rotate(-20deg) scale(0.5); } }
    .shake { animation: shake .35s; }
    @keyframes shake { 10%,90% { transform: translate(-2px, -2px); } 20%,80% { transform: translate(3px, 2px); } 30%,50%,70% { transform: translate(-3px, 3px); } 40%,60% { transform: translate(3px, -2px); } }
    /* ‚òÖÂ§âÊõ¥ÁÇπ: ÊúÄÁµÇ„Éú„Çπ„ÅÆ„Ç®„Éï„Çß„ÇØ„Éà */
    .final-glow { filter: drop-shadow(0 0 8px #ff0000) drop-shadow(0 0 16px #ff00ff) contrast(1.5); }
    #boss-img { width: 100%; max-width: 320px; height: auto; }
    .correct-answer { background-image: linear-gradient(to bottom, #ffdd00, #ffaa00) !important; color: #000; }
    .incorrect-answer { background-image: linear-gradient(to bottom, #888888, #555555) !important; opacity: 0.7; }
  </style>
</head>
<body class="flex items-start sm:items-center justify-center min-h-screen p-4">

  <div id="opening-video-container" class="video-container">
    <video id="opening-video" class="bg-video" src="./opening_movie.mp4" autoplay loop playsinline></video>
  </div>
  <div id="game-video-container" class="video-container hidden">
    <video id="game-bg-video" class="bg-video" src="./GameBackground.mp4" autoplay muted loop playsinline></video>
  </div>

  <div class="w-full max-w-3xl mx-auto">
    <div id="boss-area" class="mb-4 h-64 flex justify-center items-end relative hidden">
      <div id="boss-container"><img id="boss-img" src="./Stage4_dragon.png" alt="„Éú„Çπ„ÅÆÁîªÂÉè" class="final-glow"/></div>
    </div>
    <div id="game-container" class="w-full dq-window relative">
      <div id="title-screen" class="text-center py-8">
        <h1 class="mb-10">Sustainable Quest</h1>
        <button id="title-start-button" class="dq-button">START</button>
      </div>

      <div id="language-screen" class="text-center hidden">
        <h1 class="text-3xl font-bold mb-6">Select Language</h1>
        <div class="flex justify-center gap-4">
          <button id="lang-ja" class="dq-button">Êó•Êú¨Ë™û</button>
          <button id="lang-en" class="dq-button">English</button>
        </div>
      </div>

      <div id="instruction-screen" class="text-center hidden">
        <h1 id="instruction-title" class="text-3xl font-bold mb-4"></h1>
        <div id="instruction-text" class="text-left mb-6 space-y-2"></div>
        <button id="instruction-ok-button" class="dq-button"></button>
      </div>

      <!-- ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ Â§âÊõ¥ÁÇπ: „Çπ„ÉÜ„Éº„Ç∏2‰ª•ÈôçÁî®„ÅÆ„Çπ„Çø„Éº„ÉàÁîªÈù¢ ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ -->
      <div id="start-screen" class="text-center hidden">
        <h1 id="title-text" class="text-2xl font-bold mb-4"></h1>
        <div class="flex flex-col items-center gap-4 mb-4">
          <!-- „Éã„ÉÉ„ÇØ„Éç„Éº„É†„Å®ÊâÄÂ±û‰ºöÁ§æ„ÇíÂâäÈô§ -->
          <input id="employeeIdInput" type="text" pattern="\d{1,10}" title="Á§æÂì°Áï™Âè∑„ÇíÊï∞Â≠ó„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ" class="text-black px-3 py-2 w-full md:w-80 text-center rounded" />
        </div>
        <button id="start-button" class="dq-button inline-flex items-center gap-2"><span id="start-button-text"></span></button>
        <div id="msg" class="text-yellow-300 text-sm h-5 mt-2"></div>
      </div>

      <div id="quiz-screen" class="hidden">
        <div class="flex justify-between items-center mb-2 text-lg">
          <span id="theme-display"></span>
          <span id="progress-display"></span>
          <span id="timer-display">0.0s</span>
        </div>
        <div class="mb-4"><p id="boss-hp-label"></p><div class="boss-hp-container"><div id="boss-hp-bar"></div></div></div>
        <div class="mb-4 min-h-[80px] p-4 border-2 border-white"><p id="question-text" class="text-xl"></p></div>
        <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      </div>
      <div id="result-screen" class="hidden text-center">
        <h2 id="result-title" class="text-3xl font-bold mb-4"></h2>
        <p id="result-message" class="text-xl mb-6"></p>
        <p id="submission-status" class="text-yellow-300 mb-8"></p>
        <div id="restart-button" class="dq-button inline-block"></div>
      </div>
      <div id="explanation-modal" class="absolute inset-0 bg-black bg-opacity-80 flex-col items-center justify-center p-4 hidden">
        <div class="dq-window w-full max-w-2xl text-center">
          <h2 id="explanation-title" class="text-4xl font-bold mb-4"></h2>
          <p id="explanation-text" class="text-lg mb-6 text-left h-48 overflow-y-auto p-2 border"></p>
          <button id="next-question-button" class="dq-button"></button>
        </div>
      </div>
    </div>
  </div>
  <audio id="bgm" src="./boss_bgm_8bit.wav" loop></audio>
  <script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbzAWGVWFaajScW042FX1fWFqa72eyLAXjkFi7iUigDhbE0XIziWM91dohV0JiwHLwTZwA/exec';
    const STAGE_NUMBER = '4';
    const TEXTS = {
      ja: {
        instructionTitle: "ÂÜíÈô∫„ÅÆÂøÉÂæó",
        instructions: ["„Éª„Çµ„Çπ„ÉÜ„Éä„Éì„É™„ÉÜ„Ç£„Å´Èñ¢„Åô„Çã5„Å§„ÅÆÂïèÈ°å„ÅåÂá∫È°å„Åï„Çå„Çã„Åû„ÄÇ", "„Éª4Âïè‰ª•‰∏äÊ≠£Ëß£„Åß„Éú„Çπ„ÇíË®é‰ºê„Åß„Åç„ÇãÔºÅ", "„ÉªÊúÄÂàù„ÅÆÊåëÊà¶ÁµêÊûú„ÅÆ„Åø„Åå„É©„É≥„Ç≠„É≥„Ç∞„Å´Ë®òÈå≤„Åï„Çå„Çã„Åû„ÄÇ", "„ÉªÂÅ•Èóò„ÇíÁ•à„ÇãÔºÅ"],
        instructionOk: "„Çè„Åã„Å£„Åü",
        title: "ÊúÄÁµÇ„Çπ„ÉÜ„Éº„Ç∏ÔºöÂ§öÊßòÊÄß„ÅÆË¶ñÁÇπ",
        employeeIdPlaceholder: "Á§æÂì°Áï™Âè∑„ÇíÂÖ•Âäõ",
        startButton: "ÊúÄÂæå„ÅÆÊà¶„ÅÑ„Å∏",
        msgEnterId: "Á§æÂì°Áï™Âè∑„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ",
        theme: "„ÉÜ„Éº„ÉûÔºöÂ§öÊßòÊÄß„ÅÆË¶ñÁÇπ",
        progress: (q, t) => `${q}/${t}ÂïèÁõÆ`,
        bossHp: "„Éú„Çπ HP",
        resultWinTitle: "ÂÆåÂÖ®ÂãùÂà©ÔºÅ",
        resultWinMsg: "ÂÖ®„Å¶„ÅÆË©¶Á∑¥„Çí‰πó„ÇäË∂ä„Åà„ÅüÔºÅ‰∏ñÁïå„Å´Âπ≥Âíå„ÅåË®™„Çå„ÅüÔºÅ",
        resultLoseTitle: "„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº",
        resultLoseMsg: "Áúü„ÅÆÁêÜËß£„Å´„ÅØÂ±ä„Åã„Å™„Åã„Å£„Åü‚Ä¶",
        submitting: "ÁµêÊûú„ÇíÈÄÅ‰ø°‰∏≠...",
        submitSuccess: "ÁµêÊûú„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„ÅüÔºÅ",
        submitError: "„Ç®„É©„ÉºÔºöÁµêÊûú„ÇíÈÄÅ‰ø°„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ",
        alreadySubmitted: "Êó¢„Å´ÊåëÊà¶Ê∏à„Åø„Åß„Åô„ÄÇÊúÄÂàù„ÅÆË®òÈå≤„Åå‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ",
        restartButton: "„Çø„Ç§„Éà„É´„Å∏Êàª„Çã",
        correct: "Ê≠£Ëß£ÔºÅ",
        incorrect: "‰∏çÊ≠£Ëß£...",
        nextButton: "Ê¨°„Å∏",
        quiz: [
          { q: "„ÄåÈùí„Äç„Å®„ÄåÁ∑ë„Äç„ÇíÂå∫Âà•„Åó„Å™„ÅÑË®ÄË™û„ÅÆÂ≠òÂú®„ÅåÁ§∫„Åô„ÄÅÂ§öÊßòÊÄß„Å´Èñ¢„Åô„ÇãÈáçË¶Å„Å™Ê∞ó„Å•„Åç„Å®„ÅØÔºü", o: ["ÁèæÂÆü„ÅÆË™çË≠ò„ÅØË®ÄË™û„ÇÑÊñáÂåñ„Å´„Çà„ÇäÂΩ¢‰Ωú„Çâ„Çå„Çã", "‰∫∫Èñì„ÅÆÁõÆ„ÅØÈùí„Å®Á∑ë„ÅÆÂà§Âà•„ÅåËã¶Êâã", "ÊñáÂåñ„ÅØÂ∏∏„Å´‰∏ÄÂÆö„ÅÆÈ†ÜÂ∫è„ÅßÈÄ≤Âåñ„Åô„Çã", "Âè§‰ª£„Å´„ÅØÈùíËâ≤„ÅÆ„ÇÇ„ÅÆ„ÅåÂ∞ë„Å™„Åã„Å£„Åü"], a: "ÁèæÂÆü„ÅÆË™çË≠ò„ÅØË®ÄË™û„ÇÑÊñáÂåñ„Å´„Çà„ÇäÂΩ¢‰Ωú„Çâ„Çå„Çã", ex: "ÁßÅ„Åü„Å°„ÅØÁöÜ„ÄÅÂêå„Åò‰∏ñÁïå„ÇíË¶ã„Å¶„ÅÑ„Çã„Å®ÊÄù„ÅÑ„Åå„Å°„Åß„Åô„Åå„ÄÅÂÆüÈöõ„Å´„ÅØ„ÄåË®ÄË™û„Äç„ÇÑ„ÄåÊñáÂåñ„Äç„Å®„ÅÑ„ÅÜ„Éï„Ç£„É´„Çø„Éº„ÇíÈÄö„Åó„Å¶‰∏ñÁïå„ÇíË™çË≠ò„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇÊó•Êú¨„ÅÆ„ÄåÈùí‰ø°Âè∑„Äç„ÅåËâØ„ÅÑ‰æã„Åß„Åô„ÄÇ" },
          { q: "Â§öÊßò„Å™‰∫∫Êùê„ÅßÊßãÊàê„Åï„Çå„Åü„ÉÅ„Éº„É†„ÅåÈ´ò„ÅÑÊàêÊûú„ÇíÂá∫„Åô„ÄÅÊúÄ„ÇÇÈáçË¶Å„Å™ÁêÜÁî±„Å®„ÅØÔºü", o: ["Áîü„Åæ„Çå„Å§„ÅçÂâµÈÄ†ÊÄß„ÅåÈ´ò„ÅÑ„Åã„Çâ", "„Çà„ÇäÊ∑±„ÅèÊÄùËÄÉ„ÅóÂë®Âà∞„Å™Ê∫ñÂÇô„Çí‰øÉ„Åô„Åã„Çâ", "ÁÑ°Áî®„Å™ÂØæÁ´ã„ÇíÈÅø„Åë„Çã„Åã„Çâ", "„Ç¢„Ç§„Éá„Ç¢„ÅÆÁ∑èÈáè„ÅåÂ§ö„Åè„Å™„Çã„Åã„Çâ"], a: "„Çà„ÇäÊ∑±„ÅèÊÄùËÄÉ„ÅóÂë®Âà∞„Å™Ê∫ñÂÇô„Çí‰øÉ„Åô„Åã„Çâ", ex: "Áï∞„Å™„ÇãË¶ñÁÇπ„ÅÆÂ≠òÂú®„Åå„ÄÅ„É°„É≥„Éê„ÉºÂêÑËá™„Å´„ÄåËá™ÂàÜ„ÅÆÊÑèË¶ã„ÅØÂ§öËßíÁöÑ„Å´Ê§úË®º„Åï„Çå„Çã„Å†„Çç„ÅÜ„Äç„Å®‰∫àÊ∏¨„Åï„Åõ„ÄÅÁµêÊûú„Å®„Åó„Å¶„ÄÅ„Çà„ÇäÊ∑±„ÅèÊÉÖÂ†±„ÇíÂá¶ÁêÜ„Åó„ÄÅÂë®Âà∞„Å™Ê∫ñÂÇô„Å®ÊÄùËÄÉ„Çí‰øÉ„Åô„Åü„ÇÅ„Åß„Åô„ÄÇ" },
          { q: "Ëã±Ë™û„ÅÆ„Åì„Å®„Çè„Åñ„ÄåVariety is the spice of life.„Äç„ÅÆÊó•Êú¨Ë™ûË®≥„Å®„Åó„Å¶ÊúÄ„ÇÇÈÅ©Âàá„Å™„ÇÇ„ÅÆ„ÅØÔºü", o: ["Â§öÊßòÊÄß„ÅØ‰∫∫Áîü„ÅÆËñ¨Âë≥„Åß„ÅÇ„Çã", "Â§öÊßòÊÄß„ÅØ‰∫∫Áîü„ÅÆËøëÈÅì„Åß„ÅÇ„Çã", "Â§öÊßòÊÄß„ÅØ‰∫∫Áîü„ÅÆÁæÖÈáùÁõ§„Åß„ÅÇ„Çã", "Â§öÊßòÊÄß„ÅØ‰∫∫Áîü„ÅÆÁµÇÁùÄÈßÖ„Åß„ÅÇ„Çã"], a: "Â§öÊßòÊÄß„ÅØ‰∫∫Áîü„ÅÆËñ¨Âë≥„Åß„ÅÇ„Çã", ex: "„Åì„ÅÆ„Åì„Å®„Çè„Åñ„ÅØ„ÄÅÂ§âÂåñ„Å´ÂØå„Çì„Å†Êßò„ÄÖ„Å™ÁµåÈ®ì„Åå‰∫∫Áîü„ÇíË±ä„Åã„Å´„Åô„Çã„Å®„ÅÑ„ÅÜÊÑèÂë≥„Åß„Åô„ÄÇËñ¨Âë≥„ÅåÊñôÁêÜ„ÅÆÂë≥„ÇíÂºï„ÅçÁ´ã„Å¶„Çã„Çà„ÅÜ„Å´„ÄÅÂ§öÊßò„Å™ÁµåÈ®ì„Åå‰∫∫Áîü„Çí„Çà„ÇäÈù¢ÁôΩ„Åè„ÄÅÂë≥„Çè„ÅÑÊ∑±„ÅÑ„ÇÇ„ÅÆ„Å´„Åó„Å¶„Åè„Çå„Åæ„Åô„ÄÇ" },
          { q: "Êó•Êú¨„Åß„ÅØÁ∑ëËâ≤„ÅÆ‰ø°Âè∑„Çí„ÄåÈùí‰ø°Âè∑„Äç„Å®Âëº„Å∂„Åì„Å®„Åå„ÅÇ„Çã„ÄÇ„Åì„Çå„ÅØ„Å™„ÅúÔºü", o: ["Êòî„ÅÆ‰ø°Âè∑Ê©ü„ÅåÈùíËâ≤„Å†„Å£„Åü„Åã„Çâ", "ÈùíËâ≤„ÅÆÊñπ„ÅåÁõÆ„Å´ÂÑ™„Åó„ÅÑ„Åã„Çâ", "Âè§„ÅÑÊó•Êú¨Ë™û„Åß„ÅØÁ∑ë„ÇÇ„Äå„ÅÇ„Åä„Äç„Å®Âëº„Çì„Å†ÂêçÊÆã", "Ê≥ïÂæã„ÅßÈùí„Å®ÂÆö„ÇÅ„Çâ„Çå„Å¶„ÅÑ„Çã„Åã„Çâ"], a: "Âè§„ÅÑÊó•Êú¨Ë™û„Åß„ÅØÁ∑ë„ÇÇ„Äå„ÅÇ„Åä„Äç„Å®Âëº„Çì„Å†ÂêçÊÆã", ex: "Âè§„ÅÑÊó•Êú¨Ë™û„ÅÆ„Äå„ÅÇ„Åä„Äç„ÅØ„ÄÅÁèæÂú®„ÅÆÁ∑ëËâ≤„ÇÇÂê´„ÇÄÂ∫É„ÅÑÁØÑÂõ≤„ÅÆËâ≤„ÇíÊåá„ÅôË®ÄËëâ„Åß„Åó„Åü„ÄÇ„Åù„ÅÆÂêçÊÆã„Åß„ÄÅÁèæ‰ª£„Åß„ÇÇÁ∑ëËâ≤„ÅÆ„ÇÇ„ÅÆ„Çí„ÄåÈùí„Äç„Å®Âëº„Å∂„Åì„Å®„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ" },
          { q: "Ëá™ÂàÜ„Å®‰ºº„Åü„É°„É≥„Éê„Éº„Å†„Åë„ÅÆ„ÉÅ„Éº„É†„ÅåÈô•„Çä„Åå„Å°„Å™„ÄÅÊÄùËÄÉ„ÅÆÁΩ†„Å®„ÅØÔºü", o: ["Ê±∫ÂÆö„ÅåÈÅÖ„Åè„Å™„Çã", "ÊÑèË¶ã„Åå„Åæ„Å®„Åæ„Çâ„Å™„ÅÑ", "Âõ∫ÂÆöË¶≥Âøµ„Å´Á∏õ„Çâ„Çå„Çã", "Êñ∞„Åó„ÅÑÊåëÊà¶„ÅåÂ¢ó„Åà„Çã"], a: "Âõ∫ÂÆöË¶≥Âøµ„Å´Á∏õ„Çâ„Çå„Çã", ex: "‰ºº„Åü„É°„É≥„Éê„Éº„Å†„Åë„ÅÆ„ÉÅ„Éº„É†„Åß„ÅØ„ÄÅ„Äå„Åç„Å£„Å®ÁöÜ„ÇÇÂêå„Åò„Çà„ÅÜ„Å´ËÄÉ„Åà„Å¶„ÅÑ„Çã„Å†„Çç„ÅÜ„Äç„Å®„ÅÑ„ÅÜÊöóÈªô„ÅÆÂâçÊèê„Åã„Çâ„ÄÅÊÄùËÄÉ„ÅÆ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà„ÅåÁîü„Åæ„Çå„Åå„Å°„Åß„Åô„ÄÇ„Åì„Çå„Å´„Çà„Çä„ÄÅ„ÉÅ„Éº„É†ÂÖ®‰Ωì„ÅåÂõ∫ÂÆöË¶≥Âøµ„Å´Á∏õ„Çâ„Çå„ÄÅ„É™„Çπ„ÇØ„ÇíË¶ãÈÅé„Åî„ÅôÂéüÂõ†„Å®„Å™„Çä„Åæ„Åô„ÄÇ" }
        ]
      },
      en: {
        instructionTitle: "Rules of the Quest",
        instructions: ["- You will be asked 5 questions about sustainability.", "- Answer 4 or more correctly to defeat the boss!", "- Only your first attempt will be recorded for the ranking.", "- Good luck!"],
        instructionOk: "Got it",
        title: "Final Stage: Perspectives on Diversity",
        employeeIdPlaceholder: "Enter Employee ID",
        startButton: "To the Final Battle",
        msgEnterId: "Please enter your Employee ID",
        theme: "Theme: Perspectives on Diversity",
        progress: (q, t) => `Q ${q}/${t}`,
        bossHp: "Boss HP",
        resultWinTitle: "Complete Victory!",
        resultWinMsg: "You have overcome all trials! Peace has been restored to the world!",
        resultLoseTitle: "Game Over",
        resultLoseMsg: "True understanding was just out of reach...",
        submitting: "Submitting results...",
        submitSuccess: "Results submitted!",
        submitError: "Error: Could not submit results.",
        alreadySubmitted: "You have already challenged. Your first score is saved.",
        restartButton: "Back to Title",
        correct: "Correct!",
        incorrect: "Incorrect...",
        nextButton: "Next",
        quiz: [
          { q: "What important insight about diversity does the existence of languages that don't distinguish between 'blue' and 'green' give us?", o: ["Perception of reality is shaped by language and culture", "Human eyes are bad at distinguishing blue and green", "Cultures always evolve in a fixed order", "There were few blue things in ancient times"], a: "Perception of reality is shaped by language and culture", ex: "We tend to think we all see the same world, but we actually perceive it through the filters of 'language' and 'culture.' The Japanese 'blue traffic light' is a good example." },
          { q: "What is the most important reason that diverse teams outperform homogeneous ones?", o: ["They are naturally more creative", "It encourages deeper information processing and preparation", "They avoid unnecessary conflict", "The total number of ideas is statistically higher"], a: "It encourages deeper information processing and preparation", ex: "The presence of different viewpoints makes each member anticipate that their opinions will be scrutinized from multiple angles, which in turn encourages deeper information processing and more thorough preparation and thought." },
          { q: "What is the most appropriate translation of the English proverb 'Variety is the spice of life.'?", o: ["Diversity is the spice of life", "Diversity is a shortcut in life", "Diversity is a compass in life", "Diversity is the final stop in life"], a: "Diversity is the spice of life", ex: "This proverb means that a variety of rich experiences makes life more interesting. Just as spices enhance the flavor of food, diverse experiences make life more fun and flavorful." },
          { q: "In Japan, a green traffic light is sometimes called 'ao shingo' (blue light). Why?", o: ["Old traffic lights were blue", "Blue is easier on the eyes", "A remnant of old Japanese where 'ao' included green", "It is legally defined as blue"], a: "A remnant of old Japanese where 'ao' included green", ex: "The old Japanese word 'ao' referred to a wide range of colors, including what we now call green. As a remnant of that, green things are still sometimes referred to as 'ao' today." },
          { q: "What is the cognitive trap that teams of similar members are prone to falling into?", o: ["Slower decision making", "Inability to reach consensus", "Being bound by stereotypes", "An increase in new challenges"], a: "Being bound by stereotypes", ex: "In a team of similar members, cognitive shortcuts are often taken based on the tacit assumption that 'everyone else is probably thinking the same thing.' This can cause the entire team to be bound by stereotypes and overlook risks." }
        ]
      }
    };
    
    // --- DOMË¶ÅÁ¥†„ÅÆÂÆöÁæ© ---
    const titleScreen = document.getElementById('title-screen');
    const languageScreen = document.getElementById('language-screen');
    const instructionScreen = document.getElementById('instruction-screen');
    const startScreen = document.getElementById('start-screen');
    const quizScreen = document.getElementById('quiz-screen');
    const resultScreen = document.getElementById('result-screen');
    const bossContainer = document.getElementById('boss-container');
    const employeeIdInput = document.getElementById('employeeIdInput');
    const bgm = document.getElementById('bgm');
    const startButton = document.getElementById('start-button');
    const explanationModal = document.getElementById('explanation-modal');
    const nextQuestionButton = document.getElementById('next-question-button');
    const openingVideoContainer = document.getElementById('opening-video-container');
    const gameVideoContainer = document.getElementById('game-video-container');

    // --- „Ç≤„Éº„É†Áä∂ÊÖãÂ§âÊï∞ ---
    let currentLang = 'ja';
    let timerInterval, startTime, correctCount, isGameInProgress = false, audioStarted = false;
    let clickSound, hitSound, damageSound, victorySound, defeatSound;

    // --- ÁîªÈù¢Âàá„ÇäÊõø„Åà ---
    function switchScreen(screenName) {
      [titleScreen, languageScreen, instructionScreen, startScreen, quizScreen, resultScreen].forEach(s => s.classList.add('hidden'));
      document.getElementById(`${screenName}-screen`).classList.remove('hidden');
    }
    
    // --- UI„ÉÜ„Ç≠„Çπ„ÉàÊõ¥Êñ∞ ---
    function updateUIText() {
      const t = TEXTS[currentLang];
      document.body.lang = currentLang;
      document.getElementById('instruction-title').textContent = t.instructionTitle;
      document.getElementById('instruction-text').innerHTML = t.instructions.map(line => `<p>${line}</p>`).join('');
      document.getElementById('instruction-ok-button').textContent = t.instructionOk;
      document.getElementById('title-text').textContent = t.title;
      employeeIdInput.placeholder = t.employeeIdPlaceholder;
      document.getElementById('start-button-text').textContent = t.startButton;
      document.getElementById('boss-hp-label').textContent = t.bossHp;
      document.getElementById('restart-button').textContent = t.restartButton;
      document.getElementById('theme-display').textContent = t.theme;
    }

    // --- „Ç™„Éº„Éá„Ç£„Ç™Ë®≠ÂÆö ---
    function setupAudio() {
      if (audioStarted) return;
      clickSound = () => new Tone.MembraneSynth({ pitchDecay: 0.01, octaves: 3, envelope: { attack: 0.001, decay: 0.3, sustain: 0 } }).toDestination().triggerAttackRelease("C2", "8n");
      hitSound = () => new Tone.Synth({ oscillator: { type: "fmsquare" }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.0, release: 0.1 } }).toDestination().triggerAttackRelease("C5", "16n");
      damageSound = () => new Tone.NoiseSynth({ noise: { type: "pink" }, envelope: { attack: 0.01, decay: 0.3, sustain: 0, release: 0.2 } }).toDestination().triggerAttackRelease("8n");
      victorySound = () => { const s = new Tone.Synth().toDestination(), n = Tone.now(); s.triggerAttackRelease("C5", "8n", n); s.triggerAttackRelease("E5", "8n", n + 0.2); s.triggerAttackRelease("G5", "8n", n + 0.4); s.triggerAttackRelease("C6", "4n", n + 0.6) };
      defeatSound = () => { const s = new Tone.Synth().toDestination(), n = Tone.now(); s.triggerAttackRelease("C4", "4n", n); s.triggerAttackRelease("B3", "4n", n + 0.3); s.triggerAttackRelease("A#3", "4n", n + 0.6); s.triggerAttackRelease("A3", "2n", n + 0.9) };
      audioStarted = true;
    }

    // --- „Ç≤„Éº„É†„É≠„Ç∏„ÉÉ„ÇØ ---
    async function startGame() {
      const employeeId = employeeIdInput.value.trim();
      if (!employeeId) {
        document.getElementById('msg').textContent = TEXTS[currentLang].msgEnterId;
        return;
      }
      if (isGameInProgress) return;
      isGameInProgress = true;
      startButton.disabled = true;
      
      bgm.play().catch(e => console.error("BGM play failed:", e));
      clickSound();
      correctCount = 0;
      
      document.getElementById('boss-area').classList.remove('hidden');
      bossContainer.className = 'boss-idle';
      updateHpBars(100);
      switchScreen('quiz');
      
      startTime = Date.now();
      timerInterval = setInterval(() => {
        const elapsedTime = ((Date.now() - startTime) / 1000).toFixed(1);
        document.getElementById('timer-display').textContent = `${elapsedTime}s`;
      }, 100);
      
      displayQuestion(0);
      startButton.disabled = false;
    }

    function displayQuestion(index) {
      const quizData = TEXTS[currentLang].quiz;
      document.getElementById('progress-display').textContent = TEXTS[currentLang].progress(index + 1, quizData.length);
      const current = quizData[index];
      document.getElementById('question-text').textContent = `Q${index + 1}: ${current.q}`;
      const optionsContainer = document.getElementById('options-container');
      optionsContainer.innerHTML = '';
      current.o.forEach(opt => {
        const div = document.createElement('div');
        div.textContent = `‚ñ∂ ${opt}`;
        div.classList.add('dq-button');
        div.addEventListener('click', () => handleAnswer(opt, current, index));
        optionsContainer.appendChild(div);
      });
    }

    function handleAnswer(selectedAnswer, currentQuiz, index) {
      const isCorrect = selectedAnswer === currentQuiz.a;
      const optionsContainer = document.getElementById('options-container');
      optionsContainer.querySelectorAll('.dq-button').forEach(btn => {
        btn.style.pointerEvents = 'none';
        if (btn.textContent.includes(currentQuiz.a)) {
          btn.classList.add('correct-answer');
        } else {
          btn.classList.add('incorrect-answer');
        }
      });

      if (isCorrect) {
        correctCount++;
        hitSound();
        updateHpBars(100 - (correctCount * (100 / 4)));
        bossContainer.classList.add('shake');
        document.getElementById('explanation-title').textContent = TEXTS[currentLang].correct;
      } else {
        damageSound();
        document.querySelector('.dq-window').classList.add('shake');
        document.getElementById('explanation-title').textContent = TEXTS[currentLang].incorrect;
      }
      
      document.getElementById('explanation-text').textContent = currentQuiz.ex;
      nextQuestionButton.textContent = TEXTS[currentLang].nextButton;
      nextQuestionButton.dataset.nextIndex = index + 1;
      
      setTimeout(() => {
        explanationModal.style.display = 'flex';
      }, 800);
    }
    
    nextQuestionButton.addEventListener('click', () => {
      explanationModal.style.display = 'none';
      bossContainer.classList.remove('shake');
      document.querySelector('.dq-window').classList.remove('shake');
      
      const nextIndex = parseInt(nextQuestionButton.dataset.nextIndex);
      if (nextIndex >= TEXTS[currentLang].quiz.length || correctCount >= 4) {
        showEndScreen();
      } else {
        displayQuestion(nextIndex);
      }
    });

    function showEndScreen() {
      clearInterval(timerInterval);
      bgm.pause();
      bgm.currentTime = 0;
      
      const isVictory = correctCount >= 4;
      if (isVictory) {
        victorySound();
        bossContainer.className = 'boss-defeat';
      } else {
        defeatSound();
      }
      
      setTimeout(() => {
        document.getElementById('boss-area').classList.add('hidden');
        switchScreen('result');
        const t = TEXTS[currentLang];
        document.getElementById('result-title').textContent = isVictory ? t.resultWinTitle : t.resultLoseTitle;
        document.getElementById('result-message').textContent = isVictory ? t.resultWinMsg : t.resultLoseMsg;
        submitResults();
      }, isVictory ? 1500 : 500);
    }

    async function submitResults() {
        const statusEl = document.getElementById('submission-status');
        let ipAddress = 'N/A';
        try {
            const response = await fetch('https://api.ipify.org?format=json');
            ipAddress = (await response.json()).ip;
        } catch (error) {
            console.error('IP„Ç¢„Éâ„É¨„Çπ„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', error);
        }

        const payload = {
            employeeId: employeeIdInput.value.trim(),
            stage: STAGE_NUMBER,
            score: correctCount,
            time: ((Date.now() - startTime) / 1000).toFixed(2),
            ipAddress: ipAddress
        };
        statusEl.textContent = TEXTS[currentLang].submitting;
        fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload), mode: 'no-cors' })
            .then(() => { statusEl.textContent = TEXTS[currentLang].submitSuccess; })
            .catch(err => { statusEl.textContent = TEXTS[currentLang].submitError; console.error('Error:', err); });
    }

    function updateHpBars(percentage) {
      const hpBar = document.getElementById('boss-hp-bar');
      hpBar.style.width = `${Math.max(0, percentage)}%`;
      if (percentage <= 25) hpBar.className = 'boss-hp-bar low';
      else if (percentage <= 50) hpBar.className = 'boss-hp-bar mid';
      else hpBar.className = 'boss-hp-bar full';
    }

    // --- „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö ---
    document.getElementById('title-start-button').addEventListener('click', async () => {
      if (!audioStarted) { 
        await Tone.start();
        setupAudio();
      }
      clickSound();
      const openingVideo = document.getElementById('opening-video');
      openingVideo.muted = false;
      openingVideo.play().catch(e => console.log("User interaction might be needed for audio"));
      switchScreen('language');
    });

    document.getElementById('lang-ja').addEventListener('click', () => { clickSound(); currentLang = 'ja'; updateUIText(); switchScreen('instruction'); });
    document.getElementById('lang-en').addEventListener('click', () => { clickSound(); currentLang = 'en'; updateUIText(); switchScreen('instruction'); });
    
    document.getElementById('instruction-ok-button').addEventListener('click', () => {
      clickSound();
      openingVideoContainer.classList.add('hidden');
      document.getElementById('opening-video').pause();
      gameVideoContainer.classList.remove('hidden');
      document.getElementById('game-bg-video').play().catch(e => console.log("Game video play failed"));
      switchScreen('start');
    });
    
    startButton.addEventListener('click', startGame);
    document.getElementById('restart-button').addEventListener('click', () => location.reload());

    // --- ÂàùÊúüÂåñÂá¶ÁêÜ ---
    updateUIText();
    switchScreen('title');
    const openingVideo = document.getElementById('opening-video');
    openingVideo.muted = false;
    openingVideo.play().catch(e => {
        console.log("Autoplay with sound was prevented. Muting and retrying.");
        openingVideo.muted = true;
        openingVideo.play();
    });
  </script>
</body>
</html>
