<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sustainability Quest 🗡️</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=Press+Start+2P&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
  <style>
    body[lang="ja"], body[lang="zh"] { font-family: 'DotGothic16', sans-serif; }
    body[lang="en"] { font-family: 'Press Start 2P', cursive; }
    body { background-color: #000; color: #fff; image-rendering: pixelated; overflow-x: hidden; overflow-y: auto; }
    .dq-window { border: 4px solid #fff; background: rgba(80, 0, 80, 0.85); padding: 1.5rem; box-shadow: 0 0 0 4px #000, 0 0 20px rgba(255, 0, 255, 0.5); backdrop-filter: blur(3px); }
    .dq-button { cursor: pointer; padding: .75rem 1.5rem; border: 2px solid #fff; background-image: linear-gradient(to bottom, #aa00aa, #880088); text-shadow: 1px 1px 2px #000; transition: all 0.2s; }
    .dq-button:hover { background-image: linear-gradient(to bottom, #dd33dd, #aa00aa); box-shadow: 0 0 10px #fff; }
    .video-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
    .bg-video { width: 100%; height: 100%; object-fit: cover; }
    #title-screen h1 { font-size: 2.5rem; font-weight: bold; text-shadow: 0 0 5px #fff, 0 0 15px #fff, 0 0 25px #ff00ff; animation: fadeInTitle 2s ease-out forwards; }
    #title-start-button { animation: pulseButton 2.5s infinite ease-in-out; }
    @keyframes fadeInTitle { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
    @keyframes pulseButton { 0%, 100% { transform: scale(1); box-shadow: 0 0 10px rgba(255,255,255,0.7); } 50% { transform: scale(1.05); box-shadow: 0 0 20px rgba(255,255,255,1); } }
    .boss-hp-container { border: 2px solid #fff; height: 30px; padding: 3px; background: #333; border-radius: 5px; box-shadow: inset 0 0 5px #000; }
    .boss-hp-bar { height: 100%; transition: width .5s ease-out, background-image .5s ease-out; border-radius: 2px; }
    .boss-hp-bar.full { background-image: linear-gradient(to right, #33ff33, #88ff88); }
    .boss-hp-bar.mid { background-image: linear-gradient(to right, #ffff33, #ffff88); }
    .boss-hp-bar.low { background-image: linear-gradient(to right, #ff3333, #ff8833); }
    .boss-idle { animation: boss-float 2.5s infinite ease-in-out; }
    @keyframes boss-float{ 0%,100% { transform: translateY(0); } 50% { transform: translateY(-12px); } }
    .boss-defeat { animation: boss-defeat-anim 1.5s forwards; }
    @keyframes boss-defeat-anim { 0% { opacity: 1; transform: rotate(0deg); } 50% { opacity: 1; transform: rotate(10deg); } 100% { opacity: 0; transform: translateY(100px) rotate(-20deg) scale(0.5); } }
    .shake { animation: shake .35s; }
    @keyframes shake { 10%,90% { transform: translate(-2px, -2px); } 20%,80% { transform: translate(3px, 2px); } 30%,50%,70% { transform: translate(-3px, 3px); } 40%,60% { transform: translate(3px, -2px); } }
    .magic-glow { filter: drop-shadow(0 0 8px #ff00ff) drop-shadow(0 0 16px #aa00ff) contrast(1.2); }
    #boss-img { width: 100%; max-width: 320px; height: auto; }
    .correct-answer { background-image: linear-gradient(to bottom, #ffdd00, #ffaa00) !important; color: #000; }
    .incorrect-answer { background-image: linear-gradient(to bottom, #888888, #555555) !important; opacity: 0.7; }
  </style>
</head>
<body class="flex items-start sm:items-center justify-center min-h-screen p-4">

  <div id="opening-video-container" class="video-container">
    <video id="opening-video" class="bg-video" src="./opening_movie.mp4" autoplay loop playsinline onerror="handleMediaError(this)"></video>
  </div>
  <div id="game-video-container" class="video-container hidden">
    <video id="game-bg-video" class="bg-video" src="./GameBackground4.mp4" autoplay muted loop playsinline onerror="handleMediaError(this)"></video>
  </div>

  <div class="w-full max-w-3xl mx-auto">
    <div id="boss-area" class="mb-4 h-64 flex justify-center items-end relative hidden">
      <div id="boss-container"><img id="boss-img" src="./Stage4_dragon.png" alt="ボスの画像" class="magic-glow" onerror="handleMediaError(this)"/></div>
    </div>
    <div id="game-container" class="w-full dq-window relative">
      <div id="title-screen" class="text-center py-8">
        <h1 class="mb-10">Sustainability Quest</h1>
        <button id="title-start-button" class="dq-button">START</button>
      </div>

      <div id="language-screen" class="text-center hidden">
        <h1 class="text-3xl font-bold mb-6">Select Language</h1>
        <p class="text-sm mb-6">Translations are provided by AI. / 翻译由人工智能提供。</p>
        <div class="flex justify-center gap-2 flex-wrap">
          <button id="lang-ja" class="dq-button">日本語</button>
          <button id="lang-en" class="dq-button">English</button>
          <button id="lang-zh" class="dq-button">中文</button>
        </div>
      </div>

      <div id="instruction-screen" class="text-center hidden">
        <h1 id="instruction-title" class="text-3xl font-bold mb-4"></h1>
        <div id="instruction-text" class="text-left mb-6 space-y-2"></div>
        <button id="instruction-ok-button" class="dq-button"></button>
      </div>
      
      <div id="start-screen" class="text-center hidden">
        <h1 id="title-text" class="text-2xl font-bold mb-4"></h1>
        <div class="flex flex-col items-center gap-4 mb-4">
          <select id="companySelect" class="text-black px-3 py-2 w-full md:w-80 text-center rounded"></select>
          <input id="employeeIdInput" type="text" pattern="\d{5}" title="社員番号は半角数字5桁で入力してください" class="text-black px-3 py-2 w-full md:w-80 text-center rounded" />
          <p id="employeeIdNoteDisplay" class="text-xs text-gray-300 -mt-2"></p>
        </div>
        <button id="start-button" class="dq-button inline-flex items-center gap-2"><span id="start-button-text"></span></button>
        <div id="msg" class="text-yellow-300 text-sm h-5 mt-2"></div>
      </div>

      <div id="quiz-screen" class="hidden">
        <div class="flex justify-between items-center mb-2 text-lg">
          <span id="theme-display"></span>
          <span id="progress-display"></span>
          <span id="timer-display" class="hidden">0.0s</span>
        </div>
        <div class="mb-4"><p id="boss-hp-label"></p><div class="boss-hp-container"><div id="boss-hp-bar"></div></div></div>
        <div class="mb-4 min-h-[80px] p-4 border-2 border-white"><p id="question-text" class="text-xl"></p></div>
        <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      </div>
      <div id="result-screen" class="hidden text-center">
        <h2 id="result-title" class="text-3xl font-bold mb-4"></h2>
        <p id="result-message" class="text-xl mb-2"></p>
        <p id="submission-status" class="text-yellow-300 mb-4"></p>
        <div id="review-container" class="mt-4"></div>
        <button id="restart-button" class="dq-button inline-block mt-6"></button>
      </div>
      <div id="explanation-modal" class="absolute inset-0 bg-black bg-opacity-80 flex-col items-center justify-center p-4 hidden">
        <div class="dq-window w-full max-w-2xl text-center">
          <h2 id="explanation-title" class="text-4xl font-bold mb-4"></h2>
          <p id="explanation-text" class="text-lg mb-6 text-left h-48 overflow-y-auto p-2 border"></p>
          <button id="next-question-button" class="dq-button"></button>
        </div>
      </div>
    </div>
  </div>
  <audio id="bgm" src="./BS4_BGM.wav" loop onerror="handleMediaError(this)"></audio>
  <audio id="correct-sound" src="./correct_answer.mp3" onerror="handleMediaError(this)"></audio>
  <script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbyJ-jSH9YdU0ltF9O2Y_LJJmqd24l5PNve_ZtTze0qj6Iv4OIT8Iz77YAoh705-fAuJgg/exec';
    const STAGE_NUMBER = '4';
    const TEXTS = {
      ja: {
        instructionTitle: "冒険の心得",
        instructions: ["・サステナビリティに関する5つの問題が出題されるぞ。", "・4問以上正解でボスを討伐できる！", "・各ステージの最初の挑戦結果のみが記録されるぞ。", "・クイズの途中で画面を閉じると、その時点までのスコアがあなたの記録となるぞ。", "・健闘を祈る！"],
        instructionOk: "わかった",
        title: "こども・貧困",
        employeeIdPlaceholder: "社員番号(半角5桁)を入力",
        employeeIdNote: "社員番号4桁以下の方は、先頭に「0」を入力（例：111→00111)",
        companySelectDefault: "所属会社を選択してください",
        startButton: "挑戦する",
        msgEnterId: "所属会社と社員番号を入力してください",
        msgCheckingId: "挑戦資格を確認中...",
        msgIdNotFound: "ステージ1の記録が見つかりません。会社名と社員番号を確認してください。",
        msgCheckError: "確認エラー。時間をおいて再試行してください。",
        theme: "テーマ：こども・貧困",
        progress: (q, t) => `${q}/${t}問目`,
        bossHp: "ボス HP",
        resultWinTitle: "勝利！",
        resultWinMsg: "ステージクリア！未来への希望をつないだ！",
        resultLoseTitle: "ゲームオーバー",
        resultLoseMsg: "魔竜王の魔力は計り知れない…",
        submitting: "結果を送信中...",
        submitSuccess: "結果を送信しました！",
        submitError: "エラー：結果を送信できませんでした。",
        recordedFalse: "プレイありがとう！記録は初回のもののみとなります。",
        restartButton: "タイトルへ戻る",
        correct: "正解！",
        incorrect: "不正解...",
        nextButton: "次へ",
        reviewTitle: "クイズの振り返り",
        reviewAnswerLabel: "正解",
        reviewUserAnswerLabel: "あなたの回答",
        quiz: [
          { q: "世界では、毎日どれくらいのこどもが、家庭の貧困を理由に命を落としているでしょうか？", o: ["約150,000人", "約10,000人", "約1,000人", "約100人"], a: "約10,000人", ex: "世界では毎日、貧困が原因で約10,000人もの5歳未満のこどもが命を落としているといわれています。" },
          { q: "世界中のこどもたちの権利と健やかな成長を守る国連機関は？", o: ["WHO", "UNICEF", "UNESCO", "UNDP"], a: "UNICEF", ex: "世界中のこどもたちの権利と健やかな成長を守るために活躍している国連機関はUNICEF（国際連合児童基金）です。" },
          { q: "貧困の再生産（連鎖）を断ち切るために、最も重要だと考えられている対策は次のうちどれでしょうか？", o: ["貧しい家庭の医療費を全額免除すること", "失業者に食料を配布すること", "貧困層が住む地域の建物を新しく建て替えること", "こどもたちに公平で質の高い機会の保障をすること"], a: "こどもたちに公平で質の高い機会の保障をすること", ex: "貧困の再生産は、親の貧困が子どもの機会を奪うことで起こります。教育は、この「機会の不平等」を是正し、子どもたちに自力で未来を切り開くための機会を与える、最も効果的な手段です。" },
          { q: "フェアトレード製品を買うことが貧困問題の解決に繋がる主な理由は次のうちどれでしょうか？", o: ["製品が無料で配布されるから。", "消費者が節約したお金を寄付できるから。", "売上金がすべて貧困地域に寄付されるから。", "生産者に公正な賃金が支払われるから。"], a: "生産者に公正な賃金が支払われるから。", ex: "フェアトレードの最も重要な原則の一つは、生産者に公正な価格を保証し、安定した収入を提供することです。これにより、彼らは生活を改善し、教育や医療に投資できるようになります。" },
          { q: "家庭の経済的な理由で十分な食事がとれない子どもを支援する活動として「こども食堂」が広がっていますが、中心的な役割として最も適切なものは次のうちどれでしょうか？", o: ["子どもたちに料理の技術を教え、自立を促すこと。", "子どもたちが孤立せず、安心して過ごせる居場所を提供すること。", "貧しい家庭の子どもだけを対象に、食事を配給すること。", "子どもたちに、安価または無料で豪華な食事を提供すること。"], a: "子どもたちが孤立せず、安心して過ごせる居場所を提供すること。", ex: "こども食堂は、食事を通じて、子どもたちが孤立することなく、地域社会とつながる「居場所」を提供することを最も重要な役割としています。NKCでは、2018年から、未来あるこどもたちのために「なかにわこども食堂」を立ち上げ、新たな価値を提供する体験機会づくりに取り組んでいます。" }
        ]
      },
      en: {
        instructionTitle: "Rules of the Quest",
        instructions: ["- You will be asked 5 questions about sustainability.", "- Answer 4 or more correctly to defeat the boss!", "- Only your first attempt on each stage will be recorded.", "- If you close the screen mid-quiz, your score up to that point will be recorded.", "- Good luck!"],
        instructionOk: "Got it",
        title: "Children & Poverty",
        employeeIdPlaceholder: "Enter 5-digit Employee ID",
        employeeIdNote: "For IDs with 4 or fewer digits, add leading '0's (e.g., 111 -> 00111).",
        companySelectDefault: "Select your company",
        startButton: "Challenge",
        msgEnterId: "Please enter your Company and Employee ID",
        msgCheckingId: "Checking eligibility...",
        msgIdNotFound: "Stage 1 record not found. Please check your Company and Employee ID.",
        msgCheckError: "Verification error. Please try again later.",
        theme: "Theme: Children & Poverty",
        progress: (q, t) => `Q ${q}/${t}`,
        bossHp: "Boss HP",
        resultWinTitle: "Victory!",
        resultWinMsg: "Stage Clear! You have connected hope for the future!",
        resultLoseTitle: "Game Over",
        resultLoseMsg: "The Magic Dragon King's power is immeasurable...",
        submitting: "Submitting results...",
        submitSuccess: "Results submitted!",
        submitError: "Error: Could not submit results.",
        recordedFalse: "Thanks for playing! Only your first result is recorded.",
        restartButton: "Back to Title",
        correct: "Correct!",
        incorrect: "Incorrect...",
        nextButton: "Next",
        reviewTitle: "Quiz Review",
        reviewAnswerLabel: "Answer",
        reviewUserAnswerLabel: "Your Answer",
        quiz: [
          { q: "How many children are estimated to die every day due to family poverty worldwide?", o: ["About 150,000", "About 10,000", "About 1,000", "About 100"], a: "About 10,000", ex: "It is said that every day, about 10,000 children under the age of five lose their lives due to poverty." },
          { q: "Which UN agency protects the rights and healthy development of children worldwide?", o: ["WHO", "UNICEF", "UNESCO", "UNDP"], a: "UNICEF", ex: "The UN agency that works to protect the rights and healthy development of children worldwide is UNICEF (United Nations Children's Fund)." },
          { q: "Which of the following is considered the most important measure to break the cycle of poverty?", o: ["Waiving all medical expenses for poor families", "Distributing food to the unemployed", "Rebuilding homes in poor areas", "Ensuring fair, high-quality opportunities for children"], a: "Ensuring fair, high-quality opportunities for children", ex: "The cycle of poverty occurs when parental poverty deprives children of opportunities. Education is the most effective means to correct this 'inequality of opportunity' and give children the chance to build their own futures." },
          { q: "What is the main reason why buying Fair Trade products helps solve the problem of poverty?", o: ["The products are distributed for free.", "Consumers can donate the money they save.", "All sales are donated to poor regions.", "Producers are paid a fair wage."], a: "Producers are paid a fair wage.", ex: "One of the most important principles of Fair Trade is to guarantee a fair price to producers and provide them with a stable income. This allows them to improve their lives and invest in education and healthcare." },
          { q: "What is the most appropriate central role of 'Kodomo Shokudo' (Children's Cafeterias), which support children who can't get enough food for economic reasons?", o: ["Teaching children cooking skills to promote independence.", "Providing a safe place where children can feel secure and not isolated.", "Distributing meals exclusively to children from poor families.", "Providing children with cheap or free luxurious meals."], a: "Providing a safe place where children can feel secure and not isolated.", ex: "The most important role of Kodomo Shokudo is to provide a 'place to belong' through meals, where children can connect with the community without being isolated. Since 2018, NKC has run the 'Nakaniwa Kodomo Shokudo' to create new value experiences for children." }
        ]
      },
      zh: {
        instructionTitle: "冒险须知",
        instructions: ["・将提出5个关于可持续性的问题。", "・正确回答4个以上问题即可击敗头目！", "・每个关卡只有第一次挑战的结果会被记录。", "・如果您在测验中途关闭屏幕，您到那时为止的分数将成为您的记录。", "・祝你好运！"],
        instructionOk: "知道了",
        title: "儿童与贫困",
        employeeIdPlaceholder: "输入员工编号(5位半角数字)",
        employeeIdNote: "员工编号为4位数或以下者，请在开头输入“0”（例：111→00111）",
        companySelectDefault: "请选择所属公司",
        startButton: "挑战",
        msgEnterId: "请输入所属公司和员工编号",
        msgCheckingId: "正在确认挑战资格...",
        msgIdNotFound: "未找到第一关的记录。请检查公司名称和员工编号。",
        msgCheckError: "确认出错。请稍后再试。",
        theme: "主题：儿童与贫困",
        progress: (q, t) => `第${q}/${t}题`,
        bossHp: "头目 HP",
        resultWinTitle: "胜利！",
        resultWinMsg: "关卡完成！连接了未来的希望！",
        resultLoseTitle: "游戏结束",
        resultLoseMsg: "魔龙王的力量深不可测…",
        submitting: "正在发送结果...",
        submitSuccess: "结果已发送！",
        submitError: "错误：无法发送结果。",
        recordedFalse: "感谢您的参与！只有初次挑战结果会被记录。",
        restartButton: "返回标题",
        correct: "回答正确！",
        incorrect: "回答错误...",
        nextButton: "下一个",
        reviewTitle: "测验回顾",
        reviewAnswerLabel: "正确答案",
        reviewUserAnswerLabel: "你的答案",
        quiz: [
          { q: "全球每天大约有多少儿童因家庭贫困而死亡？", o: ["约150,000人", "约10,000人", "约1,000人", "约100人"], a: "约10,000人", ex: "据说，全球每天有多达10,000名5岁以下儿童因贫困而死亡。" },
          { q: "哪个联合国机构负责保护全世界儿童的权利和健康成长？", o: ["WHO", "UNICEF", "UNESCO", "UNDP"], a: "UNICEF", ex: "致力于保护全世界儿童权利和健康成长的联合国机构是联合国儿童基金会（UNICEF）。" },
          { q: "为打破贫困的代际传递（循环），以下哪项被认为是最重要的措施？", o: ["全额免除贫困家庭的医疗费用", "向失业者分发食物", "重建贫困地区的住房", "确保儿童获得公平和高质量的机会"], a: "确保儿童获得公平和高质量的机会", ex: "贫困的代际传递是由于父母的贫困剥夺了孩子的机会而发生的。教育是纠正这种“机会不平等”、给予孩子们依靠自己力量开创未来的机会的最有效手段。" },
          { q: "购买公平贸易产品有助于解决贫困问题的主要原因是什么？", o: ["产品是免费分发的。", "消费者可以捐出节省下来的钱。", "所有销售额都捐赠给贫困地区。", "生产者能获得公平的报酬。"], a: "生产者能获得公平的报酬。", ex: "公平贸易最重要的原则之一是保证生产者获得公正的价格，并为他们提供稳定的收入。这使他们能够改善生活，并投资于教育和医疗。" },
          { q: "“儿童食堂”作为一项支援因家庭经济原因而无法获得足够食物的儿童的活动正在普及。以下哪项是其最核心的作用？", o: ["教孩子们烹饪技巧，促进他们自立。", "提供一个让孩子们不感到孤立、可以安心度过的场所。", "专门为贫困家庭的儿童配餐。", "为孩子们提供廉价或免费的豪华餐食。"], a: "提供一个让孩子们不感到孤立、可以安心度过的场所。", ex: "儿童食堂最重要的作用是通过提供餐食，为孩子们提供一个与当地社区联系、不感到孤立的“归属地”。自2018年以来，NKC为肩负未来的孩子们创办了“中庭儿童食堂”，致力于创造提供新价值的体验机会。" }
        ]
      }
    };
    const companyList = {
      ja: ["本社/天満地区", "治工具工場", "神戸工場", "大阪工場", "名張工場", "三重工場", "滋賀工場", "河内工場", "NASSH", "須田商事", "富士ホーニング", "中西興産", "CTM", "イーグローバレッジ", "ながいグリーンパワー", "NMC", "NSC", "NWC", "NPC", "NAI", "NCP", "NDC", "その他"],
      en: ["HQ/Tenma Area", "Jig & Tool Factory", "Kobe Plant", "Osaka Plant", "Nabari Plant", "Mie Plant", "Shiga Plant", "Kawachi Plant", "NASSH", "Suda Corporation", "Fuji Honing", "Nakanishi Kosan", "CTM", "e-Globaledge", "Nagai Green Power", "NMC", "NSC", "NWC", "NPC", "NAI", "NCP", "NDC", "Other"],
      zh: ["总公司/天满地区", "治工具工場", "神户工厂", "大阪工厂", "名张工厂", "三重工厂", "滋贺工厂", "河内工厂", "NASSH", "须田商事", "富士珩磨", "中西兴产", "CTM", "e-Globaledge", "长井绿色电力", "NMC", "NSC", "NWC", "NPC", "NAI", "NCP", "NDC", "其他"]
    };
    
    const titleScreen = document.getElementById('title-screen');
    const languageScreen = document.getElementById('language-screen');
    const instructionScreen = document.getElementById('instruction-screen');
    const startScreen = document.getElementById('start-screen');
    const quizScreen = document.getElementById('quiz-screen');
    const resultScreen = document.getElementById('result-screen');
    const bossContainer = document.getElementById('boss-container');
    const employeeIdInput = document.getElementById('employeeIdInput');
    const companySelect = document.getElementById('companySelect');
    const bgm = document.getElementById('bgm');
    const correctSound = document.getElementById('correct-sound');
    const startButton = document.getElementById('start-button');
    const explanationModal = document.getElementById('explanation-modal');
    const nextQuestionButton = document.getElementById('next-question-button');
    const openingVideoContainer = document.getElementById('opening-video-container');
    const gameVideoContainer = document.getElementById('game-video-container');

    let currentLang = 'ja';
    let timerInterval, startTime, correctCount, isGameInProgress = false, audioStarted = false;
    let clickSound, hitSound, damageSound, victorySound, defeatSound;
    let userAnswers = [];

    function switchScreen(screenName) {
      [titleScreen, languageScreen, instructionScreen, startScreen, quizScreen, resultScreen].forEach(s => s.classList.add('hidden'));
      document.getElementById(`${screenName}-screen`).classList.remove('hidden');
    }
    
    function updateUIText() {
      const t = TEXTS[currentLang];
      document.body.lang = currentLang;
      document.getElementById('instruction-title').textContent = t.instructionTitle;
      document.getElementById('instruction-text').innerHTML = t.instructions.map(line => `<p>${line}</p>`).join('');
      document.getElementById('instruction-ok-button').textContent = t.instructionOk;
      document.getElementById('title-text').textContent = t.title;
      employeeIdInput.placeholder = t.employeeIdPlaceholder;
      document.getElementById('employeeIdNoteDisplay').textContent = t.employeeIdNote;
      document.getElementById('start-button-text').textContent = t.startButton;
      document.getElementById('boss-hp-label').textContent = t.bossHp;
      document.getElementById('restart-button').textContent = t.restartButton;
      document.getElementById('theme-display').textContent = t.theme;
      
      companySelect.innerHTML = `<option value="">${t.companySelectDefault}</option>`;
      companyList[currentLang].forEach(company => {
        companySelect.innerHTML += `<option value="${company}">${company}</option>`;
      });
    }

    function setupAudio() {
      if (audioStarted) return;
      clickSound = () => new Tone.MembraneSynth({ pitchDecay: 0.01, octaves: 3, envelope: { attack: 0.001, decay: 0.3, sustain: 0 } }).toDestination().triggerAttackRelease("C2", "8n");
      hitSound = () => {
        correctSound.currentTime = 0;
        correctSound.play().catch(e => console.error("Correct sound play failed:", e));
      };
      damageSound = () => new Tone.NoiseSynth({ noise: { type: "pink" }, envelope: { attack: 0.01, decay: 0.3, sustain: 0, release: 0.2 } }).toDestination().triggerAttackRelease("8n");
      victorySound = () => { const s = new Tone.Synth().toDestination(), n = Tone.now(); s.triggerAttackRelease("C5", "8n", n); s.triggerAttackRelease("E5", "8n", n + 0.2); s.triggerAttackRelease("G5", "8n", n + 0.4); s.triggerAttackRelease("C6", "4n", n + 0.6) };
      defeatSound = () => { const s = new Tone.Synth().toDestination(), n = Tone.now(); s.triggerAttackRelease("C4", "4n", n); s.triggerAttackRelease("B3", "4n", n + 0.3); s.triggerAttackRelease("A#3", "4n", n + 0.6); s.triggerAttackRelease("A3", "2n", n + 0.9) };
      audioStarted = true;
    }

    function normalizeEmployeeIdForHTML(v) {
      const digits = String(v == null ? "" : v).replace(/[^\d]/g, "");
      return digits.padStart(5, "0");
    }

    async function startGame() {
      if (!employeeIdInput.checkValidity()) {
        employeeIdInput.reportValidity();
        return;
      }
      const company = companySelect.value;
      const employeeId = employeeIdInput.value.trim();
      const msgEl = document.getElementById('msg');
      if (!company || !employeeId) {
        msgEl.textContent = TEXTS[currentLang].msgEnterId;
        return;
      }
      if (isGameInProgress) return;
      isGameInProgress = true;
      startButton.disabled = true;
      msgEl.textContent = TEXTS[currentLang].msgCheckingId;

      const normalizedEmployeeId = normalizeEmployeeIdForHTML(employeeId);

      try {
        const checkUrl = `${GAS_URL}?action=checkEmployeeId&employeeId=${encodeURIComponent(normalizedEmployeeId)}&company=${encodeURIComponent(company)}`;
        const response = await fetch(checkUrl);
        const result = await response.json();

        if (result.exists) {
          msgEl.textContent = "";
          bgm.play().catch(e => console.error("BGM play failed:", e));
          clickSound();
          correctCount = 0;
          userAnswers = [];
          document.getElementById('boss-area').classList.remove('hidden');
          bossContainer.className = 'boss-idle';
          updateHpBars(100);
          switchScreen('quiz');
          startTime = Date.now();
          timerInterval = setInterval(() => {
            const elapsedTime = ((Date.now() - startTime) / 1000).toFixed(1);
            document.getElementById('timer-display').textContent = `${elapsedTime}s`;
          }, 100);
          displayQuestion(0);
        } else {
          msgEl.textContent = TEXTS[currentLang].msgIdNotFound;
        }
      } catch (error) {
        console.error("Error checking employee ID:", error);
        msgEl.textContent = TEXTS[currentLang].msgCheckError;
      } finally {
        isGameInProgress = false;
        startButton.disabled = false;
      }
    }

    function displayQuestion(index) {
      const quizData = TEXTS[currentLang].quiz;
      document.getElementById('progress-display').textContent = TEXTS[currentLang].progress(index + 1, quizData.length);
      const current = quizData[index];
      document.getElementById('question-text').textContent = `${current.q}`;
      const optionsContainer = document.getElementById('options-container');
      optionsContainer.innerHTML = '';
      current.o.forEach(opt => {
        const div = document.createElement('div');
        div.textContent = `▶ ${opt}`;
        div.classList.add('dq-button');
        div.addEventListener('click', () => handleAnswer(opt, current, index));
        optionsContainer.appendChild(div);
      });
    }

    function handleAnswer(selectedAnswer, currentQuiz, index) {
      const isCorrect = selectedAnswer === currentQuiz.a;
      userAnswers.push({
          questionIndex: index,
          selectedAnswer: selectedAnswer,
          isCorrect: isCorrect
      });
        
      const optionsContainer = document.getElementById('options-container');
      optionsContainer.querySelectorAll('.dq-button').forEach(btn => {
        btn.style.pointerEvents = 'none';
        if (btn.textContent.includes(currentQuiz.a)) {
          btn.classList.add('correct-answer');
        } else {
          btn.classList.add('incorrect-answer');
        }
      });

      if (isCorrect) {
        correctCount++;
        hitSound();
        updateHpBars(100 - (correctCount * (100 / 4)));
        bossContainer.classList.add('shake');
        document.getElementById('explanation-title').textContent = TEXTS[currentLang].correct;
      } else {
        damageSound();
        document.querySelector('.dq-window').classList.add('shake');
        document.getElementById('explanation-title').textContent = TEXTS[currentLang].incorrect;
      }
      
      document.getElementById('explanation-text').textContent = currentQuiz.ex;
      nextQuestionButton.textContent = TEXTS[currentLang].nextButton;
      nextQuestionButton.dataset.nextIndex = index + 1;
      
      setTimeout(() => {
        explanationModal.style.display = 'flex';
      }, 800);
    }
    
    nextQuestionButton.addEventListener('click', () => {
      explanationModal.style.display = 'none';
      bossContainer.classList.remove('shake');
      document.querySelector('.dq-window').classList.remove('shake');
      
      const nextIndex = parseInt(nextQuestionButton.dataset.nextIndex);
      if (nextIndex >= TEXTS[currentLang].quiz.length) {
        showEndScreen();
      } else {
        displayQuestion(nextIndex);
      }
    });

    function showEndScreen() {
      clearInterval(timerInterval);
      bgm.pause();
      bgm.currentTime = 0;
      
      const isVictory = correctCount >= 4;
      if (isVictory) {
        victorySound();
        bossContainer.className = 'boss-defeat';
      } else {
        defeatSound();
      }
      
      setTimeout(() => {
        document.getElementById('boss-area').classList.add('hidden');
        switchScreen('result');
        const t = TEXTS[currentLang];
        document.getElementById('result-title').textContent = isVictory ? t.resultWinTitle : t.resultLoseTitle;
        document.getElementById('result-message').textContent = isVictory ? t.resultWinMsg : t.resultLoseMsg;
        populateReviewSection();
        submitResults();
      }, isVictory ? 1500 : 500);
    }

    function populateReviewSection() {
        const reviewContainer = document.getElementById('review-container');
        const quizData = TEXTS[currentLang].quiz;
        reviewContainer.innerHTML = '';

        const title = document.createElement('h3');
        title.textContent = TEXTS[currentLang].reviewTitle;
        title.className = 'text-2xl font-bold mb-4';
        reviewContainer.appendChild(title);

        const contentWrapper = document.createElement('div');
        contentWrapper.className = 'text-base text-left h-48 overflow-y-auto p-2 border-2 border-white space-y-4 rounded-lg';
        reviewContainer.appendChild(contentWrapper);

        quizData.forEach((q, index) => {
            const userAnswerData = userAnswers.find(ans => ans.questionIndex === index);
            const isCorrect = userAnswerData ? userAnswerData.isCorrect : false;

            const questionBlock = document.createElement('div');
            questionBlock.className = `p-3 border-b border-gray-500 ${!isCorrect ? 'bg-red-500 bg-opacity-20 rounded-md' : ''}`;

            const questionP = document.createElement('p');
            questionP.className = 'font-bold';
            questionP.textContent = `Q${index + 1}: ${q.q}`;
            questionBlock.appendChild(questionP);

            if (!isCorrect && userAnswerData) {
                const userAnswerP = document.createElement('p');
                userAnswerP.innerHTML = `<strong class="text-red-400">${TEXTS[currentLang].reviewUserAnswerLabel}:</strong> ${userAnswerData.selectedAnswer}`;
                questionBlock.appendChild(userAnswerP);
            }

            const answerP = document.createElement('p');
            answerP.innerHTML = `<strong class="text-green-400">${TEXTS[currentLang].reviewAnswerLabel}:</strong> ${q.a}`;
            questionBlock.appendChild(answerP);

            const explanationP = document.createElement('p');
            explanationP.textContent = q.ex;
            explanationP.className = 'text-sm mt-2 text-gray-300';
            questionBlock.appendChild(explanationP);

            contentWrapper.appendChild(questionBlock);
        });
    }

    async function submitResults() {
        const statusEl = document.getElementById('submission-status');
        let ipAddress = 'N/A';
        try {
            const response = await fetch('https://api.ipify.org?format=json');
            ipAddress = (await response.json()).ip;
        } catch (error) {
            console.error('IPアドレスの取得に失敗しました:', error);
        }

        const normalizedEmployeeId = normalizeEmployeeIdForHTML(employeeIdInput.value.trim());
        const payload = {
            company: companySelect.value,
            employeeId: normalizedEmployeeId,
            stage: STAGE_NUMBER,
            score: correctCount,
            time: ((Date.now() - startTime) / 1000).toFixed(2),
            ipAddress: ipAddress
        };
        statusEl.textContent = TEXTS[currentLang].submitting;
        
        try {
            const response = await fetch(GAS_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/plain;charset=utf-8',
                },
                body: JSON.stringify(payload)
            });

            const result = await response.json();

            if (result.status === 'success') {
                if (result.recorded === false) {
                    statusEl.textContent = TEXTS[currentLang].recordedFalse;
                } else {
                    statusEl.textContent = TEXTS[currentLang].submitSuccess;
                }
            } else {
                statusEl.textContent = result.message || TEXTS[currentLang].submitError;
            }
        } catch (err) {
            statusEl.textContent = TEXTS[currentLang].submitError;
            console.error('Error:', err);
        }
    }

    function updateHpBars(percentage) {
      const hpBar = document.getElementById('boss-hp-bar');
      hpBar.style.width = `${Math.max(0, percentage)}%`;
      if (percentage <= 25) hpBar.className = 'boss-hp-bar low';
      else if (percentage <= 50) hpBar.className = 'boss-hp-bar mid';
      else hpBar.className = 'boss-hp-bar full';
    }
    
    function handleMediaError(element) {
        console.error(`Error loading media: ${element.src || 'No Source'}`);
        element.style.display = 'none'; 
    }

    document.getElementById('title-start-button').addEventListener('click', async () => {
      if (!audioStarted) { 
        await Tone.start();
        setupAudio();
      }
      clickSound();
      const openingVideo = document.getElementById('opening-video');
      openingVideo.muted = false;
      openingVideo.play().catch(e => console.log("User interaction might be needed for audio"));
      switchScreen('language');
    });

    document.getElementById('lang-ja').addEventListener('click', () => { clickSound(); currentLang = 'ja'; updateUIText(); switchScreen('instruction'); });
    document.getElementById('lang-en').addEventListener('click', () => { clickSound(); currentLang = 'en'; updateUIText(); switchScreen('instruction'); });
    document.getElementById('lang-zh').addEventListener('click', () => { clickSound(); currentLang = 'zh'; updateUIText(); switchScreen('instruction'); });
    
    document.getElementById('instruction-ok-button').addEventListener('click', () => {
      clickSound();
      openingVideoContainer.classList.add('hidden');
      document.getElementById('opening-video').pause();
      gameVideoContainer.classList.remove('hidden');
      document.getElementById('game-bg-video').play().catch(e => console.log("Game video play failed"));
      switchScreen('start');
    });
    
    startButton.addEventListener('click', startGame);
    document.getElementById('restart-button').addEventListener('click', () => location.reload());

    updateUIText();
    switchScreen('title');
    const openingVideo = document.getElementById('opening-video');
    openingVideo.muted = false;
    openingVideo.play().catch(e => {
        console.log("Autoplay with sound was prevented. Muting and retrying.");
        openingVideo.muted = true;
        openingVideo.play();
    });
  </script>
</body>
</html>
